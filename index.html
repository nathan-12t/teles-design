<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BibliOn - Sistema de Biblioteca Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    body { box-sizing: border-box; }
    .gradient-bg { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .card-hover { transition: all .3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -10px rgba(0,0,0,.15);}
    .nav-btn.active { border-color:#f59e0b !important; color:#f59e0b !important; }
    .book-card { background: linear-gradient(145deg, #ffffff, #f3f3f3); border: 1px solid #e6e6e6; }
    .transition-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f59e0b,#d97706);z-index:50;opacity:0;visibility:hidden;transition:all .5s ease}
    .transition-screen.active{opacity:1;visibility:visible}
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
    .float { animation: float 2s ease-in-out infinite; }
  </style>
</head>
<body class="bg-[#0f172a]">
  <!-- Tela de Transi√ß√£o -->
  <div id="transitionScreen" class="transition-screen">
    <div class="text-center text-white">
      <div class="float mb-4 text-6xl">üìö</div>
      <h1 class="text-3xl font-bold">Carregando BibliOn...</h1>
      <p class="text-lg opacity-80 mt-2">Sistema de Biblioteca Digital</p>
    </div>
  </div>

  <!-- Login -->
  <section id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="text-5xl mb-2">üìö</div>
        <h1 class="text-3xl font-bold text-gray-800">BibliOn</h1>
        <p class="text-gray-500">Sistema de Biblioteca Digital</p>
      </div>

      <form id="loginForm" class="space-y-5">
        <div>
          <label for="loginUser" class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio</label>
          <input id="loginUser" type="text" placeholder="Seu usu√°rio" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 outline-none" required />
        </div>

        <div>
          <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
          <div class="relative">
            <input id="loginPassword" type="password" placeholder="Sua senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 outline-none pr-12" required />
            <button type="button" id="togglePwd" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 text-sm text-yellow-700 bg-yellow-100 rounded hover:bg-yellow-200">Mostrar</button>
          </div>
        </div>

        <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-3 rounded-lg transition">Entrar</button>
      </form>

      <div class="mt-8 text-center text-xs text-gray-500">
        BibliOn v1.0 ¬∑ Criado por Nathannael Teles ¬∑ Teles Design
      </div>
    </div>
  </section>

  <!-- App -->
  <div id="mainSystem" class="hidden">
    <!-- Header -->
    <header class="gradient-bg text-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-3xl">üìö</div>
          <div>
            <h1 class="text-2xl font-bold">BibliOn</h1>
            <div class="text-xs opacity-80">Sistema de Biblioteca Digital</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="userWelcome" class="text-sm opacity-90"></span>
          <button id="trocarSenhaBtn" class="bg-yellow-600 hover:bg-yellow-700 text-black px-3 py-2 rounded-lg hidden">üîë Trocar Senha</button>
          <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg">Sair</button>
        </div>
      </div>
    </header>

    <!-- Nav -->
    <nav class="bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-6">
          <button onclick="showTab('inicio')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600 active">üè† In√≠cio</button>
          <button onclick="showTab('livros')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">üìñ Livros</button>
          <button onclick="showTab('emprestimos')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">üìã Empr√©stimos</button>
          <button onclick="showTab('devolucoes')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">‚è∞ Devolu√ß√µes</button>
          <button id="usuariosTabBtn" onclick="showTab('usuarios')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">üë• Usu√°rios</button>
          <button onclick="showTab('backup')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">üíæ Backup</button>
          <button id="relatoriosTabBtn" onclick="showTab('relatorios')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">üìä Relat√≥rios</button>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <!-- IN√çCIO -->
      <section id="inicioTab" class="tab-content">
        <h2 class="text-2xl font-bold text-white mb-6">Painel de Controle</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-yellow-100 p-3 rounded-full text-xl">üìö</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Livros</p>
                <p id="totalLivros" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-orange-100 p-3 rounded-full text-xl">üìã</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Empr√©stimos</p>
                <p id="totalEmprestimos" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-red-100 p-3 rounded-full text-xl">‚è∞</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Pend√™ncias</p>
                <p id="totalPendentes" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div id="usuariosCard" class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-amber-100 p-3 rounded-full text-xl">üë•</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Usu√°rios</p>
                <p id="totalUsuarios" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-semibold text-gray-800 mb-4">‚≠ê Livros em Destaque</h3>
          <div id="livrosDestaque" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4"></div>
        </div>

        <div id="meusEmprestimos" class="mt-8 bg-white rounded-xl p-6 hidden">
          <h3 class="font-semibold text-gray-800 mb-4">üìñ Meus Empr√©stimos</h3>
          <div id="emprestimosAluno" class="space-y-3"></div>
        </div>
      </section>

      <!-- LIVROS -->
      <section id="livrosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Gerenciamento de Livros</h2>
          <div id="livrosActions" class="space-x-2">
            <button onclick="showModal('addBookModal')" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-semibold">‚ûï Adicionar</button>
            <button onclick="showModal('importBooksModal')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">üìÑ Importar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">üîç Filtros Avan√ßados</h3>
            <button onclick="clearLivrosFilters()" class="text-sm text-yellow-600 underline font-semibold">Limpar Filtros</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <input id="searchLivros" type="text" placeholder="T√≠tulo, autor, c√≥digo..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500"/>
            <select id="filterCategoria" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500"><option value="">Todas as categorias</option></select>
            <select id="filterAutor" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500"><option value="">Todos os autores</option></select>
            <select id="filterDisponibilidade" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500">
              <option value="">Todos</option>
              <option value="disponivel">Dispon√≠vel</option>
              <option value="indisponivel">Indispon√≠vel</option>
            </select>
          </div>
        </div>

        <div id="livrosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>

      <!-- EMPR√âSTIMOS -->
      <section id="emprestimosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Controle de Empr√©stimos</h2>
          <button id="addEmprestimoBtn" onclick="showModal('addEmprestimoModal')" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-semibold">‚ûï Novo Empr√©stimo</button>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">Empr√©stimo</th>
                  <th class="px-6 py-3 text-left">Devolu√ß√£o</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="emprestimosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DEVOLU√á√ïES -->
      <section id="devolucoesTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">Devolu√ß√µes Pendentes</h2>
        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-red-50 text-xs text-red-600 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">Empr√©stimo</th>
                  <th class="px-6 py-3 text-left">Prevista</th>
                  <th class="px-6 py-3 text-left">Atraso</th>
                  <th class="px-6 py-3 text-left">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="devolucoesList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- USU√ÅRIOS -->
      <section id="usuariosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Gerenciamento de Usu√°rios</h2>
          <div class="space-x-2">
            <button onclick="showModal('addUserModal')" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-semibold">‚ûï Adicionar</button>
            <button onclick="showModal('importUsersModal')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">üìÑ Importar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Nome</th>
                  <th class="px-6 py-3 text-left">Login</th>
                  <th class="px-6 py-3 text-left">Tipo</th>
                  <th class="px-6 py-3 text-left">Turma</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="usuariosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- BACKUP -->
      <section id="backupTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">üíæ Sistema de Backup</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Backup Tradicional -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-yellow-600 mb-4">üìä Backup Tradicional</h3>
            
            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg mb-4">
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="flex items-center gap-2">
                  <span class="text-blue-600">üìö</span>
                  <span><span id="backupStatsLivros">0</span> livros</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-purple-600">üë•</span>
                  <span><span id="backupStatsUsuarios">0</span> usu√°rios</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-green-600">üìã</span>
                  <span><span id="backupStatsEmprestimos">0</span> empr√©stimos</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-orange-600">üìÖ</span>
                  <span id="backupStatsData">-</span>
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <button onclick="exportarBackup()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg text-sm font-semibold">üíæ Baixar Backup JSON</button>
              <button onclick="copiarBackup()" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">üìã Copiar Dados</button>
              <button onclick="showModal('mergeBackupsModal')" class="w-full bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">üîó Juntar Backups</button>
            </div>

            <!-- Restaurar Backup -->
            <div class="mt-6 bg-green-50 border border-green-200 p-4 rounded-lg">
              <h4 class="font-semibold text-green-800 mb-2">üì• Restaurar Backup</h4>
              <div class="space-y-3">
                <input type="file" id="backupFile" accept=".json,.txt" class="w-full px-3 py-2 border rounded-lg text-sm">
                <textarea id="backupText" rows="4" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Ou cole os dados aqui..."></textarea>
                <button onclick="restaurarBackup()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">üì• Restaurar</button>
              </div>
            </div>
          </div>

          <!-- QR Code Backup -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-blue-600 mb-4">üì± QR Code Backup</h3>
            
            <div class="text-center mb-4">
              <div id="backupQRContainer" class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 mb-3 min-h-[200px] flex items-center justify-center">
                <div class="text-center text-gray-500">
                  <div class="text-4xl mb-2">üì±</div>
                  <div class="font-semibold">QR Code Backup</div>
                  <div class="text-sm mt-1">Clique para gerar</div>
                </div>
              </div>
              
              <button onclick="gerarQRCode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-bold mb-2">
                üì± Gerar QR Code
              </button>
              
              <button onclick="copiarLink()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
                üîó Compartilhar Link
              </button>
            </div>
            
            <!-- Recursos -->
            <div class="bg-blue-50 border border-blue-200 rounded p-3 text-xs">
              <div class="font-semibold text-blue-800 mb-1">üì± Recursos do QR Code</div>
              <div class="text-blue-700 space-y-1">
                <div>‚Ä¢ Backup completo da biblioteca</div>
                <div>‚Ä¢ Escaneie para baixar</div>
                <div>‚Ä¢ Compartilhamento f√°cil</div>
                <div>‚Ä¢ Restaura√ß√£o autom√°tica</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Estat√≠sticas da Biblioteca -->
        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-bold text-gray-800 mb-4">üìä Estat√≠sticas da Biblioteca</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
              <div class="text-2xl text-blue-600 mb-1">üìö</div>
              <div class="font-bold text-lg" id="statsLivros">0</div>
              <div class="text-xs text-gray-600">Livros</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-lg">
              <div class="text-2xl text-purple-600 mb-1">üë•</div>
              <div class="font-bold text-lg" id="statsUsuarios">0</div>
              <div class="text-xs text-gray-600">Usu√°rios</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
              <div class="text-2xl text-green-600 mb-1">üìã</div>
              <div class="font-bold text-lg" id="statsEmprestimos">0</div>
              <div class="text-xs text-gray-600">Empr√©stimos</div>
            </div>
            <div class="text-center p-4 bg-orange-50 rounded-lg">
              <div class="text-2xl text-orange-600 mb-1">üíæ</div>
              <div class="font-bold text-lg" id="statsTamanho">0</div>
              <div class="text-xs text-gray-600">KB</div>
            </div>
          </div>
        </div>
      </section>

      <!-- RELAT√ìRIOS -->
      <section id="relatoriosTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">üìä Relat√≥rios e Estat√≠sticas</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Relat√≥rio de Leitura por Usu√°rio -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-blue-600 mb-4">üìö Relat√≥rio de Leitura</h3>
            
            <div class="mb-4">
              <select id="filtroTipoUsuario" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Todos os tipos</option>
                <option value="aluno">Apenas Alunos</option>
                <option value="professor">Apenas Professores</option>
                <option value="admin">Apenas Admins</option>
              </select>
            </div>
            
            <div id="relatorioLeitura" class="space-y-3 max-h-96 overflow-y-auto"></div>
          </div>

          <!-- Top Livros Mais Emprestados -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-green-600 mb-4">üèÜ Top Livros Mais Emprestados</h3>
            <div id="topLivros" class="space-y-3"></div>
          </div>

          <!-- Estat√≠sticas Gerais -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-purple-600 mb-4">üìà Estat√≠sticas Gerais</h3>
            <div id="estatisticasGerais" class="grid grid-cols-2 gap-4"></div>
          </div>

          <!-- Feedbacks dos Livros -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-orange-600 mb-4">üí¨ Feedbacks dos Livros</h3>
            <div id="feedbacksLivros" class="space-y-3 max-h-96 overflow-y-auto"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-[#0b1224] text-white/70 text-center py-6">
      <div class="max-w-7xl mx-auto px-4">
        <div class="text-lg font-semibold mb-2">BibliOn v1.0</div>
        <div class="text-sm opacity-75">Sistema de Biblioteca Digital</div>
        <div class="text-xs mt-2">Criado por Nathannael Teles ¬∑ Teles Design</div>
      </div>
    </footer>
  </div>

  <!-- Modais -->
  <!-- Add Livro Modal -->
  <div id="addBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Adicionar Livro</h3>
        <button onclick="closeModal('addBookModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <form id="addBookForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="addBookTitulo" class="block text-sm font-medium mb-1">T√≠tulo *</label><input id="addBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookAutor" class="block text-sm font-medium mb-1">Autor *</label><input id="addBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookEditora" class="block text-sm font-medium mb-1">Editora</label><input id="addBookEditora" name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookCategoria" class="block text-sm font-medium mb-1">Categoria</label><input id="addBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookQuantidade" class="block text-sm font-medium mb-1">Quantidade Total *</label><input id="addBookQuantidade" type="number" min="1" name="quantidade" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookDisponivel" class="block text-sm font-medium mb-1">Dispon√≠vel *</label><input id="addBookDisponivel" type="number" min="0" name="disponivel" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookCodigoBarra" class="block text-sm font-medium mb-1">C√≥digo de Barras</label><input id="addBookCodigoBarra" name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookLocalizacao" class="block text-sm font-medium mb-1">Localiza√ß√£o</label><input id="addBookLocalizacao" name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
        </div>
        <div>
          <label for="addBookDescricao" class="block text-sm font-medium mb-1">Descri√ß√£o</label>
          <textarea id="addBookDescricao" name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"></textarea>
        </div>
        <div>
          <label for="addBookFoto" class="block text-sm font-medium mb-1">üì∏ Foto do Livro</label>
          <input id="addBookFoto" type="file" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
          <div class="text-xs text-gray-500 mt-1">Formatos aceitos: PNG, JPG, JPEG, GIF, WEBP</div>
          <div id="addBookPreview" class="mt-2 hidden">
            <img id="addBookPreviewImg" class="w-20 h-28 object-cover rounded border" alt="Preview"/>
          </div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeModal('addBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Livros Modal -->
  <div id="importBooksModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Livros</h3>
        <button onclick="closeModal('importBooksModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div class="space-y-4">
        <textarea id="importBooksText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="T√≠tulo | Autor | Categoria | Quantidade&#10;Ex: Dom Casmurro | Machado de Assis | Literatura | 5"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importBooksModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importBooks()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Usu√°rio Modal -->
  <div id="addUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Adicionar Usu√°rio</h3>
        <button onclick="closeModal('addUserModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <form id="addUserForm" class="space-y-4">
        <div><label for="addUserNome" class="block text-sm font-medium mb-1">Nome *</label><input id="addUserNome" name="nome" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label for="addUserLogin" class="block text-sm font-medium mb-1">Login *</label><input id="addUserLogin" name="login" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label for="addUserSenha" class="block text-sm font-medium mb-1">Senha *</label><input id="addUserSenha" type="password" name="senha" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div>
          <label for="addUserTipo" class="block text-sm font-medium mb-1">Tipo *</label>
          <select id="addUserTipo" name="tipo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione...</option>
            <option value="aluno">Aluno</option>
            <option value="professor">Professor</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div><label for="addUserTurma" class="block text-sm font-medium mb-1">S√©rie/Turma</label><input id="addUserTurma" name="turma" placeholder="Ex: 9¬∫ A, 1¬∫ EM B, 3¬∫ T√©cnico..." class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addUserModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Usu√°rios Modal -->
  <div id="importUsersModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Usu√°rios</h3>
        <button onclick="closeModal('importUsersModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div class="space-y-4">
        <textarea id="importUsersText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nome | Login | Senha | Tipo | S√©rie/Turma&#10;Ex: Jo√£o Silva | joao | 1234 | aluno | 9¬∫ A"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importUsersModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importUsers()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Empr√©stimo Modal -->
  <div id="addEmprestimoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Novo Empr√©stimo</h3>
        <button onclick="closeModal('addEmprestimoModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <form id="addEmprestimoForm" class="space-y-4">
        <div>
          <label for="emprestimoAluno" class="block text-sm font-medium mb-1">Aluno *</label>
          <select id="emprestimoAluno" name="alunoId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o aluno...</option>
          </select>
        </div>
        <div>
          <label for="emprestimoLivro" class="block text-sm font-medium mb-1">Livro *</label>
          <select id="emprestimoLivro" name="livroId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o livro...</option>
          </select>
        </div>
        <div>
          <label for="emprestimoDataDevolucao" class="block text-sm font-medium mb-1">Data de Devolu√ß√£o *</label>
          <input id="emprestimoDataDevolucao" type="date" name="dataDevolucao" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addEmprestimoModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Emprestar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Empr√©stimo Modal -->
  <div id="editEmprestimoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Editar Empr√©stimo</h3>
        <button onclick="closeModal('editEmprestimoModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <form id="editEmprestimoForm" class="space-y-4">
        <input type="hidden" id="editEmprestimoId" name="id">
        <div>
          <label for="editEmprestimoAluno" class="block text-sm font-medium mb-1">Aluno *</label>
          <select id="editEmprestimoAluno" name="alunoId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o aluno...</option>
          </select>
        </div>
        <div>
          <label for="editEmprestimoLivro" class="block text-sm font-medium mb-1">Livro *</label>
          <select id="editEmprestimoLivro" name="livroId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o livro...</option>
          </select>
        </div>
        <div>
          <label for="editEmprestimoDataEmprestimo" class="block text-sm font-medium mb-1">Data de Empr√©stimo *</label>
          <input id="editEmprestimoDataEmprestimo" type="date" name="dataEmprestimo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div>
          <label for="editEmprestimoDataDevolucao" class="block text-sm font-medium mb-1">Data de Devolu√ß√£o *</label>
          <input id="editEmprestimoDataDevolucao" type="date" name="dataDevolucao" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div>
          <label for="editEmprestimoStatus" class="block text-sm font-medium mb-1">Status *</label>
          <select id="editEmprestimoStatus" name="status" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="ativo">Ativo</option>
            <option value="devolvido">Devolvido</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('editEmprestimoModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Livro Modal -->
  <div id="editBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Editar Livro</h3>
        <button onclick="closeModal('editBookModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <form id="editBookForm" class="space-y-4">
        <input type="hidden" id="editBookId" name="id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="editBookTitulo" class="block text-sm font-medium mb-1">T√≠tulo *</label><input id="editBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookAutor" class="block text-sm font-medium mb-1">Autor *</label><input id="editBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookEditora" class="block text-sm font-medium mb-1">Editora</label><input id="editBookEditora" name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookCategoria" class="block text-sm font-medium mb-1">Categoria</label><input id="editBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookQuantidade" class="block text-sm font-medium mb-1">Quantidade Total *</label><input id="editBookQuantidade" type="number" min="1" name="quantidade" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookDisponivel" class="block text-sm font-medium mb-1">Dispon√≠vel *</label><input id="editBookDisponivel" type="number" min="0" name="disponivel" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookCodigoBarra" class="block text-sm font-medium mb-1">C√≥digo de Barras</label><input id="editBookCodigoBarra" name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookLocalizacao" class="block text-sm font-medium mb-1">Localiza√ß√£o</label><input id="editBookLocalizacao" name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
        </div>
        <div>
          <label for="editBookDescricao" class="block text-sm font-medium mb-1">Descri√ß√£o</label>
          <textarea id="editBookDescricao" name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"></textarea>
        </div>
        <div>
          <label for="editBookFoto" class="block text-sm font-medium mb-1">üì∏ Foto do Livro</label>
          <input id="editBookFoto" type="file" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
          <div class="text-xs text-gray-500 mt-1">Formatos aceitos: PNG, JPG, JPEG, GIF, WEBP</div>
          <div id="editBookPreview" class="mt-2 hidden">
            <img id="editBookPreviewImg" class="w-20 h-28 object-cover rounded border" alt="Preview atual"/>
          </div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeModal('editBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Merge Backups Modal -->
  <div id="mergeBackupsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-purple-600">üîó Juntar M√∫ltiplos Backups</h3>
        <button onclick="closeModal('mergeBackupsModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      
      <div class="space-y-6">
        <!-- Sele√ß√£o de Arquivos -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <h4 class="font-semibold text-purple-800 mb-3">üìÅ Selecionar Backups</h4>
          <input type="file" id="mergeBackupFiles" accept=".json,.txt" multiple class="w-full px-3 py-2 border rounded-lg text-sm mb-3">
          <div class="text-xs text-purple-600">
            üí° Selecione 2 ou mais arquivos de backup para juntar
          </div>
          <button onclick="loadBackupsForMerge()" class="mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">üìÇ Carregar Backups</button>
        </div>

        <!-- Preview dos Backups -->
        <div id="backupsPreview" class="hidden">
          <h4 class="font-semibold text-gray-800 mb-3">üìä Preview dos Backups</h4>
          <div id="backupsPreviewContent" class="space-y-3"></div>
        </div>

        <!-- Configura√ß√µes de Jun√ß√£o -->
        <div id="mergeSettings" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="font-semibold text-blue-800 mb-3">‚öôÔ∏è Configura√ß√µes de Jun√ß√£o</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Conflitos de Usu√°rios</label>
              <select id="userConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="skip">Pular duplicados</option>
                <option value="rename">Renomear duplicados</option>
                <option value="merge">Mesclar dados</option>
                <option value="replace">Substituir existentes</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Conflitos de Livros</label>
              <select id="bookConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="merge">Somar quantidades</option>
                <option value="skip">Pular duplicados</option>
                <option value="replace">Substituir existentes</option>
                <option value="keep_both">Manter ambos</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Empr√©stimos</label>
              <select id="loanConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="merge_all">Mesclar todos</option>
                <option value="skip_duplicates">Pular duplicados</option>
                <option value="active_only">Apenas ativos</option>
                <option value="recent_only">Mais recentes</option>
              </select>
            </div>
          </div>

          <div class="mb-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="preserveIds" checked class="rounded">
              <span class="text-sm text-blue-700">üî¢ Preservar IDs originais quando poss√≠vel</span>
            </label>
          </div>

          <div class="mb-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="createMergeLog" checked class="rounded">
              <span class="text-sm text-blue-700">üìù Criar log detalhado da jun√ß√£o</span>
            </label>
          </div>
        </div>

        <!-- Resultado da Jun√ß√£o -->
        <div id="mergeResult" class="hidden">
          <h4 class="font-semibold text-green-800 mb-3">‚úÖ Resultado da Jun√ß√£o</h4>
          <div id="mergeResultContent" class="bg-green-50 border border-green-200 rounded-lg p-4"></div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="flex justify-end gap-2 pt-4 border-t">
          <button onclick="closeModal('mergeBackupsModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button id="executeMergeBtn" onclick="executeMergeBackups()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg hidden">üîó Executar Jun√ß√£o</button>
          <button id="applyMergeBtn" onclick="applyMergedBackup()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg hidden">‚úÖ Aplicar Backup Unificado</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar Feedback -->
  <div id="addFeedbackModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">üí¨ Avaliar Livro</h3>
        <button onclick="closeModal('addFeedbackModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <form id="addFeedbackForm" class="space-y-4">
        <input type="hidden" id="feedbackLivroId" name="livroId">
        
        <div id="feedbackLivroInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
          <div class="font-semibold text-blue-800" id="feedbackLivroTitulo"></div>
          <div class="text-sm text-blue-600" id="feedbackLivroAutor"></div>
        </div>
        
        <div>
          <label for="feedbackNota" class="block text-sm font-medium mb-2">‚≠ê Nota (1 a 5 estrelas)</label>
          <div class="flex gap-2">
            <button type="button" onclick="setRating(1)" class="rating-btn px-3 py-2 border rounded hover:bg-yellow-100" data-rating="1">‚≠ê</button>
            <button type="button" onclick="setRating(2)" class="rating-btn px-3 py-2 border rounded hover:bg-yellow-100" data-rating="2">‚≠ê‚≠ê</button>
            <button type="button" onclick="setRating(3)" class="rating-btn px-3 py-2 border rounded hover:bg-yellow-100" data-rating="3">‚≠ê‚≠ê‚≠ê</button>
            <button type="button" onclick="setRating(4)" class="rating-btn px-3 py-2 border rounded hover:bg-yellow-100" data-rating="4">‚≠ê‚≠ê‚≠ê‚≠ê</button>
            <button type="button" onclick="setRating(5)" class="rating-btn px-3 py-2 border rounded hover:bg-yellow-100" data-rating="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</button>
          </div>
          <input type="hidden" id="feedbackNota" name="nota" required>
        </div>
        
        <div>
          <label for="feedbackComentario" class="block text-sm font-medium mb-1">üí≠ Coment√°rio</label>
          <textarea id="feedbackComentario" name="comentario" rows="4" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="O que voc√™ achou do livro? (opcional)"></textarea>
        </div>
        
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addFeedbackModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">üí¨ Enviar Avalia√ß√£o</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Ver Feedbacks -->
  <div id="viewFeedbacksModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">üëÅÔ∏è Avalia√ß√µes do Livro</h3>
        <button onclick="closeModal('viewFeedbacksModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      
      <div id="feedbackLivroInfoView" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
        <div class="font-semibold text-green-800" id="viewFeedbackLivroTitulo"></div>
        <div class="text-sm text-green-600" id="viewFeedbackLivroAutor"></div>
        <div class="mt-2 flex items-center gap-4">
          <div class="flex items-center gap-1">
            <span id="viewFeedbackMediaEstrelas" class="text-yellow-500"></span>
            <span id="viewFeedbackMedia" class="font-semibold"></span>
          </div>
          <div class="text-sm text-gray-600">
            <span id="viewFeedbackTotal">0</span> avalia√ß√£o(√µes)
          </div>
        </div>
      </div>
      
      <div id="feedbacksList" class="space-y-4"></div>
      
      <div class="mt-4 text-center">
        <button onclick="closeModal('viewFeedbacksModal')" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== BANCO DE DADOS =====
    const defaultDB = {
      usuarios: [
        { 
          id: 1, 
          nome: 'Administrador', 
          login: 'ADMIN', 
          senha: 'VANIA25', 
          tipo: 'admin', 
          turma: '', 
          status: 'ativo', 
          livrosLidos: 0 
        }
      ],
      livros: [
        { 
          id: 1, 
          titulo: 'Dom Casmurro', 
          autor: 'Machado de Assis', 
          editora: '√Åtica', 
          categoria: 'Literatura Brasileira', 
          quantidade: 5, 
          disponivel: 5, 
          descricao: 'Cl√°ssico da literatura brasileira que narra a hist√≥ria de Bentinho e Capitu.', 
          foto: '', 
          codigoBarra: '9788508123456', 
          localizacao: 'Estante A - Prateleira 2'
        },
        { 
          id: 2, 
          titulo: 'O Corti√ßo', 
          autor: 'Alu√≠sio Azevedo', 
          editora: 'Moderna', 
          categoria: 'Literatura Brasileira', 
          quantidade: 3, 
          disponivel: 3, 
          descricao: 'Romance naturalista que retrata a vida em um corti√ßo do Rio de Janeiro no s√©culo XIX.', 
          foto: '', 
          codigoBarra: '9788516987654', 
          localizacao: 'Estante A - Prateleira 3'
        }
      ],
      emprestimos: [],
      feedbacks: [],
      nextId: { usuarios: 2, livros: 3, emprestimos: 1, feedbacks: 1 },
      metadata: {
        version: '1.0',
        lastUpdate: new Date().toISOString(),
        systemName: 'BibliOn - Sistema de Biblioteca Digital'
      }
    };

    // ===== VARI√ÅVEIS GLOBAIS =====
    let database = null;
    let currentUser = null;

    // ===== GERADOR QR CODE =====
    function gerarQRCode() {
      const container = document.getElementById('backupQRContainer');
      container.innerHTML = '<div class="text-center text-blue-600 p-4"><div class="text-4xl mb-3">üì±</div><div class="font-bold text-xl">Gerando QR Code...</div><div class="text-sm mt-2">Aguarde um momento</div></div>';
      
      try {
        // Cria backup completo
        const backupData = {
          usuarios: database.usuarios,
          livros: database.livros,
          emprestimos: database.emprestimos,
          nextId: database.nextId,
          metadata: {
            version: '1.0',
            lastUpdate: new Date().toISOString(),
            systemName: 'BibliOn - Sistema de Biblioteca Digital',
            exportedBy: currentUser?.nome || 'Sistema',
            exportedAt: new Date().toISOString(),
            backupType: 'QR Code'
          }
        };
        
        const backupJson = JSON.stringify(backupData);
        const qrUrl = gerarURL(backupJson);
        const qrCode = criarQRCode(qrUrl);
        
        container.innerHTML = '';
        
        // T√≠tulo de sucesso
        const successTitle = document.createElement('div');
        successTitle.className = 'text-center mb-4';
        successTitle.innerHTML = `
          <div class="text-4xl mb-2">üì±</div>
          <div class="font-bold text-xl text-blue-600">QR Code Gerado</div>
          <div class="text-sm text-blue-500">Backup completo da biblioteca</div>
        `;
        container.appendChild(successTitle);
        
        // QR Code
        const qrWrapper = document.createElement('div');
        qrWrapper.className = 'flex justify-center mb-4';
        qrWrapper.appendChild(qrCode);
        container.appendChild(qrWrapper);
        
        // Estat√≠sticas
        const stats = document.createElement('div');
        stats.className = 'bg-blue-600 text-white rounded-lg p-4 text-sm';
        stats.innerHTML = `
          <div class="grid grid-cols-2 gap-3 text-center">
            <div class="bg-white/20 rounded-lg p-3">
              <div class="text-2xl mb-1">üìö</div>
              <div class="font-bold">${database.livros.length}</div>
              <div class="text-xs opacity-75">Livros</div>
            </div>
            <div class="bg-white/20 rounded-lg p-3">
              <div class="text-2xl mb-1">üë•</div>
              <div class="font-bold">${database.usuarios.length}</div>
              <div class="text-xs opacity-75">Usu√°rios</div>
            </div>
            <div class="bg-white/20 rounded-lg p-3">
              <div class="text-2xl mb-1">üìã</div>
              <div class="font-bold">${database.emprestimos.length}</div>
              <div class="text-xs opacity-75">Empr√©stimos</div>
            </div>
            <div class="bg-white/20 rounded-lg p-3">
              <div class="text-2xl mb-1">üíæ</div>
              <div class="font-bold">${Math.round(backupJson.length / 1024)}</div>
              <div class="text-xs opacity-75">KB</div>
            </div>
          </div>
        `;
        container.appendChild(stats);
        
        // Instru√ß√µes
        const instructions = document.createElement('div');
        instructions.className = 'mt-4 bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-800';
        instructions.innerHTML = `
          <div class="font-bold mb-2 flex items-center gap-2">
            <span class="text-lg">üì±</span>
            Como usar este QR Code:
          </div>
          <ol class="list-decimal list-inside space-y-1 text-xs">
            <li>Abra a c√¢mera do celular ou app de QR Code</li>
            <li>Aponte para o c√≥digo acima</li>
            <li>Toque na notifica√ß√£o que aparecer</li>
            <li>Backup ser√° baixado automaticamente</li>
          </ol>
        `;
        container.appendChild(instructions);
        
        setTimeout(() => {
          alert(`üì± QR Code gerado com sucesso!\n\nüìä Estat√≠sticas:\n‚Ä¢ ${database.livros.length} livros\n‚Ä¢ ${database.usuarios.length} usu√°rios\n‚Ä¢ ${database.emprestimos.length} empr√©stimos\n\nüì± Escaneie para baixar backup completo!`);
        }, 500);
        
      } catch (error) {
        console.error('Erro ao gerar QR Code:', error);
        
        container.innerHTML = `
          <div class="text-center text-red-600 p-4">
            <div class="text-4xl mb-2">‚ùå</div>
            <div class="font-bold">Erro ao gerar QR Code</div>
            <div class="text-sm mt-2">${error.message}</div>
          </div>
        `;
        
        setTimeout(() => {
          alert(`‚ùå Erro ao gerar QR Code:\n\n${error.message}\n\nTente usar o backup tradicional.`);
        }, 1000);
      }
    }

    function gerarURL(backupData) {
      const encoded = btoa(encodeURIComponent(backupData));
      return `https://nathan-12t.github.io/teles-design/?backup=${encoded}`;
    }

    function criarQRCode(url, size = 300) {
      const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(url)}&format=svg&bgcolor=ffffff&color=000000&ecc=L&qzone=1&margin=2`;
      
      const img = document.createElement('img');
      img.src = apiUrl;
      img.alt = 'QR Code Backup';
      img.className = 'mx-auto rounded-lg shadow-lg border-2 border-blue-300';
      img.style.width = size + 'px';
      img.style.height = size + 'px';
      
      img.onerror = function() {
        this.style.display = 'none';
        const fallback = document.createElement('div');
        fallback.className = 'bg-blue-600 rounded-lg flex items-center justify-center text-white border-2 border-blue-300';
        fallback.style.width = size + 'px';
        fallback.style.height = size + 'px';
        fallback.innerHTML = `
          <div class="text-center p-2">
            <div class="text-4xl mb-2">üì±</div>
            <div class="font-bold text-sm">QR Code</div>
            <div class="text-xs">Backup</div>
          </div>
        `;
        this.parentNode.appendChild(fallback);
      };
      
      return img;
    }

    function copiarLink() {
      try {
        const backupData = {
          ...database,
          metadata: {
            ...database.metadata,
            exportedAt: new Date().toISOString(),
            exportedBy: currentUser?.nome || 'Sistema',
            backupType: 'Link'
          }
        };
        
        const backupJson = JSON.stringify(backupData);
        const backupUrl = gerarURL(backupJson);
        
        navigator.clipboard.writeText(backupUrl).then(() => {
          alert(`üîó Link copiado!\n\n‚ú® Este link cont√©m o backup completo da biblioteca\n\nüì± Compartilhe apenas com pessoas autorizadas!`);
        }).catch(() => {
          const textArea = document.createElement('textarea');
          textArea.value = backupUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert('üîó Link copiado para √°rea de transfer√™ncia!');
        });
        
      } catch (error) {
        alert('‚ùå Erro ao gerar link: ' + error.message);
      }
    }

    // ===== FUN√á√ïES UTILIT√ÅRIAS =====
    function safeParse(json) {
      try {
        return JSON.parse(json);
      } catch {
        return null;
      }
    }

    function saveDatabase() {
      if (!database.metadata) {
        database.metadata = {};
      }
      database.metadata.lastUpdate = new Date().toISOString();
      database.metadata.version = '6.0';
      database.metadata.systemName = 'BibliOn Supremo - Sistema QR Code MEGA V6.0';
      
      localStorage.setItem('bibliOnMegaDatabase', JSON.stringify(database));
    }

    function showModal(id) {
      const modal = document.getElementById(id);
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // Carrega dados espec√≠ficos do modal
      if (id === 'addEmprestimoModal') {
        loadEmprestimoModalData();
      }
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('pt-BR');
    }

    // ===== INICIALIZA√á√ÉO DO BANCO MEGA =====
    function initializeDatabase() {
      console.log('üî• Inicializando banco de dados MEGA...');
      
      const saved = localStorage.getItem('bibliOnMegaDatabase');
      console.log('üíæ Dados MEGA encontrados:', !!saved);
      
      if (!saved) {
        console.log('‚ú® Criando banco MEGA padr√£o...');
        database = JSON.parse(JSON.stringify(defaultDB));
        saveDatabase();
      } else {
        const parsed = safeParse(saved);
        if (!parsed || !parsed.usuarios || !Array.isArray(parsed.usuarios)) {
          console.log('‚ö†Ô∏è Dados corrompidos, recriando banco MEGA...');
          database = JSON.parse(JSON.stringify(defaultDB));
          saveDatabase();
        } else {
          database = parsed;
          
          if (!database.nextId) {
            database.nextId = { usuarios: 2, livros: 3, emprestimos: 1, feedbacks: 1 };
          }
          
          if (!database.feedbacks) {
            database.feedbacks = [];
          }
          
          if (!database.metadata) {
            database.metadata = {
              version: '6.0',
              lastUpdate: new Date().toISOString(),
              systemName: 'BibliOn Supremo - Sistema QR Code MEGA V6.0'
            };
          }
          
          const hasAdmin = database.usuarios.some(u => 
            u && u.login && u.login.toUpperCase() === 'ADMIN'
          );
          
          if (!hasAdmin) {
            console.log('üëë Adicionando usu√°rio ADMIN MEGA...');
            database.usuarios.push({
              id: database.nextId.usuarios++,
              nome: 'Administrador MEGA',
              login: 'ADMIN',
              senha: 'VANIA25',
              tipo: 'admin',
              turma: '',
              status: 'ativo',
              livrosLidos: 0
            });
            saveDatabase();
          }
        }
      }
      
      console.log('‚úÖ Banco MEGA inicializado:', {
        usuarios: database.usuarios.length,
        livros: database.livros.length,
        emprestimos: database.emprestimos.length
      });
    }

    // ===== SISTEMA DE LOGIN =====
    function handleLogin(event) {
      event.preventDefault();
      
      const userInput = document.getElementById('loginUser').value.trim();
      const passwordInput = document.getElementById('loginPassword').value;
      
      console.log('üîê Tentativa de login MEGA:', { usuario: userInput, senha: '***' });
      
      if (!userInput || !passwordInput) {
        alert('Por favor, preencha usu√°rio e senha.');
        return;
      }
      
      const user = database.usuarios.find(u => {
        if (!u || !u.login || !u.senha) return false;
        
        const loginMatch = u.login.toUpperCase() === userInput.toUpperCase();
        const passwordMatch = u.senha === passwordInput;
        const isActive = u.status === 'ativo';
        
        return loginMatch && passwordMatch && isActive;
      });
      
      if (!user) {
        console.log('‚ùå Login falhou');
        alert('Usu√°rio ou senha incorretos, ou usu√°rio bloqueado.');
        return;
      }
      
      console.log('‚úÖ Login MEGA bem-sucedido:', user.nome);
      currentUser = user;
      showTransition();
    }

    function showTransition() {
      const transition = document.getElementById('transitionScreen');
      transition.classList.add('active');
      
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainSystem').classList.remove('hidden');
        transition.classList.remove('active');
        setupUserInterface();
        showTab('inicio');
      }, 800);
    }

    function setupUserInterface() {
      document.getElementById('userWelcome').textContent = `Ol√°, ${currentUser.nome}`;
      
      const isAdmin = currentUser.tipo === 'admin';
      const isStudent = currentUser.tipo === 'aluno';
      
      document.getElementById('usuariosTabBtn').classList.remove('hidden');
      document.getElementById('usuariosCard').classList.remove('hidden');
      document.getElementById('addEmprestimoBtn').classList.remove('hidden');
      document.getElementById('meusEmprestimos').classList.add('hidden');
      document.getElementById('livrosActions').classList.remove('hidden');
      document.getElementById('relatoriosTabBtn').classList.remove('hidden');
      
      document.getElementById('trocarSenhaBtn').classList.toggle('hidden', !isAdmin);
      
      if (isStudent) {
        document.getElementById('usuariosTabBtn').classList.add('hidden');
        document.getElementById('usuariosCard').classList.add('hidden');
        document.getElementById('addEmprestimoBtn').classList.add('hidden');
        document.getElementById('meusEmprestimos').classList.remove('hidden');
        document.getElementById('livrosActions').classList.add('hidden');
        document.getElementById('relatoriosTabBtn').classList.add('hidden');
      }
      
      updateDashboard();
    }

    function logout() {
      currentUser = null;
      document.getElementById('mainSystem').classList.add('hidden');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('loginForm').reset();
    }

    // ===== SISTEMA DE ABAS =====
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
          btn.classList.add('active');
        }
      });
      
      switch (tabName) {
        case 'inicio':
          updateDashboard();
          break;
        case 'livros':
          loadLivros();
          loadFilterOptions();
          break;
        case 'emprestimos':
          loadEmprestimos();
          break;
        case 'devolucoes':
          loadDevolucoesPendentes();
          break;
        case 'usuarios':
          loadUsuarios();
          break;
        case 'backup':
          updateBackupStats();
          updateStats();
          break;
        case 'relatorios':
          loadRelatorios();
          break;
      }
    }

    // ===== DASHBOARD =====
    function updateDashboard() {
      document.getElementById('totalLivros').textContent = database.livros.length;
      document.getElementById('totalEmprestimos').textContent = 
        database.emprestimos.filter(e => e.status === 'ativo').length;
      document.getElementById('totalUsuarios').textContent = 
        database.usuarios.filter(u => u.status === 'ativo').length;
      
      const hoje = new Date();
      const pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      ).length;
      document.getElementById('totalPendentes').textContent = pendentes;
      
      loadLivrosDestaque();
      
      if (currentUser?.tipo === 'aluno') {
        loadEmprestimosAluno();
      }
    }

    function loadLivrosDestaque() {
      const container = document.getElementById('livrosDestaque');
      
      if (database.livros.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500">Nenhum livro cadastrado ainda.</div>';
        return;
      }
      
      let livros = [...database.livros].slice(0, 5);
      
      container.innerHTML = livros.map(livro => `
        <div class="book-card rounded-lg p-4 text-center card-hover">
          <div class="w-16 h-20 mx-auto rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
            ${livro.foto ? 
              `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
              '<span class="text-2xl text-white">üìñ</span>'
            }
          </div>
          <div class="mt-2 font-semibold text-sm truncate" title="${livro.titulo}">${livro.titulo}</div>
          <div class="text-xs text-gray-600 truncate" title="${livro.autor}">${livro.autor}</div>
          <div class="mt-1 text-xs ${livro.disponivel > 0 ? 'text-green-600' : 'text-red-600'}">
            ${livro.disponivel > 0 ? `${livro.disponivel} dispon√≠vel` : 'Indispon√≠vel'}
          </div>
        </div>
      `).join('');
    }

    function loadEmprestimosAluno() {
      const container = document.getElementById('emprestimosAluno');
      const emprestimos = database.emprestimos.filter(e => e.alunoId === currentUser.id);
      
      if (!emprestimos.length) {
        container.innerHTML = '<div class="text-gray-500 text-center">Voc√™ n√£o possui livros emprestados.</div>';
        return;
      }
      
      container.innerHTML = emprestimos.map(emprestimo => {
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <div class="flex items-center justify-between p-3 border rounded-lg ${atrasado ? 'bg-red-50 border-red-200' : 'bg-white'}">
            <div>
              <div class="font-medium">${livro?.titulo || 'Livro'}</div>
              <div class="text-sm text-gray-600">${livro?.autor || ''}</div>
              <div class="text-xs ${atrasado ? 'text-red-600' : 'text-gray-500'}">
                Devolu√ß√£o: ${formatDate(emprestimo.dataDevolucao)} ${atrasado ? '(ATRASADO)' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== FUN√á√ïES DE ATUALIZA√á√ÉO =====
    function updateStats() {
      document.getElementById('statsLivros').textContent = database.livros.length;
      document.getElementById('statsUsuarios').textContent = database.usuarios.length;
      document.getElementById('statsEmprestimos').textContent = database.emprestimos.length;
      
      const originalSize = JSON.stringify(database).length;
      document.getElementById('statsTamanho').textContent = Math.round(originalSize / 1024);
    }

    function updateBackupStats() {
      document.getElementById('backupStatsLivros').textContent = database.livros.length;
      document.getElementById('backupStatsUsuarios').textContent = database.usuarios.length;
      document.getElementById('backupStatsEmprestimos').textContent = database.emprestimos.length;
      document.getElementById('backupStatsData').textContent = new Date().toLocaleDateString('pt-BR');
    }

    // ===== GERENCIAMENTO DE LIVROS =====
    function loadLivros() {
      const container = document.getElementById('livrosList');
      const search = document.getElementById('searchLivros').value.toLowerCase().trim();
      const categoria = document.getElementById('filterCategoria').value.trim();
      const autor = document.getElementById('filterAutor').value.trim();
      const disponibilidade = document.getElementById('filterDisponibilidade').value.trim();
      
      let livros = [...database.livros];
      
      if (search) {
        livros = livros.filter(livro =>
          (livro.titulo || '').toLowerCase().includes(search) ||
          (livro.autor || '').toLowerCase().includes(search) ||
          (livro.categoria || '').toLowerCase().includes(search) ||
          (livro.codigoBarra || '').toLowerCase().includes(search)
        );
      }
      
      if (categoria) {
        livros = livros.filter(livro => (livro.categoria || '').trim() === categoria);
      }
      
      if (autor) {
        livros = livros.filter(livro => (livro.autor || '').trim() === autor);
      }
      
      if (disponibilidade === 'disponivel') {
        livros = livros.filter(livro => livro.disponivel > 0);
      } else if (disponibilidade === 'indisponivel') {
        livros = livros.filter(livro => livro.disponivel === 0);
      }
      
      const canEdit = currentUser && ['admin', 'professor'].includes(currentUser.tipo);
      
      container.innerHTML = livros.map(livro => `
        <div class="book-card rounded-xl p-5 card-hover">
          <div class="flex gap-4">
            <div class="w-20 h-28 flex-shrink-0 rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
              ${livro.foto ? 
                `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                '<span class="text-3xl text-white">üìñ</span>'
              }
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-lg truncate" title="${livro.titulo}">${livro.titulo}</div>
              <div class="text-gray-600 truncate" title="${livro.autor}">${livro.autor}</div>
              <div class="text-sm text-gray-500 truncate" title="${livro.editora || 'Editora n√£o informada'}">${livro.editora || 'Editora n√£o informada'}</div>
              ${livro.categoria ? `<div class="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full inline-block mt-1">${livro.categoria}</div>` : ''}
              ${livro.codigoBarra ? `<div class="text-xs text-blue-600 font-mono mt-1">üìä ${livro.codigoBarra}</div>` : ''}
              <div class="mt-2 text-sm flex flex-wrap gap-3">
                <span class="flex items-center gap-1">üìö <strong>${livro.disponivel}/${livro.quantidade}</strong></span>
                ${livro.localizacao ? `<span class="flex items-center gap-1">üìç ${livro.localizacao}</span>` : ''}
              </div>
              ${livro.descricao ? `<div class="text-xs text-gray-500 mt-2 line-clamp-2" title="${livro.descricao}">${livro.descricao}</div>` : ''}
              <div class="mt-2">
                <span class="px-2 py-1 text-xs rounded-full ${livro.disponivel > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                  ${livro.disponivel > 0 ? '‚úÖ Dispon√≠vel' : '‚ùå Indispon√≠vel'}
                </span>
              </div>
              <div class="mt-3 flex gap-2 flex-wrap">
                ${canEdit ? `
                  <button onclick="editLivro(${livro.id})" class="px-3 py-1 bg-amber-700 hover:bg-amber-800 text-white rounded text-sm">‚úèÔ∏è Editar</button>
                  <button onclick="deleteLivro(${livro.id})" class="px-3 py-1 bg-red-700 hover:bg-red-800 text-white rounded text-sm">üóëÔ∏è Excluir</button>
                ` : ''}
                ${currentUser?.tipo === 'aluno' ? `
                  <button onclick="adicionarFeedback(${livro.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">üí¨ Avaliar</button>
                ` : ''}
                <button onclick="verFeedbacks(${livro.id})" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm">üëÅÔ∏è Ver Avalia√ß√µes</button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function loadFilterOptions() {
      const categorias = [...new Set(database.livros.map(l => l.categoria).filter(Boolean).map(c => c.trim()))].sort();
      const autores = [...new Set(database.livros.map(l => l.autor).filter(Boolean).map(a => a.trim()))].sort();
      
      const categoriaSelect = document.getElementById('filterCategoria');
      const autorSelect = document.getElementById('filterAutor');
      
      categoriaSelect.innerHTML = '<option value="">Todas as categorias</option>' + 
        categorias.map(c => `<option value="${c}">${c}</option>`).join('');
      
      autorSelect.innerHTML = '<option value="">Todos os autores</option>' + 
        autores.map(a => `<option value="${a}">${a}</option>`).join('');
    }

    function clearLivrosFilters() {
      document.getElementById('searchLivros').value = '';
      document.getElementById('filterCategoria').value = '';
      document.getElementById('filterAutor').value = '';
      document.getElementById('filterDisponibilidade').value = '';
      loadLivros();
    }

    // ===== FUN√á√ïES DE LIVROS =====
    function handleAddBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const fotoFile = document.getElementById('addBookFoto').files[0];
      
      const quantidade = parseInt(formData.get('quantidade'));
      const disponivel = parseInt(formData.get('disponivel'));
      
      // Verifica se a quantidade dispon√≠vel n√£o √© maior que a total
      if (disponivel > quantidade) {
        alert('‚ùå A quantidade dispon√≠vel n√£o pode ser maior que a quantidade total.');
        return;
      }
      
      const livro = {
        id: database.nextId.livros++,
        titulo: formData.get('titulo').trim(),
        autor: formData.get('autor').trim(),
        editora: formData.get('editora').trim(),
        categoria: formData.get('categoria').trim(),
        quantidade: quantidade,
        disponivel: disponivel,
        codigoBarra: formData.get('codigoBarra').trim(),
        localizacao: formData.get('localizacao').trim(),
        descricao: formData.get('descricao').trim(),
        foto: ''
      };
      
      if (fotoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          livro.foto = e.target.result;
          
          database.livros.push(livro);
          saveDatabase();
          
          closeModal('addBookModal');
          event.target.reset();
          document.getElementById('addBookPreview').classList.add('hidden');
          
          if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
            loadLivros();
            loadFilterOptions();
          }
          
          updateDashboard();
          alert('‚úÖ Livro adicionado com sucesso!');
        };
        reader.readAsDataURL(fotoFile);
      } else {
        database.livros.push(livro);
        saveDatabase();
        
        closeModal('addBookModal');
        event.target.reset();
        
        if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
          loadLivros();
          loadFilterOptions();
        }
        
        updateDashboard();
        alert('‚úÖ Livro adicionado com sucesso!');
      }
    }

    function editLivro(id) {
      const livro = database.livros.find(l => l.id === id);
      
      if (!livro) {
        alert('‚ùå Livro n√£o encontrado.');
        return;
      }
      
      // Preenche o formul√°rio de edi√ß√£o
      document.getElementById('editBookId').value = livro.id;
      document.getElementById('editBookTitulo').value = livro.titulo || '';
      document.getElementById('editBookAutor').value = livro.autor || '';
      document.getElementById('editBookEditora').value = livro.editora || '';
      document.getElementById('editBookCategoria').value = livro.categoria || '';
      document.getElementById('editBookQuantidade').value = livro.quantidade || 1;
      document.getElementById('editBookDisponivel').value = livro.disponivel || 0;
      document.getElementById('editBookCodigoBarra').value = livro.codigoBarra || '';
      document.getElementById('editBookLocalizacao').value = livro.localizacao || '';
      document.getElementById('editBookDescricao').value = livro.descricao || '';
      
      // Mostra foto atual se existir
      const previewDiv = document.getElementById('editBookPreview');
      const previewImg = document.getElementById('editBookPreviewImg');
      
      if (livro.foto) {
        previewImg.src = livro.foto;
        previewDiv.classList.remove('hidden');
      } else {
        previewDiv.classList.add('hidden');
      }
      
      showModal('editBookModal');
    }

    function handleEditBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const id = parseInt(formData.get('id'));
      const fotoFile = document.getElementById('editBookFoto').files[0];
      
      const livroIndex = database.livros.findIndex(l => l.id === id);
      
      if (livroIndex === -1) {
        alert('‚ùå Livro n√£o encontrado.');
        return;
      }
      
      const livro = database.livros[livroIndex];
      const novaQuantidade = parseInt(formData.get('quantidade'));
      const novoDisponivel = parseInt(formData.get('disponivel'));
      
      // Verifica se a quantidade dispon√≠vel n√£o √© maior que a total
      if (novoDisponivel > novaQuantidade) {
        alert('‚ùå A quantidade dispon√≠vel n√£o pode ser maior que a quantidade total.');
        return;
      }
      
      // Fun√ß√£o para salvar as altera√ß√µes
      const salvarAlteracoes = () => {
        livro.titulo = formData.get('titulo').trim();
        livro.autor = formData.get('autor').trim();
        livro.editora = formData.get('editora').trim();
        livro.categoria = formData.get('categoria').trim();
        livro.quantidade = novaQuantidade;
        livro.disponivel = novoDisponivel;
        livro.codigoBarra = formData.get('codigoBarra').trim();
        livro.localizacao = formData.get('localizacao').trim();
        livro.descricao = formData.get('descricao').trim();
        
        saveDatabase();
        
        closeModal('editBookModal');
        document.getElementById('editBookPreview').classList.add('hidden');
        
        if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
          loadLivros();
          loadFilterOptions();
        }
        
        updateDashboard();
        alert('‚úÖ Livro atualizado com sucesso!');
      };
      
      // Se h√° nova foto, processa ela
      if (fotoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          livro.foto = e.target.result;
          salvarAlteracoes();
        };
        reader.readAsDataURL(fotoFile);
      } else {
        // Mant√©m a foto atual
        salvarAlteracoes();
      }
    }

    function deleteLivro(id) {
      const livro = database.livros.find(l => l.id === id);
      
      if (!livro) {
        alert('‚ùå Livro n√£o encontrado.');
        return;
      }
      
      // Verifica se h√° empr√©stimos ativos
      const emprestimosAtivos = database.emprestimos.filter(e => 
        e.livroId === id && e.status === 'ativo'
      );
      
      if (emprestimosAtivos.length > 0) {
        alert(`‚ùå N√£o √© poss√≠vel excluir o livro "${livro.titulo}".\n\nExistem ${emprestimosAtivos.length} empr√©stimo(s) ativo(s) deste livro.\n\nFinalize os empr√©stimos antes de excluir.`);
        return;
      }
      
      if (!confirm(`‚ùå Excluir o livro "${livro.titulo}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
      }
      
      // Remove o livro
      database.livros = database.livros.filter(l => l.id !== id);
      
      // Remove empr√©stimos hist√≥ricos do livro
      database.emprestimos = database.emprestimos.filter(e => e.livroId !== id);
      
      saveDatabase();
      
      if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
        loadLivros();
        loadFilterOptions();
      }
      
      updateDashboard();
      alert('‚úÖ Livro exclu√≠do com sucesso!');
    }

    function importBooks() {
      const text = document.getElementById('importBooksText').value.trim();
      
      if (!text) {
        alert('‚ùå Digite os dados dos livros para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      
      lines.forEach(line => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length >= 2) {
          const livro = {
            id: database.nextId.livros++,
            titulo: parts[0],
            autor: parts[1],
            categoria: parts[2] || '',
            quantidade: parseInt(parts[3]) || 1,
            disponivel: parseInt(parts[3]) || 1,
            editora: '',
            descricao: '',
            foto: '',
            codigoBarra: '',
            localizacao: ''
          };
          
          database.livros.push(livro);
          imported++;
        }
      });
      
      if (imported > 0) {
        saveDatabase();
        closeModal('importBooksModal');
        document.getElementById('importBooksText').value = '';
        
        if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
          loadLivros();
          loadFilterOptions();
        }
        
        updateDashboard();
        alert(`‚úÖ ${imported} livro(s) importado(s) com sucesso!`);
      } else {
        alert('‚ùå Nenhum livro v√°lido encontrado para importar.');
      }
    }

    // ===== GERENCIAMENTO DE USU√ÅRIOS =====
    function loadUsuarios() {
      const container = document.getElementById('usuariosList');
      
      container.innerHTML = database.usuarios.map(usuario => `
        <tr>
          <td class="px-6 py-4">${usuario.nome}</td>
          <td class="px-6 py-4">${usuario.login}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs rounded-full ${
              usuario.tipo === 'admin' ? 'bg-red-100 text-red-800' :
              usuario.tipo === 'professor' ? 'bg-blue-100 text-blue-800' :
              'bg-green-100 text-green-800'
            }">
              ${usuario.tipo}
            </span>
          </td>
          <td class="px-6 py-4">${usuario.turma || '-'}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs rounded-full ${
              usuario.status === 'ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }">
              ${usuario.status}
            </span>
          </td>
          <td class="px-6 py-4">
            ${currentUser.tipo === 'admin' && usuario.login !== 'ADMIN' ? `
              <button onclick="deleteUsuario(${usuario.id})" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è Excluir</button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
    }

    function handleAddUser(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const login = formData.get('login').trim();
      
      // Verifica se login j√° existe
      if (database.usuarios.some(u => u.login.toLowerCase() === login.toLowerCase())) {
        alert('‚ùå Este login j√° est√° em uso.');
        return;
      }
      
      const usuario = {
        id: database.nextId.usuarios++,
        nome: formData.get('nome').trim(),
        login: login,
        senha: formData.get('senha'),
        tipo: formData.get('tipo'),
        turma: formData.get('turma')?.trim() || '',
        status: 'ativo',
        livrosLidos: 0
      };
      
      database.usuarios.push(usuario);
      saveDatabase();
      
      closeModal('addUserModal');
      event.target.reset();
      
      if (document.getElementById('usuariosTab').classList.contains('hidden') === false) {
        loadUsuarios();
      }
      
      updateDashboard();
      alert('‚úÖ Usu√°rio adicionado com sucesso!');
    }

    function importUsers() {
      const text = document.getElementById('importUsersText').value.trim();
      
      if (!text) {
        alert('‚ùå Digite os dados dos usu√°rios para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      
      lines.forEach(line => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length >= 4) {
          const login = parts[1];
          
          // Verifica se login j√° existe
          if (!database.usuarios.some(u => u.login.toLowerCase() === login.toLowerCase())) {
            const usuario = {
              id: database.nextId.usuarios++,
              nome: parts[0],
              login: login,
              senha: parts[2],
              tipo: parts[3],
              turma: parts[4]?.trim() || '',
              status: 'ativo',
              livrosLidos: 0
            };
            
            database.usuarios.push(usuario);
            imported++;
          }
        }
      });
      
      if (imported > 0) {
        saveDatabase();
        closeModal('importUsersModal');
        document.getElementById('importUsersText').value = '';
        
        if (document.getElementById('usuariosTab').classList.contains('hidden') === false) {
          loadUsuarios();
        }
        
        updateDashboard();
        alert(`‚úÖ ${imported} usu√°rio(s) importado(s) com sucesso!`);
      } else {
        alert('‚ùå Nenhum usu√°rio v√°lido encontrado para importar.');
      }
    }

    function deleteUsuario(id) {
      const usuario = database.usuarios.find(u => u.id === id);
      
      if (!usuario) return;
      
      if (!confirm(`‚ùå Excluir usu√°rio "${usuario.nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
      }
      
      // Remove usu√°rio
      database.usuarios = database.usuarios.filter(u => u.id !== id);
      
      // Remove empr√©stimos do usu√°rio
      database.emprestimos = database.emprestimos.filter(e => e.alunoId !== id);
      
      saveDatabase();
      loadUsuarios();
      updateDashboard();
      
      alert('‚úÖ Usu√°rio exclu√≠do com sucesso!');
    }

    // ===== GERENCIAMENTO DE EMPR√âSTIMOS =====
    function loadEmprestimoModalData() {
      // Carrega alunos
      const alunoSelect = document.getElementById('emprestimoAluno');
      const alunos = database.usuarios.filter(u => u.tipo === 'aluno' && u.status === 'ativo');
      
      alunoSelect.innerHTML = '<option value="">Selecione o aluno...</option>' +
        alunos.map(aluno => `<option value="${aluno.id}">${aluno.nome}</option>`).join('');
      
      // Carrega livros dispon√≠veis
      const livroSelect = document.getElementById('emprestimoLivro');
      const livrosDisponiveis = database.livros.filter(l => l.disponivel > 0);
      
      livroSelect.innerHTML = '<option value="">Selecione o livro...</option>' +
        livrosDisponiveis.map(livro => `<option value="${livro.id}">${livro.titulo} - ${livro.autor} (${livro.disponivel} dispon√≠vel)</option>`).join('');
      
      // Define data padr√£o (7 dias)
      const dataDefault = new Date();
      dataDefault.setDate(dataDefault.getDate() + 7);
      document.getElementById('emprestimoDataDevolucao').value = dataDefault.toISOString().split('T')[0];
    }

    function handleAddEmprestimo(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const alunoId = parseInt(formData.get('alunoId'));
      const livroId = parseInt(formData.get('livroId'));
      const dataDevolucao = formData.get('dataDevolucao');
      
      // Verifica se o livro est√° dispon√≠vel
      const livro = database.livros.find(l => l.id === livroId);
      if (!livro || livro.disponivel <= 0) {
        alert('‚ùå Livro n√£o dispon√≠vel para empr√©stimo.');
        return;
      }
      
      // Cria empr√©stimo
      const emprestimo = {
        id: database.nextId.emprestimos++,
        alunoId: alunoId,
        livroId: livroId,
        dataEmprestimo: new Date().toISOString().split('T')[0],
        dataDevolucao: dataDevolucao,
        status: 'ativo'
      };
      
      database.emprestimos.push(emprestimo);
      
      // Atualiza disponibilidade do livro
      livro.disponivel--;
      
      saveDatabase();
      
      closeModal('addEmprestimoModal');
      event.target.reset();
      
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      
      updateDashboard();
      alert('‚úÖ Empr√©stimo realizado com sucesso!');
    }

    function loadEmprestimos() {
      const container = document.getElementById('emprestimosList');
      
      container.innerHTML = database.emprestimos.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <tr class="${atrasado ? 'bg-red-50' : ''}">
            <td class="px-6 py-4">${aluno?.nome || 'Usu√°rio n√£o encontrado'}</td>
            <td class="px-6 py-4">${livro?.titulo || 'Livro n√£o encontrado'}</td>
            <td class="px-6 py-4">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-4 ${atrasado ? 'text-red-600 font-semibold' : ''}">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-4">
              <span class="px-2 py-1 text-xs rounded-full ${
                emprestimo.status === 'ativo' ? (atrasado ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800') : 'bg-green-100 text-green-800'
              }">
                ${emprestimo.status === 'ativo' ? (atrasado ? 'ATRASADO' : 'Ativo') : 'Devolvido'}
              </span>
            </td>
            <td class="px-6 py-4">
              <div class="flex gap-2">
                ${emprestimo.status === 'ativo' ? `
                  <button onclick="devolverLivro(${emprestimo.id})" class="text-green-600 hover:text-green-800 text-sm">‚úÖ Devolver</button>
                ` : ''}
                ${currentUser && currentUser.tipo === 'admin' ? `
                  <button onclick="editEmprestimo(${emprestimo.id})" class="text-blue-600 hover:text-blue-800 text-sm">‚úèÔ∏è Editar</button>
                  <button onclick="deleteEmprestimo(${emprestimo.id})" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è Excluir</button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function loadDevolucoesPendentes() {
      const container = document.getElementById('devolucoesList');
      const hoje = new Date();
      
      const pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      );
      
      container.innerHTML = pendentes.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const diasAtraso = Math.floor((hoje - new Date(emprestimo.dataDevolucao)) / (1000 * 60 * 60 * 24));
        
        return `
          <tr class="bg-red-50">
            <td class="px-6 py-4">${aluno?.nome || 'Usu√°rio n√£o encontrado'}</td>
            <td class="px-6 py-4">${livro?.titulo || 'Livro n√£o encontrado'}</td>
            <td class="px-6 py-4">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-4 text-red-600 font-semibold">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-4 text-red-600 font-semibold">${diasAtraso} dia(s)</td>
            <td class="px-6 py-4">
              <button onclick="devolverLivro(${emprestimo.id})" class="text-green-600 hover:text-green-800 text-sm">‚úÖ Devolver</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function devolverLivro(emprestimoId) {
      const emprestimo = database.emprestimos.find(e => e.id === emprestimoId);
      
      if (!emprestimo || emprestimo.status !== 'ativo') return;
      
      const livro = database.livros.find(l => l.id === emprestimo.livroId);
      
      if (!confirm(`üìö Confirmar devolu√ß√£o do livro "${livro?.titulo}"?`)) {
        return;
      }
      
      // Atualiza empr√©stimo
      emprestimo.status = 'devolvido';
      emprestimo.dataRealDevolucao = new Date().toISOString().split('T')[0];
      
      // Atualiza disponibilidade do livro
      if (livro) {
        livro.disponivel++;
      }
      
      saveDatabase();
      
      // Atualiza as telas
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      if (document.getElementById('devolucoesTab').classList.contains('hidden') === false) {
        loadDevolucoesPendentes();
      }
      
      updateDashboard();
      alert('‚úÖ Livro devolvido com sucesso!');
    }

    function editEmprestimo(id) {
      const emprestimo = database.emprestimos.find(e => e.id === id);
      
      if (!emprestimo) {
        alert('‚ùå Empr√©stimo n√£o encontrado.');
        return;
      }
      
      // Carrega dados para os selects
      const alunoSelect = document.getElementById('editEmprestimoAluno');
      const livroSelect = document.getElementById('editEmprestimoLivro');
      
      // Carrega todos os alunos
      const alunos = database.usuarios.filter(u => u.tipo === 'aluno' && u.status === 'ativo');
      alunoSelect.innerHTML = '<option value="">Selecione o aluno...</option>' +
        alunos.map(aluno => `<option value="${aluno.id}">${aluno.nome}</option>`).join('');
      
      // Carrega todos os livros (incluindo o atual do empr√©stimo)
      livroSelect.innerHTML = '<option value="">Selecione o livro...</option>' +
        database.livros.map(livro => `<option value="${livro.id}">${livro.titulo} - ${livro.autor}</option>`).join('');
      
      // Preenche o formul√°rio
      document.getElementById('editEmprestimoId').value = emprestimo.id;
      document.getElementById('editEmprestimoAluno').value = emprestimo.alunoId;
      document.getElementById('editEmprestimoLivro').value = emprestimo.livroId;
      document.getElementById('editEmprestimoDataEmprestimo').value = emprestimo.dataEmprestimo;
      document.getElementById('editEmprestimoDataDevolucao').value = emprestimo.dataDevolucao;
      document.getElementById('editEmprestimoStatus').value = emprestimo.status;
      
      showModal('editEmprestimoModal');
    }

    function handleEditEmprestimo(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const id = parseInt(formData.get('id'));
      
      const emprestimoIndex = database.emprestimos.findIndex(e => e.id === id);
      
      if (emprestimoIndex === -1) {
        alert('‚ùå Empr√©stimo n√£o encontrado.');
        return;
      }
      
      const emprestimo = database.emprestimos[emprestimoIndex];
      const livroAnterior = database.livros.find(l => l.id === emprestimo.livroId);
      const novoLivroId = parseInt(formData.get('livroId'));
      const novoLivro = database.livros.find(l => l.id === novoLivroId);
      const statusAnterior = emprestimo.status;
      const novoStatus = formData.get('status');
      
      // Se mudou o livro, ajusta disponibilidade
      if (emprestimo.livroId !== novoLivroId) {
        // Devolve o livro anterior (se estava ativo)
        if (statusAnterior === 'ativo' && livroAnterior) {
          livroAnterior.disponivel++;
        }
        
        // Empresta o novo livro (se ficar√° ativo)
        if (novoStatus === 'ativo' && novoLivro) {
          if (novoLivro.disponivel <= 0) {
            alert('‚ùå O livro selecionado n√£o est√° dispon√≠vel.');
            return;
          }
          novoLivro.disponivel--;
        }
      } else {
        // Mesmo livro, mas mudou status
        if (statusAnterior === 'ativo' && novoStatus === 'devolvido' && livroAnterior) {
          livroAnterior.disponivel++;
        } else if (statusAnterior === 'devolvido' && novoStatus === 'ativo' && novoLivro) {
          if (novoLivro.disponivel <= 0) {
            alert('‚ùå O livro n√£o est√° dispon√≠vel para reativar o empr√©stimo.');
            return;
          }
          novoLivro.disponivel--;
        }
      }
      
      // Atualiza o empr√©stimo
      emprestimo.alunoId = parseInt(formData.get('alunoId'));
      emprestimo.livroId = novoLivroId;
      emprestimo.dataEmprestimo = formData.get('dataEmprestimo');
      emprestimo.dataDevolucao = formData.get('dataDevolucao');
      emprestimo.status = novoStatus;
      
      // Se foi marcado como devolvido, adiciona data real de devolu√ß√£o
      if (novoStatus === 'devolvido' && statusAnterior === 'ativo') {
        emprestimo.dataRealDevolucao = new Date().toISOString().split('T')[0];
      } else if (novoStatus === 'ativo') {
        delete emprestimo.dataRealDevolucao;
      }
      
      saveDatabase();
      
      closeModal('editEmprestimoModal');
      
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      if (document.getElementById('devolucoesTab').classList.contains('hidden') === false) {
        loadDevolucoesPendentes();
      }
      
      updateDashboard();
      alert('‚úÖ Empr√©stimo atualizado com sucesso!');
    }

    function deleteEmprestimo(id) {
      const emprestimo = database.emprestimos.find(e => e.id === id);
      
      if (!emprestimo) {
        alert('‚ùå Empr√©stimo n√£o encontrado.');
        return;
      }
      
      const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
      const livro = database.livros.find(l => l.id === emprestimo.livroId);
      
      if (!confirm(`‚ùå Excluir empr√©stimo?\n\nAluno: ${aluno?.nome || 'N√£o encontrado'}\nLivro: ${livro?.titulo || 'N√£o encontrado'}\nData: ${formatDate(emprestimo.dataEmprestimo)}\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
      }
      
      // Se o empr√©stimo estava ativo, devolve o livro
      if (emprestimo.status === 'ativo' && livro) {
        livro.disponivel++;
      }
      
      // Remove o empr√©stimo
      database.emprestimos = database.emprestimos.filter(e => e.id !== id);
      
      saveDatabase();
      
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      if (document.getElementById('devolucoesTab').classList.contains('hidden') === false) {
        loadDevolucoesPendentes();
      }
      
      updateDashboard();
      alert('‚úÖ Empr√©stimo exclu√≠do com sucesso!');
    }

    // ===== FUN√á√ïES DE BACKUP =====
    let loadedBackups = [];
    let mergedBackupData = null;
    let mergeLog = [];

    function exportarBackup() {
      const data = JSON.stringify(database, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblion-mega-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      alert('üíæ Backup tradicional baixado com sucesso!');
    }

    function copiarBackup() {
      const data = JSON.stringify(database, null, 2);
      
      navigator.clipboard.writeText(data).then(() => {
        alert('üìã Dados copiados para a √°rea de transfer√™ncia!');
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = data;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('üìã Dados copiados!');
      });
    }

    function restaurarBackup() {
      const file = document.getElementById('backupFile').files[0];
      const text = document.getElementById('backupText').value.trim();
      
      if (!file && !text) {
        alert('‚ùå Selecione um arquivo ou cole os dados do backup.');
        return;
      }
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          processBackupData(e.target.result);
        };
        reader.readAsText(file);
      } else {
        processBackupData(text);
      }
    }

    function processBackupData(data) {
      try {
        const backupData = JSON.parse(data);
        
        if (!backupData.usuarios || !backupData.livros || !backupData.emprestimos) {
          throw new Error('Formato de backup inv√°lido');
        }
        
        if (!confirm(`üì• Confirmar restaura√ß√£o?\n\nüìä Dados a importar:\n‚Ä¢ ${backupData.livros.length} livros\n‚Ä¢ ${backupData.usuarios.length} usu√°rios\n‚Ä¢ ${backupData.emprestimos.length} empr√©stimos\n\n‚ö†Ô∏è Os dados atuais ser√£o substitu√≠dos!`)) {
          return;
        }
        
        database = backupData;
        
        if (!database.nextId) {
          database.nextId = {
            usuarios: Math.max(...database.usuarios.map(u => u.id), 0) + 1,
            livros: Math.max(...database.livros.map(l => l.id), 0) + 1,
            emprestimos: Math.max(...database.emprestimos.map(e => e.id), 0) + 1
          };
        }
        
        saveDatabase();
        
        document.getElementById('backupFile').value = '';
        document.getElementById('backupText').value = '';
        
        alert('‚úÖ Backup restaurado com sucesso!\n\nA p√°gina ser√° recarregada.');
        location.reload();
        
      } catch (error) {
        alert('‚ùå Erro ao restaurar backup: ' + error.message);
      }
    }

    // ===== FUN√á√ïES DE JUN√á√ÉO DE BACKUPS =====
    function loadBackupsForMerge() {
      const files = document.getElementById('mergeBackupFiles').files;
      
      if (files.length < 2) {
        alert('‚ùå Selecione pelo menos 2 arquivos de backup para juntar.');
        return;
      }
      
      loadedBackups = [];
      let filesProcessed = 0;
      
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backupData = JSON.parse(e.target.result);
            
            if (!backupData.usuarios || !backupData.livros || !backupData.emprestimos) {
              throw new Error(`Arquivo ${file.name}: Formato de backup inv√°lido`);
            }
            
            loadedBackups.push({
              fileName: file.name,
              data: backupData,
              stats: {
                usuarios: backupData.usuarios.length,
                livros: backupData.livros.length,
                emprestimos: backupData.emprestimos.length
              }
            });
            
            filesProcessed++;
            
            if (filesProcessed === files.length) {
              displayBackupsPreview();
            }
            
          } catch (error) {
            alert(`‚ùå Erro ao carregar ${file.name}: ${error.message}`);
          }
        };
        reader.readAsText(file);
      });
    }

    function displayBackupsPreview() {
      const container = document.getElementById('backupsPreviewContent');
      
      container.innerHTML = loadedBackups.map((backup, index) => `
        <div class="border rounded-lg p-4 ${index === 0 ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'}">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">${backup.fileName}</div>
            <div class="text-xs px-2 py-1 rounded ${index === 0 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'}">
              ${index === 0 ? 'Base' : `Backup ${index + 1}`}
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 text-sm">
            <div class="text-center">
              <div class="text-2xl text-blue-600">üë•</div>
              <div class="font-bold">${backup.stats.usuarios}</div>
              <div class="text-xs text-gray-600">Usu√°rios</div>
            </div>
            <div class="text-center">
              <div class="text-2xl text-green-600">üìö</div>
              <div class="font-bold">${backup.stats.livros}</div>
              <div class="text-xs text-gray-600">Livros</div>
            </div>
            <div class="text-center">
              <div class="text-2xl text-orange-600">üìã</div>
              <div class="font-bold">${backup.stats.emprestimos}</div>
              <div class="text-xs text-gray-600">Empr√©stimos</div>
            </div>
          </div>
          
          ${backup.data.metadata ? `
            <div class="mt-2 text-xs text-gray-500">
              üìÖ ${backup.data.metadata.lastUpdate ? new Date(backup.data.metadata.lastUpdate).toLocaleDateString('pt-BR') : 'Data n√£o informada'}
            </div>
          ` : ''}
        </div>
      `).join('');
      
      document.getElementById('backupsPreview').classList.remove('hidden');
      document.getElementById('mergeSettings').classList.remove('hidden');
      document.getElementById('executeMergeBtn').classList.remove('hidden');
    }

    function executeMergeBackups() {
      if (loadedBackups.length < 2) {
        alert('‚ùå Carregue pelo menos 2 backups primeiro.');
        return;
      }
      
      const userConflictMode = document.getElementById('userConflictMode').value;
      const bookConflictMode = document.getElementById('bookConflictMode').value;
      const loanConflictMode = document.getElementById('loanConflictMode').value;
      const preserveIds = document.getElementById('preserveIds').checked;
      const createLog = document.getElementById('createMergeLog').checked;
      
      mergeLog = [];
      
      try {
        // Inicia com o primeiro backup como base
        const baseBackup = loadedBackups[0];
        mergedBackupData = {
          usuarios: [...baseBackup.data.usuarios],
          livros: [...baseBackup.data.livros],
          emprestimos: [...baseBackup.data.emprestimos],
          nextId: { ...baseBackup.data.nextId },
          metadata: {
            version: '6.0',
            lastUpdate: new Date().toISOString(),
            systemName: 'BibliOn Supremo - Sistema QR Code MEGA V6.0',
            mergedFrom: loadedBackups.map(b => b.fileName),
            mergeDate: new Date().toISOString(),
            mergeSettings: {
              userConflictMode,
              bookConflictMode,
              loanConflictMode,
              preserveIds
            }
          }
        };
        
        if (createLog) {
          mergeLog.push(`üîó Iniciando jun√ß√£o de ${loadedBackups.length} backups`);
          mergeLog.push(`üìÅ Base: ${baseBackup.fileName} (${baseBackup.stats.usuarios} usu√°rios, ${baseBackup.stats.livros} livros, ${baseBackup.stats.emprestimos} empr√©stimos)`);
        }
        
        // Processa os demais backups
        for (let i = 1; i < loadedBackups.length; i++) {
          const currentBackup = loadedBackups[i];
          
          if (createLog) {
            mergeLog.push(`üìÅ Processando: ${currentBackup.fileName}`);
          }
          
          // Mescla usu√°rios
          mergeUsers(currentBackup.data.usuarios, userConflictMode, createLog);
          
          // Mescla livros
          mergeBooks(currentBackup.data.livros, bookConflictMode, createLog);
          
          // Mescla empr√©stimos
          mergeLoans(currentBackup.data.emprestimos, loanConflictMode, createLog);
        }
        
        // Atualiza nextId
        updateNextIds();
        
        if (createLog) {
          mergeLog.push(`‚úÖ Jun√ß√£o conclu√≠da com sucesso!`);
          mergeLog.push(`üìä Resultado final: ${mergedBackupData.usuarios.length} usu√°rios, ${mergedBackupData.livros.length} livros, ${mergedBackupData.emprestimos.length} empr√©stimos`);
        }
        
        displayMergeResult();
        
      } catch (error) {
        alert(`‚ùå Erro durante a jun√ß√£o: ${error.message}`);
        console.error('Erro na jun√ß√£o:', error);
      }
    }

    function mergeUsers(newUsers, conflictMode, createLog) {
      let added = 0, skipped = 0, merged = 0, replaced = 0;
      
      newUsers.forEach(newUser => {
        // Verifica se usu√°rio j√° existe (por login OU por ID)
        const existingByLogin = mergedBackupData.usuarios.find(u => 
          u.login.toLowerCase() === newUser.login.toLowerCase()
        );
        const existingById = mergedBackupData.usuarios.find(u => u.id === newUser.id);
        
        // Se n√£o existe nem por login nem por ID, adiciona
        if (!existingByLogin && !existingById) {
          mergedBackupData.usuarios.push({ ...newUser });
          added++;
          return;
        }
        
        // Se existe, verifica se s√£o exatamente iguais
        const existing = existingByLogin || existingById;
        const areIdentical = (
          existing.nome === newUser.nome &&
          existing.login === newUser.login &&
          existing.senha === newUser.senha &&
          existing.tipo === newUser.tipo &&
          existing.turma === newUser.turma &&
          existing.status === newUser.status
        );
        
        if (areIdentical) {
          skipped++; // Dados id√™nticos, pula
          return;
        }
        
        // Dados diferentes, aplica estrat√©gia de conflito
        switch (conflictMode) {
          case 'skip':
            skipped++;
            break;
            
          case 'rename':
            const renamedUser = { 
              ...newUser, 
              id: mergedBackupData.nextId.usuarios++,
              login: `${newUser.login}_${Date.now()}`,
              nome: `${newUser.nome} (Backup)`
            };
            mergedBackupData.usuarios.push(renamedUser);
            added++;
            break;
            
          case 'merge':
            // Mescla apenas campos vazios ou melhores
            if (newUser.turma && !existing.turma) existing.turma = newUser.turma;
            if ((newUser.livrosLidos || 0) > (existing.livrosLidos || 0)) {
              existing.livrosLidos = newUser.livrosLidos;
            }
            merged++;
            break;
            
          case 'replace':
            const existingIndex = mergedBackupData.usuarios.findIndex(u => u.id === existing.id);
            mergedBackupData.usuarios[existingIndex] = { ...newUser };
            replaced++;
            break;
        }
      });
      
      if (createLog) {
        mergeLog.push(`üë• Usu√°rios: +${added} novos, ${skipped} id√™nticos, ${merged} mesclados, ${replaced} substitu√≠dos`);
      }
    }

    function mergeBooks(newBooks, conflictMode, createLog) {
      let added = 0, skipped = 0, merged = 0, replaced = 0;
      
      newBooks.forEach(newBook => {
        // Verifica se livro j√° existe (por t√≠tulo+autor OU por ID)
        const existingByContent = mergedBackupData.livros.find(l => 
          l.titulo.toLowerCase().trim() === newBook.titulo.toLowerCase().trim() && 
          l.autor.toLowerCase().trim() === newBook.autor.toLowerCase().trim()
        );
        const existingById = mergedBackupData.livros.find(l => l.id === newBook.id);
        
        // Se n√£o existe nem por conte√∫do nem por ID, adiciona
        if (!existingByContent && !existingById) {
          mergedBackupData.livros.push({ ...newBook });
          added++;
          return;
        }
        
        // Se existe, verifica se s√£o exatamente iguais
        const existing = existingByContent || existingById;
        const areIdentical = (
          existing.titulo === newBook.titulo &&
          existing.autor === newBook.autor &&
          existing.editora === newBook.editora &&
          existing.categoria === newBook.categoria &&
          existing.quantidade === newBook.quantidade &&
          existing.codigoBarra === newBook.codigoBarra &&
          existing.localizacao === newBook.localizacao &&
          existing.descricao === newBook.descricao
        );
        
        if (areIdentical) {
          skipped++; // Dados id√™nticos, pula
          return;
        }
        
        // Dados diferentes, aplica estrat√©gia de conflito
        switch (conflictMode) {
          case 'skip':
            skipped++;
            break;
            
          case 'merge':
            // Soma quantidades e melhora informa√ß√µes
            existing.quantidade += newBook.quantidade;
            existing.disponivel += newBook.disponivel;
            if (newBook.editora && !existing.editora) existing.editora = newBook.editora;
            if (newBook.categoria && !existing.categoria) existing.categoria = newBook.categoria;
            if (newBook.codigoBarra && !existing.codigoBarra) existing.codigoBarra = newBook.codigoBarra;
            if (newBook.localizacao && !existing.localizacao) existing.localizacao = newBook.localizacao;
            if (newBook.descricao && !existing.descricao) existing.descricao = newBook.descricao;
            if (newBook.foto && !existing.foto) existing.foto = newBook.foto;
            merged++;
            break;
            
          case 'replace':
            const existingIndex = mergedBackupData.livros.findIndex(l => l.id === existing.id);
            mergedBackupData.livros[existingIndex] = { ...newBook };
            replaced++;
            break;
            
          case 'keep_both':
            const duplicatedBook = { 
              ...newBook, 
              id: mergedBackupData.nextId.livros++,
              titulo: `${newBook.titulo} (Backup ${Date.now()})`
            };
            mergedBackupData.livros.push(duplicatedBook);
            added++;
            break;
        }
      });
      
      if (createLog) {
        mergeLog.push(`üìö Livros: +${added} novos, ${skipped} id√™nticos, ${merged} mesclados, ${replaced} substitu√≠dos`);
      }
    }

    function mergeLoans(newLoans, conflictMode, createLog) {
      let added = 0, skipped = 0;
      
      newLoans.forEach(newLoan => {
        // Verifica se empr√©stimo j√° existe (por ID ou por combina√ß√£o √∫nica)
        const existingById = mergedBackupData.emprestimos.find(e => e.id === newLoan.id);
        const existingByData = mergedBackupData.emprestimos.find(e => 
          e.alunoId === newLoan.alunoId && 
          e.livroId === newLoan.livroId && 
          e.dataEmprestimo === newLoan.dataEmprestimo
        );
        
        const existing = existingById || existingByData;
        
        // Se n√£o existe, verifica se deve adicionar baseado na estrat√©gia
        if (!existing) {
          const shouldAdd = (() => {
            switch (conflictMode) {
              case 'merge_all':
                return true;
                
              case 'skip_duplicates':
                // Verifica se j√° existe empr√©stimo similar (mesmo aluno + livro + data pr√≥xima)
                const similarLoan = mergedBackupData.emprestimos.find(e => 
                  e.alunoId === newLoan.alunoId && 
                  e.livroId === newLoan.livroId &&
                  Math.abs(new Date(e.dataEmprestimo) - new Date(newLoan.dataEmprestimo)) <= 86400000 // 1 dia em ms
                );
                return !similarLoan;
                
              case 'active_only':
                return newLoan.status === 'ativo';
                
              case 'recent_only':
                // S√≥ adiciona se for mais recente que outros do mesmo aluno+livro
                const olderLoan = mergedBackupData.emprestimos.find(e => 
                  e.alunoId === newLoan.alunoId && 
                  e.livroId === newLoan.livroId &&
                  new Date(e.dataEmprestimo) < new Date(newLoan.dataEmprestimo)
                );
                return !olderLoan;
                
              default:
                return true;
            }
          })();
          
          if (shouldAdd) {
            mergedBackupData.emprestimos.push({ ...newLoan });
            added++;
          } else {
            skipped++;
          }
        } else {
          // Empr√©stimo j√° existe, verifica se s√£o id√™nticos
          const areIdentical = (
            existing.alunoId === newLoan.alunoId &&
            existing.livroId === newLoan.livroId &&
            existing.dataEmprestimo === newLoan.dataEmprestimo &&
            existing.dataDevolucao === newLoan.dataDevolucao &&
            existing.status === newLoan.status
          );
          
          if (areIdentical) {
            skipped++; // Dados id√™nticos, pula
          } else {
            // Se for mais recente ou modo espec√≠fico, atualiza
            if ((conflictMode === 'recent_only' && 
                new Date(newLoan.dataEmprestimo) > new Date(existing.dataEmprestimo)) ||
                (conflictMode === 'skip_duplicates' && !areIdentical)) {
              const existingIndex = mergedBackupData.emprestimos.findIndex(e => e.id === existing.id);
              mergedBackupData.emprestimos[existingIndex] = { ...newLoan };
              added++;
            } else {
              skipped++;
            }
          }
        }
      });
      
      if (createLog) {
        mergeLog.push(`üìã Empr√©stimos: +${added} novos/atualizados, ${skipped} id√™nticos/ignorados`);
      }
    }

    function updateNextIds() {
      mergedBackupData.nextId = {
        usuarios: Math.max(...mergedBackupData.usuarios.map(u => u.id), 0) + 1,
        livros: Math.max(...mergedBackupData.livros.map(l => l.id), 0) + 1,
        emprestimos: Math.max(...mergedBackupData.emprestimos.map(e => e.id), 0) + 1
      };
    }

    function displayMergeResult() {
      const container = document.getElementById('mergeResultContent');
      
      const totalStats = {
        usuarios: mergedBackupData.usuarios.length,
        livros: mergedBackupData.livros.length,
        emprestimos: mergedBackupData.emprestimos.length
      };
      
      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-blue-600 mb-2">üë•</div>
            <div class="text-2xl font-bold">${totalStats.usuarios}</div>
            <div class="text-sm text-gray-600">Usu√°rios Total</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-green-600 mb-2">üìö</div>
            <div class="text-2xl font-bold">${totalStats.livros}</div>
            <div class="text-sm text-gray-600">Livros Total</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-orange-600 mb-2">üìã</div>
            <div class="text-2xl font-bold">${totalStats.emprestimos}</div>
            <div class="text-sm text-gray-600">Empr√©stimos Total</div>
          </div>
        </div>
        
        ${mergeLog.length > 0 ? `
          <div class="bg-white rounded-lg border p-4">
            <h5 class="font-semibold mb-2">üìù Log da Jun√ß√£o:</h5>
            <div class="text-xs space-y-1 max-h-40 overflow-y-auto">
              ${mergeLog.map(log => `<div>${log}</div>`).join('')}
            </div>
          </div>
        ` : ''}
        
        <div class="mt-4 flex gap-2">
          <button onclick="downloadMergedBackup()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
            üíæ Baixar Backup Unificado
          </button>
          <button onclick="copyMergedBackup()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm">
            üìã Copiar Dados
          </button>
        </div>
      `;
      
      document.getElementById('mergeResult').classList.remove('hidden');
      document.getElementById('applyMergeBtn').classList.remove('hidden');
    }

    function downloadMergedBackup() {
      if (!mergedBackupData) {
        alert('‚ùå Nenhum backup unificado dispon√≠vel.');
        return;
      }
      
      const data = JSON.stringify(mergedBackupData, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblion-backup-unificado-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      alert('üíæ Backup unificado baixado com sucesso!');
    }

    function copyMergedBackup() {
      if (!mergedBackupData) {
        alert('‚ùå Nenhum backup unificado dispon√≠vel.');
        return;
      }
      
      const data = JSON.stringify(mergedBackupData, null, 2);
      
      navigator.clipboard.writeText(data).then(() => {
        alert('üìã Backup unificado copiado para a √°rea de transfer√™ncia!');
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = data;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('üìã Backup unificado copiado!');
      });
    }

    function applyMergedBackup() {
      if (!mergedBackupData) {
        alert('‚ùå Nenhum backup unificado dispon√≠vel.');
        return;
      }
      
      const totalStats = {
        usuarios: mergedBackupData.usuarios.length,
        livros: mergedBackupData.livros.length,
        emprestimos: mergedBackupData.emprestimos.length
      };
      
      if (!confirm(`üîó Aplicar backup unificado?\n\nüìä Dados a aplicar:\n‚Ä¢ ${totalStats.usuarios} usu√°rios\n‚Ä¢ ${totalStats.livros} livros\n‚Ä¢ ${totalStats.emprestimos} empr√©stimos\n\n‚ö†Ô∏è Os dados atuais ser√£o substitu√≠dos pelo backup unificado!`)) {
        return;
      }
      
      database = { ...mergedBackupData };
      saveDatabase();
      
      closeModal('mergeBackupsModal');
      
      alert('‚úÖ Backup unificado aplicado com sucesso!\n\nA p√°gina ser√° recarregada para atualizar a interface.');
      location.reload();
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
      initializeDatabase();
      
      // Login
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      
      // Toggle password
      document.getElementById('togglePwd').addEventListener('click', function() {
        const pwd = document.getElementById('loginPassword');
        const btn = this;
        
        if (pwd.type === 'password') {
          pwd.type = 'text';
          btn.textContent = 'Ocultar';
        } else {
          pwd.type = 'password';
          btn.textContent = 'Mostrar';
        }
      });
      
      // Forms
      document.getElementById('addBookForm').addEventListener('submit', handleAddBook);
      document.getElementById('editBookForm').addEventListener('submit', handleEditBook);
      document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
      document.getElementById('addEmprestimoForm').addEventListener('submit', handleAddEmprestimo);
      document.getElementById('editEmprestimoForm').addEventListener('submit', handleEditEmprestimo);
      document.getElementById('addFeedbackForm').addEventListener('submit', handleAddFeedback);
      
      // Filtro de relat√≥rios
      document.getElementById('filtroTipoUsuario').addEventListener('change', loadRelatorioLeitura);
      
      // Preview de imagens
      document.getElementById('addBookFoto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('addBookPreview');
        const img = document.getElementById('addBookPreviewImg');
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            img.src = e.target.result;
            preview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        } else {
          preview.classList.add('hidden');
        }
      });
      
      document.getElementById('editBookFoto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('editBookPreview');
        const img = document.getElementById('editBookPreviewImg');
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            img.src = e.target.result;
            preview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Filtros
      document.getElementById('searchLivros').addEventListener('input', loadLivros);
      document.getElementById('filterCategoria').addEventListener('change', loadLivros);
      document.getElementById('filterAutor').addEventListener('change', loadLivros);
      document.getElementById('filterDisponibilidade').addEventListener('change', loadLivros);
    });

    // ===== SISTEMA DE FEEDBACKS =====
    function adicionarFeedback(livroId) {
      const livro = database.livros.find(l => l.id === livroId);
      
      if (!livro) {
        alert('‚ùå Livro n√£o encontrado.');
        return;
      }
      
      // Verifica se o aluno j√° avaliou este livro
      const jaAvaliou = database.feedbacks.some(f => 
        f.livroId === livroId && f.usuarioId === currentUser.id
      );
      
      if (jaAvaliou) {
        alert('üìù Voc√™ j√° avaliou este livro!\n\nPara alterar sua avalia√ß√£o, entre em contato com o administrador.');
        return;
      }
      
      // Preenche informa√ß√µes do livro
      document.getElementById('feedbackLivroId').value = livroId;
      document.getElementById('feedbackLivroTitulo').textContent = livro.titulo;
      document.getElementById('feedbackLivroAutor').textContent = livro.autor;
      
      // Limpa sele√ß√£o anterior
      document.querySelectorAll('.rating-btn').forEach(btn => {
        btn.classList.remove('bg-yellow-200', 'border-yellow-400');
      });
      document.getElementById('feedbackNota').value = '';
      document.getElementById('feedbackComentario').value = '';
      
      showModal('addFeedbackModal');
    }

    function setRating(rating) {
      document.getElementById('feedbackNota').value = rating;
      
      // Atualiza visual dos bot√µes
      document.querySelectorAll('.rating-btn').forEach((btn, index) => {
        if (index < rating) {
          btn.classList.add('bg-yellow-200', 'border-yellow-400');
        } else {
          btn.classList.remove('bg-yellow-200', 'border-yellow-400');
        }
      });
    }

    function handleAddFeedback(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const livroId = parseInt(formData.get('livroId'));
      const nota = parseInt(formData.get('nota'));
      const comentario = formData.get('comentario').trim();
      
      if (!nota) {
        alert('‚ùå Por favor, selecione uma nota de 1 a 5 estrelas.');
        return;
      }
      
      const feedback = {
        id: database.nextId.feedbacks++,
        livroId: livroId,
        usuarioId: currentUser.id,
        nota: nota,
        comentario: comentario,
        data: new Date().toISOString().split('T')[0],
        nomeUsuario: currentUser.nome
      };
      
      database.feedbacks.push(feedback);
      saveDatabase();
      
      closeModal('addFeedbackModal');
      alert('‚úÖ Avalia√ß√£o enviada com sucesso!\n\nObrigado por compartilhar sua opini√£o sobre o livro!');
    }

    function verFeedbacks(livroId) {
      const livro = database.livros.find(l => l.id === livroId);
      
      if (!livro) {
        alert('‚ùå Livro n√£o encontrado.');
        return;
      }
      
      const feedbacks = database.feedbacks.filter(f => f.livroId === livroId);
      
      // Preenche informa√ß√µes do livro
      document.getElementById('viewFeedbackLivroTitulo').textContent = livro.titulo;
      document.getElementById('viewFeedbackLivroAutor').textContent = livro.autor;
      document.getElementById('viewFeedbackTotal').textContent = feedbacks.length;
      
      // Calcula m√©dia
      if (feedbacks.length > 0) {
        const media = feedbacks.reduce((sum, f) => sum + f.nota, 0) / feedbacks.length;
        const mediaFormatada = media.toFixed(1);
        const estrelas = '‚≠ê'.repeat(Math.round(media));
        
        document.getElementById('viewFeedbackMedia').textContent = `${mediaFormatada}/5.0`;
        document.getElementById('viewFeedbackMediaEstrelas').textContent = estrelas;
      } else {
        document.getElementById('viewFeedbackMedia').textContent = 'Sem avalia√ß√µes';
        document.getElementById('viewFeedbackMediaEstrelas').textContent = '';
      }
      
      // Lista feedbacks
      const container = document.getElementById('feedbacksList');
      
      if (feedbacks.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">üìù Nenhuma avalia√ß√£o ainda.<br><br>Seja o primeiro a avaliar este livro!</div>';
      } else {
        container.innerHTML = feedbacks.map(feedback => `
          <div class="border rounded-lg p-4 bg-gray-50">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold text-gray-800">${feedback.nomeUsuario}</div>
              <div class="flex items-center gap-2">
                <span class="text-yellow-500">${'‚≠ê'.repeat(feedback.nota)}</span>
                <span class="text-sm text-gray-500">${formatDate(feedback.data)}</span>
              </div>
            </div>
            ${feedback.comentario ? `
              <div class="text-gray-700 text-sm bg-white p-3 rounded border-l-4 border-blue-400">
                "${feedback.comentario}"
              </div>
            ` : '<div class="text-gray-500 text-sm italic">Sem coment√°rio</div>'}
          </div>
        `).join('');
      }
      
      showModal('viewFeedbacksModal');
    }

    // ===== SISTEMA DE RELAT√ìRIOS =====
    function loadRelatorios() {
      loadRelatorioLeitura();
      loadTopLivros();
      loadEstatisticasGerais();
      loadFeedbacksLivros();
    }

    function loadRelatorioLeitura() {
      const filtroTipo = document.getElementById('filtroTipoUsuario').value;
      let usuarios = database.usuarios.filter(u => u.status === 'ativo');
      
      if (filtroTipo) {
        usuarios = usuarios.filter(u => u.tipo === filtroTipo);
      }
      
      // Calcula livros lidos por usu√°rio
      const usuariosComLeitura = usuarios.map(usuario => {
        const emprestimosDevolvidos = database.emprestimos.filter(e => 
          e.alunoId === usuario.id && e.status === 'devolvido'
        );
        
        const livrosLidos = emprestimosDevolvidos.length;
        const feedbacksDados = database.feedbacks.filter(f => f.usuarioId === usuario.id).length;
        
        return {
          ...usuario,
          livrosLidos,
          feedbacksDados
        };
      }).sort((a, b) => b.livrosLidos - a.livrosLidos);
      
      const container = document.getElementById('relatorioLeitura');
      
      if (usuariosComLeitura.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500">Nenhum usu√°rio encontrado.</div>';
        return;
      }
      
      container.innerHTML = usuariosComLeitura.map((usuario, index) => `
        <div class="flex items-center justify-between p-3 border rounded-lg ${index < 3 ? 'bg-yellow-50 border-yellow-200' : 'bg-white'}">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
              index === 0 ? 'bg-yellow-500 text-white' :
              index === 1 ? 'bg-gray-400 text-white' :
              index === 2 ? 'bg-orange-600 text-white' :
              'bg-blue-100 text-blue-800'
            }">
              ${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : index + 1}
            </div>
            <div>
              <div class="font-semibold">${usuario.nome}</div>
              <div class="text-xs text-gray-600">
                ${usuario.tipo} ${usuario.turma ? `‚Ä¢ ${usuario.turma}` : ''}
              </div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-lg ${usuario.livrosLidos > 0 ? 'text-green-600' : 'text-gray-400'}">
              ${usuario.livrosLidos}
            </div>
            <div class="text-xs text-gray-500">
              ${usuario.livrosLidos === 1 ? 'livro' : 'livros'}
            </div>
            ${usuario.feedbacksDados > 0 ? `
              <div class="text-xs text-blue-600 mt-1">
                üí¨ ${usuario.feedbacksDados} avalia√ß√£o${usuario.feedbacksDados !== 1 ? '√µes' : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    function loadTopLivros() {
      // Conta empr√©stimos por livro
      const livrosEmprestimos = {};
      
      database.emprestimos.forEach(emprestimo => {
        if (!livrosEmprestimos[emprestimo.livroId]) {
          livrosEmprestimos[emprestimo.livroId] = 0;
        }
        livrosEmprestimos[emprestimo.livroId]++;
      });
      
      // Ordena livros por n√∫mero de empr√©stimos
      const topLivros = Object.entries(livrosEmprestimos)
        .map(([livroId, count]) => {
          const livro = database.livros.find(l => l.id === parseInt(livroId));
          const feedbacks = database.feedbacks.filter(f => f.livroId === parseInt(livroId));
          const mediaAvaliacao = feedbacks.length > 0 ? 
            feedbacks.reduce((sum, f) => sum + f.nota, 0) / feedbacks.length : 0;
          
          return {
            livro,
            emprestimos: count,
            avaliacoes: feedbacks.length,
            mediaAvaliacao
          };
        })
        .filter(item => item.livro)
        .sort((a, b) => b.emprestimos - a.emprestimos)
        .slice(0, 10);
      
      const container = document.getElementById('topLivros');
      
      if (topLivros.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500">Nenhum empr√©stimo registrado ainda.</div>';
        return;
      }
      
      container.innerHTML = topLivros.map((item, index) => `
        <div class="flex items-center justify-between p-3 border rounded-lg ${index < 3 ? 'bg-green-50 border-green-200' : 'bg-white'}">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
              index === 0 ? 'bg-green-500 text-white' :
              index === 1 ? 'bg-green-400 text-white' :
              index === 2 ? 'bg-green-300 text-white' :
              'bg-gray-100 text-gray-600'
            }">
              ${index + 1}
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-semibold truncate">${item.livro.titulo}</div>
              <div class="text-xs text-gray-600 truncate">${item.livro.autor}</div>
              ${item.avaliacoes > 0 ? `
                <div class="text-xs text-yellow-600 mt-1">
                  ${'‚≠ê'.repeat(Math.round(item.mediaAvaliacao))} ${item.mediaAvaliacao.toFixed(1)} (${item.avaliacoes})
                </div>
              ` : ''}
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-lg text-green-600">${item.emprestimos}</div>
            <div class="text-xs text-gray-500">empr√©stimos</div>
          </div>
        </div>
      `).join('');
    }

    function loadEstatisticasGerais() {
      const totalEmprestimos = database.emprestimos.length;
      const emprestimosAtivos = database.emprestimos.filter(e => e.status === 'ativo').length;
      const emprestimosDevolvidos = database.emprestimos.filter(e => e.status === 'devolvido').length;
      const totalFeedbacks = database.feedbacks.length;
      const usuariosAtivos = database.usuarios.filter(u => u.status === 'ativo').length;
      const livrosDisponiveis = database.livros.filter(l => l.disponivel > 0).length;
      
      // Calcula m√©dia geral de avalia√ß√µes
      const mediaGeralAvaliacoes = database.feedbacks.length > 0 ? 
        database.feedbacks.reduce((sum, f) => sum + f.nota, 0) / database.feedbacks.length : 0;
      
      // Usu√°rio mais ativo
      const usuarioMaisAtivo = database.usuarios
        .map(usuario => ({
          ...usuario,
          emprestimos: database.emprestimos.filter(e => e.alunoId === usuario.id).length
        }))
        .filter(u => u.emprestimos > 0)
        .sort((a, b) => b.emprestimos - a.emprestimos)[0];
      
      const container = document.getElementById('estatisticasGerais');
      
      container.innerHTML = `
        <div class="text-center p-3 bg-blue-50 rounded-lg">
          <div class="text-2xl text-blue-600 mb-1">üìã</div>
          <div class="font-bold text-lg">${totalEmprestimos}</div>
          <div class="text-xs text-gray-600">Total Empr√©stimos</div>
        </div>
        
        <div class="text-center p-3 bg-yellow-50 rounded-lg">
          <div class="text-2xl text-yellow-600 mb-1">‚è≥</div>
          <div class="font-bold text-lg">${emprestimosAtivos}</div>
          <div class="text-xs text-gray-600">Empr√©stimos Ativos</div>
        </div>
        
        <div class="text-center p-3 bg-green-50 rounded-lg">
          <div class="text-2xl text-green-600 mb-1">‚úÖ</div>
          <div class="font-bold text-lg">${emprestimosDevolvidos}</div>
          <div class="text-xs text-gray-600">Devolvidos</div>
        </div>
        
        <div class="text-center p-3 bg-purple-50 rounded-lg">
          <div class="text-2xl text-purple-600 mb-1">üí¨</div>
          <div class="font-bold text-lg">${totalFeedbacks}</div>
          <div class="text-xs text-gray-600">Avalia√ß√µes</div>
        </div>
        
        <div class="text-center p-3 bg-orange-50 rounded-lg">
          <div class="text-2xl text-orange-600 mb-1">üë•</div>
          <div class="font-bold text-lg">${usuariosAtivos}</div>
          <div class="text-xs text-gray-600">Usu√°rios Ativos</div>
        </div>
        
        <div class="text-center p-3 bg-indigo-50 rounded-lg">
          <div class="text-2xl text-indigo-600 mb-1">üìö</div>
          <div class="font-bold text-lg">${livrosDisponiveis}</div>
          <div class="text-xs text-gray-600">Livros Dispon√≠veis</div>
        </div>
        
        ${mediaGeralAvaliacoes > 0 ? `
          <div class="text-center p-3 bg-yellow-50 rounded-lg">
            <div class="text-2xl text-yellow-600 mb-1">‚≠ê</div>
            <div class="font-bold text-lg">${mediaGeralAvaliacoes.toFixed(1)}</div>
            <div class="text-xs text-gray-600">M√©dia Geral</div>
          </div>
        ` : ''}
        
        ${usuarioMaisAtivo ? `
          <div class="col-span-2 text-center p-3 bg-red-50 rounded-lg">
            <div class="text-2xl text-red-600 mb-1">üèÜ</div>
            <div class="font-bold text-sm">${usuarioMaisAtivo.nome}</div>
            <div class="text-xs text-gray-600">Usu√°rio Mais Ativo (${usuarioMaisAtivo.emprestimos} empr√©stimos)</div>
          </div>
        ` : ''}
      `;
    }

    function loadFeedbacksLivros() {
      const feedbacksRecentes = database.feedbacks
        .sort((a, b) => new Date(b.data) - new Date(a.data))
        .slice(0, 10);
      
      const container = document.getElementById('feedbacksLivros');
      
      if (feedbacksRecentes.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500">Nenhuma avalia√ß√£o registrada ainda.</div>';
        return;
      }
      
      container.innerHTML = feedbacksRecentes.map(feedback => {
        const livro = database.livros.find(l => l.id === feedback.livroId);
        
        return `
          <div class="border rounded-lg p-3 bg-white">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold text-sm">${feedback.nomeUsuario}</div>
              <div class="flex items-center gap-2">
                <span class="text-yellow-500">${'‚≠ê'.repeat(feedback.nota)}</span>
                <span class="text-xs text-gray-500">${formatDate(feedback.data)}</span>
              </div>
            </div>
            <div class="text-sm text-gray-700 mb-2">
              <strong>${livro?.titulo || 'Livro n√£o encontrado'}</strong>
              ${livro?.autor ? ` - ${livro.autor}` : ''}
            </div>
            ${feedback.comentario ? `
              <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded italic">
                "${feedback.comentario}"
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // ===== FUN√á√ïES GLOBAIS =====
    window.showTab = showTab;
    window.showModal = showModal;
    window.closeModal = closeModal;
    window.logout = logout;
    window.editLivro = editLivro;
    window.deleteLivro = deleteLivro;
    window.importBooks = importBooks;
    window.importUsers = importUsers;
    window.deleteUsuario = deleteUsuario;
    window.devolverLivro = devolverLivro;
    window.editEmprestimo = editEmprestimo;
    window.deleteEmprestimo = deleteEmprestimo;
    window.clearLivrosFilters = clearLivrosFilters;
    window.exportarBackup = exportarBackup;
    window.copiarBackup = copiarBackup;
    window.restaurarBackup = restaurarBackup;
    window.gerarQRCodeMega = gerarQRCodeMega;
    window.copiarLinkMega = copiarLinkMega;
    window.loadBackupsForMerge = loadBackupsForMerge;
    window.executeMergeBackups = executeMergeBackups;
    window.downloadMergedBackup = downloadMergedBackup;
    window.copyMergedBackup = copyMergedBackup;
    window.applyMergedBackup = applyMergedBackup;
    window.adicionarFeedback = adicionarFeedback;
    window.verFeedbacks = verFeedbacks;
    window.setRating = setRating;
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99347b4b92cd28b1',t:'MTc2MTI1NjU1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
