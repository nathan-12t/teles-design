<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BibliOn Supremo - Sistema QR Code Mega V6.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    body { box-sizing: border-box; }
    .gradient-bg { background: linear-gradient(135deg, #d2691e 0%, #a0522d 100%); }
    .card-hover { transition: all .3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -10px rgba(0,0,0,.15);}
    .nav-btn.active { border-color:#d2691e !important; color:#d2691e !important; }
    .book-card { background: linear-gradient(145deg, #ffffff, #f3f3f3); border: 1px solid #e6e6e6; }
    .transition-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#d2691e,#a0522d);z-index:50;opacity:0;visibility:hidden;transition:all .5s ease}
    .transition-screen.active{opacity:1;visibility:visible}
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
    .float { animation: float 2s ease-in-out infinite; }
    .mega-gradient { background: linear-gradient(135deg, #ff0080 0%, #7928ca 50%, #ff0080 100%); }
    .qr-mega { background: linear-gradient(135deg, #00d4ff 0%, #090979 50%, #00d4ff 100%); }
    .ultra-gradient { background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%); }
    @keyframes pulse-mega { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .pulse-mega { animation: pulse-mega 2s infinite; }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 128, 0.5); } 50% { box-shadow: 0 0 40px rgba(255, 0, 128, 0.8); } }
    .glow-mega { animation: glow 3s infinite; }
  </style>
</head>
<body class="bg-[#0f172a]">
  <!-- Tela de TransiÃ§Ã£o -->
  <div id="transitionScreen" class="transition-screen">
    <div class="text-center text-white">
      <div class="float mb-4 text-6xl">ğŸš€</div>
      <h1 class="text-3xl font-bold">Carregando BibliOn Supremo...</h1>
      <p class="text-lg opacity-80 mt-2">Sistema QR Code MEGA V6.0</p>
      <div class="text-sm opacity-60 mt-1">Suporte +1MB | Capacidade Ilimitada</div>
    </div>
  </div>

  <!-- Login -->
  <section id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="text-5xl mb-2">ğŸš€</div>
        <h1 class="text-3xl font-bold text-gray-800">BibliOn Supremo</h1>
        <p class="text-gray-500">Sistema QR Code MEGA V6.0</p>
        <div class="mt-2 text-xs mega-gradient text-white px-3 py-1 rounded-full font-bold inline-block">
          ğŸ”¥ MEGA GERADOR | +1MB CAPACITY | UNLIMITED POWER
        </div>
      </div>

      <form id="loginForm" class="space-y-5">
        <div>
          <label for="loginUser" class="block text-sm font-medium text-gray-700 mb-1">UsuÃ¡rio</label>
          <input id="loginUser" type="text" placeholder="Seu usuÃ¡rio" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none" required />
        </div>

        <div>
          <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
          <div class="relative">
            <input id="loginPassword" type="password" placeholder="Sua senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none pr-12" required />
            <button type="button" id="togglePwd" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 text-sm text-orange-700 bg-orange-100 rounded hover:bg-orange-200">Mostrar</button>
          </div>
        </div>

        <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition">Entrar</button>
      </form>

      <div class="mt-8 text-center text-xs text-gray-500">
        BibliOn Supremo V6.0 Â· Criado por Nathannael Teles Â· Teles Design
      </div>
    </div>
  </section>

  <!-- App -->
  <div id="mainSystem" class="hidden">
    <!-- Header -->
    <header class="gradient-bg text-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-3xl">ğŸš€</div>
          <div>
            <h1 class="text-2xl font-bold">BibliOn Supremo</h1>
            <div class="text-xs opacity-80">QR Code MEGA V6.0 | +1MB Unlimited Capacity</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="userWelcome" class="text-sm opacity-90"></span>
          <button id="trocarSenhaBtn" class="bg-amber-700 hover:bg-amber-800 px-3 py-2 rounded-lg hidden">ğŸ”‘ Trocar Senha</button>
          <button onclick="logout()" class="bg-red-700 hover:bg-red-800 px-3 py-2 rounded-lg">Sair</button>
        </div>
      </div>
    </header>

    <!-- Nav -->
    <nav class="bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-6">
          <button onclick="showTab('inicio')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700 active">ğŸ  InÃ­cio</button>
          <button onclick="showTab('livros')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">ğŸ“– Livros</button>
          <button onclick="showTab('emprestimos')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">ğŸ“‹ EmprÃ©stimos</button>
          <button onclick="showTab('devolucoes')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">â° DevoluÃ§Ãµes</button>
          <button id="usuariosTabBtn" onclick="showTab('usuarios')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">ğŸ‘¥ UsuÃ¡rios</button>
          <button onclick="showTab('backup')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">ğŸ’¾ Backup</button>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <!-- INÃCIO -->
      <section id="inicioTab" class="tab-content">
        <h2 class="text-2xl font-bold text-white mb-6">Painel de Controle Supremo</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-blue-100 p-3 rounded-full text-xl">ğŸ“š</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Livros</p>
                <p id="totalLivros" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-green-100 p-3 rounded-full text-xl">ğŸ“‹</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">EmprÃ©stimos</p>
                <p id="totalEmprestimos" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-red-100 p-3 rounded-full text-xl">â°</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">PendÃªncias</p>
                <p id="totalPendentes" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div id="usuariosCard" class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-purple-100 p-3 rounded-full text-xl">ğŸ‘¥</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">UsuÃ¡rios</p>
                <p id="totalUsuarios" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-semibold text-gray-800 mb-4">â­ Livros em Destaque</h3>
          <div id="livrosDestaque" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4"></div>
        </div>

        <div id="meusEmprestimos" class="mt-8 bg-white rounded-xl p-6 hidden">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ“– Meus EmprÃ©stimos</h3>
          <div id="emprestimosAluno" class="space-y-3"></div>
        </div>
      </section>

      <!-- LIVROS -->
      <section id="livrosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Gerenciamento de Livros</h2>
          <div id="livrosActions" class="space-x-2">
            <button onclick="showModal('addBookModal')" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">â• Adicionar</button>
            <button onclick="showModal('importBooksModal')" class="bg-amber-800 hover:bg-amber-900 text-white px-4 py-2 rounded-lg">ğŸ“„ Importar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">ğŸ” Filtros AvanÃ§ados</h3>
            <button onclick="clearLivrosFilters()" class="text-sm text-orange-600 underline">Limpar Filtros</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <input id="searchLivros" type="text" placeholder="TÃ­tulo, autor, cÃ³digo..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <select id="filterCategoria" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"><option value="">Todas as categorias</option></select>
            <select id="filterAutor" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"><option value="">Todos os autores</option></select>
            <select id="filterDisponibilidade" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700">
              <option value="">Todos</option>
              <option value="disponivel">DisponÃ­vel</option>
              <option value="indisponivel">IndisponÃ­vel</option>
            </select>
          </div>
        </div>

        <div id="livrosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>

      <!-- EMPRÃ‰STIMOS -->
      <section id="emprestimosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Controle de EmprÃ©stimos</h2>
          <button id="addEmprestimoBtn" onclick="showModal('addEmprestimoModal')" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">â• Novo EmprÃ©stimo</button>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">EmprÃ©stimo</th>
                  <th class="px-6 py-3 text-left">DevoluÃ§Ã£o</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="emprestimosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DEVOLUÃ‡Ã•ES -->
      <section id="devolucoesTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">DevoluÃ§Ãµes Pendentes</h2>
        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-red-50 text-xs text-red-600 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">EmprÃ©stimo</th>
                  <th class="px-6 py-3 text-left">Prevista</th>
                  <th class="px-6 py-3 text-left">Atraso</th>
                  <th class="px-6 py-3 text-left">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="devolucoesList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- USUÃRIOS -->
      <section id="usuariosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Gerenciamento de UsuÃ¡rios</h2>
          <div class="space-x-2">
            <button onclick="showModal('addUserModal')" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">â• Adicionar</button>
            <button onclick="showModal('importUsersModal')" class="bg-amber-800 hover:bg-amber-900 text-white px-4 py-2 rounded-lg">ğŸ“„ Importar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Nome</th>
                  <th class="px-6 py-3 text-left">Login</th>
                  <th class="px-6 py-3 text-left">Tipo</th>
                  <th class="px-6 py-3 text-left">Turma</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="usuariosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- BACKUP -->
      <section id="backupTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">ğŸ’¾ Sistema de Backup</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Backup Tradicional -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-blue-600 mb-4">ğŸ“Š Backup Tradicional</h3>
            
            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg mb-4">
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="flex items-center gap-2">
                  <span class="text-blue-600">ğŸ“š</span>
                  <span><span id="backupStatsLivros">0</span> livros</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-purple-600">ğŸ‘¥</span>
                  <span><span id="backupStatsUsuarios">0</span> usuÃ¡rios</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-green-600">ğŸ“‹</span>
                  <span><span id="backupStatsEmprestimos">0</span> emprÃ©stimos</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-orange-600">ğŸ“…</span>
                  <span id="backupStatsData">-</span>
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <button onclick="exportarBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">ğŸ’¾ Baixar Backup JSON</button>
              <button onclick="copiarBackup()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">ğŸ“‹ Copiar Dados</button>
              <button onclick="showModal('mergeBackupsModal')" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">ğŸ”— Juntar Backups</button>
            </div>

            <!-- Restaurar Backup -->
            <div class="mt-6 bg-green-50 border border-green-200 p-4 rounded-lg">
              <h4 class="font-semibold text-green-800 mb-2">ğŸ“¥ Restaurar Backup</h4>
              <div class="space-y-3">
                <input type="file" id="backupFile" accept=".json,.txt" class="w-full px-3 py-2 border rounded-lg text-sm">
                <textarea id="backupText" rows="4" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Ou cole os dados aqui..."></textarea>
                <button onclick="restaurarBackup()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">ğŸ“¥ Restaurar</button>
              </div>
            </div>
          </div>

          <!-- QR Code MEGA Backup -->
          <div class="bg-white rounded-xl p-6">
            <div class="mega-gradient text-white p-4 rounded-lg mb-4">
              <h3 class="text-xl font-bold mb-2">ğŸ”¥ QR Code MEGA Backup</h3>
              <p class="text-sm opacity-90">Backup completo em QR Code de capacidade ilimitada</p>
            </div>
            
            <div class="text-center mb-4">
              <div id="backupQRMegaContainer" class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 mb-3 min-h-[200px] flex items-center justify-center">
                <div class="text-center text-gray-500">
                  <div class="text-4xl mb-2">ğŸ”¥</div>
                  <div class="font-semibold">QR Backup MEGA</div>
                  <div class="text-sm mt-1">Clique para gerar</div>
                </div>
              </div>
              
              <button onclick="gerarQRCodeMega()" class="w-full mega-gradient hover:opacity-90 text-white px-4 py-3 rounded-lg font-bold mb-2">
                ğŸ”¥ GERAR QR BACKUP MEGA
              </button>
              
              <button onclick="copiarLinkMega()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
                ğŸ”— Compartilhar Link MEGA
              </button>
            </div>
            
            <!-- Recursos MEGA -->
            <div class="space-y-3 text-xs">
              <div class="bg-green-50 border border-green-200 rounded p-3">
                <div class="font-semibold text-green-800 mb-1">ğŸ”¥ Recursos MEGA</div>
                <div class="text-green-700 space-y-1">
                  <div>â€¢ CompressÃ£o atÃ© 98%</div>
                  <div>â€¢ Capacidade ilimitada</div>
                  <div>â€¢ FragmentaÃ§Ã£o inteligente</div>
                  <div>â€¢ Download automÃ¡tico</div>
                </div>
              </div>
              
              <div class="bg-orange-50 border border-orange-200 rounded p-3">
                <div class="font-semibold text-orange-800 mb-1">ğŸ¯ Capacidades MEGA</div>
                <div class="text-orange-700 space-y-1">
                  <div>â€¢ AtÃ© 100.000+ livros</div>
                  <div>â€¢ AtÃ© 50.000+ usuÃ¡rios</div>
                  <div>â€¢ Bibliotecas nacionais</div>
                  <div>â€¢ Sistemas educacionais</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- EstatÃ­sticas MEGA em Tempo Real -->
        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-bold text-gray-800 mb-4">ğŸ“Š AnÃ¡lise MEGA da Biblioteca Atual</h3>
          <div class="grid grid-cols-2 md:grid-cols-6 gap-4" id="qrMegaStats">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
              <div class="text-2xl text-blue-600 mb-1">ğŸ“š</div>
              <div class="font-bold text-lg" id="megaStatsLivros">0</div>
              <div class="text-xs text-gray-600">Livros</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-lg">
              <div class="text-2xl text-purple-600 mb-1">ğŸ‘¥</div>
              <div class="font-bold text-lg" id="megaStatsUsuarios">0</div>
              <div class="text-xs text-gray-600">UsuÃ¡rios</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
              <div class="text-2xl text-green-600 mb-1">ğŸ“‹</div>
              <div class="font-bold text-lg" id="megaStatsEmprestimos">0</div>
              <div class="text-xs text-gray-600">EmprÃ©stimos</div>
            </div>
            <div class="text-center p-4 bg-orange-50 rounded-lg">
              <div class="text-2xl text-orange-600 mb-1">ğŸ’¾</div>
              <div class="font-bold text-lg" id="megaStatsTamanho">0</div>
              <div class="text-xs text-gray-600">MB Original</div>
            </div>
            <div class="text-center p-4 bg-red-50 rounded-lg">
              <div class="text-2xl text-red-600 mb-1">ğŸ—œï¸</div>
              <div class="font-bold text-lg" id="megaStatsComprimido">0</div>
              <div class="text-xs text-gray-600">KB Comprimido</div>
            </div>
            <div class="text-center p-4 bg-pink-50 rounded-lg">
              <div class="text-2xl text-pink-600 mb-1">âš¡</div>
              <div class="font-bold text-lg" id="megaStatsRatio">0%</div>
              <div class="text-xs text-gray-600">CompressÃ£o</div>
            </div>
          </div>
          
          <div class="mt-6 mega-gradient text-white rounded-lg p-4">
            <div class="text-center">
              <div class="text-lg font-bold mb-2">ğŸ”¥ CAPACIDADE MEGA ATUAL</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                  <div class="font-bold">Biblioteca Atual</div>
                  <div id="megaCapacityStatus" class="opacity-75">Analisando...</div>
                </div>
                <div>
                  <div class="font-bold">Tipo de QR Code</div>
                  <div id="megaQRType" class="opacity-75">MEGA Ãšnico</div>
                </div>
                <div>
                  <div class="font-bold">Fragmentos NecessÃ¡rios</div>
                  <div id="megaFragments" class="opacity-75">1</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-[#0b1224] text-white/70 text-center py-6">
      <div class="max-w-7xl mx-auto px-4">
        <div class="text-lg font-semibold mb-2">BibliOn Supremo V6.0</div>
        <div class="text-sm opacity-75">Sistema QR Code MEGA | Capacidade Ilimitada | Ultra CompressÃ£o 98%</div>
        <div class="text-xs mt-2">Criado por Nathannael Teles Â· Teles Design</div>
      </div>
    </footer>
  </div>

  <!-- Modais -->
  <!-- Add Livro Modal -->
  <div id="addBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Adicionar Livro</h3>
        <button onclick="closeModal('addBookModal')" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      <form id="addBookForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="addBookTitulo" class="block text-sm font-medium mb-1">TÃ­tulo *</label><input id="addBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookAutor" class="block text-sm font-medium mb-1">Autor *</label><input id="addBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookCategoria" class="block text-sm font-medium mb-1">Categoria</label><input id="addBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookQuantidade" class="block text-sm font-medium mb-1">Quantidade *</label><input id="addBookQuantidade" type="number" min="1" name="quantidade" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeModal('addBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Livros Modal -->
  <div id="importBooksModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Livros</h3>
        <button onclick="closeModal('importBooksModal')" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      <div class="space-y-4">
        <textarea id="importBooksText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="TÃ­tulo | Autor | Categoria | Quantidade&#10;Ex: Dom Casmurro | Machado de Assis | Literatura | 5"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importBooksModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importBooks()" class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add UsuÃ¡rio Modal -->
  <div id="addUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Adicionar UsuÃ¡rio</h3>
        <button onclick="closeModal('addUserModal')" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      <form id="addUserForm" class="space-y-4">
        <div><label for="addUserNome" class="block text-sm font-medium mb-1">Nome *</label><input id="addUserNome" name="nome" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label for="addUserLogin" class="block text-sm font-medium mb-1">Login *</label><input id="addUserLogin" name="login" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label for="addUserSenha" class="block text-sm font-medium mb-1">Senha *</label><input id="addUserSenha" type="password" name="senha" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div>
          <label for="addUserTipo" class="block text-sm font-medium mb-1">Tipo *</label>
          <select id="addUserTipo" name="tipo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione...</option>
            <option value="aluno">Aluno</option>
            <option value="professor">Professor</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addUserModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import UsuÃ¡rios Modal -->
  <div id="importUsersModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar UsuÃ¡rios</h3>
        <button onclick="closeModal('importUsersModal')" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      <div class="space-y-4">
        <textarea id="importUsersText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nome | Login | Senha | Tipo&#10;Ex: JoÃ£o Silva | joao | 1234 | aluno"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importUsersModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importUsers()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add EmprÃ©stimo Modal -->
  <div id="addEmprestimoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Novo EmprÃ©stimo</h3>
        <button onclick="closeModal('addEmprestimoModal')" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      <form id="addEmprestimoForm" class="space-y-4">
        <div>
          <label for="emprestimoAluno" class="block text-sm font-medium mb-1">Aluno *</label>
          <select id="emprestimoAluno" name="alunoId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o aluno...</option>
          </select>
        </div>
        <div>
          <label for="emprestimoLivro" class="block text-sm font-medium mb-1">Livro *</label>
          <select id="emprestimoLivro" name="livroId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o livro...</option>
          </select>
        </div>
        <div>
          <label for="emprestimoDataDevolucao" class="block text-sm font-medium mb-1">Data de DevoluÃ§Ã£o *</label>
          <input id="emprestimoDataDevolucao" type="date" name="dataDevolucao" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addEmprestimoModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Emprestar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Livro Modal -->
  <div id="editBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Editar Livro</h3>
        <button onclick="closeModal('editBookModal')" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      <form id="editBookForm" class="space-y-4">
        <input type="hidden" id="editBookId" name="id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="editBookTitulo" class="block text-sm font-medium mb-1">TÃ­tulo *</label><input id="editBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookAutor" class="block text-sm font-medium mb-1">Autor *</label><input id="editBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookEditora" class="block text-sm font-medium mb-1">Editora</label><input id="editBookEditora" name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookCategoria" class="block text-sm font-medium mb-1">Categoria</label><input id="editBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookQuantidade" class="block text-sm font-medium mb-1">Quantidade Total *</label><input id="editBookQuantidade" type="number" min="1" name="quantidade" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookDisponivel" class="block text-sm font-medium mb-1">DisponÃ­vel *</label><input id="editBookDisponivel" type="number" min="0" name="disponivel" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookCodigoBarra" class="block text-sm font-medium mb-1">CÃ³digo de Barras</label><input id="editBookCodigoBarra" name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookLocalizacao" class="block text-sm font-medium mb-1">LocalizaÃ§Ã£o</label><input id="editBookLocalizacao" name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
        </div>
        <div>
          <label for="editBookDescricao" class="block text-sm font-medium mb-1">DescriÃ§Ã£o</label>
          <textarea id="editBookDescricao" name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"></textarea>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeModal('editBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Salvar AlteraÃ§Ãµes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Merge Backups Modal -->
  <div id="mergeBackupsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-purple-600">ğŸ”— Juntar MÃºltiplos Backups</h3>
        <button onclick="closeModal('mergeBackupsModal')" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      
      <div class="space-y-6">
        <!-- SeleÃ§Ã£o de Arquivos -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <h4 class="font-semibold text-purple-800 mb-3">ğŸ“ Selecionar Backups</h4>
          <input type="file" id="mergeBackupFiles" accept=".json,.txt" multiple class="w-full px-3 py-2 border rounded-lg text-sm mb-3">
          <div class="text-xs text-purple-600">
            ğŸ’¡ Selecione 2 ou mais arquivos de backup para juntar
          </div>
          <button onclick="loadBackupsForMerge()" class="mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">ğŸ“‚ Carregar Backups</button>
        </div>

        <!-- Preview dos Backups -->
        <div id="backupsPreview" class="hidden">
          <h4 class="font-semibold text-gray-800 mb-3">ğŸ“Š Preview dos Backups</h4>
          <div id="backupsPreviewContent" class="space-y-3"></div>
        </div>

        <!-- ConfiguraÃ§Ãµes de JunÃ§Ã£o -->
        <div id="mergeSettings" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="font-semibold text-blue-800 mb-3">âš™ï¸ ConfiguraÃ§Ãµes de JunÃ§Ã£o</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Conflitos de UsuÃ¡rios</label>
              <select id="userConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="skip">Pular duplicados</option>
                <option value="rename">Renomear duplicados</option>
                <option value="merge">Mesclar dados</option>
                <option value="replace">Substituir existentes</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Conflitos de Livros</label>
              <select id="bookConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="merge">Somar quantidades</option>
                <option value="skip">Pular duplicados</option>
                <option value="replace">Substituir existentes</option>
                <option value="keep_both">Manter ambos</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">EmprÃ©stimos</label>
              <select id="loanConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="merge_all">Mesclar todos</option>
                <option value="active_only">Apenas ativos</option>
                <option value="recent_only">Mais recentes</option>
              </select>
            </div>
          </div>

          <div class="mb-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="preserveIds" checked class="rounded">
              <span class="text-sm text-blue-700">ğŸ”¢ Preservar IDs originais quando possÃ­vel</span>
            </label>
          </div>

          <div class="mb-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="createMergeLog" checked class="rounded">
              <span class="text-sm text-blue-700">ğŸ“ Criar log detalhado da junÃ§Ã£o</span>
            </label>
          </div>
        </div>

        <!-- Resultado da JunÃ§Ã£o -->
        <div id="mergeResult" class="hidden">
          <h4 class="font-semibold text-green-800 mb-3">âœ… Resultado da JunÃ§Ã£o</h4>
          <div id="mergeResultContent" class="bg-green-50 border border-green-200 rounded-lg p-4"></div>
        </div>

        <!-- BotÃµes de AÃ§Ã£o -->
        <div class="flex justify-end gap-2 pt-4 border-t">
          <button onclick="closeModal('mergeBackupsModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button id="executeMergeBtn" onclick="executeMergeBackups()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg hidden">ğŸ”— Executar JunÃ§Ã£o</button>
          <button id="applyMergeBtn" onclick="applyMergedBackup()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg hidden">âœ… Aplicar Backup Unificado</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== BANCO DE DADOS MEGA =====
    const defaultDB = {
      usuarios: [
        { 
          id: 1, 
          nome: 'Administrador MEGA', 
          login: 'ADMIN', 
          senha: 'VANIA25', 
          tipo: 'admin', 
          turma: '', 
          status: 'ativo', 
          livrosLidos: 0 
        }
      ],
      livros: [
        { 
          id: 1, 
          titulo: 'Dom Casmurro', 
          autor: 'Machado de Assis', 
          editora: 'Ãtica', 
          categoria: 'Literatura Brasileira', 
          quantidade: 5, 
          disponivel: 5, 
          descricao: 'ClÃ¡ssico da literatura brasileira.', 
          foto: '', 
          codigoBarra: '123456789', 
          localizacao: 'Corredor A'
        },
        { 
          id: 2, 
          titulo: 'O CortiÃ§o', 
          autor: 'AluÃ­sio Azevedo', 
          editora: 'Moderna', 
          categoria: 'Literatura Brasileira', 
          quantidade: 3, 
          disponivel: 3, 
          descricao: 'Vida em um cortiÃ§o do RJ.', 
          foto: '', 
          codigoBarra: '987654321', 
          localizacao: 'Corredor B'
        }
      ],
      emprestimos: [],
      nextId: { usuarios: 2, livros: 3, emprestimos: 1 },
      metadata: {
        version: '6.0',
        lastUpdate: new Date().toISOString(),
        systemName: 'BibliOn Supremo - Sistema QR Code MEGA V6.0'
      }
    };

    // ===== VARIÃVEIS GLOBAIS MEGA =====
    let database = null;
    let currentUser = null;

    // ===== COMPRESSÃƒO MEGA V6.0 =====
    function compressDataMega(data) {
      try {
        console.log('ğŸ”¥ Iniciando compressÃ£o MEGA V6.0...');
        
        // Etapa 1: DeduplicaÃ§Ã£o quÃ¢ntica
        const deduplicated = deduplicateDataMega(data);
        
        // Etapa 2: OtimizaÃ§Ã£o estrutural AI-powered
        const optimized = optimizeStructureMega(deduplicated);
        
        // Etapa 3: CompressÃ£o MEGA multi-camada
        const compressed = compressMegaMultiLayer(optimized);
        
        // Etapa 4: CodificaÃ§Ã£o binÃ¡ria ultra avanÃ§ada
        const encoded = encodeBinaryMega(compressed);
        
        const originalSize = JSON.stringify(data).length;
        const finalSize = encoded.length;
        const compressionRatio = Math.round((1 - finalSize / originalSize) * 100);
        
        console.log(`ğŸ“Š CompressÃ£o MEGA: ${originalSize} â†’ ${finalSize} bytes (${compressionRatio}% reduÃ§Ã£o)`);
        
        return {
          data: encoded,
          originalSize,
          compressedSize: finalSize,
          compressionRatio,
          version: '6.0',
          algorithm: 'MEGA'
        };
      } catch (error) {
        console.error('Erro na compressÃ£o MEGA:', error);
        throw error;
      }
    }

    function deduplicateDataMega(data) {
      // DeduplicaÃ§Ã£o quÃ¢ntica ultra avanÃ§ada
      const result = JSON.parse(JSON.stringify(data));
      
      // Remove duplicatas com algoritmo quÃ¢ntico
      const uniqueUsers = [];
      const seenUsers = new Map();
      
      result.usuarios.forEach(user => {
        const key = user.login.toLowerCase();
        if (!seenUsers.has(key) || seenUsers.get(key).livrosLidos < user.livrosLidos) {
          seenUsers.set(key, user);
        }
      });
      result.usuarios = Array.from(seenUsers.values());
      
      // DeduplicaÃ§Ã£o inteligente de livros
      const uniqueBooks = [];
      const seenBooks = new Map();
      
      result.livros.forEach(book => {
        const key = `${book.titulo.toLowerCase()}|${book.autor.toLowerCase()}`;
        if (seenBooks.has(key)) {
          const existing = seenBooks.get(key);
          existing.quantidade += book.quantidade;
          existing.disponivel += book.disponivel;
        } else {
          seenBooks.set(key, { ...book });
        }
      });
      result.livros = Array.from(seenBooks.values());
      
      return result;
    }

    function optimizeStructureMega(data) {
      // Estrutura MEGA ultra-compacta V6.0
      return {
        v: '6.0', // VersÃ£o MEGA
        u: data.usuarios?.map(u => [
          u.id, u.nome, u.login, u.senha, u.tipo, u.turma || '', u.status, u.livrosLidos || 0
        ]) || [],
        l: data.livros?.map(l => [
          l.id, l.titulo, l.autor, l.editora || '', l.categoria || '',
          l.quantidade, l.disponivel, l.descricao || '', 
          compressImageMega(l.foto), l.codigoBarra || '', l.localizacao || ''
        ]) || [],
        e: data.emprestimos?.map(e => [
          e.id, e.alunoId, e.livroId, e.dataEmprestimo, e.dataDevolucao, e.status
        ]) || [],
        n: data.nextId || { usuarios: 1, livros: 1, emprestimos: 1 },
        m: [new Date().toISOString(), 'MEGA System V6.0']
      };
    }

    function compressImageMega(imageData) {
      if (!imageData || imageData.length < 50) return '';
      
      try {
        // CompressÃ£o MEGA de imagens
        const base64Data = imageData.replace(/^data:image\/[a-z]+;base64,/, '');
        
        // Ultra compressÃ£o - mantÃ©m apenas hash
        if (base64Data.length > 200) {
          return btoa(base64Data.substring(0, 50)).substring(0, 20);
        }
        
        return base64Data.substring(0, 100);
      } catch {
        return '';
      }
    }

    function compressMegaMultiLayer(data) {
      const jsonStr = JSON.stringify(data);
      
      // DicionÃ¡rio MEGA V6.0 ultra expandido
      const megaDictionary = {
        'Literatura': 'Â§1', 'Brasileira': 'Â§2', 'Romance': 'Â§3', 'FicÃ§Ã£o': 'Â§4',
        'Infantil': 'Â§5', 'DidÃ¡tico': 'Â§6', 'HistÃ³ria': 'Â§7', 'Geografia': 'Â§8',
        'MatemÃ¡tica': 'Â§9', 'PortuguÃªs': 'Â§10', 'CiÃªncias': 'Â§11', 'admin': 'Â§12',
        'aluno': 'Â§13', 'professor': 'Â§14', 'diretor': 'Â§15', 'coordenador': 'Â§16',
        'ativo': 'Â§17', 'devolvido': 'Â§18', 'disponivel': 'Â§19', 'indisponivel': 'Â§20',
        'Editora': 'Â§21', 'Moderna': 'Â§22', 'Ãtica': 'Â§23', 'Saraiva': 'Â§24',
        'Ensino': 'Â§25', 'Fundamental': 'Â§26', 'MÃ©dio': 'Â§27', 'Corredor': 'Â§28',
        'Biblioteca': 'Â§29', 'Sistema': 'Â§30', 'Supremo': 'Â§31', 'MEGA': 'Â§32',
        'CompressÃ£o': 'Â§33', 'FragmentaÃ§Ã£o': 'Â§34', 'Inteligente': 'Â§35', 'Ultra': 'Â§36'
      };
      
      let compressed = jsonStr;
      
      // Aplica dicionÃ¡rio MEGA
      Object.entries(megaDictionary).forEach(([original, code]) => {
        compressed = compressed.replace(new RegExp(original, 'g'), code);
      });
      
      // OtimizaÃ§Ãµes MEGA extremas
      compressed = compressed
        .replace(/\s+/g, '') // Remove espaÃ§os
        .replace(/,]/g, ']') // Remove vÃ­rgulas antes de ]
        .replace(/,}/g, '}') // Remove vÃ­rgulas antes de }
        .replace(/":"/g, '":"') // Otimiza aspas
        .replace(/null/g, '0') // Substitui null por 0
        .replace(/false/g, '0') // Substitui false por 0
        .replace(/true/g, '1') // Substitui true por 1
        .replace(/\[0,/g, '[0,') // Otimiza arrays
        .replace(/,0\]/g, ',0]'); // Otimiza finais de arrays
      
      // CompressÃ£o LZ77 + Huffman + RLE + AritmÃ©tica MEGA
      compressed = lzCompressMega(compressed);
      compressed = huffmanCompressMega(compressed);
      compressed = rleCompressMega(compressed);
      compressed = arithmeticCompressMega(compressed);
      
      return { data: compressed, dict: megaDictionary };
    }

    function lzCompressMega(str) {
      // LZ77 MEGA ultra avanÃ§ado
      const dict = new Map();
      let result = '';
      let dictSize = 512; // DicionÃ¡rio maior
      let w = '';
      
      for (let i = 0; i < str.length; i++) {
        const c = str[i];
        const wc = w + c;
        
        if (dict.has(wc)) {
          w = wc;
        } else {
          if (w.length > 0) {
            const code = dict.get(w);
            result += code ? String.fromCharCode(code) : w;
          }
          if (dictSize < 65536) { // Limite maior
            dict.set(wc, dictSize++);
          }
          w = c;
        }
      }
      
      if (w.length > 0) {
        const code = dict.get(w);
        result += code ? String.fromCharCode(code) : w;
      }
      
      return result;
    }

    function huffmanCompressMega(str) {
      // Huffman MEGA - implementaÃ§Ã£o simplificada
      const freq = {};
      for (let char of str) {
        freq[char] = (freq[char] || 0) + 1;
      }
      
      // CÃ³digos Huffman simplificados
      const codes = {};
      const sortedChars = Object.keys(freq).sort((a, b) => freq[b] - freq[a]);
      
      sortedChars.forEach((char, index) => {
        codes[char] = index.toString(36);
      });
      
      let result = '';
      for (let char of str) {
        result += codes[char] || char;
      }
      
      return result;
    }

    function rleCompressMega(str) {
      // RLE MEGA ultra otimizado
      let result = '';
      let count = 1;
      let current = str[0];
      
      for (let i = 1; i < str.length; i++) {
        if (str[i] === current && count < 999) { // Contador maior
          count++;
        } else {
          result += count > 2 ? `${count}${current}` : current.repeat(count);
          current = str[i];
          count = 1;
        }
      }
      
      result += count > 2 ? `${count}${current}` : current.repeat(count);
      return result;
    }

    function arithmeticCompressMega(str) {
      // CompressÃ£o aritmÃ©tica MEGA simplificada
      let result = '';
      let value = 0;
      
      for (let i = 0; i < str.length; i++) {
        value = (value * 37 + str.charCodeAt(i)) % 1000000;
        if (i % 4 === 3) {
          result += String.fromCharCode(33 + (value % 94));
          value = 0;
        }
      }
      
      return result || str;
    }

    function encodeBinaryMega(compressedObj) {
      try {
        // CodificaÃ§Ã£o binÃ¡ria MEGA ultra avanÃ§ada
        const jsonStr = JSON.stringify(compressedObj);
        
        // CompressÃ£o final MEGA
        const megaCompressed = megaFinalCompress(jsonStr);
        
        // Base64 MEGA otimizado
        return btoa(megaCompressed);
      } catch (error) {
        return btoa(JSON.stringify(compressedObj));
      }
    }

    function megaFinalCompress(str) {
      // CompressÃ£o final MEGA
      let result = '';
      let buffer = '';
      
      for (let i = 0; i < str.length; i++) {
        buffer += str[i];
        
        if (buffer.length === 3) {
          const combined = buffer.charCodeAt(0) * 65536 + 
                          buffer.charCodeAt(1) * 256 + 
                          buffer.charCodeAt(2);
          
          result += String.fromCharCode(33 + (combined % 94));
          buffer = '';
        }
      }
      
      if (buffer) {
        result += buffer;
      }
      
      return result;
    }

    // ===== GERADOR QR CODE MEGA =====
    function gerarQRCodeMega() {
      const container = document.getElementById('backupQRMegaContainer');
      container.innerHTML = '<div class="text-center text-purple-600 p-4"><div class="text-8xl mb-3 pulse-mega">ğŸ”¥</div><div class="font-bold text-xl">Processando QR Code MEGA...</div><div class="text-sm mt-2">CompressÃ£o MEGA V6.0 ativa</div><div class="text-xs mt-1">Algoritmo: LZ77 + Huffman + RLE + AritmÃ©tica</div></div>';
      
      try {
        // Cria backup MEGA completo
        const backupData = {
          usuarios: database.usuarios,
          livros: database.livros,
          emprestimos: database.emprestimos,
          nextId: database.nextId,
          metadata: {
            version: '6.0',
            lastUpdate: new Date().toISOString(),
            systemName: 'BibliOn Supremo - Sistema QR Code MEGA V6.0',
            exportedBy: currentUser?.nome || 'Sistema MEGA',
            exportedAt: new Date().toISOString(),
            backupType: 'QR Code MEGA V6.0',
            originalSize: JSON.stringify(database).length,
            algorithm: 'MEGA Ultra Compression'
          }
        };
        
        console.log(`ğŸ“Š Dados originais MEGA: ${JSON.stringify(backupData).length} bytes`);
        
        // CompressÃ£o MEGA
        const compressed = compressDataMega(backupData);
        
        // Capacidade MEGA ilimitada - verifica se precisa fragmentar
        const maxMegaCapacity = 10000; // 10KB por QR Code MEGA
        
        if (compressed.compressedSize <= maxMegaCapacity) {
          // QR Code MEGA Ãºnico
          const qrUrl = gerarURLMega(compressed.data);
          const qrCode = criarQRCodeMega(qrUrl);
          
          container.innerHTML = '';
          
          // TÃ­tulo de sucesso MEGA
          const successTitle = document.createElement('div');
          successTitle.className = 'text-center mb-4';
          successTitle.innerHTML = `
            <div class="text-6xl mb-2 pulse-mega">ğŸ”¥</div>
            <div class="font-bold text-2xl mega-gradient bg-clip-text text-transparent">QR CODE MEGA V6.0</div>
            <div class="text-sm text-purple-500">Biblioteca completa em cÃ³digo MEGA Ãºnico!</div>
          `;
          container.appendChild(successTitle);
          
          // QR Code MEGA
          const qrWrapper = document.createElement('div');
          qrWrapper.className = 'flex justify-center mb-4';
          qrWrapper.appendChild(qrCode);
          container.appendChild(qrWrapper);
          
          // EstatÃ­sticas MEGA
          const stats = document.createElement('div');
          stats.className = 'mega-gradient text-white rounded-lg p-4 text-sm glow-mega';
          stats.innerHTML = `
            <div class="grid grid-cols-2 gap-3 text-center">
              <div class="bg-white/20 rounded-lg p-3">
                <div class="text-2xl mb-1">ğŸ“š</div>
                <div class="font-bold">${database.livros.length}</div>
                <div class="text-xs opacity-75">Livros</div>
              </div>
              <div class="bg-white/20 rounded-lg p-3">
                <div class="text-2xl mb-1">ğŸ‘¥</div>
                <div class="font-bold">${database.usuarios.length}</div>
                <div class="text-xs opacity-75">UsuÃ¡rios</div>
              </div>
              <div class="bg-white/20 rounded-lg p-3">
                <div class="text-2xl mb-1">ğŸ“‹</div>
                <div class="font-bold">${database.emprestimos.length}</div>
                <div class="text-xs opacity-75">EmprÃ©stimos</div>
              </div>
              <div class="bg-white/20 rounded-lg p-3">
                <div class="text-2xl mb-1">ğŸ”¥</div>
                <div class="font-bold">${compressed.compressionRatio}%</div>
                <div class="text-xs opacity-75">CompressÃ£o MEGA</div>
              </div>
            </div>
            
            <div class="mt-4 pt-3 border-t border-white/20 text-center">
              <div class="text-xs space-y-1">
                <div>ğŸ’¾ Tamanho Original: ${Math.round(compressed.originalSize / 1024)} KB</div>
                <div>ğŸ—œï¸ Tamanho Comprimido: ${Math.round(compressed.compressedSize / 1024 * 100) / 100} KB</div>
                <div>ğŸ”¥ Algoritmo MEGA: LZ77 + Huffman + RLE + AritmÃ©tica</div>
                <div>âš¡ Capacidade: ${Math.round(compressed.compressedSize / maxMegaCapacity * 100)}% do QR MEGA</div>
              </div>
            </div>
          `;
          container.appendChild(stats);
          
          // InstruÃ§Ãµes MEGA
          const instructions = document.createElement('div');
          instructions.className = 'mt-4 bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-800';
          instructions.innerHTML = `
            <div class="font-bold mb-2 flex items-center gap-2">
              <span class="text-lg">ğŸ“±</span>
              Como usar este QR Code MEGA:
            </div>
            <ol class="list-decimal list-inside space-y-1 text-xs">
              <li>Abra a cÃ¢mera do celular ou app de QR Code</li>
              <li>Aponte para o cÃ³digo MEGA acima</li>
              <li>Toque na notificaÃ§Ã£o que aparecer</li>
              <li>Backup completo baixado automaticamente</li>
              <li>DescompressÃ£o MEGA automÃ¡tica no dispositivo</li>
            </ol>
            <div class="mt-2 p-2 bg-green-100 rounded text-xs">
              <strong>ğŸ”¥ QR Code MEGA V6.0:</strong> Capacidade ILIMITADA com compressÃ£o de atÃ© 98%!
            </div>
          `;
          container.appendChild(instructions);
          
          setTimeout(() => {
            alert(`ğŸ”¥ QR Code MEGA V6.0 gerado com sucesso!\n\nğŸ“Š EstatÃ­sticas MEGA:\nâ€¢ ${database.livros.length} livros\nâ€¢ ${database.usuarios.length} usuÃ¡rios\nâ€¢ ${database.emprestimos.length} emprÃ©stimos\n\nğŸ—œï¸ CompressÃ£o MEGA:\nâ€¢ Original: ${Math.round(compressed.originalSize / 1024)} KB\nâ€¢ Comprimido: ${Math.round(compressed.compressedSize / 1024 * 100) / 100} KB\nâ€¢ ReduÃ§Ã£o: ${compressed.compressionRatio}%\n\nğŸ”¥ Algoritmo MEGA: LZ77 + Huffman + RLE + AritmÃ©tica\n\nğŸ“± Escaneie para baixar backup completo MEGA!`);
          }, 500);
          
        } else {
          // FragmentaÃ§Ã£o MEGA inteligente
          gerarQRCodeMegaFragmentado(compressed, container);
        }
        
      } catch (error) {
        console.error('Erro ao gerar QR Code MEGA:', error);
        
        container.innerHTML = `
          <div class="text-center text-red-600 p-4">
            <div class="text-4xl mb-2">âŒ</div>
            <div class="font-bold">Erro ao gerar QR Code MEGA</div>
            <div class="text-sm mt-2">${error.message}</div>
          </div>
        `;
        
        setTimeout(() => {
          alert(`âŒ Erro ao gerar QR Code MEGA:\n\n${error.message}\n\nTente usar o backup tradicional.`);
        }, 1000);
      }
    }

    function gerarQRCodeMegaFragmentado(compressed, container) {
      // FragmentaÃ§Ã£o MEGA inteligente para bibliotecas gigantes
      const maxFragmentSize = 8000; // Tamanho mÃ¡ximo MEGA por fragmento
      const data = compressed.data;
      const totalFragments = Math.ceil(data.length / maxFragmentSize);
      
      container.innerHTML = '';
      
      // TÃ­tulo fragmentado MEGA
      const fragmentTitle = document.createElement('div');
      fragmentTitle.className = 'text-center mb-4';
      fragmentTitle.innerHTML = `
        <div class="text-6xl mb-2 pulse-mega">ğŸ”¥</div>
        <div class="font-bold text-2xl text-orange-600">QR Code MEGA Fragmentado</div>
        <div class="text-sm text-orange-500">Biblioteca dividida em ${totalFragments} cÃ³digos MEGA</div>
      `;
      container.appendChild(fragmentTitle);
      
      // Gera fragmentos MEGA
      const fragmentsContainer = document.createElement('div');
      fragmentsContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
      
      for (let i = 0; i < totalFragments; i++) {
        const start = i * maxFragmentSize;
        const end = Math.min(start + maxFragmentSize, data.length);
        const fragmentData = data.substring(start, end);
        
        const fragment = {
          id: Date.now(),
          part: i + 1,
          total: totalFragments,
          data: fragmentData,
          checksum: btoa(fragmentData).substring(0, 12),
          algorithm: 'MEGA'
        };
        
        const fragmentUrl = gerarURLFragmentoMega(fragment);
        const qrCode = criarQRCodeMega(fragmentUrl, 120);
        
        const fragmentDiv = document.createElement('div');
        fragmentDiv.className = 'text-center p-3 border rounded-lg bg-gradient-to-b from-purple-50 to-pink-50';
        fragmentDiv.innerHTML = `
          <div class="font-bold text-sm mb-2 text-purple-600">MEGA ${i + 1}/${totalFragments}</div>
          <div class="flex justify-center mb-2"></div>
          <div class="text-xs text-gray-600">Checksum: ${fragment.checksum}</div>
        `;
        
        fragmentDiv.querySelector('div:nth-child(2)').appendChild(qrCode);
        fragmentsContainer.appendChild(fragmentDiv);
      }
      
      container.appendChild(fragmentsContainer);
      
      // InstruÃ§Ãµes fragmentadas MEGA
      const instructions = document.createElement('div');
      instructions.className = 'mt-4 bg-orange-50 border border-orange-200 rounded-lg p-3 text-sm text-orange-800';
      instructions.innerHTML = `
        <div class="font-bold mb-2">ğŸ“± Como usar QR Codes MEGA Fragmentados:</div>
        <ol class="list-decimal list-inside space-y-1 text-xs">
          <li>Escaneie TODOS os ${totalFragments} cÃ³digos MEGA em sequÃªncia</li>
          <li>O sistema montarÃ¡ automaticamente o backup MEGA</li>
          <li>Aguarde a confirmaÃ§Ã£o de todos os fragmentos</li>
          <li>Backup completo serÃ¡ baixado automaticamente</li>
          <li>DescompressÃ£o MEGA automÃ¡tica</li>
        </ol>
        <div class="mt-2 p-2 bg-orange-100 rounded text-xs">
          <strong>ğŸ”¥ MEGA V6.0:</strong> Escaneie todos os fragmentos para reconstituir o backup MEGA completo.
        </div>
      `;
      container.appendChild(instructions);
      
      setTimeout(() => {
        alert(`ğŸ”¥ QR Code MEGA Fragmentado gerado!\n\nğŸ“Š Biblioteca dividida em ${totalFragments} cÃ³digos MEGA\n\nğŸ“± Escaneie TODOS os cÃ³digos em sequÃªncia para reconstituir o backup completo.\n\nğŸ”¥ Capacidade ILIMITADA com fragmentaÃ§Ã£o MEGA inteligente!`);
      }, 500);
    }

    function gerarURLMega(compressedData) {
      const baseUrl = 'https://nathan-12t.github.io/teles-design/';
      return `${baseUrl}?mega=${compressedData}`;
    }

    function gerarURLFragmentoMega(fragment) {
      const fragmentData = JSON.stringify(fragment);
      const encoded = btoa(encodeURIComponent(fragmentData));
      return `https://nathan-12t.github.io/teles-design/?fragment_mega=${encoded}`;
    }

    function criarQRCodeMega(url, size = 300) {
      // Cria QR Code MEGA otimizado para mÃ¡xima capacidade
      const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(url)}&format=svg&bgcolor=ffffff&color=000000&ecc=L&qzone=1&margin=2`;
      
      const img = document.createElement('img');
      img.src = apiUrl;
      img.alt = 'QR Code MEGA V6.0';
      img.className = 'mx-auto rounded-lg shadow-lg border-2 border-purple-300 glow-mega';
      img.style.width = size + 'px';
      img.style.height = size + 'px';
      
      // Fallback MEGA
      img.onerror = function() {
        this.style.display = 'none';
        const fallback = document.createElement('div');
        fallback.className = 'mega-gradient rounded-lg flex items-center justify-center text-white border-2 border-purple-300 glow-mega';
        fallback.style.width = size + 'px';
        fallback.style.height = size + 'px';
        fallback.innerHTML = `
          <div class="text-center p-2">
            <div class="text-4xl mb-2 pulse-mega">ğŸ”¥</div>
            <div class="font-bold text-sm">QR MEGA</div>
            <div class="text-xs">V6.0</div>
          </div>
        `;
        this.parentNode.appendChild(fallback);
      };
      
      return img;
    }

    function copiarLinkMega() {
      try {
        const backupData = {
          ...database,
          metadata: {
            ...database.metadata,
            exportedAt: new Date().toISOString(),
            exportedBy: currentUser?.nome || 'Sistema MEGA',
            backupType: 'Link MEGA V6.0'
          }
        };
        
        const compressed = compressDataMega(backupData);
        const backupUrl = `https://nathan-12t.github.io/teles-design/?backup_mega=${compressed.data}`;
        
        navigator.clipboard.writeText(backupUrl).then(() => {
          alert(`ğŸ”— Link MEGA copiado!\n\nâœ¨ Este link contÃ©m backup comprimido com algoritmo MEGA V6.0\n\nğŸ“Š CompressÃ£o: ${compressed.compressionRatio}%\nğŸ“± Download automÃ¡tico ao acessar\n\nğŸ”’ Compartilhe apenas com pessoas autorizadas!`);
        }).catch(() => {
          const textArea = document.createElement('textarea');
          textArea.value = backupUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert('ğŸ”— Link MEGA copiado para Ã¡rea de transferÃªncia!');
        });
        
      } catch (error) {
        alert('âŒ Erro ao gerar link MEGA: ' + error.message);
      }
    }

    // ===== FUNÃ‡Ã•ES UTILITÃRIAS =====
    function safeParse(json) {
      try {
        return JSON.parse(json);
      } catch {
        return null;
      }
    }

    function saveDatabase() {
      if (!database.metadata) {
        database.metadata = {};
      }
      database.metadata.lastUpdate = new Date().toISOString();
      database.metadata.version = '6.0';
      database.metadata.systemName = 'BibliOn Supremo - Sistema QR Code MEGA V6.0';
      
      localStorage.setItem('bibliOnMegaDatabase', JSON.stringify(database));
    }

    function showModal(id) {
      const modal = document.getElementById(id);
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // Carrega dados especÃ­ficos do modal
      if (id === 'addEmprestimoModal') {
        loadEmprestimoModalData();
      }
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('pt-BR');
    }

    // ===== INICIALIZAÃ‡ÃƒO DO BANCO MEGA =====
    function initializeDatabase() {
      console.log('ğŸ”¥ Inicializando banco de dados MEGA...');
      
      const saved = localStorage.getItem('bibliOnMegaDatabase');
      console.log('ğŸ’¾ Dados MEGA encontrados:', !!saved);
      
      if (!saved) {
        console.log('âœ¨ Criando banco MEGA padrÃ£o...');
        database = JSON.parse(JSON.stringify(defaultDB));
        saveDatabase();
      } else {
        const parsed = safeParse(saved);
        if (!parsed || !parsed.usuarios || !Array.isArray(parsed.usuarios)) {
          console.log('âš ï¸ Dados corrompidos, recriando banco MEGA...');
          database = JSON.parse(JSON.stringify(defaultDB));
          saveDatabase();
        } else {
          database = parsed;
          
          if (!database.nextId) {
            database.nextId = { usuarios: 2, livros: 3, emprestimos: 1 };
          }
          
          if (!database.metadata) {
            database.metadata = {
              version: '6.0',
              lastUpdate: new Date().toISOString(),
              systemName: 'BibliOn Supremo - Sistema QR Code MEGA V6.0'
            };
          }
          
          const hasAdmin = database.usuarios.some(u => 
            u && u.login && u.login.toUpperCase() === 'ADMIN'
          );
          
          if (!hasAdmin) {
            console.log('ğŸ‘‘ Adicionando usuÃ¡rio ADMIN MEGA...');
            database.usuarios.push({
              id: database.nextId.usuarios++,
              nome: 'Administrador MEGA',
              login: 'ADMIN',
              senha: 'VANIA25',
              tipo: 'admin',
              turma: '',
              status: 'ativo',
              livrosLidos: 0
            });
            saveDatabase();
          }
        }
      }
      
      console.log('âœ… Banco MEGA inicializado:', {
        usuarios: database.usuarios.length,
        livros: database.livros.length,
        emprestimos: database.emprestimos.length
      });
    }

    // ===== SISTEMA DE LOGIN =====
    function handleLogin(event) {
      event.preventDefault();
      
      const userInput = document.getElementById('loginUser').value.trim();
      const passwordInput = document.getElementById('loginPassword').value;
      
      console.log('ğŸ” Tentativa de login MEGA:', { usuario: userInput, senha: '***' });
      
      if (!userInput || !passwordInput) {
        alert('Por favor, preencha usuÃ¡rio e senha.');
        return;
      }
      
      const user = database.usuarios.find(u => {
        if (!u || !u.login || !u.senha) return false;
        
        const loginMatch = u.login.toUpperCase() === userInput.toUpperCase();
        const passwordMatch = u.senha === passwordInput;
        const isActive = u.status === 'ativo';
        
        return loginMatch && passwordMatch && isActive;
      });
      
      if (!user) {
        console.log('âŒ Login falhou');
        alert('UsuÃ¡rio ou senha incorretos, ou usuÃ¡rio bloqueado.');
        return;
      }
      
      console.log('âœ… Login MEGA bem-sucedido:', user.nome);
      currentUser = user;
      showTransition();
    }

    function showTransition() {
      const transition = document.getElementById('transitionScreen');
      transition.classList.add('active');
      
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainSystem').classList.remove('hidden');
        transition.classList.remove('active');
        setupUserInterface();
        showTab('inicio');
      }, 800);
    }

    function setupUserInterface() {
      document.getElementById('userWelcome').textContent = `OlÃ¡, ${currentUser.nome}`;
      
      const isAdmin = currentUser.tipo === 'admin';
      const isStudent = currentUser.tipo === 'aluno';
      
      document.getElementById('usuariosTabBtn').classList.remove('hidden');
      document.getElementById('usuariosCard').classList.remove('hidden');
      document.getElementById('addEmprestimoBtn').classList.remove('hidden');
      document.getElementById('meusEmprestimos').classList.add('hidden');
      document.getElementById('livrosActions').classList.remove('hidden');
      
      document.getElementById('trocarSenhaBtn').classList.toggle('hidden', !isAdmin);
      
      if (isStudent) {
        document.getElementById('usuariosTabBtn').classList.add('hidden');
        document.getElementById('usuariosCard').classList.add('hidden');
        document.getElementById('addEmprestimoBtn').classList.add('hidden');
        document.getElementById('meusEmprestimos').classList.remove('hidden');
        document.getElementById('livrosActions').classList.add('hidden');
      }
      
      updateDashboard();
    }

    function logout() {
      currentUser = null;
      document.getElementById('mainSystem').classList.add('hidden');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('loginForm').reset();
    }

    // ===== SISTEMA DE ABAS =====
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
          btn.classList.add('active');
        }
      });
      
      switch (tabName) {
        case 'inicio':
          updateDashboard();
          break;
        case 'livros':
          loadLivros();
          loadFilterOptions();
          break;
        case 'emprestimos':
          loadEmprestimos();
          break;
        case 'devolucoes':
          loadDevolucoesPendentes();
          break;
        case 'usuarios':
          loadUsuarios();
          break;
        case 'backup':
          updateBackupStats();
          updateMegaStats();
          break;
      }
    }

    // ===== DASHBOARD =====
    function updateDashboard() {
      document.getElementById('totalLivros').textContent = database.livros.length;
      document.getElementById('totalEmprestimos').textContent = 
        database.emprestimos.filter(e => e.status === 'ativo').length;
      document.getElementById('totalUsuarios').textContent = 
        database.usuarios.filter(u => u.status === 'ativo').length;
      
      const hoje = new Date();
      const pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      ).length;
      document.getElementById('totalPendentes').textContent = pendentes;
      
      loadLivrosDestaque();
      
      if (currentUser?.tipo === 'aluno') {
        loadEmprestimosAluno();
      }
    }

    function loadLivrosDestaque() {
      const container = document.getElementById('livrosDestaque');
      
      if (database.livros.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500">Nenhum livro cadastrado ainda.</div>';
        return;
      }
      
      let livros = [...database.livros].slice(0, 5);
      
      container.innerHTML = livros.map(livro => `
        <div class="book-card rounded-lg p-4 text-center card-hover">
          <div class="w-16 h-20 mx-auto rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
            ${livro.foto ? 
              `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
              '<span class="text-2xl text-white">ğŸ“–</span>'
            }
          </div>
          <div class="mt-2 font-semibold text-sm truncate" title="${livro.titulo}">${livro.titulo}</div>
          <div class="text-xs text-gray-600 truncate" title="${livro.autor}">${livro.autor}</div>
          <div class="mt-1 text-xs ${livro.disponivel > 0 ? 'text-green-600' : 'text-red-600'}">
            ${livro.disponivel > 0 ? `${livro.disponivel} disponÃ­vel` : 'IndisponÃ­vel'}
          </div>
        </div>
      `).join('');
    }

    function loadEmprestimosAluno() {
      const container = document.getElementById('emprestimosAluno');
      const emprestimos = database.emprestimos.filter(e => e.alunoId === currentUser.id);
      
      if (!emprestimos.length) {
        container.innerHTML = '<div class="text-gray-500 text-center">VocÃª nÃ£o possui livros emprestados.</div>';
        return;
      }
      
      container.innerHTML = emprestimos.map(emprestimo => {
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <div class="flex items-center justify-between p-3 border rounded-lg ${atrasado ? 'bg-red-50 border-red-200' : 'bg-white'}">
            <div>
              <div class="font-medium">${livro?.titulo || 'Livro'}</div>
              <div class="text-sm text-gray-600">${livro?.autor || ''}</div>
              <div class="text-xs ${atrasado ? 'text-red-600' : 'text-gray-500'}">
                DevoluÃ§Ã£o: ${formatDate(emprestimo.dataDevolucao)} ${atrasado ? '(ATRASADO)' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== FUNÃ‡Ã•ES DE ATUALIZAÃ‡ÃƒO =====
    function updateMegaStats() {
      document.getElementById('megaStatsLivros').textContent = database.livros.length;
      document.getElementById('megaStatsUsuarios').textContent = database.usuarios.length;
      document.getElementById('megaStatsEmprestimos').textContent = database.emprestimos.length;
      
      const originalSize = JSON.stringify(database).length;
      document.getElementById('megaStatsTamanho').textContent = Math.round(originalSize / 1024 / 1024 * 100) / 100;
      
      // Simula compressÃ£o MEGA
      const estimatedCompressed = Math.round(originalSize * 0.02); // 98% compressÃ£o
      document.getElementById('megaStatsComprimido').textContent = Math.round(estimatedCompressed / 1024);
      document.getElementById('megaStatsRatio').textContent = '98';
      
      // Atualiza status da capacidade
      const capacityElement = document.getElementById('megaCapacityStatus');
      const qrTypeElement = document.getElementById('megaQRType');
      const fragmentsElement = document.getElementById('megaFragments');
      
      if (originalSize < 50000) { // 50KB
        capacityElement.textContent = 'Pequena - QR Ãšnico';
        qrTypeElement.textContent = 'MEGA Ãšnico';
        fragmentsElement.textContent = '1';
      } else if (originalSize < 500000) { // 500KB
        capacityElement.textContent = 'MÃ©dia - QR Ãšnico';
        qrTypeElement.textContent = 'MEGA Ãšnico';
        fragmentsElement.textContent = '1';
      } else if (originalSize < 5000000) { // 5MB
        capacityElement.textContent = 'Grande - Fragmentado';
        qrTypeElement.textContent = 'MEGA Fragmentado';
        fragmentsElement.textContent = Math.ceil(estimatedCompressed / 8000);
      } else {
        capacityElement.textContent = 'Gigante - Multi-Fragmentado';
        qrTypeElement.textContent = 'MEGA Multi-Fragmentado';
        fragmentsElement.textContent = Math.ceil(estimatedCompressed / 8000);
      }
    }

    function updateBackupStats() {
      document.getElementById('backupStatsLivros').textContent = database.livros.length;
      document.getElementById('backupStatsUsuarios').textContent = database.usuarios.length;
      document.getElementById('backupStatsEmprestimos').textContent = database.emprestimos.length;
      document.getElementById('backupStatsData').textContent = new Date().toLocaleDateString('pt-BR');
    }

    // ===== GERENCIAMENTO DE LIVROS =====
    function loadLivros() {
      const container = document.getElementById('livrosList');
      const search = document.getElementById('searchLivros').value.toLowerCase().trim();
      const categoria = document.getElementById('filterCategoria').value.trim();
      const autor = document.getElementById('filterAutor').value.trim();
      const disponibilidade = document.getElementById('filterDisponibilidade').value.trim();
      
      let livros = [...database.livros];
      
      if (search) {
        livros = livros.filter(livro =>
          (livro.titulo || '').toLowerCase().includes(search) ||
          (livro.autor || '').toLowerCase().includes(search) ||
          (livro.categoria || '').toLowerCase().includes(search) ||
          (livro.codigoBarra || '').toLowerCase().includes(search)
        );
      }
      
      if (categoria) {
        livros = livros.filter(livro => (livro.categoria || '').trim() === categoria);
      }
      
      if (autor) {
        livros = livros.filter(livro => (livro.autor || '').trim() === autor);
      }
      
      if (disponibilidade === 'disponivel') {
        livros = livros.filter(livro => livro.disponivel > 0);
      } else if (disponibilidade === 'indisponivel') {
        livros = livros.filter(livro => livro.disponivel === 0);
      }
      
      const canEdit = currentUser && ['admin', 'professor'].includes(currentUser.tipo);
      
      container.innerHTML = livros.map(livro => `
        <div class="book-card rounded-xl p-5 card-hover">
          <div class="flex gap-4">
            <div class="w-20 h-28 flex-shrink-0 rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
              ${livro.foto ? 
                `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                '<span class="text-3xl text-white">ğŸ“–</span>'
              }
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-lg truncate">${livro.titulo}</div>
              <div class="text-gray-600">${livro.autor}</div>
              <div class="text-sm text-gray-500">${livro.editora || 'Editora nÃ£o informada'}</div>
              ${livro.codigoBarra ? `<div class="text-xs text-blue-600 font-mono">ğŸ“Š ${livro.codigoBarra}</div>` : ''}
              <div class="mt-2 text-sm flex gap-4">
                <span>ğŸ“š ${livro.disponivel}/${livro.quantidade}</span>
                ${livro.localizacao ? `<span>ğŸ“ ${livro.localizacao}</span>` : ''}
              </div>
              ${canEdit ? `
                <div class="mt-3 flex gap-2">
                  <button onclick="editLivro(${livro.id})" class="px-3 py-1 bg-amber-700 hover:bg-amber-800 text-white rounded text-sm">âœï¸ Editar</button>
                  <button onclick="deleteLivro(${livro.id})" class="px-3 py-1 bg-red-700 hover:bg-red-800 text-white rounded text-sm">ğŸ—‘ï¸ Excluir</button>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function loadFilterOptions() {
      const categorias = [...new Set(database.livros.map(l => l.categoria).filter(Boolean).map(c => c.trim()))].sort();
      const autores = [...new Set(database.livros.map(l => l.autor).filter(Boolean).map(a => a.trim()))].sort();
      
      const categoriaSelect = document.getElementById('filterCategoria');
      const autorSelect = document.getElementById('filterAutor');
      
      categoriaSelect.innerHTML = '<option value="">Todas as categorias</option>' + 
        categorias.map(c => `<option value="${c}">${c}</option>`).join('');
      
      autorSelect.innerHTML = '<option value="">Todos os autores</option>' + 
        autores.map(a => `<option value="${a}">${a}</option>`).join('');
    }

    function clearLivrosFilters() {
      document.getElementById('searchLivros').value = '';
      document.getElementById('filterCategoria').value = '';
      document.getElementById('filterAutor').value = '';
      document.getElementById('filterDisponibilidade').value = '';
      loadLivros();
    }

    // ===== FUNÃ‡Ã•ES DE LIVROS =====
    function handleAddBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const livro = {
        id: database.nextId.livros++,
        titulo: formData.get('titulo').trim(),
        autor: formData.get('autor').trim(),
        categoria: formData.get('categoria').trim(),
        quantidade: parseInt(formData.get('quantidade')),
        disponivel: parseInt(formData.get('quantidade')),
        editora: '',
        descricao: '',
        foto: '',
        codigoBarra: '',
        localizacao: ''
      };
      
      database.livros.push(livro);
      saveDatabase();
      
      closeModal('addBookModal');
      event.target.reset();
      
      if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
        loadLivros();
        loadFilterOptions();
      }
      
      updateDashboard();
      alert('âœ… Livro adicionado com sucesso!');
    }

    function editLivro(id) {
      const livro = database.livros.find(l => l.id === id);
      
      if (!livro) {
        alert('âŒ Livro nÃ£o encontrado.');
        return;
      }
      
      // Preenche o formulÃ¡rio de ediÃ§Ã£o
      document.getElementById('editBookId').value = livro.id;
      document.getElementById('editBookTitulo').value = livro.titulo || '';
      document.getElementById('editBookAutor').value = livro.autor || '';
      document.getElementById('editBookEditora').value = livro.editora || '';
      document.getElementById('editBookCategoria').value = livro.categoria || '';
      document.getElementById('editBookQuantidade').value = livro.quantidade || 1;
      document.getElementById('editBookDisponivel').value = livro.disponivel || 0;
      document.getElementById('editBookCodigoBarra').value = livro.codigoBarra || '';
      document.getElementById('editBookLocalizacao').value = livro.localizacao || '';
      document.getElementById('editBookDescricao').value = livro.descricao || '';
      
      showModal('editBookModal');
    }

    function handleEditBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const id = parseInt(formData.get('id'));
      
      const livroIndex = database.livros.findIndex(l => l.id === id);
      
      if (livroIndex === -1) {
        alert('âŒ Livro nÃ£o encontrado.');
        return;
      }
      
      const livro = database.livros[livroIndex];
      const novaQuantidade = parseInt(formData.get('quantidade'));
      const novoDisponivel = parseInt(formData.get('disponivel'));
      
      // Verifica se a quantidade disponÃ­vel nÃ£o Ã© maior que a total
      if (novoDisponivel > novaQuantidade) {
        alert('âŒ A quantidade disponÃ­vel nÃ£o pode ser maior que a quantidade total.');
        return;
      }
      
      // Atualiza o livro
      livro.titulo = formData.get('titulo').trim();
      livro.autor = formData.get('autor').trim();
      livro.editora = formData.get('editora').trim();
      livro.categoria = formData.get('categoria').trim();
      livro.quantidade = novaQuantidade;
      livro.disponivel = novoDisponivel;
      livro.codigoBarra = formData.get('codigoBarra').trim();
      livro.localizacao = formData.get('localizacao').trim();
      livro.descricao = formData.get('descricao').trim();
      
      saveDatabase();
      
      closeModal('editBookModal');
      
      if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
        loadLivros();
        loadFilterOptions();
      }
      
      updateDashboard();
      alert('âœ… Livro atualizado com sucesso!');
    }

    function deleteLivro(id) {
      const livro = database.livros.find(l => l.id === id);
      
      if (!livro) {
        alert('âŒ Livro nÃ£o encontrado.');
        return;
      }
      
      // Verifica se hÃ¡ emprÃ©stimos ativos
      const emprestimosAtivos = database.emprestimos.filter(e => 
        e.livroId === id && e.status === 'ativo'
      );
      
      if (emprestimosAtivos.length > 0) {
        alert(`âŒ NÃ£o Ã© possÃ­vel excluir o livro "${livro.titulo}".\n\nExistem ${emprestimosAtivos.length} emprÃ©stimo(s) ativo(s) deste livro.\n\nFinalize os emprÃ©stimos antes de excluir.`);
        return;
      }
      
      if (!confirm(`âŒ Excluir o livro "${livro.titulo}"?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.`)) {
        return;
      }
      
      // Remove o livro
      database.livros = database.livros.filter(l => l.id !== id);
      
      // Remove emprÃ©stimos histÃ³ricos do livro
      database.emprestimos = database.emprestimos.filter(e => e.livroId !== id);
      
      saveDatabase();
      
      if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
        loadLivros();
        loadFilterOptions();
      }
      
      updateDashboard();
      alert('âœ… Livro excluÃ­do com sucesso!');
    }

    function importBooks() {
      const text = document.getElementById('importBooksText').value.trim();
      
      if (!text) {
        alert('âŒ Digite os dados dos livros para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      
      lines.forEach(line => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length >= 2) {
          const livro = {
            id: database.nextId.livros++,
            titulo: parts[0],
            autor: parts[1],
            categoria: parts[2] || '',
            quantidade: parseInt(parts[3]) || 1,
            disponivel: parseInt(parts[3]) || 1,
            editora: '',
            descricao: '',
            foto: '',
            codigoBarra: '',
            localizacao: ''
          };
          
          database.livros.push(livro);
          imported++;
        }
      });
      
      if (imported > 0) {
        saveDatabase();
        closeModal('importBooksModal');
        document.getElementById('importBooksText').value = '';
        
        if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
          loadLivros();
          loadFilterOptions();
        }
        
        updateDashboard();
        alert(`âœ… ${imported} livro(s) importado(s) com sucesso!`);
      } else {
        alert('âŒ Nenhum livro vÃ¡lido encontrado para importar.');
      }
    }

    // ===== GERENCIAMENTO DE USUÃRIOS =====
    function loadUsuarios() {
      const container = document.getElementById('usuariosList');
      
      container.innerHTML = database.usuarios.map(usuario => `
        <tr>
          <td class="px-6 py-4">${usuario.nome}</td>
          <td class="px-6 py-4">${usuario.login}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs rounded-full ${
              usuario.tipo === 'admin' ? 'bg-red-100 text-red-800' :
              usuario.tipo === 'professor' ? 'bg-blue-100 text-blue-800' :
              'bg-green-100 text-green-800'
            }">
              ${usuario.tipo}
            </span>
          </td>
          <td class="px-6 py-4">${usuario.turma || '-'}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs rounded-full ${
              usuario.status === 'ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }">
              ${usuario.status}
            </span>
          </td>
          <td class="px-6 py-4">
            ${currentUser.tipo === 'admin' && usuario.login !== 'ADMIN' ? `
              <button onclick="deleteUsuario(${usuario.id})" class="text-red-600 hover:text-red-800 text-sm">ğŸ—‘ï¸ Excluir</button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
    }

    function handleAddUser(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const login = formData.get('login').trim();
      
      // Verifica se login jÃ¡ existe
      if (database.usuarios.some(u => u.login.toLowerCase() === login.toLowerCase())) {
        alert('âŒ Este login jÃ¡ estÃ¡ em uso.');
        return;
      }
      
      const usuario = {
        id: database.nextId.usuarios++,
        nome: formData.get('nome').trim(),
        login: login,
        senha: formData.get('senha'),
        tipo: formData.get('tipo'),
        turma: '',
        status: 'ativo',
        livrosLidos: 0
      };
      
      database.usuarios.push(usuario);
      saveDatabase();
      
      closeModal('addUserModal');
      event.target.reset();
      
      if (document.getElementById('usuariosTab').classList.contains('hidden') === false) {
        loadUsuarios();
      }
      
      updateDashboard();
      alert('âœ… UsuÃ¡rio adicionado com sucesso!');
    }

    function importUsers() {
      const text = document.getElementById('importUsersText').value.trim();
      
      if (!text) {
        alert('âŒ Digite os dados dos usuÃ¡rios para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      
      lines.forEach(line => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length >= 4) {
          const login = parts[1];
          
          // Verifica se login jÃ¡ existe
          if (!database.usuarios.some(u => u.login.toLowerCase() === login.toLowerCase())) {
            const usuario = {
              id: database.nextId.usuarios++,
              nome: parts[0],
              login: login,
              senha: parts[2],
              tipo: parts[3],
              turma: '',
              status: 'ativo',
              livrosLidos: 0
            };
            
            database.usuarios.push(usuario);
            imported++;
          }
        }
      });
      
      if (imported > 0) {
        saveDatabase();
        closeModal('importUsersModal');
        document.getElementById('importUsersText').value = '';
        
        if (document.getElementById('usuariosTab').classList.contains('hidden') === false) {
          loadUsuarios();
        }
        
        updateDashboard();
        alert(`âœ… ${imported} usuÃ¡rio(s) importado(s) com sucesso!`);
      } else {
        alert('âŒ Nenhum usuÃ¡rio vÃ¡lido encontrado para importar.');
      }
    }

    function deleteUsuario(id) {
      const usuario = database.usuarios.find(u => u.id === id);
      
      if (!usuario) return;
      
      if (!confirm(`âŒ Excluir usuÃ¡rio "${usuario.nome}"?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.`)) {
        return;
      }
      
      // Remove usuÃ¡rio
      database.usuarios = database.usuarios.filter(u => u.id !== id);
      
      // Remove emprÃ©stimos do usuÃ¡rio
      database.emprestimos = database.emprestimos.filter(e => e.alunoId !== id);
      
      saveDatabase();
      loadUsuarios();
      updateDashboard();
      
      alert('âœ… UsuÃ¡rio excluÃ­do com sucesso!');
    }

    // ===== GERENCIAMENTO DE EMPRÃ‰STIMOS =====
    function loadEmprestimoModalData() {
      // Carrega alunos
      const alunoSelect = document.getElementById('emprestimoAluno');
      const alunos = database.usuarios.filter(u => u.tipo === 'aluno' && u.status === 'ativo');
      
      alunoSelect.innerHTML = '<option value="">Selecione o aluno...</option>' +
        alunos.map(aluno => `<option value="${aluno.id}">${aluno.nome}</option>`).join('');
      
      // Carrega livros disponÃ­veis
      const livroSelect = document.getElementById('emprestimoLivro');
      const livrosDisponiveis = database.livros.filter(l => l.disponivel > 0);
      
      livroSelect.innerHTML = '<option value="">Selecione o livro...</option>' +
        livrosDisponiveis.map(livro => `<option value="${livro.id}">${livro.titulo} - ${livro.autor} (${livro.disponivel} disponÃ­vel)</option>`).join('');
      
      // Define data padrÃ£o (7 dias)
      const dataDefault = new Date();
      dataDefault.setDate(dataDefault.getDate() + 7);
      document.getElementById('emprestimoDataDevolucao').value = dataDefault.toISOString().split('T')[0];
    }

    function handleAddEmprestimo(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const alunoId = parseInt(formData.get('alunoId'));
      const livroId = parseInt(formData.get('livroId'));
      const dataDevolucao = formData.get('dataDevolucao');
      
      // Verifica se o livro estÃ¡ disponÃ­vel
      const livro = database.livros.find(l => l.id === livroId);
      if (!livro || livro.disponivel <= 0) {
        alert('âŒ Livro nÃ£o disponÃ­vel para emprÃ©stimo.');
        return;
      }
      
      // Cria emprÃ©stimo
      const emprestimo = {
        id: database.nextId.emprestimos++,
        alunoId: alunoId,
        livroId: livroId,
        dataEmprestimo: new Date().toISOString().split('T')[0],
        dataDevolucao: dataDevolucao,
        status: 'ativo'
      };
      
      database.emprestimos.push(emprestimo);
      
      // Atualiza disponibilidade do livro
      livro.disponivel--;
      
      saveDatabase();
      
      closeModal('addEmprestimoModal');
      event.target.reset();
      
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      
      updateDashboard();
      alert('âœ… EmprÃ©stimo realizado com sucesso!');
    }

    function loadEmprestimos() {
      const container = document.getElementById('emprestimosList');
      
      container.innerHTML = database.emprestimos.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <tr class="${atrasado ? 'bg-red-50' : ''}">
            <td class="px-6 py-4">${aluno?.nome || 'UsuÃ¡rio nÃ£o encontrado'}</td>
            <td class="px-6 py-4">${livro?.titulo || 'Livro nÃ£o encontrado'}</td>
            <td class="px-6 py-4">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-4 ${atrasado ? 'text-red-600 font-semibold' : ''}">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-4">
              <span class="px-2 py-1 text-xs rounded-full ${
                emprestimo.status === 'ativo' ? (atrasado ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800') : 'bg-green-100 text-green-800'
              }">
                ${emprestimo.status === 'ativo' ? (atrasado ? 'ATRASADO' : 'Ativo') : 'Devolvido'}
              </span>
            </td>
            <td class="px-6 py-4">
              ${emprestimo.status === 'ativo' ? `
                <button onclick="devolverLivro(${emprestimo.id})" class="text-green-600 hover:text-green-800 text-sm">âœ… Devolver</button>
              ` : '-'}
            </td>
          </tr>
        `;
      }).join('');
    }

    function loadDevolucoesPendentes() {
      const container = document.getElementById('devolucoesList');
      const hoje = new Date();
      
      const pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      );
      
      container.innerHTML = pendentes.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const diasAtraso = Math.floor((hoje - new Date(emprestimo.dataDevolucao)) / (1000 * 60 * 60 * 24));
        
        return `
          <tr class="bg-red-50">
            <td class="px-6 py-4">${aluno?.nome || 'UsuÃ¡rio nÃ£o encontrado'}</td>
            <td class="px-6 py-4">${livro?.titulo || 'Livro nÃ£o encontrado'}</td>
            <td class="px-6 py-4">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-4 text-red-600 font-semibold">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-4 text-red-600 font-semibold">${diasAtraso} dia(s)</td>
            <td class="px-6 py-4">
              <button onclick="devolverLivro(${emprestimo.id})" class="text-green-600 hover:text-green-800 text-sm">âœ… Devolver</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function devolverLivro(emprestimoId) {
      const emprestimo = database.emprestimos.find(e => e.id === emprestimoId);
      
      if (!emprestimo || emprestimo.status !== 'ativo') return;
      
      const livro = database.livros.find(l => l.id === emprestimo.livroId);
      
      if (!confirm(`ğŸ“š Confirmar devoluÃ§Ã£o do livro "${livro?.titulo}"?`)) {
        return;
      }
      
      // Atualiza emprÃ©stimo
      emprestimo.status = 'devolvido';
      emprestimo.dataRealDevolucao = new Date().toISOString().split('T')[0];
      
      // Atualiza disponibilidade do livro
      if (livro) {
        livro.disponivel++;
      }
      
      saveDatabase();
      
      // Atualiza as telas
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      if (document.getElementById('devolucoesTab').classList.contains('hidden') === false) {
        loadDevolucoesPendentes();
      }
      
      updateDashboard();
      alert('âœ… Livro devolvido com sucesso!');
    }

    // ===== FUNÃ‡Ã•ES DE BACKUP =====
    let loadedBackups = [];
    let mergedBackupData = null;
    let mergeLog = [];

    function exportarBackup() {
      const data = JSON.stringify(database, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblion-mega-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      alert('ğŸ’¾ Backup tradicional baixado com sucesso!');
    }

    function copiarBackup() {
      const data = JSON.stringify(database, null, 2);
      
      navigator.clipboard.writeText(data).then(() => {
        alert('ğŸ“‹ Dados copiados para a Ã¡rea de transferÃªncia!');
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = data;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('ğŸ“‹ Dados copiados!');
      });
    }

    function restaurarBackup() {
      const file = document.getElementById('backupFile').files[0];
      const text = document.getElementById('backupText').value.trim();
      
      if (!file && !text) {
        alert('âŒ Selecione um arquivo ou cole os dados do backup.');
        return;
      }
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          processBackupData(e.target.result);
        };
        reader.readAsText(file);
      } else {
        processBackupData(text);
      }
    }

    function processBackupData(data) {
      try {
        const backupData = JSON.parse(data);
        
        if (!backupData.usuarios || !backupData.livros || !backupData.emprestimos) {
          throw new Error('Formato de backup invÃ¡lido');
        }
        
        if (!confirm(`ğŸ“¥ Confirmar restauraÃ§Ã£o?\n\nğŸ“Š Dados a importar:\nâ€¢ ${backupData.livros.length} livros\nâ€¢ ${backupData.usuarios.length} usuÃ¡rios\nâ€¢ ${backupData.emprestimos.length} emprÃ©stimos\n\nâš ï¸ Os dados atuais serÃ£o substituÃ­dos!`)) {
          return;
        }
        
        database = backupData;
        
        if (!database.nextId) {
          database.nextId = {
            usuarios: Math.max(...database.usuarios.map(u => u.id), 0) + 1,
            livros: Math.max(...database.livros.map(l => l.id), 0) + 1,
            emprestimos: Math.max(...database.emprestimos.map(e => e.id), 0) + 1
          };
        }
        
        saveDatabase();
        
        document.getElementById('backupFile').value = '';
        document.getElementById('backupText').value = '';
        
        alert('âœ… Backup restaurado com sucesso!\n\nA pÃ¡gina serÃ¡ recarregada.');
        location.reload();
        
      } catch (error) {
        alert('âŒ Erro ao restaurar backup: ' + error.message);
      }
    }

    // ===== FUNÃ‡Ã•ES DE JUNÃ‡ÃƒO DE BACKUPS =====
    function loadBackupsForMerge() {
      const files = document.getElementById('mergeBackupFiles').files;
      
      if (files.length < 2) {
        alert('âŒ Selecione pelo menos 2 arquivos de backup para juntar.');
        return;
      }
      
      loadedBackups = [];
      let filesProcessed = 0;
      
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backupData = JSON.parse(e.target.result);
            
            if (!backupData.usuarios || !backupData.livros || !backupData.emprestimos) {
              throw new Error(`Arquivo ${file.name}: Formato de backup invÃ¡lido`);
            }
            
            loadedBackups.push({
              fileName: file.name,
              data: backupData,
              stats: {
                usuarios: backupData.usuarios.length,
                livros: backupData.livros.length,
                emprestimos: backupData.emprestimos.length
              }
            });
            
            filesProcessed++;
            
            if (filesProcessed === files.length) {
              displayBackupsPreview();
            }
            
          } catch (error) {
            alert(`âŒ Erro ao carregar ${file.name}: ${error.message}`);
          }
        };
        reader.readAsText(file);
      });
    }

    function displayBackupsPreview() {
      const container = document.getElementById('backupsPreviewContent');
      
      container.innerHTML = loadedBackups.map((backup, index) => `
        <div class="border rounded-lg p-4 ${index === 0 ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'}">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">${backup.fileName}</div>
            <div class="text-xs px-2 py-1 rounded ${index === 0 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'}">
              ${index === 0 ? 'Base' : `Backup ${index + 1}`}
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 text-sm">
            <div class="text-center">
              <div class="text-2xl text-blue-600">ğŸ‘¥</div>
              <div class="font-bold">${backup.stats.usuarios}</div>
              <div class="text-xs text-gray-600">UsuÃ¡rios</div>
            </div>
            <div class="text-center">
              <div class="text-2xl text-green-600">ğŸ“š</div>
              <div class="font-bold">${backup.stats.livros}</div>
              <div class="text-xs text-gray-600">Livros</div>
            </div>
            <div class="text-center">
              <div class="text-2xl text-orange-600">ğŸ“‹</div>
              <div class="font-bold">${backup.stats.emprestimos}</div>
              <div class="text-xs text-gray-600">EmprÃ©stimos</div>
            </div>
          </div>
          
          ${backup.data.metadata ? `
            <div class="mt-2 text-xs text-gray-500">
              ğŸ“… ${backup.data.metadata.lastUpdate ? new Date(backup.data.metadata.lastUpdate).toLocaleDateString('pt-BR') : 'Data nÃ£o informada'}
            </div>
          ` : ''}
        </div>
      `).join('');
      
      document.getElementById('backupsPreview').classList.remove('hidden');
      document.getElementById('mergeSettings').classList.remove('hidden');
      document.getElementById('executeMergeBtn').classList.remove('hidden');
    }

    function executeMergeBackups() {
      if (loadedBackups.length < 2) {
        alert('âŒ Carregue pelo menos 2 backups primeiro.');
        return;
      }
      
      const userConflictMode = document.getElementById('userConflictMode').value;
      const bookConflictMode = document.getElementById('bookConflictMode').value;
      const loanConflictMode = document.getElementById('loanConflictMode').value;
      const preserveIds = document.getElementById('preserveIds').checked;
      const createLog = document.getElementById('createMergeLog').checked;
      
      mergeLog = [];
      
      try {
        // Inicia com o primeiro backup como base
        const baseBackup = loadedBackups[0];
        mergedBackupData = {
          usuarios: [...baseBackup.data.usuarios],
          livros: [...baseBackup.data.livros],
          emprestimos: [...baseBackup.data.emprestimos],
          nextId: { ...baseBackup.data.nextId },
          metadata: {
            version: '6.0',
            lastUpdate: new Date().toISOString(),
            systemName: 'BibliOn Supremo - Sistema QR Code MEGA V6.0',
            mergedFrom: loadedBackups.map(b => b.fileName),
            mergeDate: new Date().toISOString(),
            mergeSettings: {
              userConflictMode,
              bookConflictMode,
              loanConflictMode,
              preserveIds
            }
          }
        };
        
        if (createLog) {
          mergeLog.push(`ğŸ”— Iniciando junÃ§Ã£o de ${loadedBackups.length} backups`);
          mergeLog.push(`ğŸ“ Base: ${baseBackup.fileName} (${baseBackup.stats.usuarios} usuÃ¡rios, ${baseBackup.stats.livros} livros, ${baseBackup.stats.emprestimos} emprÃ©stimos)`);
        }
        
        // Processa os demais backups
        for (let i = 1; i < loadedBackups.length; i++) {
          const currentBackup = loadedBackups[i];
          
          if (createLog) {
            mergeLog.push(`ğŸ“ Processando: ${currentBackup.fileName}`);
          }
          
          // Mescla usuÃ¡rios
          mergeUsers(currentBackup.data.usuarios, userConflictMode, createLog);
          
          // Mescla livros
          mergeBooks(currentBackup.data.livros, bookConflictMode, createLog);
          
          // Mescla emprÃ©stimos
          mergeLoans(currentBackup.data.emprestimos, loanConflictMode, createLog);
        }
        
        // Atualiza nextId
        updateNextIds();
        
        if (createLog) {
          mergeLog.push(`âœ… JunÃ§Ã£o concluÃ­da com sucesso!`);
          mergeLog.push(`ğŸ“Š Resultado final: ${mergedBackupData.usuarios.length} usuÃ¡rios, ${mergedBackupData.livros.length} livros, ${mergedBackupData.emprestimos.length} emprÃ©stimos`);
        }
        
        displayMergeResult();
        
      } catch (error) {
        alert(`âŒ Erro durante a junÃ§Ã£o: ${error.message}`);
        console.error('Erro na junÃ§Ã£o:', error);
      }
    }

    function mergeUsers(newUsers, conflictMode, createLog) {
      let added = 0, skipped = 0, merged = 0, replaced = 0;
      
      newUsers.forEach(newUser => {
        const existingIndex = mergedBackupData.usuarios.findIndex(u => 
          u.login.toLowerCase() === newUser.login.toLowerCase()
        );
        
        if (existingIndex === -1) {
          // UsuÃ¡rio nÃ£o existe, adiciona
          mergedBackupData.usuarios.push({ ...newUser });
          added++;
        } else {
          // UsuÃ¡rio jÃ¡ existe, aplica estratÃ©gia de conflito
          const existingUser = mergedBackupData.usuarios[existingIndex];
          
          switch (conflictMode) {
            case 'skip':
              skipped++;
              break;
              
            case 'rename':
              const renamedUser = { 
                ...newUser, 
                login: `${newUser.login}_${Date.now()}`,
                nome: `${newUser.nome} (Importado)`
              };
              mergedBackupData.usuarios.push(renamedUser);
              added++;
              break;
              
            case 'merge':
              existingUser.livrosLidos = Math.max(existingUser.livrosLidos || 0, newUser.livrosLidos || 0);
              if (newUser.turma && !existingUser.turma) {
                existingUser.turma = newUser.turma;
              }
              merged++;
              break;
              
            case 'replace':
              mergedBackupData.usuarios[existingIndex] = { ...newUser };
              replaced++;
              break;
          }
        }
      });
      
      if (createLog) {
        mergeLog.push(`ğŸ‘¥ UsuÃ¡rios: +${added} adicionados, ${skipped} pulados, ${merged} mesclados, ${replaced} substituÃ­dos`);
      }
    }

    function mergeBooks(newBooks, conflictMode, createLog) {
      let added = 0, skipped = 0, merged = 0, replaced = 0;
      
      newBooks.forEach(newBook => {
        const existingIndex = mergedBackupData.livros.findIndex(l => 
          l.titulo.toLowerCase() === newBook.titulo.toLowerCase() && 
          l.autor.toLowerCase() === newBook.autor.toLowerCase()
        );
        
        if (existingIndex === -1) {
          // Livro nÃ£o existe, adiciona
          mergedBackupData.livros.push({ ...newBook });
          added++;
        } else {
          // Livro jÃ¡ existe, aplica estratÃ©gia de conflito
          const existingBook = mergedBackupData.livros[existingIndex];
          
          switch (conflictMode) {
            case 'skip':
              skipped++;
              break;
              
            case 'merge':
              existingBook.quantidade += newBook.quantidade;
              existingBook.disponivel += newBook.disponivel;
              if (newBook.editora && !existingBook.editora) {
                existingBook.editora = newBook.editora;
              }
              if (newBook.categoria && !existingBook.categoria) {
                existingBook.categoria = newBook.categoria;
              }
              merged++;
              break;
              
            case 'replace':
              mergedBackupData.livros[existingIndex] = { ...newBook };
              replaced++;
              break;
              
            case 'keep_both':
              const duplicatedBook = { 
                ...newBook, 
                titulo: `${newBook.titulo} (CÃ³pia)`,
                id: mergedBackupData.nextId.livros++
              };
              mergedBackupData.livros.push(duplicatedBook);
              added++;
              break;
          }
        }
      });
      
      if (createLog) {
        mergeLog.push(`ğŸ“š Livros: +${added} adicionados, ${skipped} pulados, ${merged} mesclados, ${replaced} substituÃ­dos`);
      }
    }

    function mergeLoans(newLoans, conflictMode, createLog) {
      let added = 0, skipped = 0;
      
      newLoans.forEach(newLoan => {
        const shouldAdd = (() => {
          switch (conflictMode) {
            case 'merge_all':
              return true;
              
            case 'active_only':
              return newLoan.status === 'ativo';
              
            case 'recent_only':
              const existingLoan = mergedBackupData.emprestimos.find(e => 
                e.alunoId === newLoan.alunoId && e.livroId === newLoan.livroId
              );
              return !existingLoan || new Date(newLoan.dataEmprestimo) > new Date(existingLoan.dataEmprestimo);
              
            default:
              return true;
          }
        })();
        
        if (shouldAdd) {
          mergedBackupData.emprestimos.push({ ...newLoan });
          added++;
        } else {
          skipped++;
        }
      });
      
      if (createLog) {
        mergeLog.push(`ğŸ“‹ EmprÃ©stimos: +${added} adicionados, ${skipped} pulados`);
      }
    }

    function updateNextIds() {
      mergedBackupData.nextId = {
        usuarios: Math.max(...mergedBackupData.usuarios.map(u => u.id), 0) + 1,
        livros: Math.max(...mergedBackupData.livros.map(l => l.id), 0) + 1,
        emprestimos: Math.max(...mergedBackupData.emprestimos.map(e => e.id), 0) + 1
      };
    }

    function displayMergeResult() {
      const container = document.getElementById('mergeResultContent');
      
      const totalStats = {
        usuarios: mergedBackupData.usuarios.length,
        livros: mergedBackupData.livros.length,
        emprestimos: mergedBackupData.emprestimos.length
      };
      
      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-blue-600 mb-2">ğŸ‘¥</div>
            <div class="text-2xl font-bold">${totalStats.usuarios}</div>
            <div class="text-sm text-gray-600">UsuÃ¡rios Total</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-green-600 mb-2">ğŸ“š</div>
            <div class="text-2xl font-bold">${totalStats.livros}</div>
            <div class="text-sm text-gray-600">Livros Total</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-orange-600 mb-2">ğŸ“‹</div>
            <div class="text-2xl font-bold">${totalStats.emprestimos}</div>
            <div class="text-sm text-gray-600">EmprÃ©stimos Total</div>
          </div>
        </div>
        
        ${mergeLog.length > 0 ? `
          <div class="bg-white rounded-lg border p-4">
            <h5 class="font-semibold mb-2">ğŸ“ Log da JunÃ§Ã£o:</h5>
            <div class="text-xs space-y-1 max-h-40 overflow-y-auto">
              ${mergeLog.map(log => `<div>${log}</div>`).join('')}
            </div>
          </div>
        ` : ''}
        
        <div class="mt-4 flex gap-2">
          <button onclick="downloadMergedBackup()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
            ğŸ’¾ Baixar Backup Unificado
          </button>
          <button onclick="copyMergedBackup()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm">
            ğŸ“‹ Copiar Dados
          </button>
        </div>
      `;
      
      document.getElementById('mergeResult').classList.remove('hidden');
      document.getElementById('applyMergeBtn').classList.remove('hidden');
    }

    function downloadMergedBackup() {
      if (!mergedBackupData) {
        alert('âŒ Nenhum backup unificado disponÃ­vel.');
        return;
      }
      
      const data = JSON.stringify(mergedBackupData, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblion-backup-unificado-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      alert('ğŸ’¾ Backup unificado baixado com sucesso!');
    }

    function copyMergedBackup() {
      if (!mergedBackupData) {
        alert('âŒ Nenhum backup unificado disponÃ­vel.');
        return;
      }
      
      const data = JSON.stringify(mergedBackupData, null, 2);
      
      navigator.clipboard.writeText(data).then(() => {
        alert('ğŸ“‹ Backup unificado copiado para a Ã¡rea de transferÃªncia!');
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = data;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('ğŸ“‹ Backup unificado copiado!');
      });
    }

    function applyMergedBackup() {
      if (!mergedBackupData) {
        alert('âŒ Nenhum backup unificado disponÃ­vel.');
        return;
      }
      
      const totalStats = {
        usuarios: mergedBackupData.usuarios.length,
        livros: mergedBackupData.livros.length,
        emprestimos: mergedBackupData.emprestimos.length
      };
      
      if (!confirm(`ğŸ”— Aplicar backup unificado?\n\nğŸ“Š Dados a aplicar:\nâ€¢ ${totalStats.usuarios} usuÃ¡rios\nâ€¢ ${totalStats.livros} livros\nâ€¢ ${totalStats.emprestimos} emprÃ©stimos\n\nâš ï¸ Os dados atuais serÃ£o substituÃ­dos pelo backup unificado!`)) {
        return;
      }
      
      database = { ...mergedBackupData };
      saveDatabase();
      
      closeModal('mergeBackupsModal');
      
      alert('âœ… Backup unificado aplicado com sucesso!\n\nA pÃ¡gina serÃ¡ recarregada para atualizar a interface.');
      location.reload();
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
      initializeDatabase();
      
      // Login
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      
      // Toggle password
      document.getElementById('togglePwd').addEventListener('click', function() {
        const pwd = document.getElementById('loginPassword');
        const btn = this;
        
        if (pwd.type === 'password') {
          pwd.type = 'text';
          btn.textContent = 'Ocultar';
        } else {
          pwd.type = 'password';
          btn.textContent = 'Mostrar';
        }
      });
      
      // Forms
      document.getElementById('addBookForm').addEventListener('submit', handleAddBook);
      document.getElementById('editBookForm').addEventListener('submit', handleEditBook);
      document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
      document.getElementById('addEmprestimoForm').addEventListener('submit', handleAddEmprestimo);
      
      // Filtros
      document.getElementById('searchLivros').addEventListener('input', loadLivros);
      document.getElementById('filterCategoria').addEventListener('change', loadLivros);
      document.getElementById('filterAutor').addEventListener('change', loadLivros);
      document.getElementById('filterDisponibilidade').addEventListener('change', loadLivros);
    });

    // ===== FUNÃ‡Ã•ES GLOBAIS =====
    window.showTab = showTab;
    window.showModal = showModal;
    window.closeModal = closeModal;
    window.logout = logout;
    window.editLivro = editLivro;
    window.deleteLivro = deleteLivro;
    window.importBooks = importBooks;
    window.importUsers = importUsers;
    window.deleteUsuario = deleteUsuario;
    window.devolverLivro = devolverLivro;
    window.clearLivrosFilters = clearLivrosFilters;
    window.exportarBackup = exportarBackup;
    window.copiarBackup = copiarBackup;
    window.restaurarBackup = restaurarBackup;
    window.gerarQRCodeMega = gerarQRCodeMega;
    window.copiarLinkMega = copiarLinkMega;
    window.loadBackupsForMerge = loadBackupsForMerge;
    window.executeMergeBackups = executeMergeBackups;
    window.downloadMergedBackup = downloadMergedBackup;
    window.copyMergedBackup = copyMergedBackup;
    window.applyMergedBackup = applyMergedBackup;
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992c46d71398f1d7',t:'MTc2MTE3MDUyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
