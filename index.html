<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BibliOn - Sistema de Biblioteca Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    body { box-sizing: border-box; }
    .gradient-bg { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .card-hover { transition: all .3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -10px rgba(0,0,0,.15);}
    .nav-btn.active { border-color:#f59e0b !important; color:#f59e0b !important; }
    .book-card { background: linear-gradient(145deg, #ffffff, #f3f3f3); border: 1px solid #e6e6e6; }
    .transition-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f59e0b,#d97706);z-index:50;opacity:0;visibility:hidden;transition:all .5s ease}
    .transition-screen.active{opacity:1;visibility:visible}
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
    .float { animation: float 2s ease-in-out infinite; }
  </style>
</head>
<body class="bg-[#0f172a]">
  <!-- Tela de Transição -->
  <div id="transitionScreen" class="transition-screen">
    <div class="text-center text-white">
      <div class="float mb-4 text-6xl">📚</div>
      <h1 class="text-3xl font-bold">Carregando BibliOn...</h1>
      <p class="text-lg opacity-80 mt-2">Sistema de Biblioteca Digital</p>
    </div>
  </div>

  <!-- Login -->
  <section id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="text-5xl mb-2">📚</div>
        <h1 class="text-3xl font-bold text-gray-800">BibliOn</h1>
        <p class="text-gray-500">Sistema de Biblioteca Digital</p>
      </div>

      <form id="loginForm" class="space-y-5">
        <div>
          <label for="loginUser" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
          <input id="loginUser" type="text" placeholder="Seu usuário" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 outline-none" required />
        </div>

        <div>
          <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
          <div class="relative">
            <input id="loginPassword" type="password" placeholder="Sua senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 outline-none pr-12" required />
            <button type="button" id="togglePwd" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 text-sm text-yellow-700 bg-yellow-100 rounded hover:bg-yellow-200">Mostrar</button>
          </div>
        </div>

        <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-3 rounded-lg transition">Entrar</button>
      </form>

      <div class="mt-8 text-center text-xs text-gray-500">
        BibliOn v1.0 · Criado por Nathannael Teles · Teles Design
      </div>
    </div>
  </section>

  <!-- App -->
  <div id="mainSystem" class="hidden">
    <!-- Header -->
    <header class="gradient-bg text-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-3xl">📚</div>
          <div>
            <h1 class="text-2xl font-bold">BibliOn</h1>
            <div class="text-xs opacity-80">Sistema de Biblioteca Digital</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="userWelcome" class="text-sm opacity-90"></span>
          <button id="trocarSenhaBtn" class="bg-yellow-600 hover:bg-yellow-700 text-black px-3 py-2 rounded-lg hidden">🔑 Trocar Senha</button>
          <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg">Sair</button>
        </div>
      </div>
    </header>

    <!-- Nav -->
    <nav class="bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-6">
          <button onclick="showTab('inicio')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600 active">🏠 Início</button>
          <button onclick="showTab('livros')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">📖 Livros</button>
          <button onclick="showTab('emprestimos')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">📋 Empréstimos</button>
          <button onclick="showTab('devolucoes')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">⏰ Devoluções</button>
          <button id="usuariosTabBtn" onclick="showTab('usuarios')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">👥 Usuários</button>
          <button onclick="showTab('backup')" class="nav-btn py-4 border-b-2 border-transparent hover:border-yellow-600">💾 Backup</button>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <!-- INÍCIO -->
      <section id="inicioTab" class="tab-content">
        <h2 class="text-2xl font-bold text-white mb-6">Painel de Controle</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-yellow-100 p-3 rounded-full text-xl">📚</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Livros</p>
                <p id="totalLivros" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-orange-100 p-3 rounded-full text-xl">📋</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Empréstimos</p>
                <p id="totalEmprestimos" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-red-100 p-3 rounded-full text-xl">⏰</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Pendências</p>
                <p id="totalPendentes" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div id="usuariosCard" class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-amber-100 p-3 rounded-full text-xl">👥</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Usuários</p>
                <p id="totalUsuarios" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-semibold text-gray-800 mb-4">⭐ Livros em Destaque</h3>
          <div id="livrosDestaque" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4"></div>
        </div>

        <div id="meusEmprestimos" class="mt-8 bg-white rounded-xl p-6 hidden">
          <h3 class="font-semibold text-gray-800 mb-4">📖 Meus Empréstimos</h3>
          <div id="emprestimosAluno" class="space-y-3"></div>
        </div>
      </section>

      <!-- LIVROS -->
      <section id="livrosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Gerenciamento de Livros</h2>
          <div id="livrosActions" class="space-x-2">
            <button onclick="showModal('addBookModal')" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-semibold">➕ Adicionar</button>
            <button onclick="showModal('importBooksModal')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">📄 Importar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">🔍 Filtros Avançados</h3>
            <button onclick="clearLivrosFilters()" class="text-sm text-yellow-600 underline font-semibold">Limpar Filtros</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <input id="searchLivros" type="text" placeholder="Título, autor, código..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500"/>
            <select id="filterCategoria" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500"><option value="">Todas as categorias</option></select>
            <select id="filterAutor" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500"><option value="">Todos os autores</option></select>
            <select id="filterDisponibilidade" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500">
              <option value="">Todos</option>
              <option value="disponivel">Disponível</option>
              <option value="indisponivel">Indisponível</option>
            </select>
          </div>
        </div>

        <div id="livrosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>

      <!-- EMPRÉSTIMOS -->
      <section id="emprestimosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Controle de Empréstimos</h2>
          <button id="addEmprestimoBtn" onclick="showModal('addEmprestimoModal')" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-semibold">➕ Novo Empréstimo</button>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">Empréstimo</th>
                  <th class="px-6 py-3 text-left">Devolução</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="emprestimosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DEVOLUÇÕES -->
      <section id="devolucoesTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">Devoluções Pendentes</h2>
        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-red-50 text-xs text-red-600 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">Empréstimo</th>
                  <th class="px-6 py-3 text-left">Prevista</th>
                  <th class="px-6 py-3 text-left">Atraso</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="devolucoesList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- USUÁRIOS -->
      <section id="usuariosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Gerenciamento de Usuários</h2>
          <div class="space-x-2">
            <button onclick="showModal('addUserModal')" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-semibold">➕ Adicionar</button>
            <button onclick="showModal('importUsersModal')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">📄 Importar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Nome</th>
                  <th class="px-6 py-3 text-left">Login</th>
                  <th class="px-6 py-3 text-left">Tipo</th>
                  <th class="px-6 py-3 text-left">Turma</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="usuariosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- BACKUP -->
      <section id="backupTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">💾 Sistema de Backup</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Backup Tradicional -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-yellow-600 mb-4">📊 Backup Tradicional</h3>
            
            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg mb-4">
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="flex items-center gap-2">
                  <span class="text-blue-600">📚</span>
                  <span><span id="backupStatsLivros">0</span> livros</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-purple-600">👥</span>
                  <span><span id="backupStatsUsuarios">0</span> usuários</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-green-600">📋</span>
                  <span><span id="backupStatsEmprestimos">0</span> empréstimos</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-orange-600">📅</span>
                  <span id="backupStatsData">-</span>
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <button onclick="exportarBackup()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg text-sm font-semibold">💾 Baixar Backup JSON</button>
              <button onclick="copiarBackup()" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">📋 Copiar Dados</button>
              <button onclick="showModal('mergeBackupsModal')" class="w-full bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">🔗 Juntar Backups</button>
            </div>

            <!-- Restaurar Backup -->
            <div class="mt-6 bg-green-50 border border-green-200 p-4 rounded-lg">
              <h4 class="font-semibold text-green-800 mb-2">📥 Restaurar Backup</h4>
              <div class="space-y-3">
                <input type="file" id="backupFile" accept=".json,.txt" class="w-full px-3 py-2 border rounded-lg text-sm">
                <textarea id="backupText" rows="4" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Ou cole os dados aqui..."></textarea>
                <button onclick="restaurarBackup()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">📥 Restaurar</button>
              </div>
            </div>
          </div>

          <!-- QR Code Backup -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-blue-600 mb-4">📱 QR Code Backup</h3>
            
            <div class="text-center mb-4">
              <div id="backupQRContainer" class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6 mb-3 min-h-[200px] flex items-center justify-center">
                <div class="text-center text-gray-500">
                  <div class="text-4xl mb-2">📱</div>
                  <div class="font-semibold">QR Code Backup</div>
                  <div class="text-sm mt-1">Clique para gerar</div>
                </div>
              </div>
              
              <button onclick="gerarQRCode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-bold mb-2">
                📱 Gerar QR Code
              </button>
              
              <button onclick="copiarLink()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
                🔗 Compartilhar Link
              </button>
            </div>
            
            <!-- Recursos -->
            <div class="bg-blue-50 border border-blue-200 rounded p-3 text-xs">
              <div class="font-semibold text-blue-800 mb-1">📱 Recursos do QR Code</div>
              <div class="text-blue-700 space-y-1">
                <div>• Backup completo da biblioteca</div>
                <div>• Escaneie para baixar</div>
                <div>• Compartilhamento fácil</div>
                <div>• Restauração automática</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Estatísticas da Biblioteca -->
        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-bold text-gray-800 mb-4">📊 Estatísticas da Biblioteca</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
              <div class="text-2xl text-blue-600 mb-1">📚</div>
              <div class="font-bold text-lg" id="statsLivros">0</div>
              <div class="text-xs text-gray-600">Livros</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-lg">
              <div class="text-2xl text-purple-600 mb-1">👥</div>
              <div class="font-bold text-lg" id="statsUsuarios">0</div>
              <div class="text-xs text-gray-600">Usuários</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
              <div class="text-2xl text-green-600 mb-1">📋</div>
              <div class="font-bold text-lg" id="statsEmprestimos">0</div>
              <div class="text-xs text-gray-600">Empréstimos</div>
            </div>
            <div class="text-center p-4 bg-orange-50 rounded-lg">
              <div class="text-2xl text-orange-600 mb-1">💾</div>
              <div class="font-bold text-lg" id="statsTamanho">0</div>
              <div class="text-xs text-gray-600">KB</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-[#0b1224] text-white/70 text-center py-6">
      <div class="max-w-7xl mx-auto px-4">
        <div class="text-lg font-semibold mb-2">BibliOn v1.0</div>
        <div class="text-sm opacity-75">Sistema de Biblioteca Digital</div>
        <div class="text-xs mt-2">Criado por Nathannael Teles · Teles Design</div>
      </div>
    </footer>
  </div>

  <!-- Modais -->
  <!-- Add Livro Modal -->
  <div id="addBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Adicionar Livro</h3>
        <button onclick="closeModal('addBookModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addBookForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="addBookTitulo" class="block text-sm font-medium mb-1">Título *</label><input id="addBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookAutor" class="block text-sm font-medium mb-1">Autor *</label><input id="addBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookEditora" class="block text-sm font-medium mb-1">Editora</label><input id="addBookEditora" name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookCategoria" class="block text-sm font-medium mb-1">Categoria</label><input id="addBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookQuantidade" class="block text-sm font-medium mb-1">Quantidade Total *</label><input id="addBookQuantidade" type="number" min="1" name="quantidade" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookDisponivel" class="block text-sm font-medium mb-1">Disponível *</label><input id="addBookDisponivel" type="number" min="0" name="disponivel" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookCodigoBarra" class="block text-sm font-medium mb-1">Código de Barras</label><input id="addBookCodigoBarra" name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookLocalizacao" class="block text-sm font-medium mb-1">Localização</label><input id="addBookLocalizacao" name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
        </div>
        <div>
          <label for="addBookDescricao" class="block text-sm font-medium mb-1">Descrição</label>
          <textarea id="addBookDescricao" name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"></textarea>
        </div>
        <div>
          <label for="addBookFoto" class="block text-sm font-medium mb-1">📸 Foto do Livro</label>
          <input id="addBookFoto" type="file" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
          <div class="text-xs text-gray-500 mt-1">Formatos aceitos: PNG, JPG, JPEG, GIF, WEBP</div>
          <div id="addBookPreview" class="mt-2 hidden">
            <img id="addBookPreviewImg" class="w-20 h-28 object-cover rounded border" alt="Preview"/>
          </div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeModal('addBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Livros Modal -->
  <div id="importBooksModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Livros</h3>
        <button onclick="closeModal('importBooksModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="space-y-4">
        <textarea id="importBooksText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Título | Autor | Categoria | Quantidade&#10;Ex: Dom Casmurro | Machado de Assis | Literatura | 5"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importBooksModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importBooks()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Usuário Modal -->
  <div id="addUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Adicionar Usuário</h3>
        <button onclick="closeModal('addUserModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addUserForm" class="space-y-4">
        <div><label for="addUserNome" class="block text-sm font-medium mb-1">Nome *</label><input id="addUserNome" name="nome" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label for="addUserLogin" class="block text-sm font-medium mb-1">Login *</label><input id="addUserLogin" name="login" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label for="addUserSenha" class="block text-sm font-medium mb-1">Senha *</label><input id="addUserSenha" type="password" name="senha" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div>
          <label for="addUserTipo" class="block text-sm font-medium mb-1">Tipo *</label>
          <select id="addUserTipo" name="tipo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione...</option>
            <option value="aluno">Aluno</option>
            <option value="professor">Professor</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addUserModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Usuários Modal -->
  <div id="importUsersModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Usuários</h3>
        <button onclick="closeModal('importUsersModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="space-y-4">
        <textarea id="importUsersText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nome | Login | Senha | Tipo&#10;Ex: João Silva | joao | 1234 | aluno"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importUsersModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importUsers()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Empréstimo Modal -->
  <div id="addEmprestimoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Novo Empréstimo</h3>
        <button onclick="closeModal('addEmprestimoModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addEmprestimoForm" class="space-y-4">
        <div>
          <label for="emprestimoAluno" class="block text-sm font-medium mb-1">Aluno *</label>
          <select id="emprestimoAluno" name="alunoId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o aluno...</option>
          </select>
        </div>
        <div>
          <label for="emprestimoLivro" class="block text-sm font-medium mb-1">Livro *</label>
          <select id="emprestimoLivro" name="livroId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o livro...</option>
          </select>
        </div>
        <div>
          <label for="emprestimoDataDevolucao" class="block text-sm font-medium mb-1">Data de Devolução *</label>
          <input id="emprestimoDataDevolucao" type="date" name="dataDevolucao" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addEmprestimoModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Emprestar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Empréstimo Modal -->
  <div id="editEmprestimoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Editar Empréstimo</h3>
        <button onclick="closeModal('editEmprestimoModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="editEmprestimoForm" class="space-y-4">
        <input type="hidden" id="editEmprestimoId" name="id">
        <div>
          <label for="editEmprestimoAluno" class="block text-sm font-medium mb-1">Aluno *</label>
          <select id="editEmprestimoAluno" name="alunoId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o aluno...</option>
          </select>
        </div>
        <div>
          <label for="editEmprestimoLivro" class="block text-sm font-medium mb-1">Livro *</label>
          <select id="editEmprestimoLivro" name="livroId" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o livro...</option>
          </select>
        </div>
        <div>
          <label for="editEmprestimoDataEmprestimo" class="block text-sm font-medium mb-1">Data de Empréstimo *</label>
          <input id="editEmprestimoDataEmprestimo" type="date" name="dataEmprestimo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div>
          <label for="editEmprestimoDataDevolucao" class="block text-sm font-medium mb-1">Data de Devolução *</label>
          <input id="editEmprestimoDataDevolucao" type="date" name="dataDevolucao" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div>
          <label for="editEmprestimoStatus" class="block text-sm font-medium mb-1">Status *</label>
          <select id="editEmprestimoStatus" name="status" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="ativo">Ativo</option>
            <option value="devolvido">Devolvido</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('editEmprestimoModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Livro Modal -->
  <div id="editBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Editar Livro</h3>
        <button onclick="closeModal('editBookModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="editBookForm" class="space-y-4">
        <input type="hidden" id="editBookId" name="id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="editBookTitulo" class="block text-sm font-medium mb-1">Título *</label><input id="editBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookAutor" class="block text-sm font-medium mb-1">Autor *</label><input id="editBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookEditora" class="block text-sm font-medium mb-1">Editora</label><input id="editBookEditora" name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookCategoria" class="block text-sm font-medium mb-1">Categoria</label><input id="editBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookQuantidade" class="block text-sm font-medium mb-1">Quantidade Total *</label><input id="editBookQuantidade" type="number" min="1" name="quantidade" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookDisponivel" class="block text-sm font-medium mb-1">Disponível *</label><input id="editBookDisponivel" type="number" min="0" name="disponivel" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookCodigoBarra" class="block text-sm font-medium mb-1">Código de Barras</label><input id="editBookCodigoBarra" name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="editBookLocalizacao" class="block text-sm font-medium mb-1">Localização</label><input id="editBookLocalizacao" name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
        </div>
        <div>
          <label for="editBookDescricao" class="block text-sm font-medium mb-1">Descrição</label>
          <textarea id="editBookDescricao" name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"></textarea>
        </div>
        <div>
          <label for="editBookFoto" class="block text-sm font-medium mb-1">📸 Foto do Livro</label>
          <input id="editBookFoto" type="file" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
          <div class="text-xs text-gray-500 mt-1">Formatos aceitos: PNG, JPG, JPEG, GIF, WEBP</div>
          <div id="editBookPreview" class="mt-2 hidden">
            <img id="editBookPreviewImg" class="w-20 h-28 object-cover rounded border" alt="Preview atual"/>
          </div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeModal('editBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Merge Backups Modal -->
  <div id="mergeBackupsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-purple-600">🔗 Juntar Múltiplos Backups</h3>
        <button onclick="closeModal('mergeBackupsModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      
      <div class="space-y-6">
        <!-- Seleção de Arquivos -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <h4 class="font-semibold text-purple-800 mb-3">📁 Selecionar Backups</h4>
          <input type="file" id="mergeBackupFiles" accept=".json,.txt" multiple class="w-full px-3 py-2 border rounded-lg text-sm mb-3">
          <div class="text-xs text-purple-600">
            💡 Selecione 2 ou mais arquivos de backup para juntar
          </div>
          <button onclick="loadBackupsForMerge()" class="mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">📂 Carregar Backups</button>
        </div>

        <!-- Preview dos Backups -->
        <div id="backupsPreview" class="hidden">
          <h4 class="font-semibold text-gray-800 mb-3">📊 Preview dos Backups</h4>
          <div id="backupsPreviewContent" class="space-y-3"></div>
        </div>

        <!-- Configurações de Junção -->
        <div id="mergeSettings" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="font-semibold text-blue-800 mb-3">⚙️ Configurações de Junção</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Conflitos de Usuários</label>
              <select id="userConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="skip">Pular duplicados</option>
                <option value="rename">Renomear duplicados</option>
                <option value="merge">Mesclar dados</option>
                <option value="replace">Substituir existentes</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Conflitos de Livros</label>
              <select id="bookConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="merge">Somar quantidades</option>
                <option value="skip">Pular duplicados</option>
                <option value="replace">Substituir existentes</option>
                <option value="keep_both">Manter ambos</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Empréstimos</label>
              <select id="loanConflictMode" class="w-full px-3 py-2 border rounded-lg text-sm">
                <option value="merge_all">Mesclar todos</option>
                <option value="active_only">Apenas ativos</option>
                <option value="recent_only">Mais recentes</option>
              </select>
            </div>
          </div>

          <div class="mb-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="preserveIds" checked class="rounded">
              <span class="text-sm text-blue-700">🔢 Preservar IDs originais quando possível</span>
            </label>
          </div>

          <div class="mb-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="createMergeLog" checked class="rounded">
              <span class="text-sm text-blue-700">📝 Criar log detalhado da junção</span>
            </label>
          </div>
        </div>

        <!-- Resultado da Junção -->
        <div id="mergeResult" class="hidden">
          <h4 class="font-semibold text-green-800 mb-3">✅ Resultado da Junção</h4>
          <div id="mergeResultContent" class="bg-green-50 border border-green-200 rounded-lg p-4"></div>
        </div>

        <!-- Botões de Ação -->
        <div class="flex justify-end gap-2 pt-4 border-t">
          <button onclick="closeModal('mergeBackupsModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button id="executeMergeBtn" onclick="executeMergeBackups()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg hidden">🔗 Executar Junção</button>
          <button id="applyMergeBtn" onclick="applyMergedBackup()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg hidden">✅ Aplicar Backup Unificado</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== BANCO DE DADOS =====
    const defaultDB = {
      usuarios: [
        { 
          id: 1, 
          nome: 'Administrador', 
          login: 'ADMIN', 
          senha: 'VANIA25', 
          tipo: 'admin', 
          turma: '', 
          status: 'ativo', 
          livrosLidos: 0 
        }
      ],
      livros: [
        { 
          id: 1, 
          titulo: 'Dom Casmurro', 
          autor: 'Machado de Assis', 
          editora: 'Ática', 
          categoria: 'Literatura Brasileira', 
          quantidade: 5, 
          disponivel: 5, 
          descricao: 'Clássico da literatura brasileira que narra a história de Bentinho e Capitu.', 
          foto: '', 
          codigoBarra: '9788508123456', 
          localizacao: 'Estante A - Prateleira 2'
        },
        { 
          id: 2, 
          titulo: 'O Cortiço', 
          autor: 'Aluísio Azevedo', 
          editora: 'Moderna', 
          categoria: 'Literatura Brasileira', 
          quantidade: 3, 
          disponivel: 3, 
          descricao: 'Romance naturalista que retrata a vida em um cortiço do Rio de Janeiro no século XIX.', 
          foto: '', 
          codigoBarra: '9788516987654', 
          localizacao: 'Estante A - Prateleira 3'
        }
      ],
      emprestimos: [],
      nextId: { usuarios: 2, livros: 3, emprestimos: 1 },
      metadata: {
        version: '1.0',
        lastUpdate: new Date().toISOString(),
        systemName: 'BibliOn - Sistema de Biblioteca Digital'
      }
    };

    // ===== VARIÁVEIS GLOBAIS =====
    let database = null;
    let currentUser = null;

    // ===== GERADOR QR CODE =====
    function gerarQRCode() {
      const container = document.getElementById('backupQRContainer');
      container.innerHTML = '<div class="text-center text-blue-600 p-4"><div class="text-4xl mb-3">📱</div><div class="font-bold text-xl">Gerando QR Code...</div><div class="text-sm mt-2">Aguarde um momento</div></div>';
      
      try {
        // Cria backup completo
        const backupData = {
          usuarios: database.usuarios,
          livros: database.livros,
          emprestimos: database.emprestimos,
          nextId: database.nextId,
          metadata: {
            version: '1.0',
            lastUpdate: new Date().toISOString(),
            systemName: 'BibliOn - Sistema de Biblioteca Digital',
            exportedBy: currentUser?.nome || 'Sistema',
            exportedAt: new Date().toISOString(),
            backupType: 'QR Code'
          }
        };
        
        const backupJson = JSON.stringify(backupData);
        const qrUrl = gerarURL(backupJson);
        const qrCode = criarQRCode(qrUrl);
        
        container.innerHTML = '';
        
        // Título de sucesso
        const successTitle = document.createElement('div');
        successTitle.className = 'text-center mb-4';
        successTitle.innerHTML = `
          <div class="text-4xl mb-2">📱</div>
          <div class="font-bold text-xl text-blue-600">QR Code Gerado</div>
          <div class="text-sm text-blue-500">Backup completo da biblioteca</div>
        `;
        container.appendChild(successTitle);
        
        // QR Code
        const qrWrapper = document.createElement('div');
        qrWrapper.className = 'flex justify-center mb-4';
        qrWrapper.appendChild(qrCode);
        container.appendChild(qrWrapper);
        
        // Estatísticas
        const stats = document.createElement('div');
        stats.className = 'bg-blue-600 text-white rounded-lg p-4 text-sm';
        stats.innerHTML = `
          <div class="grid grid-cols-2 gap-3 text-center">
            <div class="bg-white/20 rounded-lg p-3">
              <div class="text-2xl mb-1">📚</div>
              <div class="font-bold">${database.livros.length}</div>
              <div class="text-xs opacity-75">Livros</div>
            </div>
            <div class="bg-white/20 rounded-lg p-3">
              <div class="text-2xl mb-1">👥</div>
              <div class="font-bold">${database.usuarios.length}</div>
              <div class="text-xs opacity-75">Usuários</div>
            </div>
            <div class="bg-white/20 rounded-lg p-3">
              <div class="text-2xl mb-1">📋</div>
              <div class="font-bold">${database.emprestimos.length}</div>
              <div class="text-xs opacity-75">Empréstimos</div>
            </div>
            <div class="bg-white/20 rounded-lg p-3">
              <div class="text-2xl mb-1">💾</div>
              <div class="font-bold">${Math.round(backupJson.length / 1024)}</div>
              <div class="text-xs opacity-75">KB</div>
            </div>
          </div>
        `;
        container.appendChild(stats);
        
        // Instruções
        const instructions = document.createElement('div');
        instructions.className = 'mt-4 bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-800';
        instructions.innerHTML = `
          <div class="font-bold mb-2 flex items-center gap-2">
            <span class="text-lg">📱</span>
            Como usar este QR Code:
          </div>
          <ol class="list-decimal list-inside space-y-1 text-xs">
            <li>Abra a câmera do celular ou app de QR Code</li>
            <li>Aponte para o código acima</li>
            <li>Toque na notificação que aparecer</li>
            <li>Backup será baixado automaticamente</li>
          </ol>
        `;
        container.appendChild(instructions);
        
        setTimeout(() => {
          alert(`📱 QR Code gerado com sucesso!\n\n📊 Estatísticas:\n• ${database.livros.length} livros\n• ${database.usuarios.length} usuários\n• ${database.emprestimos.length} empréstimos\n\n📱 Escaneie para baixar backup completo!`);
        }, 500);
        
      } catch (error) {
        console.error('Erro ao gerar QR Code:', error);
        
        container.innerHTML = `
          <div class="text-center text-red-600 p-4">
            <div class="text-4xl mb-2">❌</div>
            <div class="font-bold">Erro ao gerar QR Code</div>
            <div class="text-sm mt-2">${error.message}</div>
          </div>
        `;
        
        setTimeout(() => {
          alert(`❌ Erro ao gerar QR Code:\n\n${error.message}\n\nTente usar o backup tradicional.`);
        }, 1000);
      }
    }

    function gerarURL(backupData) {
      const encoded = btoa(encodeURIComponent(backupData));
      return `https://nathan-12t.github.io/teles-design/?backup=${encoded}`;
    }

    function criarQRCode(url, size = 300) {
      const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(url)}&format=svg&bgcolor=ffffff&color=000000&ecc=L&qzone=1&margin=2`;
      
      const img = document.createElement('img');
      img.src = apiUrl;
      img.alt = 'QR Code Backup';
      img.className = 'mx-auto rounded-lg shadow-lg border-2 border-blue-300';
      img.style.width = size + 'px';
      img.style.height = size + 'px';
      
      img.onerror = function() {
        this.style.display = 'none';
        const fallback = document.createElement('div');
        fallback.className = 'bg-blue-600 rounded-lg flex items-center justify-center text-white border-2 border-blue-300';
        fallback.style.width = size + 'px';
        fallback.style.height = size + 'px';
        fallback.innerHTML = `
          <div class="text-center p-2">
            <div class="text-4xl mb-2">📱</div>
            <div class="font-bold text-sm">QR Code</div>
            <div class="text-xs">Backup</div>
          </div>
        `;
        this.parentNode.appendChild(fallback);
      };
      
      return img;
    }

    function copiarLink() {
      try {
        const backupData = {
          ...database,
          metadata: {
            ...database.metadata,
            exportedAt: new Date().toISOString(),
            exportedBy: currentUser?.nome || 'Sistema',
            backupType: 'Link'
          }
        };
        
        const backupJson = JSON.stringify(backupData);
        const backupUrl = gerarURL(backupJson);
        
        navigator.clipboard.writeText(backupUrl).then(() => {
          alert(`🔗 Link copiado!\n\n✨ Este link contém o backup completo da biblioteca\n\n📱 Compartilhe apenas com pessoas autorizadas!`);
        }).catch(() => {
          const textArea = document.createElement('textarea');
          textArea.value = backupUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert('🔗 Link copiado para área de transferência!');
        });
        
      } catch (error) {
        alert('❌ Erro ao gerar link: ' + error.message);
      }
    }

    // ===== FUNÇÕES UTILITÁRIAS =====
    function safeParse(json) {
      try {
        return JSON.parse(json);
      } catch {
        return null;
      }
    }

    function saveDatabase() {
      if (!database.metadata) {
        database.metadata = {};
      }
      database.metadata.lastUpdate = new Date().toISOString();
      database.metadata.version = '6.0';
      database.metadata.systemName = 'BibliOn Supremo - Sistema QR Code MEGA V6.0';
      
      localStorage.setItem('bibliOnMegaDatabase', JSON.stringify(database));
    }

    function showModal(id) {
      const modal = document.getElementById(id);
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // Carrega dados específicos do modal
      if (id === 'addEmprestimoModal') {
        loadEmprestimoModalData();
      }
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('pt-BR');
    }

    // ===== INICIALIZAÇÃO DO BANCO MEGA =====
    function initializeDatabase() {
      console.log('🔥 Inicializando banco de dados MEGA...');
      
      const saved = localStorage.getItem('bibliOnMegaDatabase');
      console.log('💾 Dados MEGA encontrados:', !!saved);
      
      if (!saved) {
        console.log('✨ Criando banco MEGA padrão...');
        database = JSON.parse(JSON.stringify(defaultDB));
        saveDatabase();
      } else {
        const parsed = safeParse(saved);
        if (!parsed || !parsed.usuarios || !Array.isArray(parsed.usuarios)) {
          console.log('⚠️ Dados corrompidos, recriando banco MEGA...');
          database = JSON.parse(JSON.stringify(defaultDB));
          saveDatabase();
        } else {
          database = parsed;
          
          if (!database.nextId) {
            database.nextId = { usuarios: 2, livros: 3, emprestimos: 1 };
          }
          
          if (!database.metadata) {
            database.metadata = {
              version: '6.0',
              lastUpdate: new Date().toISOString(),
              systemName: 'BibliOn Supremo - Sistema QR Code MEGA V6.0'
            };
          }
          
          const hasAdmin = database.usuarios.some(u => 
            u && u.login && u.login.toUpperCase() === 'ADMIN'
          );
          
          if (!hasAdmin) {
            console.log('👑 Adicionando usuário ADMIN MEGA...');
            database.usuarios.push({
              id: database.nextId.usuarios++,
              nome: 'Administrador MEGA',
              login: 'ADMIN',
              senha: 'VANIA25',
              tipo: 'admin',
              turma: '',
              status: 'ativo',
              livrosLidos: 0
            });
            saveDatabase();
          }
        }
      }
      
      console.log('✅ Banco MEGA inicializado:', {
        usuarios: database.usuarios.length,
        livros: database.livros.length,
        emprestimos: database.emprestimos.length
      });
    }

    // ===== SISTEMA DE LOGIN =====
    function handleLogin(event) {
      event.preventDefault();
      
      const userInput = document.getElementById('loginUser').value.trim();
      const passwordInput = document.getElementById('loginPassword').value;
      
      console.log('🔐 Tentativa de login MEGA:', { usuario: userInput, senha: '***' });
      
      if (!userInput || !passwordInput) {
        alert('Por favor, preencha usuário e senha.');
        return;
      }
      
      const user = database.usuarios.find(u => {
        if (!u || !u.login || !u.senha) return false;
        
        const loginMatch = u.login.toUpperCase() === userInput.toUpperCase();
        const passwordMatch = u.senha === passwordInput;
        const isActive = u.status === 'ativo';
        
        return loginMatch && passwordMatch && isActive;
      });
      
      if (!user) {
        console.log('❌ Login falhou');
        alert('Usuário ou senha incorretos, ou usuário bloqueado.');
        return;
      }
      
      console.log('✅ Login MEGA bem-sucedido:', user.nome);
      currentUser = user;
      showTransition();
    }

    function showTransition() {
      const transition = document.getElementById('transitionScreen');
      transition.classList.add('active');
      
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainSystem').classList.remove('hidden');
        transition.classList.remove('active');
        setupUserInterface();
        showTab('inicio');
      }, 800);
    }

    function setupUserInterface() {
      document.getElementById('userWelcome').textContent = `Olá, ${currentUser.nome}`;
      
      const isAdmin = currentUser.tipo === 'admin';
      const isStudent = currentUser.tipo === 'aluno';
      
      document.getElementById('usuariosTabBtn').classList.remove('hidden');
      document.getElementById('usuariosCard').classList.remove('hidden');
      document.getElementById('addEmprestimoBtn').classList.remove('hidden');
      document.getElementById('meusEmprestimos').classList.add('hidden');
      document.getElementById('livrosActions').classList.remove('hidden');
      
      document.getElementById('trocarSenhaBtn').classList.toggle('hidden', !isAdmin);
      
      if (isStudent) {
        document.getElementById('usuariosTabBtn').classList.add('hidden');
        document.getElementById('usuariosCard').classList.add('hidden');
        document.getElementById('addEmprestimoBtn').classList.add('hidden');
        document.getElementById('meusEmprestimos').classList.remove('hidden');
        document.getElementById('livrosActions').classList.add('hidden');
      }
      
      updateDashboard();
    }

    function logout() {
      currentUser = null;
      document.getElementById('mainSystem').classList.add('hidden');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('loginForm').reset();
    }

    // ===== SISTEMA DE ABAS =====
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
          btn.classList.add('active');
        }
      });
      
      switch (tabName) {
        case 'inicio':
          updateDashboard();
          break;
        case 'livros':
          loadLivros();
          loadFilterOptions();
          break;
        case 'emprestimos':
          loadEmprestimos();
          break;
        case 'devolucoes':
          loadDevolucoesPendentes();
          break;
        case 'usuarios':
          loadUsuarios();
          break;
        case 'backup':
          updateBackupStats();
          updateStats();
          break;
      }
    }

    // ===== DASHBOARD =====
    function updateDashboard() {
      document.getElementById('totalLivros').textContent = database.livros.length;
      document.getElementById('totalEmprestimos').textContent = 
        database.emprestimos.filter(e => e.status === 'ativo').length;
      document.getElementById('totalUsuarios').textContent = 
        database.usuarios.filter(u => u.status === 'ativo').length;
      
      const hoje = new Date();
      const pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      ).length;
      document.getElementById('totalPendentes').textContent = pendentes;
      
      loadLivrosDestaque();
      
      if (currentUser?.tipo === 'aluno') {
        loadEmprestimosAluno();
      }
    }

    function loadLivrosDestaque() {
      const container = document.getElementById('livrosDestaque');
      
      if (database.livros.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500">Nenhum livro cadastrado ainda.</div>';
        return;
      }
      
      let livros = [...database.livros].slice(0, 5);
      
      container.innerHTML = livros.map(livro => `
        <div class="book-card rounded-lg p-4 text-center card-hover">
          <div class="w-16 h-20 mx-auto rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
            ${livro.foto ? 
              `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
              '<span class="text-2xl text-white">📖</span>'
            }
          </div>
          <div class="mt-2 font-semibold text-sm truncate" title="${livro.titulo}">${livro.titulo}</div>
          <div class="text-xs text-gray-600 truncate" title="${livro.autor}">${livro.autor}</div>
          <div class="mt-1 text-xs ${livro.disponivel > 0 ? 'text-green-600' : 'text-red-600'}">
            ${livro.disponivel > 0 ? `${livro.disponivel} disponível` : 'Indisponível'}
          </div>
        </div>
      `).join('');
    }

    function loadEmprestimosAluno() {
      const container = document.getElementById('emprestimosAluno');
      const emprestimos = database.emprestimos.filter(e => e.alunoId === currentUser.id);
      
      if (!emprestimos.length) {
        container.innerHTML = '<div class="text-gray-500 text-center">Você não possui livros emprestados.</div>';
        return;
      }
      
      container.innerHTML = emprestimos.map(emprestimo => {
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <div class="flex items-center justify-between p-3 border rounded-lg ${atrasado ? 'bg-red-50 border-red-200' : 'bg-white'}">
            <div>
              <div class="font-medium">${livro?.titulo || 'Livro'}</div>
              <div class="text-sm text-gray-600">${livro?.autor || ''}</div>
              <div class="text-xs ${atrasado ? 'text-red-600' : 'text-gray-500'}">
                Devolução: ${formatDate(emprestimo.dataDevolucao)} ${atrasado ? '(ATRASADO)' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== FUNÇÕES DE ATUALIZAÇÃO =====
    function updateStats() {
      document.getElementById('statsLivros').textContent = database.livros.length;
      document.getElementById('statsUsuarios').textContent = database.usuarios.length;
      document.getElementById('statsEmprestimos').textContent = database.emprestimos.length;
      
      const originalSize = JSON.stringify(database).length;
      document.getElementById('statsTamanho').textContent = Math.round(originalSize / 1024);
    }

    function updateBackupStats() {
      document.getElementById('backupStatsLivros').textContent = database.livros.length;
      document.getElementById('backupStatsUsuarios').textContent = database.usuarios.length;
      document.getElementById('backupStatsEmprestimos').textContent = database.emprestimos.length;
      document.getElementById('backupStatsData').textContent = new Date().toLocaleDateString('pt-BR');
    }

    // ===== GERENCIAMENTO DE LIVROS =====
    function loadLivros() {
      const container = document.getElementById('livrosList');
      const search = document.getElementById('searchLivros').value.toLowerCase().trim();
      const categoria = document.getElementById('filterCategoria').value.trim();
      const autor = document.getElementById('filterAutor').value.trim();
      const disponibilidade = document.getElementById('filterDisponibilidade').value.trim();
      
      let livros = [...database.livros];
      
      if (search) {
        livros = livros.filter(livro =>
          (livro.titulo || '').toLowerCase().includes(search) ||
          (livro.autor || '').toLowerCase().includes(search) ||
          (livro.categoria || '').toLowerCase().includes(search) ||
          (livro.codigoBarra || '').toLowerCase().includes(search)
        );
      }
      
      if (categoria) {
        livros = livros.filter(livro => (livro.categoria || '').trim() === categoria);
      }
      
      if (autor) {
        livros = livros.filter(livro => (livro.autor || '').trim() === autor);
      }
      
      if (disponibilidade === 'disponivel') {
        livros = livros.filter(livro => livro.disponivel > 0);
      } else if (disponibilidade === 'indisponivel') {
        livros = livros.filter(livro => livro.disponivel === 0);
      }
      
      const canEdit = currentUser && ['admin', 'professor'].includes(currentUser.tipo);
      
      container.innerHTML = livros.map(livro => `
        <div class="book-card rounded-xl p-5 card-hover">
          <div class="flex gap-4">
            <div class="w-20 h-28 flex-shrink-0 rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
              ${livro.foto ? 
                `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                '<span class="text-3xl text-white">📖</span>'
              }
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-lg truncate" title="${livro.titulo}">${livro.titulo}</div>
              <div class="text-gray-600 truncate" title="${livro.autor}">${livro.autor}</div>
              <div class="text-sm text-gray-500 truncate" title="${livro.editora || 'Editora não informada'}">${livro.editora || 'Editora não informada'}</div>
              ${livro.categoria ? `<div class="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full inline-block mt-1">${livro.categoria}</div>` : ''}
              ${livro.codigoBarra ? `<div class="text-xs text-blue-600 font-mono mt-1">📊 ${livro.codigoBarra}</div>` : ''}
              <div class="mt-2 text-sm flex flex-wrap gap-3">
                <span class="flex items-center gap-1">📚 <strong>${livro.disponivel}/${livro.quantidade}</strong></span>
                ${livro.localizacao ? `<span class="flex items-center gap-1">📍 ${livro.localizacao}</span>` : ''}
              </div>
              ${livro.descricao ? `<div class="text-xs text-gray-500 mt-2 line-clamp-2" title="${livro.descricao}">${livro.descricao}</div>` : ''}
              <div class="mt-2">
                <span class="px-2 py-1 text-xs rounded-full ${livro.disponivel > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                  ${livro.disponivel > 0 ? '✅ Disponível' : '❌ Indisponível'}
                </span>
              </div>
              ${canEdit ? `
                <div class="mt-3 flex gap-2">
                  <button onclick="editLivro(${livro.id})" class="px-3 py-1 bg-amber-700 hover:bg-amber-800 text-white rounded text-sm">✏️ Editar</button>
                  <button onclick="deleteLivro(${livro.id})" class="px-3 py-1 bg-red-700 hover:bg-red-800 text-white rounded text-sm">🗑️ Excluir</button>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function loadFilterOptions() {
      const categorias = [...new Set(database.livros.map(l => l.categoria).filter(Boolean).map(c => c.trim()))].sort();
      const autores = [...new Set(database.livros.map(l => l.autor).filter(Boolean).map(a => a.trim()))].sort();
      
      const categoriaSelect = document.getElementById('filterCategoria');
      const autorSelect = document.getElementById('filterAutor');
      
      categoriaSelect.innerHTML = '<option value="">Todas as categorias</option>' + 
        categorias.map(c => `<option value="${c}">${c}</option>`).join('');
      
      autorSelect.innerHTML = '<option value="">Todos os autores</option>' + 
        autores.map(a => `<option value="${a}">${a}</option>`).join('');
    }

    function clearLivrosFilters() {
      document.getElementById('searchLivros').value = '';
      document.getElementById('filterCategoria').value = '';
      document.getElementById('filterAutor').value = '';
      document.getElementById('filterDisponibilidade').value = '';
      loadLivros();
    }

    // ===== FUNÇÕES DE LIVROS =====
    function handleAddBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const fotoFile = document.getElementById('addBookFoto').files[0];
      
      const quantidade = parseInt(formData.get('quantidade'));
      const disponivel = parseInt(formData.get('disponivel'));
      
      // Verifica se a quantidade disponível não é maior que a total
      if (disponivel > quantidade) {
        alert('❌ A quantidade disponível não pode ser maior que a quantidade total.');
        return;
      }
      
      const livro = {
        id: database.nextId.livros++,
        titulo: formData.get('titulo').trim(),
        autor: formData.get('autor').trim(),
        editora: formData.get('editora').trim(),
        categoria: formData.get('categoria').trim(),
        quantidade: quantidade,
        disponivel: disponivel,
        codigoBarra: formData.get('codigoBarra').trim(),
        localizacao: formData.get('localizacao').trim(),
        descricao: formData.get('descricao').trim(),
        foto: ''
      };
      
      if (fotoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          livro.foto = e.target.result;
          
          database.livros.push(livro);
          saveDatabase();
          
          closeModal('addBookModal');
          event.target.reset();
          document.getElementById('addBookPreview').classList.add('hidden');
          
          if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
            loadLivros();
            loadFilterOptions();
          }
          
          updateDashboard();
          alert('✅ Livro adicionado com sucesso!');
        };
        reader.readAsDataURL(fotoFile);
      } else {
        database.livros.push(livro);
        saveDatabase();
        
        closeModal('addBookModal');
        event.target.reset();
        
        if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
          loadLivros();
          loadFilterOptions();
        }
        
        updateDashboard();
        alert('✅ Livro adicionado com sucesso!');
      }
    }

    function editLivro(id) {
      const livro = database.livros.find(l => l.id === id);
      
      if (!livro) {
        alert('❌ Livro não encontrado.');
        return;
      }
      
      // Preenche o formulário de edição
      document.getElementById('editBookId').value = livro.id;
      document.getElementById('editBookTitulo').value = livro.titulo || '';
      document.getElementById('editBookAutor').value = livro.autor || '';
      document.getElementById('editBookEditora').value = livro.editora || '';
      document.getElementById('editBookCategoria').value = livro.categoria || '';
      document.getElementById('editBookQuantidade').value = livro.quantidade || 1;
      document.getElementById('editBookDisponivel').value = livro.disponivel || 0;
      document.getElementById('editBookCodigoBarra').value = livro.codigoBarra || '';
      document.getElementById('editBookLocalizacao').value = livro.localizacao || '';
      document.getElementById('editBookDescricao').value = livro.descricao || '';
      
      // Mostra foto atual se existir
      const previewDiv = document.getElementById('editBookPreview');
      const previewImg = document.getElementById('editBookPreviewImg');
      
      if (livro.foto) {
        previewImg.src = livro.foto;
        previewDiv.classList.remove('hidden');
      } else {
        previewDiv.classList.add('hidden');
      }
      
      showModal('editBookModal');
    }

    function handleEditBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const id = parseInt(formData.get('id'));
      const fotoFile = document.getElementById('editBookFoto').files[0];
      
      const livroIndex = database.livros.findIndex(l => l.id === id);
      
      if (livroIndex === -1) {
        alert('❌ Livro não encontrado.');
        return;
      }
      
      const livro = database.livros[livroIndex];
      const novaQuantidade = parseInt(formData.get('quantidade'));
      const novoDisponivel = parseInt(formData.get('disponivel'));
      
      // Verifica se a quantidade disponível não é maior que a total
      if (novoDisponivel > novaQuantidade) {
        alert('❌ A quantidade disponível não pode ser maior que a quantidade total.');
        return;
      }
      
      // Função para salvar as alterações
      const salvarAlteracoes = () => {
        livro.titulo = formData.get('titulo').trim();
        livro.autor = formData.get('autor').trim();
        livro.editora = formData.get('editora').trim();
        livro.categoria = formData.get('categoria').trim();
        livro.quantidade = novaQuantidade;
        livro.disponivel = novoDisponivel;
        livro.codigoBarra = formData.get('codigoBarra').trim();
        livro.localizacao = formData.get('localizacao').trim();
        livro.descricao = formData.get('descricao').trim();
        
        saveDatabase();
        
        closeModal('editBookModal');
        document.getElementById('editBookPreview').classList.add('hidden');
        
        if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
          loadLivros();
          loadFilterOptions();
        }
        
        updateDashboard();
        alert('✅ Livro atualizado com sucesso!');
      };
      
      // Se há nova foto, processa ela
      if (fotoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          livro.foto = e.target.result;
          salvarAlteracoes();
        };
        reader.readAsDataURL(fotoFile);
      } else {
        // Mantém a foto atual
        salvarAlteracoes();
      }
    }

    function deleteLivro(id) {
      const livro = database.livros.find(l => l.id === id);
      
      if (!livro) {
        alert('❌ Livro não encontrado.');
        return;
      }
      
      // Verifica se há empréstimos ativos
      const emprestimosAtivos = database.emprestimos.filter(e => 
        e.livroId === id && e.status === 'ativo'
      );
      
      if (emprestimosAtivos.length > 0) {
        alert(`❌ Não é possível excluir o livro "${livro.titulo}".\n\nExistem ${emprestimosAtivos.length} empréstimo(s) ativo(s) deste livro.\n\nFinalize os empréstimos antes de excluir.`);
        return;
      }
      
      if (!confirm(`❌ Excluir o livro "${livro.titulo}"?\n\nEsta ação não pode ser desfeita.`)) {
        return;
      }
      
      // Remove o livro
      database.livros = database.livros.filter(l => l.id !== id);
      
      // Remove empréstimos históricos do livro
      database.emprestimos = database.emprestimos.filter(e => e.livroId !== id);
      
      saveDatabase();
      
      if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
        loadLivros();
        loadFilterOptions();
      }
      
      updateDashboard();
      alert('✅ Livro excluído com sucesso!');
    }

    function importBooks() {
      const text = document.getElementById('importBooksText').value.trim();
      
      if (!text) {
        alert('❌ Digite os dados dos livros para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      
      lines.forEach(line => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length >= 2) {
          const livro = {
            id: database.nextId.livros++,
            titulo: parts[0],
            autor: parts[1],
            categoria: parts[2] || '',
            quantidade: parseInt(parts[3]) || 1,
            disponivel: parseInt(parts[3]) || 1,
            editora: '',
            descricao: '',
            foto: '',
            codigoBarra: '',
            localizacao: ''
          };
          
          database.livros.push(livro);
          imported++;
        }
      });
      
      if (imported > 0) {
        saveDatabase();
        closeModal('importBooksModal');
        document.getElementById('importBooksText').value = '';
        
        if (document.getElementById('livrosTab').classList.contains('hidden') === false) {
          loadLivros();
          loadFilterOptions();
        }
        
        updateDashboard();
        alert(`✅ ${imported} livro(s) importado(s) com sucesso!`);
      } else {
        alert('❌ Nenhum livro válido encontrado para importar.');
      }
    }

    // ===== GERENCIAMENTO DE USUÁRIOS =====
    function loadUsuarios() {
      const container = document.getElementById('usuariosList');
      
      container.innerHTML = database.usuarios.map(usuario => `
        <tr>
          <td class="px-6 py-4">${usuario.nome}</td>
          <td class="px-6 py-4">${usuario.login}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs rounded-full ${
              usuario.tipo === 'admin' ? 'bg-red-100 text-red-800' :
              usuario.tipo === 'professor' ? 'bg-blue-100 text-blue-800' :
              'bg-green-100 text-green-800'
            }">
              ${usuario.tipo}
            </span>
          </td>
          <td class="px-6 py-4">${usuario.turma || '-'}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs rounded-full ${
              usuario.status === 'ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }">
              ${usuario.status}
            </span>
          </td>
          <td class="px-6 py-4">
            ${currentUser.tipo === 'admin' && usuario.login !== 'ADMIN' ? `
              <button onclick="deleteUsuario(${usuario.id})" class="text-red-600 hover:text-red-800 text-sm">🗑️ Excluir</button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
    }

    function handleAddUser(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const login = formData.get('login').trim();
      
      // Verifica se login já existe
      if (database.usuarios.some(u => u.login.toLowerCase() === login.toLowerCase())) {
        alert('❌ Este login já está em uso.');
        return;
      }
      
      const usuario = {
        id: database.nextId.usuarios++,
        nome: formData.get('nome').trim(),
        login: login,
        senha: formData.get('senha'),
        tipo: formData.get('tipo'),
        turma: '',
        status: 'ativo',
        livrosLidos: 0
      };
      
      database.usuarios.push(usuario);
      saveDatabase();
      
      closeModal('addUserModal');
      event.target.reset();
      
      if (document.getElementById('usuariosTab').classList.contains('hidden') === false) {
        loadUsuarios();
      }
      
      updateDashboard();
      alert('✅ Usuário adicionado com sucesso!');
    }

    function importUsers() {
      const text = document.getElementById('importUsersText').value.trim();
      
      if (!text) {
        alert('❌ Digite os dados dos usuários para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      
      lines.forEach(line => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length >= 4) {
          const login = parts[1];
          
          // Verifica se login já existe
          if (!database.usuarios.some(u => u.login.toLowerCase() === login.toLowerCase())) {
            const usuario = {
              id: database.nextId.usuarios++,
              nome: parts[0],
              login: login,
              senha: parts[2],
              tipo: parts[3],
              turma: '',
              status: 'ativo',
              livrosLidos: 0
            };
            
            database.usuarios.push(usuario);
            imported++;
          }
        }
      });
      
      if (imported > 0) {
        saveDatabase();
        closeModal('importUsersModal');
        document.getElementById('importUsersText').value = '';
        
        if (document.getElementById('usuariosTab').classList.contains('hidden') === false) {
          loadUsuarios();
        }
        
        updateDashboard();
        alert(`✅ ${imported} usuário(s) importado(s) com sucesso!`);
      } else {
        alert('❌ Nenhum usuário válido encontrado para importar.');
      }
    }

    function deleteUsuario(id) {
      const usuario = database.usuarios.find(u => u.id === id);
      
      if (!usuario) return;
      
      if (!confirm(`❌ Excluir usuário "${usuario.nome}"?\n\nEsta ação não pode ser desfeita.`)) {
        return;
      }
      
      // Remove usuário
      database.usuarios = database.usuarios.filter(u => u.id !== id);
      
      // Remove empréstimos do usuário
      database.emprestimos = database.emprestimos.filter(e => e.alunoId !== id);
      
      saveDatabase();
      loadUsuarios();
      updateDashboard();
      
      alert('✅ Usuário excluído com sucesso!');
    }

    // ===== GERENCIAMENTO DE EMPRÉSTIMOS =====
    function loadEmprestimoModalData() {
      // Carrega alunos
      const alunoSelect = document.getElementById('emprestimoAluno');
      const alunos = database.usuarios.filter(u => u.tipo === 'aluno' && u.status === 'ativo');
      
      alunoSelect.innerHTML = '<option value="">Selecione o aluno...</option>' +
        alunos.map(aluno => `<option value="${aluno.id}">${aluno.nome}</option>`).join('');
      
      // Carrega livros disponíveis
      const livroSelect = document.getElementById('emprestimoLivro');
      const livrosDisponiveis = database.livros.filter(l => l.disponivel > 0);
      
      livroSelect.innerHTML = '<option value="">Selecione o livro...</option>' +
        livrosDisponiveis.map(livro => `<option value="${livro.id}">${livro.titulo} - ${livro.autor} (${livro.disponivel} disponível)</option>`).join('');
      
      // Define data padrão (7 dias)
      const dataDefault = new Date();
      dataDefault.setDate(dataDefault.getDate() + 7);
      document.getElementById('emprestimoDataDevolucao').value = dataDefault.toISOString().split('T')[0];
    }

    function handleAddEmprestimo(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const alunoId = parseInt(formData.get('alunoId'));
      const livroId = parseInt(formData.get('livroId'));
      const dataDevolucao = formData.get('dataDevolucao');
      
      // Verifica se o livro está disponível
      const livro = database.livros.find(l => l.id === livroId);
      if (!livro || livro.disponivel <= 0) {
        alert('❌ Livro não disponível para empréstimo.');
        return;
      }
      
      // Cria empréstimo
      const emprestimo = {
        id: database.nextId.emprestimos++,
        alunoId: alunoId,
        livroId: livroId,
        dataEmprestimo: new Date().toISOString().split('T')[0],
        dataDevolucao: dataDevolucao,
        status: 'ativo'
      };
      
      database.emprestimos.push(emprestimo);
      
      // Atualiza disponibilidade do livro
      livro.disponivel--;
      
      saveDatabase();
      
      closeModal('addEmprestimoModal');
      event.target.reset();
      
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      
      updateDashboard();
      alert('✅ Empréstimo realizado com sucesso!');
    }

    function loadEmprestimos() {
      const container = document.getElementById('emprestimosList');
      
      container.innerHTML = database.emprestimos.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <tr class="${atrasado ? 'bg-red-50' : ''}">
            <td class="px-6 py-4">${aluno?.nome || 'Usuário não encontrado'}</td>
            <td class="px-6 py-4">${livro?.titulo || 'Livro não encontrado'}</td>
            <td class="px-6 py-4">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-4 ${atrasado ? 'text-red-600 font-semibold' : ''}">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-4">
              <span class="px-2 py-1 text-xs rounded-full ${
                emprestimo.status === 'ativo' ? (atrasado ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800') : 'bg-green-100 text-green-800'
              }">
                ${emprestimo.status === 'ativo' ? (atrasado ? 'ATRASADO' : 'Ativo') : 'Devolvido'}
              </span>
            </td>
            <td class="px-6 py-4">
              <div class="flex gap-2">
                ${emprestimo.status === 'ativo' ? `
                  <button onclick="devolverLivro(${emprestimo.id})" class="text-green-600 hover:text-green-800 text-sm">✅ Devolver</button>
                ` : ''}
                ${currentUser && currentUser.tipo === 'admin' ? `
                  <button onclick="editEmprestimo(${emprestimo.id})" class="text-blue-600 hover:text-blue-800 text-sm">✏️ Editar</button>
                  <button onclick="deleteEmprestimo(${emprestimo.id})" class="text-red-600 hover:text-red-800 text-sm">🗑️ Excluir</button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function loadDevolucoesPendentes() {
      const container = document.getElementById('devolucoesList');
      const hoje = new Date();
      
      const pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      );
      
      container.innerHTML = pendentes.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const diasAtraso = Math.floor((hoje - new Date(emprestimo.dataDevolucao)) / (1000 * 60 * 60 * 24));
        
        return `
          <tr class="bg-red-50">
            <td class="px-6 py-4">${aluno?.nome || 'Usuário não encontrado'}</td>
            <td class="px-6 py-4">${livro?.titulo || 'Livro não encontrado'}</td>
            <td class="px-6 py-4">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-4 text-red-600 font-semibold">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-4 text-red-600 font-semibold">${diasAtraso} dia(s)</td>
            <td class="px-6 py-4">
              <button onclick="devolverLivro(${emprestimo.id})" class="text-green-600 hover:text-green-800 text-sm">✅ Devolver</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function devolverLivro(emprestimoId) {
      const emprestimo = database.emprestimos.find(e => e.id === emprestimoId);
      
      if (!emprestimo || emprestimo.status !== 'ativo') return;
      
      const livro = database.livros.find(l => l.id === emprestimo.livroId);
      
      if (!confirm(`📚 Confirmar devolução do livro "${livro?.titulo}"?`)) {
        return;
      }
      
      // Atualiza empréstimo
      emprestimo.status = 'devolvido';
      emprestimo.dataRealDevolucao = new Date().toISOString().split('T')[0];
      
      // Atualiza disponibilidade do livro
      if (livro) {
        livro.disponivel++;
      }
      
      saveDatabase();
      
      // Atualiza as telas
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      if (document.getElementById('devolucoesTab').classList.contains('hidden') === false) {
        loadDevolucoesPendentes();
      }
      
      updateDashboard();
      alert('✅ Livro devolvido com sucesso!');
    }

    function editEmprestimo(id) {
      const emprestimo = database.emprestimos.find(e => e.id === id);
      
      if (!emprestimo) {
        alert('❌ Empréstimo não encontrado.');
        return;
      }
      
      // Carrega dados para os selects
      const alunoSelect = document.getElementById('editEmprestimoAluno');
      const livroSelect = document.getElementById('editEmprestimoLivro');
      
      // Carrega todos os alunos
      const alunos = database.usuarios.filter(u => u.tipo === 'aluno' && u.status === 'ativo');
      alunoSelect.innerHTML = '<option value="">Selecione o aluno...</option>' +
        alunos.map(aluno => `<option value="${aluno.id}">${aluno.nome}</option>`).join('');
      
      // Carrega todos os livros (incluindo o atual do empréstimo)
      livroSelect.innerHTML = '<option value="">Selecione o livro...</option>' +
        database.livros.map(livro => `<option value="${livro.id}">${livro.titulo} - ${livro.autor}</option>`).join('');
      
      // Preenche o formulário
      document.getElementById('editEmprestimoId').value = emprestimo.id;
      document.getElementById('editEmprestimoAluno').value = emprestimo.alunoId;
      document.getElementById('editEmprestimoLivro').value = emprestimo.livroId;
      document.getElementById('editEmprestimoDataEmprestimo').value = emprestimo.dataEmprestimo;
      document.getElementById('editEmprestimoDataDevolucao').value = emprestimo.dataDevolucao;
      document.getElementById('editEmprestimoStatus').value = emprestimo.status;
      
      showModal('editEmprestimoModal');
    }

    function handleEditEmprestimo(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const id = parseInt(formData.get('id'));
      
      const emprestimoIndex = database.emprestimos.findIndex(e => e.id === id);
      
      if (emprestimoIndex === -1) {
        alert('❌ Empréstimo não encontrado.');
        return;
      }
      
      const emprestimo = database.emprestimos[emprestimoIndex];
      const livroAnterior = database.livros.find(l => l.id === emprestimo.livroId);
      const novoLivroId = parseInt(formData.get('livroId'));
      const novoLivro = database.livros.find(l => l.id === novoLivroId);
      const statusAnterior = emprestimo.status;
      const novoStatus = formData.get('status');
      
      // Se mudou o livro, ajusta disponibilidade
      if (emprestimo.livroId !== novoLivroId) {
        // Devolve o livro anterior (se estava ativo)
        if (statusAnterior === 'ativo' && livroAnterior) {
          livroAnterior.disponivel++;
        }
        
        // Empresta o novo livro (se ficará ativo)
        if (novoStatus === 'ativo' && novoLivro) {
          if (novoLivro.disponivel <= 0) {
            alert('❌ O livro selecionado não está disponível.');
            return;
          }
          novoLivro.disponivel--;
        }
      } else {
        // Mesmo livro, mas mudou status
        if (statusAnterior === 'ativo' && novoStatus === 'devolvido' && livroAnterior) {
          livroAnterior.disponivel++;
        } else if (statusAnterior === 'devolvido' && novoStatus === 'ativo' && novoLivro) {
          if (novoLivro.disponivel <= 0) {
            alert('❌ O livro não está disponível para reativar o empréstimo.');
            return;
          }
          novoLivro.disponivel--;
        }
      }
      
      // Atualiza o empréstimo
      emprestimo.alunoId = parseInt(formData.get('alunoId'));
      emprestimo.livroId = novoLivroId;
      emprestimo.dataEmprestimo = formData.get('dataEmprestimo');
      emprestimo.dataDevolucao = formData.get('dataDevolucao');
      emprestimo.status = novoStatus;
      
      // Se foi marcado como devolvido, adiciona data real de devolução
      if (novoStatus === 'devolvido' && statusAnterior === 'ativo') {
        emprestimo.dataRealDevolucao = new Date().toISOString().split('T')[0];
      } else if (novoStatus === 'ativo') {
        delete emprestimo.dataRealDevolucao;
      }
      
      saveDatabase();
      
      closeModal('editEmprestimoModal');
      
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      if (document.getElementById('devolucoesTab').classList.contains('hidden') === false) {
        loadDevolucoesPendentes();
      }
      
      updateDashboard();
      alert('✅ Empréstimo atualizado com sucesso!');
    }

    function deleteEmprestimo(id) {
      const emprestimo = database.emprestimos.find(e => e.id === id);
      
      if (!emprestimo) {
        alert('❌ Empréstimo não encontrado.');
        return;
      }
      
      const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
      const livro = database.livros.find(l => l.id === emprestimo.livroId);
      
      if (!confirm(`❌ Excluir empréstimo?\n\nAluno: ${aluno?.nome || 'Não encontrado'}\nLivro: ${livro?.titulo || 'Não encontrado'}\nData: ${formatDate(emprestimo.dataEmprestimo)}\n\nEsta ação não pode ser desfeita.`)) {
        return;
      }
      
      // Se o empréstimo estava ativo, devolve o livro
      if (emprestimo.status === 'ativo' && livro) {
        livro.disponivel++;
      }
      
      // Remove o empréstimo
      database.emprestimos = database.emprestimos.filter(e => e.id !== id);
      
      saveDatabase();
      
      if (document.getElementById('emprestimosTab').classList.contains('hidden') === false) {
        loadEmprestimos();
      }
      if (document.getElementById('devolucoesTab').classList.contains('hidden') === false) {
        loadDevolucoesPendentes();
      }
      
      updateDashboard();
      alert('✅ Empréstimo excluído com sucesso!');
    }

    // ===== FUNÇÕES DE BACKUP =====
    let loadedBackups = [];
    let mergedBackupData = null;
    let mergeLog = [];

    function exportarBackup() {
      const data = JSON.stringify(database, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblion-mega-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      alert('💾 Backup tradicional baixado com sucesso!');
    }

    function copiarBackup() {
      const data = JSON.stringify(database, null, 2);
      
      navigator.clipboard.writeText(data).then(() => {
        alert('📋 Dados copiados para a área de transferência!');
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = data;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('📋 Dados copiados!');
      });
    }

    function restaurarBackup() {
      const file = document.getElementById('backupFile').files[0];
      const text = document.getElementById('backupText').value.trim();
      
      if (!file && !text) {
        alert('❌ Selecione um arquivo ou cole os dados do backup.');
        return;
      }
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          processBackupData(e.target.result);
        };
        reader.readAsText(file);
      } else {
        processBackupData(text);
      }
    }

    function processBackupData(data) {
      try {
        const backupData = JSON.parse(data);
        
        if (!backupData.usuarios || !backupData.livros || !backupData.emprestimos) {
          throw new Error('Formato de backup inválido');
        }
        
        if (!confirm(`📥 Confirmar restauração?\n\n📊 Dados a importar:\n• ${backupData.livros.length} livros\n• ${backupData.usuarios.length} usuários\n• ${backupData.emprestimos.length} empréstimos\n\n⚠️ Os dados atuais serão substituídos!`)) {
          return;
        }
        
        database = backupData;
        
        if (!database.nextId) {
          database.nextId = {
            usuarios: Math.max(...database.usuarios.map(u => u.id), 0) + 1,
            livros: Math.max(...database.livros.map(l => l.id), 0) + 1,
            emprestimos: Math.max(...database.emprestimos.map(e => e.id), 0) + 1
          };
        }
        
        saveDatabase();
        
        document.getElementById('backupFile').value = '';
        document.getElementById('backupText').value = '';
        
        alert('✅ Backup restaurado com sucesso!\n\nA página será recarregada.');
        location.reload();
        
      } catch (error) {
        alert('❌ Erro ao restaurar backup: ' + error.message);
      }
    }

    // ===== FUNÇÕES DE JUNÇÃO DE BACKUPS =====
    function loadBackupsForMerge() {
      const files = document.getElementById('mergeBackupFiles').files;
      
      if (files.length < 2) {
        alert('❌ Selecione pelo menos 2 arquivos de backup para juntar.');
        return;
      }
      
      loadedBackups = [];
      let filesProcessed = 0;
      
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backupData = JSON.parse(e.target.result);
            
            if (!backupData.usuarios || !backupData.livros || !backupData.emprestimos) {
              throw new Error(`Arquivo ${file.name}: Formato de backup inválido`);
            }
            
            loadedBackups.push({
              fileName: file.name,
              data: backupData,
              stats: {
                usuarios: backupData.usuarios.length,
                livros: backupData.livros.length,
                emprestimos: backupData.emprestimos.length
              }
            });
            
            filesProcessed++;
            
            if (filesProcessed === files.length) {
              displayBackupsPreview();
            }
            
          } catch (error) {
            alert(`❌ Erro ao carregar ${file.name}: ${error.message}`);
          }
        };
        reader.readAsText(file);
      });
    }

    function displayBackupsPreview() {
      const container = document.getElementById('backupsPreviewContent');
      
      container.innerHTML = loadedBackups.map((backup, index) => `
        <div class="border rounded-lg p-4 ${index === 0 ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'}">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">${backup.fileName}</div>
            <div class="text-xs px-2 py-1 rounded ${index === 0 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'}">
              ${index === 0 ? 'Base' : `Backup ${index + 1}`}
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 text-sm">
            <div class="text-center">
              <div class="text-2xl text-blue-600">👥</div>
              <div class="font-bold">${backup.stats.usuarios}</div>
              <div class="text-xs text-gray-600">Usuários</div>
            </div>
            <div class="text-center">
              <div class="text-2xl text-green-600">📚</div>
              <div class="font-bold">${backup.stats.livros}</div>
              <div class="text-xs text-gray-600">Livros</div>
            </div>
            <div class="text-center">
              <div class="text-2xl text-orange-600">📋</div>
              <div class="font-bold">${backup.stats.emprestimos}</div>
              <div class="text-xs text-gray-600">Empréstimos</div>
            </div>
          </div>
          
          ${backup.data.metadata ? `
            <div class="mt-2 text-xs text-gray-500">
              📅 ${backup.data.metadata.lastUpdate ? new Date(backup.data.metadata.lastUpdate).toLocaleDateString('pt-BR') : 'Data não informada'}
            </div>
          ` : ''}
        </div>
      `).join('');
      
      document.getElementById('backupsPreview').classList.remove('hidden');
      document.getElementById('mergeSettings').classList.remove('hidden');
      document.getElementById('executeMergeBtn').classList.remove('hidden');
    }

    function executeMergeBackups() {
      if (loadedBackups.length < 2) {
        alert('❌ Carregue pelo menos 2 backups primeiro.');
        return;
      }
      
      const userConflictMode = document.getElementById('userConflictMode').value;
      const bookConflictMode = document.getElementById('bookConflictMode').value;
      const loanConflictMode = document.getElementById('loanConflictMode').value;
      const preserveIds = document.getElementById('preserveIds').checked;
      const createLog = document.getElementById('createMergeLog').checked;
      
      mergeLog = [];
      
      try {
        // Inicia com o primeiro backup como base
        const baseBackup = loadedBackups[0];
        mergedBackupData = {
          usuarios: [...baseBackup.data.usuarios],
          livros: [...baseBackup.data.livros],
          emprestimos: [...baseBackup.data.emprestimos],
          nextId: { ...baseBackup.data.nextId },
          metadata: {
            version: '6.0',
            lastUpdate: new Date().toISOString(),
            systemName: 'BibliOn Supremo - Sistema QR Code MEGA V6.0',
            mergedFrom: loadedBackups.map(b => b.fileName),
            mergeDate: new Date().toISOString(),
            mergeSettings: {
              userConflictMode,
              bookConflictMode,
              loanConflictMode,
              preserveIds
            }
          }
        };
        
        if (createLog) {
          mergeLog.push(`🔗 Iniciando junção de ${loadedBackups.length} backups`);
          mergeLog.push(`📁 Base: ${baseBackup.fileName} (${baseBackup.stats.usuarios} usuários, ${baseBackup.stats.livros} livros, ${baseBackup.stats.emprestimos} empréstimos)`);
        }
        
        // Processa os demais backups
        for (let i = 1; i < loadedBackups.length; i++) {
          const currentBackup = loadedBackups[i];
          
          if (createLog) {
            mergeLog.push(`📁 Processando: ${currentBackup.fileName}`);
          }
          
          // Mescla usuários
          mergeUsers(currentBackup.data.usuarios, userConflictMode, createLog);
          
          // Mescla livros
          mergeBooks(currentBackup.data.livros, bookConflictMode, createLog);
          
          // Mescla empréstimos
          mergeLoans(currentBackup.data.emprestimos, loanConflictMode, createLog);
        }
        
        // Atualiza nextId
        updateNextIds();
        
        if (createLog) {
          mergeLog.push(`✅ Junção concluída com sucesso!`);
          mergeLog.push(`📊 Resultado final: ${mergedBackupData.usuarios.length} usuários, ${mergedBackupData.livros.length} livros, ${mergedBackupData.emprestimos.length} empréstimos`);
        }
        
        displayMergeResult();
        
      } catch (error) {
        alert(`❌ Erro durante a junção: ${error.message}`);
        console.error('Erro na junção:', error);
      }
    }

    function mergeUsers(newUsers, conflictMode, createLog) {
      let added = 0, skipped = 0, merged = 0, replaced = 0;
      
      newUsers.forEach(newUser => {
        // Verifica se usuário já existe (por login OU por ID)
        const existingByLogin = mergedBackupData.usuarios.find(u => 
          u.login.toLowerCase() === newUser.login.toLowerCase()
        );
        const existingById = mergedBackupData.usuarios.find(u => u.id === newUser.id);
        
        // Se não existe nem por login nem por ID, adiciona
        if (!existingByLogin && !existingById) {
          mergedBackupData.usuarios.push({ ...newUser });
          added++;
          return;
        }
        
        // Se existe, verifica se são exatamente iguais
        const existing = existingByLogin || existingById;
        const areIdentical = (
          existing.nome === newUser.nome &&
          existing.login === newUser.login &&
          existing.senha === newUser.senha &&
          existing.tipo === newUser.tipo &&
          existing.turma === newUser.turma &&
          existing.status === newUser.status
        );
        
        if (areIdentical) {
          skipped++; // Dados idênticos, pula
          return;
        }
        
        // Dados diferentes, aplica estratégia de conflito
        switch (conflictMode) {
          case 'skip':
            skipped++;
            break;
            
          case 'rename':
            const renamedUser = { 
              ...newUser, 
              id: mergedBackupData.nextId.usuarios++,
              login: `${newUser.login}_${Date.now()}`,
              nome: `${newUser.nome} (Backup)`
            };
            mergedBackupData.usuarios.push(renamedUser);
            added++;
            break;
            
          case 'merge':
            // Mescla apenas campos vazios ou melhores
            if (newUser.turma && !existing.turma) existing.turma = newUser.turma;
            if ((newUser.livrosLidos || 0) > (existing.livrosLidos || 0)) {
              existing.livrosLidos = newUser.livrosLidos;
            }
            merged++;
            break;
            
          case 'replace':
            const existingIndex = mergedBackupData.usuarios.findIndex(u => u.id === existing.id);
            mergedBackupData.usuarios[existingIndex] = { ...newUser };
            replaced++;
            break;
        }
      });
      
      if (createLog) {
        mergeLog.push(`👥 Usuários: +${added} novos, ${skipped} idênticos, ${merged} mesclados, ${replaced} substituídos`);
      }
    }

    function mergeBooks(newBooks, conflictMode, createLog) {
      let added = 0, skipped = 0, merged = 0, replaced = 0;
      
      newBooks.forEach(newBook => {
        // Verifica se livro já existe (por título+autor OU por ID)
        const existingByContent = mergedBackupData.livros.find(l => 
          l.titulo.toLowerCase().trim() === newBook.titulo.toLowerCase().trim() && 
          l.autor.toLowerCase().trim() === newBook.autor.toLowerCase().trim()
        );
        const existingById = mergedBackupData.livros.find(l => l.id === newBook.id);
        
        // Se não existe nem por conteúdo nem por ID, adiciona
        if (!existingByContent && !existingById) {
          mergedBackupData.livros.push({ ...newBook });
          added++;
          return;
        }
        
        // Se existe, verifica se são exatamente iguais
        const existing = existingByContent || existingById;
        const areIdentical = (
          existing.titulo === newBook.titulo &&
          existing.autor === newBook.autor &&
          existing.editora === newBook.editora &&
          existing.categoria === newBook.categoria &&
          existing.quantidade === newBook.quantidade &&
          existing.codigoBarra === newBook.codigoBarra &&
          existing.localizacao === newBook.localizacao &&
          existing.descricao === newBook.descricao
        );
        
        if (areIdentical) {
          skipped++; // Dados idênticos, pula
          return;
        }
        
        // Dados diferentes, aplica estratégia de conflito
        switch (conflictMode) {
          case 'skip':
            skipped++;
            break;
            
          case 'merge':
            // Soma quantidades e melhora informações
            existing.quantidade += newBook.quantidade;
            existing.disponivel += newBook.disponivel;
            if (newBook.editora && !existing.editora) existing.editora = newBook.editora;
            if (newBook.categoria && !existing.categoria) existing.categoria = newBook.categoria;
            if (newBook.codigoBarra && !existing.codigoBarra) existing.codigoBarra = newBook.codigoBarra;
            if (newBook.localizacao && !existing.localizacao) existing.localizacao = newBook.localizacao;
            if (newBook.descricao && !existing.descricao) existing.descricao = newBook.descricao;
            if (newBook.foto && !existing.foto) existing.foto = newBook.foto;
            merged++;
            break;
            
          case 'replace':
            const existingIndex = mergedBackupData.livros.findIndex(l => l.id === existing.id);
            mergedBackupData.livros[existingIndex] = { ...newBook };
            replaced++;
            break;
            
          case 'keep_both':
            const duplicatedBook = { 
              ...newBook, 
              id: mergedBackupData.nextId.livros++,
              titulo: `${newBook.titulo} (Backup ${Date.now()})`
            };
            mergedBackupData.livros.push(duplicatedBook);
            added++;
            break;
        }
      });
      
      if (createLog) {
        mergeLog.push(`📚 Livros: +${added} novos, ${skipped} idênticos, ${merged} mesclados, ${replaced} substituídos`);
      }
    }

    function mergeLoans(newLoans, conflictMode, createLog) {
      let added = 0, skipped = 0;
      
      newLoans.forEach(newLoan => {
        // Verifica se empréstimo já existe (por ID ou por combinação única)
        const existingById = mergedBackupData.emprestimos.find(e => e.id === newLoan.id);
        const existingByData = mergedBackupData.emprestimos.find(e => 
          e.alunoId === newLoan.alunoId && 
          e.livroId === newLoan.livroId && 
          e.dataEmprestimo === newLoan.dataEmprestimo
        );
        
        const existing = existingById || existingByData;
        
        // Se não existe, verifica se deve adicionar baseado na estratégia
        if (!existing) {
          const shouldAdd = (() => {
            switch (conflictMode) {
              case 'merge_all':
                return true;
                
              case 'active_only':
                return newLoan.status === 'ativo';
                
              case 'recent_only':
                // Só adiciona se for mais recente que outros do mesmo aluno+livro
                const olderLoan = mergedBackupData.emprestimos.find(e => 
                  e.alunoId === newLoan.alunoId && 
                  e.livroId === newLoan.livroId &&
                  new Date(e.dataEmprestimo) < new Date(newLoan.dataEmprestimo)
                );
                return !olderLoan;
                
              default:
                return true;
            }
          })();
          
          if (shouldAdd) {
            mergedBackupData.emprestimos.push({ ...newLoan });
            added++;
          } else {
            skipped++;
          }
        } else {
          // Empréstimo já existe, verifica se são idênticos
          const areIdentical = (
            existing.alunoId === newLoan.alunoId &&
            existing.livroId === newLoan.livroId &&
            existing.dataEmprestimo === newLoan.dataEmprestimo &&
            existing.dataDevolucao === newLoan.dataDevolucao &&
            existing.status === newLoan.status
          );
          
          if (areIdentical) {
            skipped++; // Dados idênticos, pula
          } else {
            // Se for mais recente, atualiza
            if (conflictMode === 'recent_only' && 
                new Date(newLoan.dataEmprestimo) > new Date(existing.dataEmprestimo)) {
              const existingIndex = mergedBackupData.emprestimos.findIndex(e => e.id === existing.id);
              mergedBackupData.emprestimos[existingIndex] = { ...newLoan };
              added++;
            } else {
              skipped++;
            }
          }
        }
      });
      
      if (createLog) {
        mergeLog.push(`📋 Empréstimos: +${added} novos/atualizados, ${skipped} idênticos/ignorados`);
      }
    }

    function updateNextIds() {
      mergedBackupData.nextId = {
        usuarios: Math.max(...mergedBackupData.usuarios.map(u => u.id), 0) + 1,
        livros: Math.max(...mergedBackupData.livros.map(l => l.id), 0) + 1,
        emprestimos: Math.max(...mergedBackupData.emprestimos.map(e => e.id), 0) + 1
      };
    }

    function displayMergeResult() {
      const container = document.getElementById('mergeResultContent');
      
      const totalStats = {
        usuarios: mergedBackupData.usuarios.length,
        livros: mergedBackupData.livros.length,
        emprestimos: mergedBackupData.emprestimos.length
      };
      
      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-blue-600 mb-2">👥</div>
            <div class="text-2xl font-bold">${totalStats.usuarios}</div>
            <div class="text-sm text-gray-600">Usuários Total</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-green-600 mb-2">📚</div>
            <div class="text-2xl font-bold">${totalStats.livros}</div>
            <div class="text-sm text-gray-600">Livros Total</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg border">
            <div class="text-3xl text-orange-600 mb-2">📋</div>
            <div class="text-2xl font-bold">${totalStats.emprestimos}</div>
            <div class="text-sm text-gray-600">Empréstimos Total</div>
          </div>
        </div>
        
        ${mergeLog.length > 0 ? `
          <div class="bg-white rounded-lg border p-4">
            <h5 class="font-semibold mb-2">📝 Log da Junção:</h5>
            <div class="text-xs space-y-1 max-h-40 overflow-y-auto">
              ${mergeLog.map(log => `<div>${log}</div>`).join('')}
            </div>
          </div>
        ` : ''}
        
        <div class="mt-4 flex gap-2">
          <button onclick="downloadMergedBackup()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
            💾 Baixar Backup Unificado
          </button>
          <button onclick="copyMergedBackup()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm">
            📋 Copiar Dados
          </button>
        </div>
      `;
      
      document.getElementById('mergeResult').classList.remove('hidden');
      document.getElementById('applyMergeBtn').classList.remove('hidden');
    }

    function downloadMergedBackup() {
      if (!mergedBackupData) {
        alert('❌ Nenhum backup unificado disponível.');
        return;
      }
      
      const data = JSON.stringify(mergedBackupData, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblion-backup-unificado-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      alert('💾 Backup unificado baixado com sucesso!');
    }

    function copyMergedBackup() {
      if (!mergedBackupData) {
        alert('❌ Nenhum backup unificado disponível.');
        return;
      }
      
      const data = JSON.stringify(mergedBackupData, null, 2);
      
      navigator.clipboard.writeText(data).then(() => {
        alert('📋 Backup unificado copiado para a área de transferência!');
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = data;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('📋 Backup unificado copiado!');
      });
    }

    function applyMergedBackup() {
      if (!mergedBackupData) {
        alert('❌ Nenhum backup unificado disponível.');
        return;
      }
      
      const totalStats = {
        usuarios: mergedBackupData.usuarios.length,
        livros: mergedBackupData.livros.length,
        emprestimos: mergedBackupData.emprestimos.length
      };
      
      if (!confirm(`🔗 Aplicar backup unificado?\n\n📊 Dados a aplicar:\n• ${totalStats.usuarios} usuários\n• ${totalStats.livros} livros\n• ${totalStats.emprestimos} empréstimos\n\n⚠️ Os dados atuais serão substituídos pelo backup unificado!`)) {
        return;
      }
      
      database = { ...mergedBackupData };
      saveDatabase();
      
      closeModal('mergeBackupsModal');
      
      alert('✅ Backup unificado aplicado com sucesso!\n\nA página será recarregada para atualizar a interface.');
      location.reload();
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
      initializeDatabase();
      
      // Login
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      
      // Toggle password
      document.getElementById('togglePwd').addEventListener('click', function() {
        const pwd = document.getElementById('loginPassword');
        const btn = this;
        
        if (pwd.type === 'password') {
          pwd.type = 'text';
          btn.textContent = 'Ocultar';
        } else {
          pwd.type = 'password';
          btn.textContent = 'Mostrar';
        }
      });
      
      // Forms
      document.getElementById('addBookForm').addEventListener('submit', handleAddBook);
      document.getElementById('editBookForm').addEventListener('submit', handleEditBook);
      document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
      document.getElementById('addEmprestimoForm').addEventListener('submit', handleAddEmprestimo);
      document.getElementById('editEmprestimoForm').addEventListener('submit', handleEditEmprestimo);
      
      // Preview de imagens
      document.getElementById('addBookFoto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('addBookPreview');
        const img = document.getElementById('addBookPreviewImg');
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            img.src = e.target.result;
            preview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        } else {
          preview.classList.add('hidden');
        }
      });
      
      document.getElementById('editBookFoto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('editBookPreview');
        const img = document.getElementById('editBookPreviewImg');
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            img.src = e.target.result;
            preview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Filtros
      document.getElementById('searchLivros').addEventListener('input', loadLivros);
      document.getElementById('filterCategoria').addEventListener('change', loadLivros);
      document.getElementById('filterAutor').addEventListener('change', loadLivros);
      document.getElementById('filterDisponibilidade').addEventListener('change', loadLivros);
    });

    // ===== FUNÇÕES GLOBAIS =====
    window.showTab = showTab;
    window.showModal = showModal;
    window.closeModal = closeModal;
    window.logout = logout;
    window.editLivro = editLivro;
    window.deleteLivro = deleteLivro;
    window.importBooks = importBooks;
    window.importUsers = importUsers;
    window.deleteUsuario = deleteUsuario;
    window.devolverLivro = devolverLivro;
    window.editEmprestimo = editEmprestimo;
    window.deleteEmprestimo = deleteEmprestimo;
    window.clearLivrosFilters = clearLivrosFilters;
    window.exportarBackup = exportarBackup;
    window.copiarBackup = copiarBackup;
    window.restaurarBackup = restaurarBackup;
    window.gerarQRCodeMega = gerarQRCodeMega;
    window.copiarLinkMega = copiarLinkMega;
    window.loadBackupsForMerge = loadBackupsForMerge;
    window.executeMergeBackups = executeMergeBackups;
    window.downloadMergedBackup = downloadMergedBackup;
    window.copyMergedBackup = copyMergedBackup;
    window.applyMergedBackup = applyMergedBackup;
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99345aa56077f1db',t:'MTc2MTI1NTIyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
