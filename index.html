<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BibliOn - Sistema de Biblioteca</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    body { box-sizing: border-box; }
    .gradient-bg { background: linear-gradient(135deg, #d2691e 0%, #a0522d 100%); }
    .card-hover { transition: all .3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -10px rgba(0,0,0,.15);}
    .nav-btn.active { border-color:#d2691e !important; color:#d2691e !important; }
    .book-card { background: linear-gradient(145deg, #ffffff, #f3f3f3); border: 1px solid #e6e6e6; }
    .transition-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#d2691e,#a0522d);z-index:50;opacity:0;visibility:hidden;transition:all .5s ease}
    .transition-screen.active{opacity:1;visibility:visible}
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
    .float { animation: float 2s ease-in-out infinite; }
  </style>
</head>
<body class="bg-[#0f172a]">
  <!-- Tela de Transição -->
  <div id="transitionScreen" class="transition-screen">
    <div class="text-center text-white">
      <div class="float mb-4 text-6xl">📚</div>
      <h1 class="text-3xl font-bold">Carregando sua biblioteca...</h1>
    </div>
  </div>

  <!-- Login -->
  <section id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="text-5xl mb-2">📚</div>
        <h1 class="text-3xl font-bold text-gray-800">BibliOn</h1>
        <p class="text-gray-500">Sistema de Gerenciamento de Biblioteca</p>
      </div>

      <form id="loginForm" class="space-y-5">
        <div>
          <label for="loginUser" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
          <input id="loginUser" type="text" placeholder="Seu usuário" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none" required />
        </div>

        <div>
          <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
          <div class="relative">
            <input id="loginPassword" type="password" placeholder="Sua senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none pr-12" required />
            <button type="button" id="togglePwd" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 text-sm text-orange-700 bg-orange-100 rounded hover:bg-orange-200">Mostrar</button>
          </div>
        </div>

        <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition">Entrar</button>
      </form>

      <div class="mt-8 text-center text-xs text-gray-500">
        Criado por Nathannael Teles · Teles Design
      </div>
    </div>
  </section>

  <!-- App -->
  <div id="mainSystem" class="hidden">
    <!-- Header -->
    <header class="gradient-bg text-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-3xl">📚</div>
          <h1 class="text-2xl font-bold">BibliOn</h1>
        </div>
        <div class="flex items-center gap-2">
          <span id="userWelcome" class="text-sm opacity-90"></span>
          <button id="trocarSenhaBtn" class="bg-amber-700 hover:bg-amber-800 px-3 py-2 rounded-lg hidden">🔑 Trocar Senha</button>
          <button onclick="logout()" class="bg-red-700 hover:bg-red-800 px-3 py-2 rounded-lg">Sair</button>
        </div>
      </div>
    </header>

    <!-- Nav -->
    <nav class="bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-6">
          <button onclick="showTab('inicio')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700 active">🏠 Início</button>
          <button onclick="showTab('livros')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">📖 Livros</button>
          <button onclick="showTab('emprestimos')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">📋 Empréstimos</button>
          <button onclick="showTab('devolucoes')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">⏰ Devoluções</button>
          <button id="usuariosTabBtn" onclick="showTab('usuarios')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">👥 Usuários</button>
          <button onclick="showTab('backup')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">💾 Backup</button>
          <button onclick="showTab('qrcode')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">📱 QR Code</button>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <!-- INÍCIO -->
      <section id="inicioTab" class="tab-content">
        <h2 class="text-2xl font-bold text-white mb-6">Painel</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-blue-100 p-3 rounded-full text-xl">📚</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Livros</p>
                <p id="totalLivros" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-green-100 p-3 rounded-full text-xl">📋</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Empréstimos</p>
                <p id="totalEmprestimos" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-red-100 p-3 rounded-full text-xl">⏰</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Pendências</p>
                <p id="totalPendentes" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div id="usuariosCard" class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-purple-100 p-3 rounded-full text-xl">👥</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Usuários</p>
                <p id="totalUsuarios" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-semibold text-gray-800 mb-4">⭐ Livros em Destaque</h3>
          <div id="livrosDestaque" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4"></div>
        </div>

        <div id="meusEmprestimos" class="mt-8 bg-white rounded-xl p-6 hidden">
          <h3 class="font-semibold text-gray-800 mb-4">📖 Meus Empréstimos</h3>
          <div id="emprestimosAluno" class="space-y-3"></div>
        </div>
      </section>

      <!-- LIVROS -->
      <section id="livrosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Livros</h2>
          <div id="livrosActions" class="space-x-2">
            <button onclick="showModal('addBookModal')" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">➕ Adicionar</button>
            <button onclick="showModal('importBooksModal')" class="bg-amber-800 hover:bg-amber-900 text-white px-4 py-2 rounded-lg">📄 Importar</button>
            <button id="clearLibraryBtn" onclick="showModal('clearLibraryModal')" class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-lg hidden">🗑️ Limpar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">🔍 Filtros</h3>
            <button onclick="clearLivrosFilters()" class="text-sm text-orange-600 underline">Limpar</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <input id="searchLivros" type="text" placeholder="Título, autor, código de barras..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <select id="filterCategoria" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"><option value="">Todas as categorias</option></select>
            <select id="filterAutor" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"><option value="">Todos os autores</option></select>
            <select id="filterDisponibilidade" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700">
              <option value="">Todos</option>
              <option value="disponivel">Disponível</option>
              <option value="indisponivel">Indisponível</option>
            </select>
          </div>
        </div>

        <div id="livrosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>

      <!-- EMPRÉSTIMOS -->
      <section id="emprestimosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Empréstimos</h2>
          <button id="addEmprestimoBtn" onclick="showAddEmprestimoModal()" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">➕ Novo</button>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">🔍 Filtros</h3>
            <button onclick="clearEmprestimosFilters()" class="text-sm text-orange-600 underline">Limpar</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <input id="searchEmprestimos" type="text" placeholder="Aluno, livro, turma..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <input id="filterDataInicio" type="date" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <input id="filterDataFim" type="date" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <select id="filterTurma" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"><option value="">Todas as turmas</option></select>
          </div>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">Empréstimo</th>
                  <th class="px-6 py-3 text-left">Devolução</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="emprestimosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DEVOLUÇÕES -->
      <section id="devolucoesTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">Devoluções Pendentes</h2>
        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-red-50 text-xs text-red-600 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">Empréstimo</th>
                  <th class="px-6 py-3 text-left">Prevista</th>
                  <th class="px-6 py-3 text-left">Atraso</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="devolucoesList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- USUÁRIOS -->
      <section id="usuariosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Usuários</h2>
          <div class="space-x-2">
            <button onclick="showModal('addUserModal')" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">➕ Adicionar</button>
            <button onclick="showModal('importUsersModal')" class="bg-amber-800 hover:bg-amber-900 text-white px-4 py-2 rounded-lg">📄 Importar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="searchUsuarios" type="text" placeholder="Buscar usuários..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <select id="filterTipoUsuario" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700">
              <option value="">Todos os tipos</option>
              <option value="aluno">Aluno</option>
              <option value="professor">Professor</option>
              <option value="diretor">Diretor</option>
              <option value="coordenador">Coordenador</option>
              <option value="ajudante">Ajudante</option>
              <option value="admin">Admin</option>
            </select>
            <select id="filterStatusUsuario" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700">
              <option value="">Todos</option>
              <option value="ativo">Ativo</option>
              <option value="bloqueado">Bloqueado</option>
            </select>
          </div>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Nome</th>
                  <th class="px-6 py-3 text-left">Login</th>
                  <th class="px-6 py-3 text-left">Tipo</th>
                  <th class="px-6 py-3 text-left">Turma</th>
                  <th class="px-6 py-3 text-left">Lidos</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="usuariosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- QR CODE -->
      <section id="qrcodeTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">📱 QR Code - Teles Design</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- QR Code Display -->
          <div class="bg-white rounded-xl p-8 text-center">
            <h3 class="text-xl font-bold text-blue-600 mb-6">🎨 Acesse o Teles Design</h3>
            
            <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-8 mb-6">
              <div id="qrCodeContainer" class="flex justify-center">
                <!-- QR Code será gerado aqui -->
              </div>
            </div>
            
            <div class="space-y-3">
              <div class="text-sm text-gray-600">
                <strong>Link:</strong> 
                <a href="https://nathan-12t.github.io/teles-design/" target="_blank" rel="noopener noreferrer" 
                   class="text-blue-600 hover:underline break-all">
                  https://nathan-12t.github.io/teles-design/
                </a>
              </div>
              
              <div class="flex gap-2 justify-center flex-wrap">
                <button onclick="window.open('https://nathan-12t.github.io/teles-design/', '_blank', 'noopener,noreferrer')" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">
                  🌐 Abrir Site
                </button>
                <button onclick="copiarLinkTeles()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm">
                  📋 Link Simples
                </button>
                <button onclick="copiarLinkComBackup()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm">
                  💾 Link + Backup
                </button>
              </div>
            </div>
          </div>

          <!-- Informações -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-purple-600 mb-4">ℹ️ Sobre o Teles Design</h3>
            
            <div class="space-y-4 text-sm text-gray-700">
              <div class="bg-purple-50 border border-purple-200 p-4 rounded-lg">
                <h4 class="font-semibold text-purple-800 mb-2">🎨 Portfolio Criativo</h4>
                <p>Conheça os trabalhos e projetos desenvolvidos por Nathannael Teles, incluindo designs, sistemas e soluções digitais inovadoras.</p>
              </div>
              
              <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">💼 Serviços Profissionais</h4>
                <p>Desenvolvimento de sistemas, design gráfico, criação de sites e soluções personalizadas para empresas e instituições.</p>
              </div>
              
              <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                <h4 class="font-semibold text-green-800 mb-2">📱 Como usar o QR Code</h4>
                <ol class="list-decimal list-inside space-y-1">
                  <li>Abra a câmera do seu celular</li>
                  <li>Aponte para o QR Code acima</li>
                  <li>Toque na notificação que aparecer</li>
                  <li>Será redirecionado para o site</li>
                  <li class="text-green-700 font-medium">💾 Backup será baixado automaticamente!</li>
                </ol>
              </div>
              
              <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg">
                <h4 class="font-semibold text-orange-800 mb-2">🔗 Compartilhamento</h4>
                <p>Use o botão "Copiar Link" para compartilhar o endereço do Teles Design em redes sociais, mensagens ou e-mails.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Rodapé da seção -->
        <div class="mt-8 bg-white rounded-xl p-6 text-center">
          <div class="text-gray-600 mb-2">
            <span class="text-2xl">🎨</span>
          </div>
          <h4 class="font-bold text-gray-800 mb-1">Teles Design</h4>
          <p class="text-sm text-gray-600">Criatividade e Inovação em cada projeto</p>
          <p class="text-xs text-gray-500 mt-2">Desenvolvido por Nathannael Teles</p>
        </div>
      </section>

      <!-- BACKUP -->
      <section id="backupTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">💾 Backup dos Dados</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Estatísticas -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-blue-600 mb-4">📊 Dados Atuais</h3>
            
            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg mb-4">
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="flex items-center gap-2">
                  <span class="text-blue-600">📚</span>
                  <span><span id="backupStatsLivros">0</span> livros</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-purple-600">👥</span>
                  <span><span id="backupStatsUsuarios">0</span> usuários</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-green-600">📋</span>
                  <span><span id="backupStatsEmprestimos">0</span> empréstimos</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-orange-600">📅</span>
                  <span id="backupStatsData">-</span>
                </div>
              </div>
            </div>

            <!-- Fazer Backup -->
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
              <h4 class="font-semibold text-blue-800 mb-2">📤 Exportar Dados</h4>
              <p class="text-sm text-blue-700 mb-3">Salve todos os dados da biblioteca em um arquivo.</p>
              <div class="space-y-2">
                <button onclick="exportarBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">💾 Baixar Backup JSON</button>
                <button onclick="copiarBackup()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">📋 Copiar Dados</button>
              </div>
            </div>

            <!-- Limpar Sistema -->
            <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
              <h4 class="font-semibold text-red-800 mb-2">🗑️ Limpar Sistema</h4>
              <p class="text-sm text-red-700 mb-3">Remove todos os dados (exceto usuário ADMIN).</p>
              <button onclick="showModal('clearSystemModal')" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">🗑️ Limpar Tudo</button>
            </div>
          </div>

          <!-- QR Code do Backup -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-purple-600 mb-4">📱 Compartilhar Backup</h3>
            
            <div class="bg-purple-50 border border-purple-200 p-4 rounded-lg mb-4">
              <h4 class="font-semibold text-purple-800 mb-2">🔗 QR Code dos Dados</h4>
              <p class="text-sm text-purple-700 mb-3">Gere um QR Code para compartilhar todos os dados da biblioteca.</p>
              
              <div class="text-center mb-4">
                <div id="backupQRContainer" class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 mb-3">
                  <div class="text-gray-500 text-sm">Clique em "Gerar QR Code" para criar</div>
                </div>
                
                <div class="space-y-2">
                  <button onclick="gerarQRCodeBackup()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">📱 Gerar QR Code</button>
                  <button onclick="compartilharLinkBackup()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">🔗 Copiar Link</button>
                </div>
              </div>
              
              <div class="text-xs text-purple-600 bg-purple-100 rounded p-2">
                <strong>💡 Como funciona:</strong><br>
                • O QR Code contém todos os dados da biblioteca<br>
                • Ao escanear, os dados são baixados automaticamente<br>
                • Perfeito para sincronizar entre dispositivos
              </div>
            </div>
          </div>

          <!-- Restaurar Backup -->
          <div class="bg-white rounded-xl p-6">
            <h3 class="text-xl font-bold text-green-600 mb-4">📥 Importar Dados</h3>
            
            <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
              <h4 class="font-semibold text-green-800 mb-2">📥 Restaurar Backup</h4>
              <p class="text-sm text-green-700 mb-3">Carregue dados de um backup anterior.</p>
              
              <div class="space-y-3">
                <div>
                  <label for="backupFile" class="block text-sm font-medium mb-1">Arquivo de Backup</label>
                  <input type="file" id="backupFile" accept=".json,.txt" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 text-sm">
                </div>
                
                <div class="text-sm text-gray-600 text-center">ou</div>
                
                <div>
                  <label for="backupText" class="block text-sm font-medium mb-1">Cole os dados do backup</label>
                  <textarea id="backupText" rows="6" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 text-sm" placeholder="Cole aqui o conteúdo do backup..."></textarea>
                </div>
                
                <button onclick="restaurarBackup()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">📥 Restaurar Backup</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Instruções -->
        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-semibold text-gray-800 mb-4">📖 Como usar o Backup</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-700">
            <div>
              <h4 class="font-medium text-gray-800 mb-2">💾 Para fazer backup:</h4>
              <ol class="space-y-1 list-decimal list-inside">
                <li>Clique em "Baixar Backup JSON"</li>
                <li>Salve o arquivo em local seguro</li>
                <li>Ou use "Copiar Dados" para colar em outro lugar</li>
                <li>Guarde o backup regularmente</li>
              </ol>
            </div>
            <div>
              <h4 class="font-medium text-gray-800 mb-2">📥 Para restaurar backup:</h4>
              <ol class="space-y-1 list-decimal list-inside">
                <li>Selecione o arquivo de backup</li>
                <li>Ou cole o conteúdo na área de texto</li>
                <li>Clique em "Restaurar Backup"</li>
                <li>Confirme a operação</li>
                <li>O sistema será recarregado</li>
              </ol>
            </div>
          </div>
          
          <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start gap-2">
              <span class="text-yellow-600">⚠️</span>
              <div class="text-sm text-yellow-800">
                <strong>Importante:</strong> Sempre faça backup antes de grandes alterações. 
                A restauração substitui todos os dados atuais pelos dados do backup.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-[#0b1224] text-white/70 text-center py-6">
      Criado por Nathannael Teles · Teles Design
    </footer>
  </div>

  <!-- Modais -->
  <!-- Add Livro -->
  <div id="addBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Adicionar Livro</h3>
        <button onclick="closeModal('addBookModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addBookForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="addBookTitulo" class="block text-sm font-medium mb-1">Título *</label><input id="addBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookCodigo" class="block text-sm font-medium mb-1">Código de Barra</label><input id="addBookCodigo" name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookAutor" class="block text-sm font-medium mb-1">Autor *</label><input id="addBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookEditora" class="block text-sm font-medium mb-1">Editora</label><input id="addBookEditora" name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookCategoria" class="block text-sm font-medium mb-1">Categoria</label><input id="addBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookSubcategoria" class="block text-sm font-medium mb-1">Subcategoria</label><input id="addBookSubcategoria" name="subcategoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookQuantidade" class="block text-sm font-medium mb-1">Quantidade *</label><input id="addBookQuantidade" type="number" min="1" name="quantidade" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label for="addBookLocalizacao" class="block text-sm font-medium mb-1">Localização</label><input id="addBookLocalizacao" name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
        </div>
        <div><label for="addBookDescricao" class="block text-sm font-medium mb-1">Descrição</label><textarea id="addBookDescricao" name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"></textarea></div>
        <div>
          <label for="addBookFoto" class="block text-sm font-medium mb-1">Foto do Livro</label>
          <input type="file" id="addBookFoto" name="foto" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
          <p class="text-xs text-gray-500">Selecione uma imagem (JPG, PNG, GIF, etc.)</p>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeModal('addBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Livros -->
  <div id="importBooksModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Livros</h3>
        <button onclick="closeModal('importBooksModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="space-y-4">
        <div class="bg-blue-50 border border-blue-200 p-3 rounded">
          <div class="text-sm text-blue-800"><b>Formato:</b> Título | Autor | Código | Categoria | Estoque | Local | Quantidade</div>
        </div>
        <textarea id="importBooksText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Ex.:&#10;Dom Casmurro | Machado de Assis&#10;O Cortiço | Aluísio Azevedo | 123456 | Literatura | 5 | Corredor A | 3"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importBooksModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importBooks()" class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Empréstimo -->
  <div id="addEmprestimoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Novo Empréstimo</h3>
        <button onclick="closeModal('addEmprestimoModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addEmprestimoForm" class="space-y-4">
        <div id="alunoSelectDiv">
          <label for="emprestimoAluno" class="block text-sm font-medium mb-1">Aluno *</label>
          <select id="emprestimoAluno" name="aluno" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o aluno...</option>
          </select>
        </div>
        <div>
          <label for="searchLivroEmprestimo" class="block text-sm font-medium mb-1">Buscar Livro *</label>
          <input id="searchLivroEmprestimo" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Digite título, código ou autor..."/>
          <div id="livroSuggestions" class="hidden mt-2 border rounded-lg max-h-40 overflow-y-auto"></div>
        </div>
        <div id="livroSelecionado" class="hidden">
          <label class="block text-sm font-medium mb-1">Livro Selecionado</label>
          <div id="livroInfo" class="p-3 bg-gray-50 rounded-lg"></div>
          <input type="hidden" name="livro" id="livroId"/>
        </div>
        <div>
          <label for="emprestimoDataDevolucao" class="block text-sm font-medium mb-1">Devolução *</label>
          <input type="date" id="emprestimoDataDevolucao" name="dataDevolucao" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addEmprestimoModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Criar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Livro -->
  <div id="editBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Editar Livro</h3>
        <button onclick="closeModal('editBookModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="editBookForm" class="space-y-4">
        <input type="hidden" name="id" id="editBookId"/>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="editBookTitulo" class="block text-sm font-medium mb-1">Título *</label><input id="editBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label for="editBookCodigo" class="block text-sm font-medium mb-1">Código de Barra</label><input id="editBookCodigo" name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label for="editBookAutor" class="block text-sm font-medium mb-1">Autor *</label><input id="editBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label for="editBookEditora" class="block text-sm font-medium mb-1">Editora</label><input id="editBookEditora" name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label for="editBookCategoria" class="block text-sm font-medium mb-1">Categoria</label><input id="editBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label for="editBookSubcategoria" class="block text-sm font-medium mb-1">Subcategoria</label><input id="editBookSubcategoria" name="subcategoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label for="editBookQuantidade" class="block text-sm font-medium mb-1">Quantidade *</label><input type="number" id="editBookQuantidade" name="quantidade" min="1" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label for="editBookLocalizacao" class="block text-sm font-medium mb-1">Localização</label><input id="editBookLocalizacao" name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        </div>
        <div><label for="editBookDescricao" class="block text-sm font-medium mb-1">Descrição</label><textarea id="editBookDescricao" name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"></textarea></div>
        <div>
          <label for="editBookFoto" class="block text-sm font-medium mb-1">Foto do Livro</label>
          <input type="file" id="editBookFoto" name="foto" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
          <p class="text-xs text-gray-500">Selecione uma nova imagem (JPG, PNG, GIF, etc.)</p>
          <div id="currentBookImage" class="mt-2 hidden">
            <p class="text-xs text-gray-600 mb-1">Imagem atual:</p>
            <img id="currentImagePreview" src="" alt="Imagem atual" class="w-20 h-28 object-cover rounded border">
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('editBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Usuário -->
  <div id="addUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Adicionar Usuário</h3>
        <button onclick="closeModal('addUserModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addUserForm" class="space-y-4">
        <div><label for="addUserNome" class="block text-sm font-medium mb-1">Nome *</label><input id="addUserNome" name="nome" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label for="addUserLogin" class="block text-sm font-medium mb-1">Login *</label><input id="addUserLogin" name="login" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label for="addUserSenha" class="block text-sm font-medium mb-1">Senha *</label><input id="addUserSenha" type="password" name="senha" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div>
          <label for="addUserTipo" class="block text-sm font-medium mb-1">Tipo de Usuário *</label>
          <select id="addUserTipo" name="tipo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" onchange="toggleTurmaField(this)">
            <option value="">Selecione...</option>
            <option value="aluno">Aluno</option>
            <option value="professor">Professor</option>
            <option value="diretor">Diretor</option>
            <option value="coordenador">Coordenador</option>
            <option value="ajudante">Ajudante</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div id="turmaField" class="hidden">
          <label for="addUserTurma" class="block text-sm font-medium mb-1">Turma</label>
          <select id="addUserTurma" name="turma" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione a turma...</option>
            <optgroup label="Ensino Fundamental (EF)">
              <option value="1-A EF">1º A EF</option><option value="1-B EF">1º B EF</option><option value="1-C EF">1º C EF</option><option value="1-D EF">1º D EF</option><option value="1-E EF">1º E EF</option>
              <option value="2-A EF">2º A EF</option><option value="2-B EF">2º B EF</option><option value="2-C EF">2º C EF</option><option value="2-D EF">2º D EF</option><option value="2-E EF">2º E EF</option>
              <option value="3-A EF">3º A EF</option><option value="3-B EF">3º B EF</option><option value="3-C EF">3º C EF</option><option value="3-D EF">3º D EF</option><option value="3-E EF">3º E EF</option>
              <option value="4-A EF">4º A EF</option><option value="4-B EF">4º B EF</option><option value="4-C EF">4º C EF</option><option value="4-D EF">4º D EF</option><option value="4-E EF">4º E EF</option>
              <option value="5-A EF">5º A EF</option><option value="5-B EF">5º B EF</option><option value="5-C EF">5º C EF</option><option value="5-D EF">5º D EF</option><option value="5-E EF">5º E EF</option>
              <option value="6-A EF">6º A EF</option><option value="6-B EF">6º B EF</option><option value="6-C EF">6º C EF</option><option value="6-D EF">6º D EF</option><option value="6-E EF">6º E EF</option>
              <option value="7-A EF">7º A EF</option><option value="7-B EF">7º B EF</option><option value="7-C EF">7º C EF</option><option value="7-D EF">7º D EF</option><option value="7-E EF">7º E EF</option>
              <option value="8-A EF">8º A EF</option><option value="8-B EF">8º B EF</option><option value="8-C EF">8º C EF</option><option value="8-D EF">8º D EF</option><option value="8-E EF">8º E EF</option>
              <option value="9-A EF">9º A EF</option><option value="9-B EF">9º B EF</option><option value="9-C EF">9º C EF</option><option value="9-D EF">9º D EF</option><option value="9-E EF">9º E EF</option>
            </optgroup>
            <optgroup label="Ensino Médio (EM)">
              <option value="1-A EM">1º A EM</option><option value="1-B EM">1º B EM</option><option value="1-C EM">1º C EM</option><option value="1-D EM">1º D EM</option><option value="1-E EM">1º E EM</option>
              <option value="2-A EM">2º A EM</option><option value="2-B EM">2º B EM</option><option value="2-C EM">2º C EM</option><option value="2-D EM">2º D EM</option><option value="2-E EM">2º E EM</option>
              <option value="3-A EM">3º A EM</option><option value="3-B EM">3º B EM</option><option value="3-C EM">3º C EM</option><option value="3-D EM">3º D EM</option><option value="3-E EM">3º E EM</option>
            </optgroup>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addUserModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Usuários -->
  <div id="importUsersModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Usuários</h3>
        <button onclick="closeModal('importUsersModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="space-y-4">
        <div class="text-sm text-gray-600">Formato: Nome | Login | Senha | Tipo | Turma (um por linha)</div>
        <textarea id="importUsersText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Ex.:&#10;João Silva | joaos | 1234 | aluno | 1-A EF&#10;Maria Lima | marial | 1234 | professor |"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importUsersModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importUsers()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Limpar Sistema -->
  <div id="clearSystemModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold text-red-600">⚠️ Limpar Sistema</h3>
        <button onclick="closeModal('clearSystemModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="space-y-4">
        <div class="bg-red-50 border border-red-200 p-3 rounded text-sm text-red-800">
          Esta ação apagará TODOS os dados (exceto usuário ADMIN). Irreversível.
        </div>
        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded text-sm text-yellow-800">
          <div><b>Dados a remover:</b></div>
          <div>• <span id="statLivros">0</span> livros</div>
          <div>• <span id="statEmpAtivos">0</span> empréstimos</div>
          <div>• <span id="statUsuarios">0</span> usuários (exceto ADMIN)</div>
        </div>
        <form id="clearSystemForm" class="space-y-3">
          <div>
            <label for="adminPasswordConfirm" class="block text-sm font-medium mb-1">Senha do administrador</label>
            <input id="adminPasswordConfirm" type="password" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"/>
          </div>
          <label class="flex items-center gap-2 text-sm">
            <input id="confirmClear" type="checkbox" class="rounded"/> Confirmo que entendo o risco
          </label>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeModal('clearSystemModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
            <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">LIMPAR</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Trocar Senha -->
  <div id="trocarSenhaModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold text-blue-600">🔑 Trocar Senha</h3>
        <button onclick="closeModal('trocarSenhaModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="trocarSenhaForm" class="space-y-4">
        <div class="bg-blue-50 border border-blue-200 p-3 rounded text-sm text-blue-800">Confirme sua senha atual e defina uma nova.</div>
        <div><label for="senhaAtual" class="block text-sm font-medium mb-1">Senha Atual *</label><input id="senhaAtual" type="password" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"/></div>
        <div><label for="novaSenha" class="block text-sm font-medium mb-1">Nova Senha *</label><input id="novaSenha" type="password" minlength="4" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"/></div>
        <div><label for="confirmarNovaSenha" class="block text-sm font-medium mb-1">Confirmar Nova Senha *</label><input id="confirmarNovaSenha" type="password" minlength="4" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"/></div>
        <div class="text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded p-2">Anote sua nova senha em local seguro.</div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('trocarSenhaModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Alterar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== BANCO DE DADOS =====
    const defaultDB = {
      usuarios: [
        { 
          id: 1, 
          nome: 'Administrador', 
          login: 'ADMIN', 
          senha: 'VANIA25', 
          tipo: 'admin', 
          turma: '', 
          status: 'ativo', 
          livrosLidos: 0 
        }
      ],
      livros: [
        { 
          id: 1, 
          titulo: 'Dom Casmurro', 
          autor: 'Machado de Assis', 
          editora: 'Ática', 
          categoria: 'Literatura Brasileira', 
          subcategoria: 'Romance', 
          quantidade: 5, 
          disponivel: 5, 
          descricao: 'Clássico da literatura brasileira.', 
          foto: '', 
          codigoBarra: '123456789', 
          localizacao: 'Corredor A', 
          avaliacoes: [] 
        },
        { 
          id: 2, 
          titulo: 'O Cortiço', 
          autor: 'Aluísio Azevedo', 
          editora: 'Moderna', 
          categoria: 'Literatura Brasileira', 
          subcategoria: 'Naturalismo', 
          quantidade: 3, 
          disponivel: 3, 
          descricao: 'Vida em um cortiço do RJ.', 
          foto: '', 
          codigoBarra: '987654321', 
          localizacao: 'Corredor B', 
          avaliacoes: [] 
        }
      ],
      emprestimos: [],
      nextId: { usuarios: 2, livros: 3, emprestimos: 1 },
      metadata: {
        version: '2.0',
        lastUpdate: new Date().toISOString(),
        systemName: 'BibliOn - Sistema de Biblioteca'
      }
    };

    // ===== VARIÁVEIS GLOBAIS =====
    let database = null;
    let currentUser = null;

    // ===== FUNÇÕES UTILITÁRIAS =====
    function safeParse(json) {
      try {
        return JSON.parse(json);
      } catch {
        return null;
      }
    }

    function saveDatabase() {
      if (!database.metadata) {
        database.metadata = {};
      }
      database.metadata.lastUpdate = new Date().toISOString();
      database.metadata.version = '2.0';
      database.metadata.systemName = 'BibliOn - Sistema de Biblioteca';
      
      localStorage.setItem('bibliOnDatabase', JSON.stringify(database));
    }

    function showModal(id) {
      const modal = document.getElementById(id);
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('pt-BR');
    }

    // ===== BACKUP E RESTAURAÇÃO =====
    function exportarBackup() {
      const data = JSON.stringify(database, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblion-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      alert('💾 Backup baixado com sucesso!');
    }

    function copiarBackup() {
      const data = JSON.stringify(database, null, 2);
      
      navigator.clipboard.writeText(data).then(() => {
        alert('📋 Dados copiados para a área de transferência!\n\nVocê pode colar em outro dispositivo para sincronizar.');
      }).catch(() => {
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = data;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('📋 Dados copiados para a área de transferência!');
      });
    }

    function restaurarBackup() {
      const file = document.getElementById('backupFile').files[0];
      const text = document.getElementById('backupText').value.trim();
      
      if (!file && !text) {
        alert('❌ Selecione um arquivo ou cole os dados do backup.');
        return;
      }
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          processBackupData(e.target.result);
        };
        reader.readAsText(file);
      } else {
        processBackupData(text);
      }
    }

    function processBackupData(data) {
      try {
        const backupData = JSON.parse(data);
        
        // Validação básica
        if (!backupData.usuarios || !backupData.livros || !backupData.emprestimos) {
          throw new Error('Formato de backup inválido');
        }
        
        if (!confirm(`📥 Confirmar restauração do backup?\n\n📊 Dados a importar:\n• ${backupData.livros.length} livros\n• ${backupData.usuarios.length} usuários\n• ${backupData.emprestimos.length} empréstimos\n\n⚠️ Os dados atuais serão substituídos!`)) {
          return;
        }
        
        // Restaura os dados
        database = backupData;
        
        // Garante estrutura mínima
        if (!database.nextId) {
          database.nextId = {
            usuarios: Math.max(...database.usuarios.map(u => u.id), 0) + 1,
            livros: Math.max(...database.livros.map(l => l.id), 0) + 1,
            emprestimos: Math.max(...database.emprestimos.map(e => e.id), 0) + 1
          };
        }
        
        saveDatabase();
        
        // Limpa formulário
        document.getElementById('backupFile').value = '';
        document.getElementById('backupText').value = '';
        
        alert('✅ Backup restaurado com sucesso!\n\nA página será recarregada para aplicar as mudanças.');
        location.reload();
        
      } catch (error) {
        alert('❌ Erro ao restaurar backup: ' + error.message);
      }
    }

    function updateBackupStats() {
      document.getElementById('backupStatsLivros').textContent = database.livros.length;
      document.getElementById('backupStatsUsuarios').textContent = database.usuarios.length;
      document.getElementById('backupStatsEmprestimos').textContent = database.emprestimos.length;
      document.getElementById('backupStatsData').textContent = new Date().toLocaleDateString('pt-BR');
    }

    function handleClearSystem(event) {
      event.preventDefault();
      
      const senha = document.getElementById('adminPasswordConfirm').value;
      const confirmado = document.getElementById('confirmClear').checked;
      
      if (!confirmado) {
        alert('❌ Você deve confirmar que entende o risco.');
        return;
      }
      
      // Verifica senha do admin
      const admin = database.usuarios.find(u => u.login === 'ADMIN');
      if (!admin || admin.senha !== senha) {
        alert('❌ Senha do administrador incorreta.');
        return;
      }
      
      if (!confirm('⚠️ ÚLTIMA CONFIRMAÇÃO\n\nTodos os dados serão apagados permanentemente!\n\nDeseja continuar?')) {
        return;
      }
      
      // Limpa tudo exceto o admin
      database.livros = [];
      database.emprestimos = [];
      database.usuarios = database.usuarios.filter(u => u.login === 'ADMIN');
      database.nextId = { usuarios: 2, livros: 1, emprestimos: 1 };
      
      saveDatabase();
      closeModal('clearSystemModal');
      
      alert('✅ Sistema limpo com sucesso!\n\nApenas o usuário ADMIN foi mantido.');
      location.reload();
    }

    // ===== INICIALIZAÇÃO DO BANCO =====
    function initializeDatabase() {
      console.log('🔧 Inicializando banco de dados...');
      
      const saved = localStorage.getItem('bibliOnDatabase');
      console.log('💾 Dados salvos encontrados:', !!saved);
      
      if (!saved) {
        console.log('✨ Criando banco padrão...');
        database = JSON.parse(JSON.stringify(defaultDB));
        saveDatabase();
      } else {
        const parsed = safeParse(saved);
        if (!parsed || !parsed.usuarios || !Array.isArray(parsed.usuarios)) {
          console.log('⚠️ Dados corrompidos, recriando...');
          database = JSON.parse(JSON.stringify(defaultDB));
          saveDatabase();
        } else {
          database = parsed;
          
          if (!database.nextId) {
            database.nextId = { usuarios: 2, livros: 3, emprestimos: 1 };
          }
          
          if (!database.metadata) {
            database.metadata = {
              version: '2.0',
              lastUpdate: new Date().toISOString(),
              systemName: 'BibliOn - Sistema de Biblioteca'
            };
          }
          
          const hasAdmin = database.usuarios.some(u => 
            u && u.login && u.login.toUpperCase() === 'ADMIN'
          );
          
          if (!hasAdmin) {
            console.log('👑 Adicionando usuário ADMIN...');
            database.usuarios.push({
              id: database.nextId.usuarios++,
              nome: 'Administrador',
              login: 'ADMIN',
              senha: 'VANIA25',
              tipo: 'admin',
              turma: '',
              status: 'ativo',
              livrosLidos: 0
            });
            saveDatabase();
          }
        }
      }
      
      console.log('✅ Banco inicializado:', {
        usuarios: database.usuarios.length,
        livros: database.livros.length,
        emprestimos: database.emprestimos.length
      });
    }

    // ===== SISTEMA DE LOGIN =====
    function handleLogin(event) {
      event.preventDefault();
      
      const userInput = document.getElementById('loginUser').value.trim();
      const passwordInput = document.getElementById('loginPassword').value;
      
      console.log('🔐 Tentativa de login:', { usuario: userInput, senha: '***' });
      
      if (!userInput || !passwordInput) {
        alert('Por favor, preencha usuário e senha.');
        return;
      }
      
      const user = database.usuarios.find(u => {
        if (!u || !u.login || !u.senha) return false;
        
        const loginMatch = u.login.toUpperCase() === userInput.toUpperCase();
        const passwordMatch = u.senha === passwordInput;
        const isActive = u.status === 'ativo';
        
        return loginMatch && passwordMatch && isActive;
      });
      
      if (!user) {
        console.log('❌ Login falhou');
        alert('Usuário ou senha incorretos, ou usuário bloqueado.');
        return;
      }
      
      console.log('✅ Login bem-sucedido:', user.nome);
      currentUser = user;
      showTransition();
    }

    function showTransition() {
      const transition = document.getElementById('transitionScreen');
      transition.classList.add('active');
      
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainSystem').classList.remove('hidden');
        transition.classList.remove('active');
        setupUserInterface();
        showTab('inicio');
      }, 800);
    }

    function setupUserInterface() {
      document.getElementById('userWelcome').textContent = `Olá, ${currentUser.nome}`;
      
      const isAdmin = currentUser.tipo === 'admin';
      const isStudent = currentUser.tipo === 'aluno';
      
      document.getElementById('usuariosTabBtn').classList.remove('hidden');
      document.getElementById('usuariosCard').classList.remove('hidden');
      document.getElementById('addEmprestimoBtn').classList.remove('hidden');
      document.getElementById('meusEmprestimos').classList.add('hidden');
      document.getElementById('livrosActions').classList.remove('hidden');
      
      document.getElementById('clearLibraryBtn').classList.toggle('hidden', !isAdmin);
      document.getElementById('trocarSenhaBtn').classList.toggle('hidden', !isAdmin);
      
      if (isStudent) {
        document.getElementById('usuariosTabBtn').classList.add('hidden');
        document.getElementById('usuariosCard').classList.add('hidden');
        document.getElementById('addEmprestimoBtn').classList.add('hidden');
        document.getElementById('meusEmprestimos').classList.remove('hidden');
        document.getElementById('livrosActions').classList.add('hidden');
      }
      
      updateDashboard();
    }

    function logout() {
      currentUser = null;
      document.getElementById('mainSystem').classList.add('hidden');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('loginForm').reset();
    }

    // ===== SISTEMA DE ABAS =====
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
          btn.classList.add('active');
        }
      });
      
      switch (tabName) {
        case 'inicio':
          updateDashboard();
          break;
        case 'livros':
          loadLivros();
          loadFilterOptions();
          break;
        case 'emprestimos':
          loadEmprestimos();
          loadTurmasFilter();
          break;
        case 'devolucoes':
          loadDevolucoesPendentes();
          break;
        case 'usuarios':
          loadUsuarios();
          break;
        case 'backup':
          updateBackupStats();
          break;
        case 'qrcode':
          generateQRCode();
          break;
      }
    }

    // ===== DASHBOARD =====
    function updateDashboard() {
      document.getElementById('totalLivros').textContent = database.livros.length;
      document.getElementById('totalEmprestimos').textContent = 
        database.emprestimos.filter(e => e.status === 'ativo').length;
      document.getElementById('totalUsuarios').textContent = 
        database.usuarios.filter(u => u.status === 'ativo').length;
      
      const hoje = new Date();
      const pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      ).length;
      document.getElementById('totalPendentes').textContent = pendentes;
      
      loadLivrosDestaque();
      
      if (currentUser?.tipo === 'aluno') {
        loadEmprestimosAluno();
      }
    }

    function loadLivrosDestaque() {
      const container = document.getElementById('livrosDestaque');
      
      if (database.livros.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500">Nenhum livro cadastrado ainda.</div>';
        return;
      }
      
      let livros = [...database.livros];
      
      livros.sort((a, b) => {
        const mediaA = a.avaliacoes.length ? 
          a.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / a.avaliacoes.length : 0;
        const mediaB = b.avaliacoes.length ? 
          b.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / b.avaliacoes.length : 0;
        
        if (mediaB !== mediaA) return mediaB - mediaA;
        if (b.disponivel !== a.disponivel) return b.disponivel - a.disponivel;
        return b.id - a.id;
      });
      
      livros = livros.slice(0, 5);
      
      container.innerHTML = livros.map(livro => {
        const media = livro.avaliacoes.length ? 
          (livro.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / livro.avaliacoes.length).toFixed(1) : 0;
        
        return `
          <div class="book-card rounded-lg p-4 text-center card-hover">
            <div class="w-16 h-20 mx-auto rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
              ${livro.foto ? 
                `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                '<span class="text-2xl text-white">📖</span>'
              }
            </div>
            <div class="mt-2 font-semibold text-sm truncate" title="${livro.titulo}">${livro.titulo}</div>
            <div class="text-xs text-gray-600 truncate" title="${livro.autor}">${livro.autor}</div>
            <div class="mt-1 text-xs ${livro.disponivel > 0 ? 'text-green-600' : 'text-red-600'}">
              ${livro.disponivel > 0 ? `${livro.disponivel} disponível` : 'Indisponível'}
            </div>
            <div class="text-xs text-gray-500">
              ${livro.avaliacoes.length ? `⭐ ${media} (${livro.avaliacoes.length})` : 'Sem avaliações'}
            </div>
          </div>
        `;
      }).join('');
    }

    function loadEmprestimosAluno() {
      const container = document.getElementById('emprestimosAluno');
      const emprestimos = database.emprestimos.filter(e => e.alunoId === currentUser.id);
      
      if (!emprestimos.length) {
        container.innerHTML = '<div class="text-gray-500 text-center">Você não possui livros emprestados.</div>';
        return;
      }
      
      container.innerHTML = emprestimos.map(emprestimo => {
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <div class="flex items-center justify-between p-3 border rounded-lg ${atrasado ? 'bg-red-50 border-red-200' : 'bg-white'}">
            <div>
              <div class="font-medium">${livro?.titulo || 'Livro'}</div>
              <div class="text-sm text-gray-600">${livro?.autor || ''}</div>
              <div class="text-xs ${atrasado ? 'text-red-600' : 'text-gray-500'}">
                Devolução: ${formatDate(emprestimo.dataDevolucao)} ${atrasado ? '(ATRASADO)' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== GERENCIAMENTO DE LIVROS =====
    function loadLivros() {
      const container = document.getElementById('livrosList');
      const search = document.getElementById('searchLivros').value.toLowerCase().trim();
      const categoria = document.getElementById('filterCategoria').value.trim();
      const autor = document.getElementById('filterAutor').value.trim();
      const disponibilidade = document.getElementById('filterDisponibilidade').value.trim();
      
      let livros = [...database.livros];
      
      if (search) {
        livros = livros.filter(livro =>
          (livro.titulo || '').toLowerCase().includes(search) ||
          (livro.autor || '').toLowerCase().includes(search) ||
          (livro.descricao || '').toLowerCase().includes(search) ||
          (livro.categoria || '').toLowerCase().includes(search) ||
          (livro.subcategoria || '').toLowerCase().includes(search) ||
          (livro.editora || '').toLowerCase().includes(search) ||
          (livro.codigoBarra || '').toLowerCase().includes(search)
        );
      }
      
      if (categoria) {
        livros = livros.filter(livro => (livro.categoria || '').trim() === categoria);
      }
      
      if (autor) {
        livros = livros.filter(livro => (livro.autor || '').trim() === autor);
      }
      
      if (disponibilidade === 'disponivel') {
        livros = livros.filter(livro => livro.disponivel > 0);
      } else if (disponibilidade === 'indisponivel') {
        livros = livros.filter(livro => livro.disponivel === 0);
      }
      
      const canEdit = currentUser && ['admin', 'professor', 'diretor', 'coordenador', 'ajudante'].includes(currentUser.tipo);
      
      container.innerHTML = livros.map(livro => {
        const media = livro.avaliacoes.length ? 
          (livro.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / livro.avaliacoes.length).toFixed(1) : 0;
        
        return `
          <div class="book-card rounded-xl p-5 card-hover">
            <div class="flex gap-4">
              <div class="w-20 h-28 flex-shrink-0 rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
                ${livro.foto ? 
                  `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                  '<span class="text-3xl text-white">📖</span>'
                }
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-bold text-lg truncate">${livro.titulo}</div>
                <div class="text-gray-600">${livro.autor}</div>
                <div class="text-sm text-gray-500">${livro.editora || 'Editora não informada'}</div>
                ${livro.codigoBarra ? `<div class="text-xs text-blue-600 font-mono">📊 ${livro.codigoBarra}</div>` : ''}
                <div class="mt-2 text-sm flex gap-4">
                  <span>📚 ${livro.disponivel}/${livro.quantidade}</span>
                  <span>⭐ ${media} (${livro.avaliacoes.length})</span>
                  ${livro.localizacao ? `<span>📍 ${livro.localizacao}</span>` : ''}
                </div>
                <div class="mt-3 flex gap-2">
                  ${canEdit ? `
                    <button onclick="editLivro(${livro.id})" class="px-3 py-1 bg-amber-700 hover:bg-amber-800 text-white rounded text-sm">✏️ Editar</button>
                    <button onclick="deleteLivro(${livro.id})" class="px-3 py-1 bg-red-700 hover:bg-red-800 text-white rounded text-sm">🗑️ Excluir</button>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function loadFilterOptions() {
      const categorias = [...new Set(database.livros.map(l => l.categoria).filter(Boolean).map(c => c.trim()))].sort();
      const autores = [...new Set(database.livros.map(l => l.autor).filter(Boolean).map(a => a.trim()))].sort();
      
      const categoriaSelect = document.getElementById('filterCategoria');
      const autorSelect = document.getElementById('filterAutor');
      
      const currentCategoria = categoriaSelect.value;
      const currentAutor = autorSelect.value;
      
      categoriaSelect.innerHTML = '<option value="">Todas as categorias</option>' + 
        categorias.map(c => `<option ${c === currentCategoria ? 'selected' : ''}>${c}</option>`).join('');
      
      autorSelect.innerHTML = '<option value="">Todos os autores</option>' + 
        autores.map(a => `<option ${a === currentAutor ? 'selected' : ''}>${a}</option>`).join('');
    }

    function clearLivrosFilters() {
      document.getElementById('searchLivros').value = '';
      document.getElementById('filterCategoria').value = '';
      document.getElementById('filterAutor').value = '';
      document.getElementById('filterDisponibilidade').value = '';
      loadLivros();
    }

    // ===== CRUD LIVROS =====
    function verificarLivroDuplicado(titulo, autor, codigo, ignoreId = null) {
      const tituloNorm = (titulo || '').toLowerCase().trim();
      const autorNorm = (autor || '').toLowerCase().trim();
      
      return database.livros.some(livro => {
        if (ignoreId && livro.id === ignoreId) return false;
        
        const sameTitleAuthor = (livro.titulo || '').toLowerCase().trim() === tituloNorm && 
                               (livro.autor || '').toLowerCase().trim() === autorNorm;
        
        const sameCode = codigo && livro.codigoBarra && 
                        (livro.codigoBarra + '').trim() === (codigo + '').trim();
        
        return sameTitleAuthor || sameCode;
      });
    }

    function handleAddBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const titulo = formData.get('titulo');
      const autor = formData.get('autor');
      const codigo = formData.get('codigoBarra');
      
      if (verificarLivroDuplicado(titulo, autor, codigo)) {
        alert('Livro duplicado. Verifique título/autor/código.');
        return;
      }
      
      const quantidade = parseInt(formData.get('quantidade'));
      const fotoFile = formData.get('foto');
      
      // Processa a imagem se foi selecionada
      if (fotoFile && fotoFile.size > 0) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fotoBase64 = e.target.result;
          
          const novoLivro = {
            id: database.nextId.livros++,
            titulo,
            autor,
            editora: formData.get('editora') || '',
            categoria: formData.get('categoria') || '',
            subcategoria: formData.get('subcategoria') || '',
            quantidade,
            disponivel: quantidade,
            descricao: formData.get('descricao') || '',
            foto: fotoBase64,
            codigoBarra: codigo || '',
            localizacao: formData.get('localizacao') || '',
            avaliacoes: []
          };
          
          database.livros.push(novoLivro);
          saveDatabase();
          
          closeModal('addBookModal');
          event.target.reset();
          loadLivros();
          updateDashboard();
          
          alert('Livro adicionado com sucesso!');
        };
        reader.readAsDataURL(fotoFile);
      } else {
        // Sem imagem
        const novoLivro = {
          id: database.nextId.livros++,
          titulo,
          autor,
          editora: formData.get('editora') || '',
          categoria: formData.get('categoria') || '',
          subcategoria: formData.get('subcategoria') || '',
          quantidade,
          disponivel: quantidade,
          descricao: formData.get('descricao') || '',
          foto: '',
          codigoBarra: codigo || '',
          localizacao: formData.get('localizacao') || '',
          avaliacoes: []
        };
        
        database.livros.push(novoLivro);
        saveDatabase();
        
        closeModal('addBookModal');
        event.target.reset();
        loadLivros();
        updateDashboard();
        
        alert('Livro adicionado com sucesso!');
      }
    }

    function handleEditBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const id = parseInt(formData.get('id'));
      const livro = database.livros.find(l => l.id === id);
      
      if (!livro) return;
      
      const titulo = formData.get('titulo');
      const autor = formData.get('autor');
      const codigo = formData.get('codigoBarra');
      
      if (verificarLivroDuplicado(titulo, autor, codigo, id)) {
        alert('Conflito com outro livro existente.');
        return;
      }
      
      const novaQuantidade = parseInt(formData.get('quantidade'));
      const diferenca = novaQuantidade - livro.quantidade;
      const fotoFile = formData.get('foto');
      
      // Função para atualizar o livro
      function atualizarLivro(novaFoto = null) {
        livro.titulo = titulo;
        livro.autor = autor;
        livro.editora = formData.get('editora') || '';
        livro.categoria = formData.get('categoria') || '';
        livro.subcategoria = formData.get('subcategoria') || '';
        livro.quantidade = novaQuantidade;
        livro.disponivel = Math.max(0, livro.disponivel + diferenca);
        livro.descricao = formData.get('descricao') || '';
        livro.codigoBarra = codigo || '';
        livro.localizacao = formData.get('localizacao') || '';
        
        // Atualiza foto apenas se uma nova foi selecionada
        if (novaFoto !== null) {
          livro.foto = novaFoto;
        }
        
        saveDatabase();
        closeModal('editBookModal');
        loadLivros();
        updateDashboard();
        
        alert('Livro atualizado!');
      }
      
      // Processa nova imagem se foi selecionada
      if (fotoFile && fotoFile.size > 0) {
        const reader = new FileReader();
        reader.onload = function(e) {
          atualizarLivro(e.target.result);
        };
        reader.readAsDataURL(fotoFile);
      } else {
        // Mantém a foto atual
        atualizarLivro();
      }
    }

    function deleteLivro(id) {
      if (!confirm('Excluir este livro?')) return;
      
      const index = database.livros.findIndex(l => l.id === id);
      if (index >= 0) {
        database.livros.splice(index, 1);
        saveDatabase();
        loadLivros();
        updateDashboard();
      }
    }

    function editLivro(id) {
      const livro = database.livros.find(l => l.id === id);
      if (!livro) return;
      
      document.getElementById('editBookId').value = livro.id;
      document.getElementById('editBookTitulo').value = livro.titulo;
      document.getElementById('editBookCodigo').value = livro.codigoBarra || '';
      document.getElementById('editBookAutor').value = livro.autor;
      document.getElementById('editBookEditora').value = livro.editora || '';
      document.getElementById('editBookCategoria').value = livro.categoria || '';
      document.getElementById('editBookSubcategoria').value = livro.subcategoria || '';
      document.getElementById('editBookQuantidade').value = livro.quantidade;
      document.getElementById('editBookLocalizacao').value = livro.localizacao || '';
      document.getElementById('editBookDescricao').value = livro.descricao || '';
      
      // Limpa o input de arquivo
      document.getElementById('editBookFoto').value = '';
      
      // Mostra imagem atual se existir
      const currentImageDiv = document.getElementById('currentBookImage');
      const currentImagePreview = document.getElementById('currentImagePreview');
      
      if (livro.foto && livro.foto.trim() !== '') {
        currentImagePreview.src = livro.foto;
        currentImageDiv.classList.remove('hidden');
      } else {
        currentImageDiv.classList.add('hidden');
      }
      
      showModal('editBookModal');
    }

    function importBooks() {
      const text = document.getElementById('importBooksText').value.trim();
      if (!text) {
        alert('Digite os dados dos livros para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      let errors = [];
      
      lines.forEach((line, index) => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length < 2) {
          errors.push(`Linha ${index + 1}: Formato inválido`);
          return;
        }
        
        const [titulo, autor, codigo = '', categoria = '', estoque = '1', local = '', quantidade = ''] = parts;
        
        if (!titulo || !autor) {
          errors.push(`Linha ${index + 1}: Título e autor são obrigatórios`);
          return;
        }
        
        if (verificarLivroDuplicado(titulo, autor, codigo)) {
          errors.push(`Linha ${index + 1}: Livro duplicado`);
          return;
        }
        
        const qtd = parseInt(quantidade || estoque || '1') || 1;
        
        database.livros.push({
          id: database.nextId.livros++,
          titulo,
          autor,
          editora: '',
          categoria,
          subcategoria: '',
          quantidade: qtd,
          disponivel: qtd,
          descricao: '',
          foto: '',
          codigoBarra: codigo,
          localizacao: local,
          avaliacoes: []
        });
        
        imported++;
      });
      
      if (imported > 0) {
        saveDatabase();
        loadLivros();
        updateDashboard();
      }
      
      closeModal('importBooksModal');
      document.getElementById('importBooksText').value = '';
      
      let message = `${imported} livro(s) importado(s) com sucesso!`;
      if (errors.length > 0) {
        message += `\n\nErros:\n${errors.join('\n')}`;
      }
      
      alert(message);
    }

    // ===== EMPRÉSTIMOS =====
    function showAddEmprestimoModal() {
      const alunoSelect = document.getElementById('emprestimoAluno');
      const alunos = database.usuarios.filter(u => u.tipo === 'aluno' && u.status === 'ativo');
      
      alunoSelect.innerHTML = '<option value="">Selecione o aluno...</option>' + 
        alunos.map(aluno => `<option value="${aluno.id}">${aluno.nome} (${aluno.turma || 'Sem turma'})</option>`).join('');
      
      if (currentUser?.tipo === 'aluno') {
        alunoSelect.value = currentUser.id;
        alunoSelect.disabled = true;
        document.getElementById('alunoSelectDiv').style.display = 'none';
      } else {
        alunoSelect.disabled = false;
        document.getElementById('alunoSelectDiv').style.display = 'block';
      }
      
      const hoje = new Date();
      const dateInput = document.getElementById('emprestimoDataDevolucao');
      dateInput.min = hoje.toISOString().split('T')[0];
      
      showModal('addEmprestimoModal');
    }

    function searchLivrosEmprestimo() {
      const query = document.getElementById('searchLivroEmprestimo').value.toLowerCase();
      const container = document.getElementById('livroSuggestions');
      
      if (query.length < 2) {
        container.classList.add('hidden');
        return;
      }
      
      const livros = database.livros.filter(l => 
        l.disponivel > 0 && (
          (l.titulo || '').toLowerCase().includes(query) ||
          (l.codigoBarra || '').toLowerCase().includes(query) ||
          (l.autor || '').toLowerCase().includes(query)
        )
      );
      
      if (!livros.length) {
        container.innerHTML = '<div class="p-3 text-gray-500">Nenhum livro encontrado</div>';
        container.classList.remove('hidden');
        return;
      }
      
      container.innerHTML = livros.map(livro => `
        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b" onclick="selectLivroEmprestimo(${livro.id})">
          <div class="font-medium">${livro.titulo}</div>
          <div class="text-sm text-gray-600">${livro.autor}</div>
          ${livro.codigoBarra ? `<div class="text-xs text-blue-600 font-mono">📊 ${livro.codigoBarra}</div>` : ''}
          <div class="text-xs text-green-600">${livro.disponivel} disponível(is)</div>
        </div>
      `).join('');
      
      container.classList.remove('hidden');
    }

    function selectLivroEmprestimo(id) {
      const livro = database.livros.find(l => l.id === id);
      
      document.getElementById('livroId').value = id;
      document.getElementById('livroInfo').innerHTML = `
        <div class="font-medium">${livro.titulo}</div>
        <div class="text-sm text-gray-600">${livro.autor}</div>
        <div class="text-xs text-green-600">${livro.disponivel} disponível(is)</div>
      `;
      
      document.getElementById('livroSelecionado').classList.remove('hidden');
      document.getElementById('livroSuggestions').classList.add('hidden');
      document.getElementById('searchLivroEmprestimo').value = livro.titulo;
    }

    function handleAddEmprestimo(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const alunoId = parseInt(formData.get('aluno')) || currentUser.id;
      const livroId = parseInt(formData.get('livro'));
      const dataDevolucao = formData.get('dataDevolucao');
      
      if (!alunoId || !livroId || !dataDevolucao) {
        alert('Preencha todos os campos obrigatórios.');
        return;
      }
      
      const livro = database.livros.find(l => l.id === livroId);
      if (!livro || livro.disponivel <= 0) {
        alert('Livro indisponível.');
        return;
      }
      
      database.emprestimos.push({
        id: database.nextId.emprestimos++,
        alunoId,
        livroId,
        dataEmprestimo: new Date().toISOString().split('T')[0],
        dataDevolucao,
        status: 'ativo'
      });
      
      livro.disponivel--;
      
      saveDatabase();
      closeModal('addEmprestimoModal');
      event.target.reset();
      document.getElementById('livroSelecionado').classList.add('hidden');
      
      loadEmprestimos();
      updateDashboard();
      
      alert('Empréstimo criado com sucesso!');
    }

    function loadEmprestimos() {
      const container = document.getElementById('emprestimosList');
      let emprestimos = [...database.emprestimos];
      
      if (currentUser?.tipo === 'aluno') {
        emprestimos = emprestimos.filter(e => e.alunoId === currentUser.id);
      }
      
      const search = document.getElementById('searchEmprestimos').value.toLowerCase().trim();
      const dataInicio = document.getElementById('filterDataInicio').value.trim();
      const dataFim = document.getElementById('filterDataFim').value.trim();
      const turma = document.getElementById('filterTurma').value.trim();
      
      if (search) {
        emprestimos = emprestimos.filter(emprestimo => {
          const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
          const livro = database.livros.find(l => l.id === emprestimo.livroId);
          
          return (aluno?.nome || '').toLowerCase().includes(search) ||
                 (aluno?.turma || '').toLowerCase().includes(search) ||
                 (livro?.titulo || '').toLowerCase().includes(search) ||
                 (livro?.autor || '').toLowerCase().includes(search);
        });
      }
      
      if (dataInicio) {
        emprestimos = emprestimos.filter(e => e.dataEmprestimo >= dataInicio);
      }
      
      if (dataFim) {
        emprestimos = emprestimos.filter(e => e.dataEmprestimo <= dataFim);
      }
      
      if (turma) {
        emprestimos = emprestimos.filter(e => {
          const aluno = database.usuarios.find(u => u.id === e.alunoId);
          return (aluno?.turma || '').trim() === turma;
        });
      }
      
      container.innerHTML = emprestimos.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <tr class="${atrasado ? 'bg-red-50' : ''}">
            <td class="px-6 py-3 text-sm">
              ${aluno ? aluno.nome : '-'}
              ${aluno?.turma ? `<br><span class="text-xs text-gray-500">${aluno.turma}</span>` : ''}
            </td>
            <td class="px-6 py-3 text-sm">
              ${livro ? livro.titulo : '-'}
              ${livro ? `<br><span class="text-xs text-gray-500">${livro.autor}</span>` : ''}
            </td>
            <td class="px-6 py-3 text-sm">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-3 text-sm">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                emprestimo.status === 'ativo' ? 
                  (atrasado ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700') : 
                  'bg-green-100 text-green-700'
              }">
                ${emprestimo.status === 'ativo' ? (atrasado ? 'Atrasado' : 'Ativo') : 'Devolvido'}
              </span>
            </td>
            <td class="px-6 py-3 text-sm">
              ${emprestimo.status === 'ativo' ? 
                `<button onclick="devolverLivro(${emprestimo.id})" class="text-green-700 hover:underline">✅ Devolver</button>` : 
                ''
              }
              ${['admin', 'professor', 'diretor', 'coordenador', 'ajudante'].includes(currentUser?.tipo || '') ? 
                `<button onclick="deleteEmprestimo(${emprestimo.id})" class="text-red-700 hover:underline ml-2">🗑️</button>` : 
                ''
              }
            </td>
          </tr>
        `;
      }).join('');
    }

    function devolverLivro(id) {
      const emprestimo = database.emprestimos.find(e => e.id === id);
      if (!emprestimo) return;
      
      const livro = database.livros.find(l => l.id === emprestimo.livroId);
      const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
      
      emprestimo.status = 'devolvido';
      emprestimo.dataRealDevolucao = new Date().toISOString().split('T')[0];
      
      if (livro) livro.disponivel++;
      if (aluno) aluno.livrosLidos = (aluno.livrosLidos || 0) + 1;
      
      saveDatabase();
      loadEmprestimos();
      loadDevolucoesPendentes();
      updateDashboard();
      
      alert('Livro devolvido com sucesso!');
    }

    function deleteEmprestimo(id) {
      if (!confirm('Excluir este empréstimo?')) return;
      
      const index = database.emprestimos.findIndex(e => e.id === id);
      if (index < 0) return;
      
      const emprestimo = database.emprestimos[index];
      
      if (emprestimo.status === 'ativo') {
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        if (livro) livro.disponivel++;
      } else if (emprestimo.status === 'devolvido') {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        if (aluno && aluno.livrosLidos > 0) aluno.livrosLidos--;
      }
      
      database.emprestimos.splice(index, 1);
      saveDatabase();
      loadEmprestimos();
      updateDashboard();
    }

    function loadDevolucoesPendentes() {
      const hoje = new Date();
      let pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      );
      
      if (currentUser?.tipo === 'aluno') {
        pendentes = pendentes.filter(e => e.alunoId === currentUser.id);
      }
      
      const container = document.getElementById('devolucoesList');
      
      container.innerHTML = pendentes.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const diasAtraso = Math.max(0, Math.floor((hoje - new Date(emprestimo.dataDevolucao)) / 86400000));
        
        return `
          <tr class="bg-red-50">
            <td class="px-6 py-3 text-sm">
              ${aluno ? aluno.nome : '-'}
              ${aluno?.turma ? `<br><span class="text-xs text-gray-500">${aluno.turma}</span>` : ''}
            </td>
            <td class="px-6 py-3 text-sm">
              ${livro ? livro.titulo : '-'}
              ${livro ? `<br><span class="text-xs text-gray-500">${livro.autor}</span>` : ''}
            </td>
            <td class="px-6 py-3 text-sm">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-3 text-sm">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-3 text-sm font-bold text-red-700">${diasAtraso} dia(s)</td>
            <td class="px-6 py-3 text-sm">
              <button onclick="devolverLivro(${emprestimo.id})" class="text-green-700 hover:underline">✅ Devolver</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function loadTurmasFilter() {
      const turmas = [...new Set(database.usuarios
        .filter(u => u.turma && u.turma.trim() !== '')
        .map(u => u.turma.trim())
      )].sort();
      
      const select = document.getElementById('filterTurma');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="">Todas as turmas</option>' + 
        turmas.map(t => `<option ${t === currentValue ? 'selected' : ''}>${t}</option>`).join('');
    }

    function clearEmprestimosFilters() {
      document.getElementById('searchEmprestimos').value = '';
      document.getElementById('filterDataInicio').value = '';
      document.getElementById('filterDataFim').value = '';
      document.getElementById('filterTurma').value = '';
      loadEmprestimos();
    }

    // ===== USUÁRIOS =====
    function loadUsuarios() {
      const search = document.getElementById('searchUsuarios').value.toLowerCase();
      const tipo = document.getElementById('filterTipoUsuario').value;
      const status = document.getElementById('filterStatusUsuario').value;
      
      let usuarios = [...database.usuarios];
      
      if (search) {
        usuarios = usuarios.filter(u => 
          (u.nome || '').toLowerCase().includes(search) || 
          (u.login || '').toLowerCase().includes(search)
        );
      }
      
      if (tipo) {
        usuarios = usuarios.filter(u => u.tipo === tipo);
      }
      
      if (status) {
        usuarios = usuarios.filter(u => u.status === status);
      }
      
      const canDelete = currentUser?.tipo === 'admin';
      const container = document.getElementById('usuariosList');
      
      container.innerHTML = usuarios.map(usuario => {
        const canEdit = currentUser?.tipo === 'admin' || 
          (currentUser?.login !== usuario.login && usuario.login !== 'ADMIN');
        
        return `
          <tr>
            <td class="px-6 py-3">${usuario.nome}</td>
            <td class="px-6 py-3">${usuario.login}</td>
            <td class="px-6 py-3">${usuario.tipo}</td>
            <td class="px-6 py-3">${usuario.turma || '-'}</td>
            <td class="px-6 py-3">${usuario.livrosLidos || 0}</td>
            <td class="px-6 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                usuario.status === 'ativo' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
              }">
                ${usuario.status}
              </span>
            </td>
            <td class="px-6 py-3 text-sm">
              ${canEdit ? `<button onclick="editUsuario(${usuario.id})" class="text-orange-700 hover:underline">✏️</button>` : ''}
              ${usuario.login !== 'ADMIN' ? `
                <button onclick="toggleUsuarioStatus(${usuario.id})" class="ml-2 ${
                  usuario.status === 'ativo' ? 'text-red-700' : 'text-green-700'
                } hover:underline">
                  ${usuario.status === 'ativo' ? '🚫' : '✅'}
                </button>
              ` : ''}
              ${canDelete && usuario.login !== 'ADMIN' ? `
                <button onclick="deleteUsuario(${usuario.id})" class="ml-2 text-red-700 hover:underline">🗑️</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    function handleAddUser(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const login = (formData.get('login') || '').trim();
      
      if (database.usuarios.some(u => (u.login || '').toLowerCase() === login.toLowerCase())) {
        alert('Este login já está em uso.');
        return;
      }
      
      const novoUsuario = {
        id: database.nextId.usuarios++,
        nome: formData.get('nome'),
        login,
        senha: formData.get('senha'),
        tipo: formData.get('tipo'),
        turma: formData.get('turma') || '',
        status: 'ativo',
        livrosLidos: 0
      };
      
      database.usuarios.push(novoUsuario);
      saveDatabase();
      
      closeModal('addUserModal');
      event.target.reset();
      loadUsuarios();
      updateDashboard();
      
      alert('Usuário adicionado com sucesso!');
    }

    function editUsuario(id) {
      alert('Funcionalidade de edição em desenvolvimento');
    }

    function toggleTurmaField(select) {
      const turmaField = document.getElementById('turmaField');
      if (select.value === 'aluno') {
        turmaField.classList.remove('hidden');
        turmaField.querySelector('select').required = true;
      } else {
        turmaField.classList.add('hidden');
        turmaField.querySelector('select').required = false;
      }
    }

    function toggleUsuarioStatus(id) {
      const usuario = database.usuarios.find(u => u.id === id);
      if (!usuario) return;
      
      usuario.status = usuario.status === 'ativo' ? 'bloqueado' : 'ativo';
      saveDatabase();
      loadUsuarios();
      updateDashboard();
    }

    function deleteUsuario(id) {
      if (!confirm('Excluir este usuário?')) return;
      
      const index = database.usuarios.findIndex(u => u.id === id);
      if (index >= 0) {
        database.usuarios.splice(index, 1);
        saveDatabase();
        loadUsuarios();
        updateDashboard();
      }
    }

    function importUsers() {
      const text = document.getElementById('importUsersText').value.trim();
      if (!text) {
        alert('Digite os dados dos usuários para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      let errors = [];
      
      lines.forEach((line, index) => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length < 4) {
          errors.push(`Linha ${index + 1}: Formato inválido`);
          return;
        }
        
        const [nome, login, senha, tipo, turma = ''] = parts;
        
        if (!nome || !login || !senha || !tipo) {
          errors.push(`Linha ${index + 1}: Campos obrigatórios em falta`);
          return;
        }
        
        if (database.usuarios.some(u => (u.login || '').toLowerCase() === login.toLowerCase())) {
          errors.push(`Linha ${index + 1}: Login já existe`);
          return;
        }
        
        database.usuarios.push({
          id: database.nextId.usuarios++,
          nome,
          login,
          senha,
          tipo,
          turma,
          status: 'ativo',
          livrosLidos: 0
        });
        
        imported++;
      });
      
      if (imported > 0) {
        saveDatabase();
        loadUsuarios();
        updateDashboard();
      }
      
      closeModal('importUsersModal');
      document.getElementById('importUsersText').value = '';
      
      let message = `${imported} usuário(s) importado(s) com sucesso!`;
      if (errors.length > 0) {
        message += `\n\nErros:\n${errors.join('\n')}`;
      }
      
      alert(message);
    }

    // ===== QR CODE =====
    function generateQRCode() {
      const container = document.getElementById('qrCodeContainer');
      
      // Limpa container
      container.innerHTML = '';
      
      try {
        // Tenta gerar URL com backup
        const urlComBackup = gerarLinkComBackup();
        
        // Verifica se a URL não é muito longa para QR Code
        if (urlComBackup.length > 2000) {
          throw new Error('URL muito longa');
        }
        
        const qrSize = 200;
        const qrCode = createQRCodeSVG(urlComBackup, qrSize);
        container.appendChild(qrCode);
        
        // Adiciona indicador de backup
        const indicator = document.createElement('div');
        indicator.className = 'mt-2 text-xs text-green-600 font-semibold';
        indicator.innerHTML = '✨ QR Code com Backup Automático';
        container.appendChild(indicator);
        
      } catch (error) {
        // Fallback para URL normal
        const url = 'https://nathan-12t.github.io/teles-design/';
        const qrSize = 200;
        const qrCode = createQRCodeSVG(url, qrSize);
        container.appendChild(qrCode);
        
        // Adiciona indicador de fallback
        const indicator = document.createElement('div');
        indicator.className = 'mt-2 text-xs text-orange-600';
        indicator.innerHTML = '⚠️ QR Code simples (dados muito grandes para backup automático)';
        container.appendChild(indicator);
      }
    }

    function createQRCodeSVG(text, size) {
      // Cria um QR Code simples usando API externa
      const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}&format=svg&bgcolor=ffffff&color=000000&qzone=2&margin=10`;
      
      const img = document.createElement('img');
      img.src = qrApiUrl;
      img.alt = 'QR Code para Teles Design';
      img.className = 'mx-auto rounded-lg shadow-md';
      img.style.width = size + 'px';
      img.style.height = size + 'px';
      
      // Fallback caso a API não funcione
      img.onerror = function() {
        this.style.display = 'none';
        const fallback = document.createElement('div');
        fallback.className = 'bg-gray-200 rounded-lg flex items-center justify-center text-gray-600';
        fallback.style.width = size + 'px';
        fallback.style.height = size + 'px';
        fallback.innerHTML = `
          <div class="text-center">
            <div class="text-4xl mb-2">📱</div>
            <div class="text-sm">QR Code</div>
            <div class="text-xs">Teles Design</div>
          </div>
        `;
        this.parentNode.appendChild(fallback);
      };
      
      return img;
    }

    function copiarLinkTeles() {
      const link = 'https://nathan-12t.github.io/teles-design/';
      
      navigator.clipboard.writeText(link).then(() => {
        alert('🔗 Link copiado!\n\nVocê pode colar em qualquer lugar para compartilhar o Teles Design.');
      }).catch(() => {
        // Fallback para navegadores mais antigos
        const textArea = document.createElement('textarea');
        textArea.value = link;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('🔗 Link copiado para a área de transferência!');
      });
    }

    function gerarLinkComBackup() {
      // Cria um backup dos dados atuais
      const backupData = {
        ...database,
        metadata: {
          ...database.metadata,
          exportedAt: new Date().toISOString(),
          exportedBy: currentUser?.nome || 'Sistema',
          systemName: 'BibliOn - Sistema de Biblioteca'
        }
      };
      
      // Converte para JSON compactado
      const jsonData = JSON.stringify(backupData);
      
      // Codifica em Base64 para incluir na URL
      const encodedData = btoa(encodeURIComponent(jsonData));
      
      // Cria URL com os dados
      const baseUrl = 'https://nathan-12t.github.io/teles-design/';
      const linkComBackup = `${baseUrl}?backup=${encodedData}`;
      
      return linkComBackup;
    }

    function copiarLinkComBackup() {
      try {
        const linkComBackup = gerarLinkComBackup();
        
        navigator.clipboard.writeText(linkComBackup).then(() => {
          alert('🔗 Link especial copiado!\n\n✨ Este link contém um backup automático dos dados da biblioteca.\n\n📱 Quando alguém acessar pelo QR Code ou link, o backup será baixado automaticamente no dispositivo.');
        }).catch(() => {
          // Fallback
          const textArea = document.createElement('textarea');
          textArea.value = linkComBackup;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert('🔗 Link especial copiado com backup automático!');
        });
      } catch (error) {
        alert('❌ Erro ao gerar link com backup. Os dados podem ser muito grandes.');
        copiarLinkTeles(); // Fallback para link normal
      }
    }

    // ===== COMPRESSÃO DE DADOS =====
    function compressData(data) {
      // Compressão simples usando técnicas de otimização
      const jsonStr = JSON.stringify(data);
      
      // Remove espaços desnecessários e otimiza estrutura
      const optimized = jsonStr
        .replace(/\s+/g, '') // Remove espaços
        .replace(/"([^"]+)":/g, '$1:') // Remove aspas desnecessárias das chaves
        .replace(/,}/g, '}') // Remove vírgulas antes de }
        .replace(/,]/g, ']'); // Remove vírgulas antes de ]
      
      return optimized;
    }

    function decompressData(compressedData) {
      try {
        // Reconstrói o JSON válido
        let restored = compressedData
          .replace(/([{,])(\w+):/g, '$1"$2":') // Restaura aspas nas chaves
          .replace(/([{,])(\d+):/g, '$1"$2":'); // Restaura aspas em chaves numéricas
        
        return JSON.parse(restored);
      } catch (error) {
        // Fallback para JSON normal
        return JSON.parse(compressedData);
      }
    }

    // ===== SISTEMA DE FRAGMENTAÇÃO =====
    function fragmentarDados(data, maxSize = 2000) {
      const compressed = compressData(data);
      const encoded = btoa(encodeURIComponent(compressed));
      
      if (encoded.length <= maxSize) {
        return { single: encoded };
      }
      
      // Fragmenta os dados
      const fragments = [];
      const fragmentSize = maxSize - 100; // Reserva espaço para metadados
      const totalFragments = Math.ceil(encoded.length / fragmentSize);
      const fragmentId = Date.now().toString(36); // ID único para este backup
      
      for (let i = 0; i < totalFragments; i++) {
        const start = i * fragmentSize;
        const end = Math.min(start + fragmentSize, encoded.length);
        const fragment = encoded.slice(start, end);
        
        fragments.push({
          id: fragmentId,
          part: i + 1,
          total: totalFragments,
          data: fragment,
          checksum: btoa(fragment).slice(0, 8) // Checksum simples
        });
      }
      
      return { fragments };
    }

    function criarURLFragmento(fragment) {
      const fragmentData = JSON.stringify(fragment);
      const encoded = btoa(encodeURIComponent(fragmentData));
      return `https://nathan-12t.github.io/teles-design/?biblion_fragment=${encoded}`;
    }

    // ===== QR CODE DE BACKUP AVANÇADO =====
    function gerarQRCodeBackup() {
      const container = document.getElementById('backupQRContainer');
      container.innerHTML = '<div class="text-center text-blue-600">🔄 Processando backup...</div>';
      
      try {
        // Cria backup otimizado dos dados atuais
        const backupData = {
          v: '3.0', // Versão compacta
          u: database.usuarios.map(u => ({
            i: u.id,
            n: u.nome,
            l: u.login,
            s: u.senha,
            t: u.tipo,
            tm: u.turma || '',
            st: u.status,
            lr: u.livrosLidos || 0
          })),
          l: database.livros.map(l => ({
            i: l.id,
            t: l.titulo,
            a: l.autor,
            e: l.editora || '',
            c: l.categoria || '',
            sc: l.subcategoria || '',
            q: l.quantidade,
            d: l.disponivel,
            ds: l.descricao || '',
            f: l.foto ? l.foto.slice(0, 500) : '', // Limita tamanho da foto
            cb: l.codigoBarra || '',
            lc: l.localizacao || '',
            av: l.avaliacoes || []
          })),
          e: database.emprestimos.map(e => ({
            i: e.id,
            ai: e.alunoId,
            li: e.livroId,
            de: e.dataEmprestimo,
            dd: e.dataDevolucao,
            st: e.status,
            dr: e.dataRealDevolucao || ''
          })),
          ni: database.nextId,
          m: {
            v: '3.0',
            lu: new Date().toISOString(),
            sn: 'BibliOn',
            eb: currentUser?.nome || 'Sistema',
            ea: new Date().toISOString()
          }
        };
        
        // Tenta fragmentação inteligente
        const result = fragmentarDados(backupData, 2800);
        
        if (result.single) {
          // Dados cabem em um QR Code
          const backupUrl = `https://nathan-12t.github.io/teles-design/?biblion_backup=${result.single}`;
          const qrCode = createQRCodeSVG(backupUrl, 180);
          
          container.innerHTML = '';
          container.appendChild(qrCode);
          
          const info = document.createElement('div');
          info.className = 'mt-2 text-xs text-green-600';
          info.innerHTML = `
            <div class="font-semibold">✅ QR Code Único Gerado!</div>
            <div>📊 ${database.livros.length} livros • ${database.usuarios.length} usuários • ${database.emprestimos.length} empréstimos</div>
            <div>💾 Tamanho: ${Math.round(result.single.length / 1024 * 100) / 100} KB</div>
          `;
          container.appendChild(info);
          
          alert('📱 QR Code do backup gerado com sucesso!\n\n✅ Todos os dados cabem em um único código\n\n🔒 Compartilhe apenas com pessoas autorizadas!');
          
        } else if (result.fragments) {
          // Precisa de múltiplos QR Codes
          container.innerHTML = '';
          
          // Título
          const title = document.createElement('div');
          title.className = 'text-sm font-semibold text-purple-600 mb-3';
          title.innerHTML = `📱 Backup Fragmentado (${result.fragments.length} códigos)`;
          container.appendChild(title);
          
          // Container dos QR Codes
          const qrGrid = document.createElement('div');
          qrGrid.className = 'grid grid-cols-2 gap-2';
          
          result.fragments.forEach((fragment, index) => {
            const fragmentUrl = criarURLFragmento(fragment);
            const qrWrapper = document.createElement('div');
            qrWrapper.className = 'text-center';
            
            const qrCode = createQRCodeSVG(fragmentUrl, 80);
            qrWrapper.appendChild(qrCode);
            
            const label = document.createElement('div');
            label.className = 'text-xs text-purple-600 mt-1';
            label.textContent = `${index + 1}/${result.fragments.length}`;
            qrWrapper.appendChild(label);
            
            qrGrid.appendChild(qrWrapper);
          });
          
          container.appendChild(qrGrid);
          
          // Instruções
          const instructions = document.createElement('div');
          instructions.className = 'mt-3 text-xs text-purple-700 bg-purple-50 p-2 rounded';
          instructions.innerHTML = `
            <div class="font-semibold mb-1">📋 Como usar:</div>
            <div>1. Escaneie TODOS os códigos em ordem</div>
            <div>2. O backup será montado automaticamente</div>
            <div>3. Aguarde o download do arquivo completo</div>
          `;
          container.appendChild(instructions);
          
          // Estatísticas
          const stats = document.createElement('div');
          stats.className = 'mt-2 text-xs text-purple-600';
          stats.innerHTML = `
            <div>📊 ${database.livros.length} livros • ${database.usuarios.length} usuários • ${database.emprestimos.length} empréstimos</div>
            <div>💾 Total: ${Math.round(result.fragments.reduce((sum, f) => sum + f.data.length, 0) / 1024 * 100) / 100} KB</div>
          `;
          container.appendChild(stats);
          
          alert(`📱 Backup fragmentado gerado!\n\n🔢 ${result.fragments.length} QR Codes criados\n\n📋 Escaneie todos os códigos em ordem para reconstruir o backup completo.\n\n💡 Dica: Use "Copiar Link" para uma alternativa mais simples.`);
          
        }
        
      } catch (error) {
        console.error('Erro ao gerar QR Code:', error);
        
        container.innerHTML = `
          <div class="text-center text-red-600 p-4">
            <div class="text-2xl mb-2">❌</div>
            <div class="text-sm">Erro ao processar backup</div>
            <div class="text-xs mt-1">Use "Copiar Link" como alternativa</div>
          </div>
        `;
        
        alert('❌ Erro ao gerar QR Code do backup.\n\nUse a opção "Copiar Link" para compartilhar os dados.');
      }
    }

    function compartilharLinkBackup() {
      try {
        // Cria backup dos dados atuais
        const backupData = {
          ...database,
          metadata: {
            ...database.metadata,
            exportedAt: new Date().toISOString(),
            exportedBy: currentUser?.nome || 'Sistema',
            systemName: 'BibliOn - Sistema de Biblioteca',
            backupType: 'Link Share'
          }
        };
        
        // Converte para JSON compactado
        const jsonData = JSON.stringify(backupData);
        
        // Codifica em Base64
        const encodedData = btoa(encodeURIComponent(jsonData));
        
        // Cria URL especial para backup
        const backupUrl = `https://nathan-12t.github.io/teles-design/?biblion_backup=${encodedData}`;
        
        // Copia para área de transferência
        navigator.clipboard.writeText(backupUrl).then(() => {
          alert('🔗 Link do backup copiado!\n\n✨ Este link contém todos os dados da biblioteca.\n\n📱 Quando alguém acessar, o backup será baixado automaticamente.\n\n🔒 Compartilhe apenas com pessoas autorizadas!');
        }).catch(() => {
          // Fallback para navegadores mais antigos
          const textArea = document.createElement('textarea');
          textArea.value = backupUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert('🔗 Link do backup copiado para a área de transferência!');
        });
        
      } catch (error) {
        alert('❌ Erro ao gerar link do backup: ' + error.message);
      }
    }

    // ===== SISTEMA DE FRAGMENTOS =====
    let fragmentStorage = {};

    function processarFragmento(fragmentData) {
      const fragment = fragmentData;
      const fragmentId = fragment.id;
      
      // Inicializa storage para este backup se não existir
      if (!fragmentStorage[fragmentId]) {
        fragmentStorage[fragmentId] = {
          fragments: {},
          total: fragment.total,
          received: 0
        };
      }
      
      const storage = fragmentStorage[fragmentId];
      
      // Adiciona o fragmento se ainda não foi recebido
      if (!storage.fragments[fragment.part]) {
        storage.fragments[fragment.part] = fragment;
        storage.received++;
        
        console.log(`📦 Fragmento ${fragment.part}/${fragment.total} recebido`);
        
        // Verifica se todos os fragmentos foram recebidos
        if (storage.received === storage.total) {
          console.log('✅ Todos os fragmentos recebidos, montando backup...');
          
          try {
            // Reconstrói os dados na ordem correta
            let reconstructedData = '';
            for (let i = 1; i <= storage.total; i++) {
              if (!storage.fragments[i]) {
                throw new Error(`Fragmento ${i} não encontrado`);
              }
              reconstructedData += storage.fragments[i].data;
            }
            
            // Decodifica os dados completos
            const decodedData = decodeURIComponent(atob(reconstructedData));
            const backupData = decompressData(decodedData);
            
            // Converte formato compacto para formato completo
            const fullBackup = expandirBackupCompacto(backupData);
            
            // Cria arquivo para download
            const blob = new Blob([JSON.stringify(fullBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `biblion-backup-fragmentado-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            
            // Limpa o storage
            delete fragmentStorage[fragmentId];
            
            // Notifica sucesso
            setTimeout(() => {
              const exportedBy = fullBackup.metadata?.exportedBy || 'Sistema';
              const exportedAt = fullBackup.metadata?.exportedAt ? 
                new Date(fullBackup.metadata.exportedAt).toLocaleString('pt-BR') : 
                'Data não informada';
              
              alert(`📥 Backup fragmentado montado com sucesso!\n\n✅ Arquivo completo salvo na pasta Downloads\n\n📊 Dados do backup:\n• ${fullBackup.livros.length} livros\n• ${fullBackup.usuarios.length} usuários\n• ${fullBackup.emprestimos.length} empréstimos\n\n👤 Exportado por: ${exportedBy}\n📅 Data: ${exportedAt}\n\n🔢 Fragmentos processados: ${storage.total}`);
            }, 1000);
            
            return true;
            
          } catch (error) {
            console.error('Erro ao montar backup fragmentado:', error);
            alert('❌ Erro ao montar backup fragmentado.\n\nVerifique se todos os QR Codes foram escaneados corretamente.');
            delete fragmentStorage[fragmentId];
          }
        } else {
          // Ainda faltam fragmentos
          setTimeout(() => {
            alert(`📦 Fragmento ${fragment.part}/${fragment.total} recebido!\n\n⏳ Faltam ${storage.total - storage.received} fragmento(s)\n\n📱 Continue escaneando os próximos QR Codes para completar o backup.`);
          }, 500);
        }
      }
      
      return false;
    }

    function expandirBackupCompacto(compactData) {
      // Converte formato compacto v3.0 para formato completo
      if (compactData.v === '3.0') {
        return {
          usuarios: compactData.u.map(u => ({
            id: u.i,
            nome: u.n,
            login: u.l,
            senha: u.s,
            tipo: u.t,
            turma: u.tm,
            status: u.st,
            livrosLidos: u.lr
          })),
          livros: compactData.l.map(l => ({
            id: l.i,
            titulo: l.t,
            autor: l.a,
            editora: l.e,
            categoria: l.c,
            subcategoria: l.sc,
            quantidade: l.q,
            disponivel: l.d,
            descricao: l.ds,
            foto: l.f,
            codigoBarra: l.cb,
            localizacao: l.lc,
            avaliacoes: l.av
          })),
          emprestimos: compactData.e.map(e => ({
            id: e.i,
            alunoId: e.ai,
            livroId: e.li,
            dataEmprestimo: e.de,
            dataDevolucao: e.dd,
            status: e.st,
            dataRealDevolucao: e.dr
          })),
          nextId: compactData.ni,
          metadata: {
            version: compactData.m.v,
            lastUpdate: compactData.m.lu,
            systemName: compactData.m.sn === 'BibliOn' ? 'BibliOn - Sistema de Biblioteca' : compactData.m.sn,
            exportedBy: compactData.m.eb,
            exportedAt: compactData.m.ea
          }
        };
      }
      
      // Retorna dados já no formato completo
      return compactData;
    }

    // ===== DETECÇÃO DE BACKUP NA URL =====
    function detectarBackupNaURL() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Verifica fragmento primeiro
      const fragmentParam = urlParams.get('biblion_fragment');
      if (fragmentParam) {
        try {
          const decodedFragment = decodeURIComponent(atob(fragmentParam));
          const fragmentData = JSON.parse(decodedFragment);
          
          // Remove o parâmetro da URL
          const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
          
          return processarFragmento(fragmentData);
          
        } catch (error) {
          console.error('Erro ao processar fragmento:', error);
          setTimeout(() => {
            alert('❌ Erro ao processar fragmento do backup.\n\nO QR Code pode estar corrompido.');
          }, 1000);
        }
      }
      
      // Verifica parâmetro do backup completo
      const backupParam = urlParams.get('biblion_backup') || urlParams.get('backup');
      if (backupParam) {
        try {
          // Decodifica os dados do backup
          const decodedData = decodeURIComponent(atob(backupParam));
          let backupData;
          
          try {
            // Tenta descomprimir primeiro
            backupData = decompressData(decodedData);
          } catch {
            // Fallback para JSON normal
            backupData = JSON.parse(decodedData);
          }
          
          // Expande se for formato compacto
          const fullBackup = expandirBackupCompacto(backupData);
          
          // Valida se é um backup válido
          if (fullBackup.usuarios && fullBackup.livros && fullBackup.emprestimos) {
            // Cria o arquivo de backup para download
            const blob = new Blob([JSON.stringify(fullBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Cria link de download automático
            const a = document.createElement('a');
            a.href = url;
            a.download = `biblion-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            // Força o download
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Limpa a URL
            URL.revokeObjectURL(url);
            
            // Remove o parâmetro da URL sem recarregar a página
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
            
            // Notifica o usuário
            setTimeout(() => {
              const exportedBy = fullBackup.metadata?.exportedBy || 'Sistema';
              const exportedAt = fullBackup.metadata?.exportedAt ? 
                new Date(fullBackup.metadata.exportedAt).toLocaleString('pt-BR') : 
                'Data não informada';
              
              alert(`📥 Backup do BibliOn baixado automaticamente!\n\n✅ Arquivo salvo na pasta Downloads\n\n📊 Dados do backup:\n• ${fullBackup.livros.length} livros\n• ${fullBackup.usuarios.length} usuários\n• ${fullBackup.emprestimos.length} empréstimos\n\n👤 Exportado por: ${exportedBy}\n📅 Data: ${exportedAt}`);
            }, 1000);
            
            return true;
          }
        } catch (error) {
          console.error('Erro ao processar backup da URL:', error);
          
          // Notifica erro ao usuário
          setTimeout(() => {
            alert('❌ Erro ao processar backup da URL.\n\nO link pode estar corrompido ou incompleto.');
          }, 1000);
        }
      }
      
      return false;
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
      // Verifica se há backup na URL antes de inicializar
      const temBackup = detectarBackupNaURL();
      
      initializeDatabase();
      
      // Login
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      
      // Toggle senha
      document.getElementById('togglePwd').addEventListener('click', function() {
        const input = document.getElementById('loginPassword');
        const btn = this;
        
        if (input.type === 'password') {
          input.type = 'text';
          btn.textContent = 'Ocultar';
        } else {
          input.type = 'password';
          btn.textContent = 'Mostrar';
        }
      });
      
      // Forms
      document.getElementById('addBookForm').addEventListener('submit', handleAddBook);
      document.getElementById('editBookForm').addEventListener('submit', handleEditBook);
      document.getElementById('addEmprestimoForm').addEventListener('submit', handleAddEmprestimo);
      document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
      document.getElementById('clearSystemForm').addEventListener('submit', handleClearSystem);
      
      // Filtros
      document.getElementById('searchLivros').addEventListener('input', loadLivros);
      document.getElementById('filterCategoria').addEventListener('change', loadLivros);
      document.getElementById('filterAutor').addEventListener('change', loadLivros);
      document.getElementById('filterDisponibilidade').addEventListener('change', loadLivros);
      
      document.getElementById('searchEmprestimos').addEventListener('input', loadEmprestimos);
      document.getElementById('filterDataInicio').addEventListener('change', loadEmprestimos);
      document.getElementById('filterDataFim').addEventListener('change', loadEmprestimos);
      document.getElementById('filterTurma').addEventListener('change', loadEmprestimos);
      
      document.getElementById('searchUsuarios').addEventListener('input', loadUsuarios);
      document.getElementById('filterTipoUsuario').addEventListener('change', loadUsuarios);
      document.getElementById('filterStatusUsuario').addEventListener('change', loadUsuarios);
      
      // Busca de livros para empréstimo
      document.getElementById('searchLivroEmprestimo').addEventListener('input', searchLivrosEmprestimo);
      
      // Trocar senha
      document.getElementById('trocarSenhaBtn').addEventListener('click', () => showModal('trocarSenhaModal'));
      
      // Atualizar estatísticas do modal de limpeza
      document.getElementById('clearSystemModal').addEventListener('click', function() {
        document.getElementById('statLivros').textContent = database.livros.length;
        document.getElementById('statEmpAtivos').textContent = database.emprestimos.filter(e => e.status === 'ativo').length;
        document.getElementById('statUsuarios').textContent = database.usuarios.filter(u => u.login !== 'ADMIN').length;
      });
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9902ac13c589f1f2',t:'MTc2MDczNDI2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
