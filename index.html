<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BibliOn - Sistema de Biblioteca</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    body { box-sizing: border-box; }
    .gradient-bg { background: linear-gradient(135deg, #d2691e 0%, #a0522d 100%); }
    .card-hover { transition: all .3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -10px rgba(0,0,0,.15);}
    .nav-btn.active { border-color:#d2691e !important; color:#d2691e !important; }
    .book-card { background: linear-gradient(145deg, #ffffff, #f3f3f3); border: 1px solid #e6e6e6; }
    .transition-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#d2691e,#a0522d);z-index:50;opacity:0;visibility:hidden;transition:all .5s ease}
    .transition-screen.active{opacity:1;visibility:visible}
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
    .float { animation: float 2s ease-in-out infinite; }
  </style>
</head>
<body class="bg-[#0f172a]">
  <!-- Tela de Transição -->
  <div id="transitionScreen" class="transition-screen">
    <div class="text-center text-white">
      <div class="float mb-4 text-6xl">📚</div>
      <h1 class="text-3xl font-bold">Carregando sua biblioteca...</h1>
    </div>
  </div>

  <!-- Login -->
  <section id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="text-5xl mb-2">📚</div>
        <h1 class="text-3xl font-bold text-gray-800">BibliOn</h1>
        <p class="text-gray-500">Sistema de Gerenciamento de Biblioteca</p>
      </div>

      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
          <input id="loginUser" type="text" placeholder="Seu usuário" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none" required />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
          <div class="relative">
            <input id="loginPassword" type="password" placeholder="Sua senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none pr-12" required />
            <button type="button" id="togglePwd" class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 text-sm text-orange-700 bg-orange-100 rounded hover:bg-orange-200">Mostrar</button>
          </div>
        </div>

        <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition">Entrar</button>
      </form>

      <div class="mt-8 text-center text-xs text-gray-500">
        Criado por Nathannael Teles · Teles Design
      </div>
    </div>
  </section>

  <!-- App -->
  <div id="mainSystem" class="hidden">
    <!-- Header -->
    <header class="gradient-bg text-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="text-3xl">📚</div>
          <h1 class="text-2xl font-bold">BibliOn</h1>
        </div>
        <div class="flex items-center gap-2">
          <span id="userWelcome" class="text-sm opacity-90"></span>
          <button id="trocarSenhaBtn" class="bg-amber-700 hover:bg-amber-800 px-3 py-2 rounded-lg hidden">🔑 Trocar Senha</button>
          <button id="backupBtn" class="bg-blue-700 hover:bg-blue-800 px-3 py-2 rounded-lg hidden">💾 Backup</button>
          <button onclick="logout()" class="bg-red-700 hover:bg-red-800 px-3 py-2 rounded-lg">Sair</button>
        </div>
      </div>
    </header>

    <!-- Nav -->
    <nav class="bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-6">
          <button onclick="showTab('inicio')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700 active">🏠 Início</button>
          <button onclick="showTab('livros')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">📖 Livros</button>
          <button onclick="showTab('emprestimos')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">📋 Empréstimos</button>
          <button onclick="showTab('devolucoes')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">⏰ Devoluções</button>
          <button id="usuariosTabBtn" onclick="showTab('usuarios')" class="nav-btn py-4 border-b-2 border-transparent hover:border-amber-700">👥 Usuários</button>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <!-- INÍCIO -->
      <section id="inicioTab" class="tab-content">
        <h2 class="text-2xl font-bold text-white mb-6">Painel</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-blue-100 p-3 rounded-full text-xl">📚</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Livros</p>
                <p id="totalLivros" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-green-100 p-3 rounded-full text-xl">📋</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Empréstimos</p>
                <p id="totalEmprestimos" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-red-100 p-3 rounded-full text-xl">⏰</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Pendências</p>
                <p id="totalPendentes" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
          <div id="usuariosCard" class="bg-white rounded-xl p-6 card-hover">
            <div class="flex items-center">
              <div class="bg-purple-100 p-3 rounded-full text-xl">👥</div>
              <div class="ml-3">
                <p class="text-gray-500 text-sm">Usuários</p>
                <p id="totalUsuarios" class="text-2xl font-bold">0</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 bg-white rounded-xl p-6">
          <h3 class="font-semibold text-gray-800 mb-4">⭐ Livros em Destaque</h3>
          <div id="livrosDestaque" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4"></div>
        </div>

        <div id="meusEmprestimos" class="mt-8 bg-white rounded-xl p-6 hidden">
          <h3 class="font-semibold text-gray-800 mb-4">📖 Meus Empréstimos</h3>
          <div id="emprestimosAluno" class="space-y-3"></div>
        </div>
      </section>

      <!-- LIVROS -->
      <section id="livrosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Livros</h2>
          <div id="livrosActions" class="space-x-2">
            <button onclick="showModal('addBookModal')" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">➕ Adicionar</button>
            <button onclick="showModal('importBooksModal')" class="bg-amber-800 hover:bg-amber-900 text-white px-4 py-2 rounded-lg">📄 Importar</button>
            <button id="clearLibraryBtn" onclick="showModal('clearLibraryModal')" class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-lg hidden">🗑️ Limpar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">🔍 Filtros</h3>
            <button onclick="clearLivrosFilters()" class="text-sm text-orange-600 underline">Limpar</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <input id="searchLivros" type="text" placeholder="Título, autor, categoria..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <select id="filterCategoria" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"><option value="">Todas as categorias</option></select>
            <select id="filterAutor" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"><option value="">Todos os autores</option></select>
            <select id="filterDisponibilidade" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700">
              <option value="">Todos</option>
              <option value="disponivel">Disponível</option>
              <option value="indisponivel">Indisponível</option>
            </select>
          </div>
        </div>

        <div id="livrosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>

      <!-- EMPRÉSTIMOS -->
      <section id="emprestimosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Empréstimos</h2>
          <button id="addEmprestimoBtn" onclick="showAddEmprestimoModal()" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">➕ Novo</button>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">🔍 Filtros</h3>
            <button onclick="clearEmprestimosFilters()" class="text-sm text-orange-600 underline">Limpar</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <input id="searchEmprestimos" type="text" placeholder="Aluno, livro, turma..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <input id="filterDataInicio" type="date" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <input id="filterDataFim" type="date" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <select id="filterTurma" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"><option value="">Todas as turmas</option></select>
          </div>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">Empréstimo</th>
                  <th class="px-6 py-3 text-left">Devolução</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="emprestimosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DEVOLUÇÕES -->
      <section id="devolucoesTab" class="tab-content hidden">
        <h2 class="text-2xl font-bold text-white mb-6">Devoluções Pendentes</h2>
        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-red-50 text-xs text-red-600 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Aluno</th>
                  <th class="px-6 py-3 text-left">Livro</th>
                  <th class="px-6 py-3 text-left">Empréstimo</th>
                  <th class="px-6 py-3 text-left">Prevista</th>
                  <th class="px-6 py-3 text-left">Atraso</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="devolucoesList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- USUÁRIOS -->
      <section id="usuariosTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Usuários</h2>
          <div class="space-x-2">
            <button onclick="showModal('addUserModal')" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg">➕ Adicionar</button>
            <button onclick="showModal('importUsersModal')" class="bg-amber-800 hover:bg-amber-900 text-white px-4 py-2 rounded-lg">📄 Importar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl p-6 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="searchUsuarios" type="text" placeholder="Buscar usuários..." class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/>
            <select id="filterTipoUsuario" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700">
              <option value="">Todos os tipos</option>
              <option value="aluno">Aluno</option>
              <option value="professor">Professor</option>
              <option value="diretor">Diretor</option>
              <option value="coordenador">Coordenador</option>
              <option value="ajudante">Ajudante</option>
              <option value="admin">Admin</option>
            </select>
            <select id="filterStatusUsuario" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700">
              <option value="">Todos</option>
              <option value="ativo">Ativo</option>
              <option value="bloqueado">Bloqueado</option>
            </select>
          </div>
        </div>

        <div class="bg-white rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                <tr>
                  <th class="px-6 py-3 text-left">Nome</th>
                  <th class="px-6 py-3 text-left">Login</th>
                  <th class="px-6 py-3 text-left">Tipo</th>
                  <th class="px-6 py-3 text-left">Turma</th>
                  <th class="px-6 py-3 text-left">Lidos</th>
                  <th class="px-6 py-3 text-left">Status</th>
                  <th class="px-6 py-3 text-left">Ações</th>
                </tr>
              </thead>
              <tbody id="usuariosList" class="bg-white divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-[#0b1224] text-white/70 text-center py-6">
      Criado por Nathannael Teles · Teles Design
    </footer>
  </div>

  <!-- Modais -->
  <!-- Add Livro -->
  <div id="addBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Adicionar Livro</h3>
        <button onclick="closeModal('addBookModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addBookForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium mb-1">Título *</label><input name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label class="block text-sm font-medium mb-1">Código de Barra</label><input name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label class="block text-sm font-medium mb-1">Autor *</label><input name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label class="block text-sm font-medium mb-1">Editora</label><input name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label class="block text-sm font-medium mb-1">Categoria</label><input name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label class="block text-sm font-medium mb-1">Subcategoria</label><input name="subcategoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label class="block text-sm font-medium mb-1">Quantidade *</label><input type="number" min="1" name="quantidade" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
          <div><label class="block text-sm font-medium mb-1">Localização</label><input name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"/></div>
        </div>
        <div><label class="block text-sm font-medium mb-1">Descrição</label><textarea name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-700"></textarea></div>
        <div>
          <label class="block text-sm font-medium mb-1">Foto do Livro</label>
          <div class="space-y-2">
            <input type="file" name="fotoFile" accept="image/png,image/jpg,image/jpeg" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <p class="text-xs text-gray-500">ou</p>
            <input type="url" name="foto" placeholder="URL da imagem" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
          </div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeModal('addBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Livros -->
  <div id="importBooksModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Livros</h3>
        <button onclick="closeModal('importBooksModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="space-y-4">
        <div class="bg-blue-50 border border-blue-200 p-3 rounded">
          <div class="text-sm text-blue-800"><b>Formato:</b> Título | Autor | Código | Categoria | Estoque | Local | Quantidade</div>
        </div>
        <textarea id="importBooksText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Ex.:&#10;Dom Casmurro | Machado de Assis&#10;O Cortiço | Aluísio Azevedo | 123456 | Literatura | 5 | Corredor A | 3"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importBooksModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importBooks()" class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Empréstimo -->
  <div id="addEmprestimoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Novo Empréstimo</h3>
        <button onclick="closeModal('addEmprestimoModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addEmprestimoForm" class="space-y-4">
        <div id="alunoSelectDiv">
          <label class="block text-sm font-medium mb-1">Aluno *</label>
          <select name="aluno" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione o aluno...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Buscar Livro *</label>
          <input id="searchLivroEmprestimo" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Digite o título..."/>
          <div id="livroSuggestions" class="hidden mt-2 border rounded-lg max-h-40 overflow-y-auto"></div>
        </div>
        <div id="livroSelecionado" class="hidden">
          <label class="block text-sm font-medium mb-1">Livro Selecionado</label>
          <div id="livroInfo" class="p-3 bg-gray-50 rounded-lg"></div>
          <input type="hidden" name="livro" id="livroId"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Devolução *</label>
          <input type="date" name="dataDevolucao" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addEmprestimoModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Criar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Livro -->
  <div id="editBookModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Editar Livro</h3>
        <button onclick="closeModal('editBookModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="editBookForm" class="space-y-4">
        <input type="hidden" name="id" id="editBookId"/>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium mb-1">Título *</label><input id="editBookTitulo" name="titulo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label class="block text-sm font-medium mb-1">Código de Barra</label><input id="editBookCodigo" name="codigoBarra" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label class="block text-sm font-medium mb-1">Autor *</label><input id="editBookAutor" name="autor" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label class="block text-sm font-medium mb-1">Editora</label><input id="editBookEditora" name="editora" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label class="block text-sm font-medium mb-1">Categoria</label><input id="editBookCategoria" name="categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label class="block text-sm font-medium mb-1">Subcategoria</label><input id="editBookSubcategoria" name="subcategoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label class="block text-sm font-medium mb-1">Quantidade *</label><input type="number" id="editBookQuantidade" name="quantidade" min="1" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
          <div><label class="block text-sm font-medium mb-1">Localização</label><input id="editBookLocalizacao" name="localizacao" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        </div>
        <div><label class="block text-sm font-medium mb-1">Descrição</label><textarea id="editBookDescricao" name="descricao" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"></textarea></div>
        <div>
          <label class="block text-sm font-medium mb-1">Foto do Livro</label>
          <div class="space-y-2">
            <input type="file" name="fotoFile" accept="image/png,image/jpg,image/jpeg" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <p class="text-xs text-gray-500">ou</p>
            <input type="url" id="editBookFoto" name="foto" placeholder="URL da imagem" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('editBookModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Usuário -->
  <div id="addUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Adicionar Usuário</h3>
        <button onclick="closeModal('addUserModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="addUserForm" class="space-y-4">
        <div><label class="block text-sm font-medium mb-1">Nome *</label><input name="nome" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label class="block text-sm font-medium mb-1">Login *</label><input name="login" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div><label class="block text-sm font-medium mb-1">Senha *</label><input type="password" name="senha" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"/></div>
        <div>
          <label class="block text-sm font-medium mb-1">Tipo de Usuário *</label>
          <select name="tipo" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" onchange="toggleTurmaField(this)">
            <option value="">Selecione...</option>
            <option value="aluno">Aluno</option>
            <option value="professor">Professor</option>
            <option value="diretor">Diretor</option>
            <option value="coordenador">Coordenador</option>
            <option value="ajudante">Ajudante</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div id="turmaField" class="hidden">
          <label class="block text-sm font-medium mb-1">Turma</label>
          <select name="turma" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            <option value="">Selecione a turma...</option>
            <optgroup label="Ensino Fundamental (EF)">
              <option value="1-A EF">1º A EF</option><option value="1-B EF">1º B EF</option><option value="1-C EF">1º C EF</option><option value="1-D EF">1º D EF</option><option value="1-E EF">1º E EF</option>
              <option value="2-A EF">2º A EF</option><option value="2-B EF">2º B EF</option><option value="2-C EF">2º C EF</option><option value="2-D EF">2º D EF</option><option value="2-E EF">2º E EF</option>
              <option value="3-A EF">3º A EF</option><option value="3-B EF">3º B EF</option><option value="3-C EF">3º C EF</option><option value="3-D EF">3º D EF</option><option value="3-E EF">3º E EF</option>
              <option value="4-A EF">4º A EF</option><option value="4-B EF">4º B EF</option><option value="4-C EF">4º C EF</option><option value="4-D EF">4º D EF</option><option value="4-E EF">4º E EF</option>
              <option value="5-A EF">5º A EF</option><option value="5-B EF">5º B EF</option><option value="5-C EF">5º C EF</option><option value="5-D EF">5º D EF</option><option value="5-E EF">5º E EF</option>
              <option value="6-A EF">6º A EF</option><option value="6-B EF">6º B EF</option><option value="6-C EF">6º C EF</option><option value="6-D EF">6º D EF</option><option value="6-E EF">6º E EF</option>
              <option value="7-A EF">7º A EF</option><option value="7-B EF">7º B EF</option><option value="7-C EF">7º C EF</option><option value="7-D EF">7º D EF</option><option value="7-E EF">7º E EF</option>
              <option value="8-A EF">8º A EF</option><option value="8-B EF">8º B EF</option><option value="8-C EF">8º C EF</option><option value="8-D EF">8º D EF</option><option value="8-E EF">8º E EF</option>
              <option value="9-A EF">9º A EF</option><option value="9-B EF">9º B EF</option><option value="9-C EF">9º C EF</option><option value="9-D EF">9º D EF</option><option value="9-E EF">9º E EF</option>
            </optgroup>
            <optgroup label="Ensino Médio (EM)">
              <option value="1-A EM">1º A EM</option><option value="1-B EM">1º B EM</option><option value="1-C EM">1º C EM</option><option value="1-D EM">1º D EM</option><option value="1-E EM">1º E EM</option>
              <option value="2-A EM">2º A EM</option><option value="2-B EM">2º B EM</option><option value="2-C EM">2º C EM</option><option value="2-D EM">2º D EM</option><option value="2-E EM">2º E EM</option>
              <option value="3-A EM">3º A EM</option><option value="3-B EM">3º B EM</option><option value="3-C EM">3º C EM</option><option value="3-D EM">3º D EM</option><option value="3-E EM">3º E EM</option>
            </optgroup>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('addUserModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Usuários -->
  <div id="importUsersModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">Importar Usuários</h3>
        <button onclick="closeModal('importUsersModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="space-y-4">
        <div class="text-sm text-gray-600">Formato: Nome | Login | Senha | Tipo | Turma (um por linha)</div>
        <textarea id="importUsersText" rows="8" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Ex.:&#10;João Silva | joaos | 1234 | aluno | 1-A EF&#10;Maria Lima | marial | 1234 | professor |"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="closeModal('importUsersModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button onclick="importUsers()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Limpar Biblioteca -->
  <div id="clearLibraryModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold text-red-600">⚠️ Limpar Biblioteca</h3>
        <button onclick="closeModal('clearLibraryModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="space-y-4">
        <div class="bg-red-50 border border-red-200 p-3 rounded text-sm text-red-800">
          Esta ação apagará TODOS os livros e empréstimos. Irreversível.
        </div>
        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded text-sm text-yellow-800">
          <div><b>Dados a remover:</b></div>
          <div>• <span id="statLivros">0</span> livros</div>
          <div>• <span id="statEmpAtivos">0</span> empréstimos ativos</div>
          <div>• Todas as avaliações</div>
        </div>
        <form id="clearLibraryForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Senha do administrador</label>
            <input id="adminPasswordConfirm" type="password" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"/>
          </div>
          <label class="flex items-center gap-2 text-sm">
            <input id="confirmClear" type="checkbox" class="rounded"/> Confirmo que entendo o risco
          </label>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeModal('clearLibraryModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
            <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">LIMPAR</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Trocar Senha -->
  <div id="trocarSenhaModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold text-blue-600">🔑 Trocar Senha</h3>
        <button onclick="closeModal('trocarSenhaModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <form id="trocarSenhaForm" class="space-y-4">
        <div class="bg-blue-50 border border-blue-200 p-3 rounded text-sm text-blue-800">Confirme sua senha atual e defina uma nova.</div>
        <div><label class="block text-sm font-medium mb-1">Senha Atual *</label><input id="senhaAtual" type="password" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"/></div>
        <div><label class="block text-sm font-medium mb-1">Nova Senha *</label><input id="novaSenha" type="password" minlength="4" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"/></div>
        <div><label class="block text-sm font-medium mb-1">Confirmar Nova Senha *</label><input id="confirmarNovaSenha" type="password" minlength="4" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"/></div>
        <div class="text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded p-2">Anote sua nova senha em local seguro.</div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal('trocarSenhaModal')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Alterar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Backup Modal -->
  <div id="backupModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-blue-600">💾 Backup e Restauração</h3>
        <button onclick="closeModal('backupModal')" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      
      <div class="space-y-6">
        <!-- Fazer Backup -->
        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
          <h4 class="font-semibold text-blue-800 mb-2">📤 Fazer Backup</h4>
          <p class="text-sm text-blue-700 mb-3">Salve todos os dados da biblioteca em um arquivo.</p>
          <div class="flex gap-2">
            <button onclick="exportarBackup()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">💾 Baixar Backup</button>
            <button onclick="copiarBackup()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">📋 Copiar Dados</button>
          </div>
        </div>

        <!-- Restaurar Backup -->
        <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
          <h4 class="font-semibold text-green-800 mb-2">📥 Restaurar Backup</h4>
          <p class="text-sm text-green-700 mb-3">Carregue dados de um backup anterior.</p>
          
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium mb-1">Arquivo de Backup</label>
              <input type="file" id="backupFile" accept=".json,.txt" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
            </div>
            
            <div class="text-sm text-gray-600">ou</div>
            
            <div>
              <label class="block text-sm font-medium mb-1">Cole os dados do backup</label>
              <textarea id="backupText" rows="6" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Cole aqui o conteúdo do backup..."></textarea>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded text-sm text-yellow-800">
              ⚠️ <strong>Atenção:</strong> Restaurar um backup substituirá TODOS os dados atuais.
            </div>
            
            <button onclick="restaurarBackup()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">📥 Restaurar Backup</button>
          </div>
        </div>

        <!-- Estatísticas -->
        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
          <h4 class="font-semibold text-gray-800 mb-2">📊 Dados Atuais</h4>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>📚 <span id="backupStatsLivros">0</span> livros</div>
            <div>👥 <span id="backupStatsUsuarios">0</span> usuários</div>
            <div>📋 <span id="backupStatsEmprestimos">0</span> empréstimos</div>
            <div>⭐ <span id="backupStatsAvaliacoes">0</span> avaliações</div>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-4">
        <button onclick="closeModal('backupModal')" class="px-4 py-2 border rounded-lg">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== BANCO DE DADOS =====
    const defaultDB = {
      usuarios: [
        { 
          id: 1, 
          nome: 'Administrador', 
          login: 'ADMIN', 
          senha: 'VANIA25', 
          tipo: 'admin', 
          turma: '', 
          status: 'ativo', 
          livrosLidos: 0 
        }
      ],
      livros: [
        { 
          id: 1, 
          titulo: 'Dom Casmurro', 
          autor: 'Machado de Assis', 
          editora: 'Ática', 
          categoria: 'Literatura Brasileira', 
          subcategoria: 'Romance', 
          quantidade: 5, 
          disponivel: 5, 
          descricao: 'Clássico da literatura brasileira.', 
          foto: '', 
          codigoBarra: '123456789', 
          localizacao: 'Corredor A', 
          avaliacoes: [] 
        },
        { 
          id: 2, 
          titulo: 'O Cortiço', 
          autor: 'Aluísio Azevedo', 
          editora: 'Moderna', 
          categoria: 'Literatura Brasileira', 
          subcategoria: 'Naturalismo', 
          quantidade: 3, 
          disponivel: 3, 
          descricao: 'Vida em um cortiço do RJ.', 
          foto: '', 
          codigoBarra: '987654321', 
          localizacao: 'Corredor B', 
          avaliacoes: [] 
        }
      ],
      emprestimos: [],
      nextId: { usuarios: 2, livros: 3, emprestimos: 1 }
    };

    // ===== VARIÁVEIS GLOBAIS =====
    let database = null;
    let currentUser = null;

    // ===== FUNÇÕES UTILITÁRIAS =====
    function safeParse(json) {
      try {
        return JSON.parse(json);
      } catch {
        return null;
      }
    }

    function saveDatabase() {
      localStorage.setItem('bibliOnDatabase', JSON.stringify(database));
    }

    function showModal(id) {
      const modal = document.getElementById(id);
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('pt-BR');
    }

    // ===== INICIALIZAÇÃO DO BANCO =====
    function initializeDatabase() {
      console.log('🔧 Inicializando banco de dados...');
      
      const saved = localStorage.getItem('bibliOnDatabase');
      console.log('💾 Dados salvos encontrados:', !!saved);
      
      if (!saved) {
        console.log('✨ Criando banco padrão...');
        database = JSON.parse(JSON.stringify(defaultDB));
        saveDatabase();
      } else {
        const parsed = safeParse(saved);
        if (!parsed || !parsed.usuarios || !Array.isArray(parsed.usuarios)) {
          console.log('⚠️ Dados corrompidos, recriando...');
          database = JSON.parse(JSON.stringify(defaultDB));
          saveDatabase();
        } else {
          database = parsed;
          
          // Garantir estrutura
          if (!database.nextId) {
            database.nextId = { usuarios: 2, livros: 3, emprestimos: 1 };
          }
          
          // Garantir admin
          const hasAdmin = database.usuarios.some(u => 
            u && u.login && u.login.toUpperCase() === 'ADMIN'
          );
          
          if (!hasAdmin) {
            console.log('👑 Adicionando usuário ADMIN...');
            database.usuarios.push({
              id: database.nextId.usuarios++,
              nome: 'Administrador',
              login: 'ADMIN',
              senha: 'VANIA25',
              tipo: 'admin',
              turma: '',
              status: 'ativo',
              livrosLidos: 0
            });
            saveDatabase();
          }
        }
      }
      
      console.log('✅ Banco inicializado:', {
        usuarios: database.usuarios.length,
        livros: database.livros.length,
        emprestimos: database.emprestimos.length
      });
    }

    // ===== SISTEMA DE LOGIN =====
    function handleLogin(event) {
      event.preventDefault();
      
      const userInput = document.getElementById('loginUser').value.trim();
      const passwordInput = document.getElementById('loginPassword').value;
      
      console.log('🔐 Tentativa de login:', { usuario: userInput, senha: '***' });
      
      if (!userInput || !passwordInput) {
        alert('Por favor, preencha usuário e senha.');
        return;
      }
      
      // Buscar usuário
      const user = database.usuarios.find(u => {
        if (!u || !u.login || !u.senha) return false;
        
        const loginMatch = u.login.toUpperCase() === userInput.toUpperCase();
        const passwordMatch = u.senha === passwordInput;
        const isActive = u.status === 'ativo';
        
        return loginMatch && passwordMatch && isActive;
      });
      
      if (!user) {
        console.log('❌ Login falhou');
        alert('Usuário ou senha incorretos, ou usuário bloqueado.\n\n' +
              '🔑 Credenciais padrão:\n' +
              'Usuário: ADMIN\n' +
              'Senha: VANIA25');
        return;
      }
      
      console.log('✅ Login bem-sucedido:', user.nome);
      currentUser = user;
      showTransition();
    }

    function showTransition() {
      const transition = document.getElementById('transitionScreen');
      transition.classList.add('active');
      
      setTimeout(() => {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainSystem').classList.remove('hidden');
        transition.classList.remove('active');
        setupUserInterface();
        showTab('inicio');
      }, 800);
    }

    function setupUserInterface() {
      document.getElementById('userWelcome').textContent = `Olá, ${currentUser.nome}`;
      
      const isAdmin = currentUser.tipo === 'admin';
      const isStudent = currentUser.tipo === 'aluno';
      
      // Resetar visibilidade
      document.getElementById('usuariosTabBtn').classList.remove('hidden');
      document.getElementById('usuariosCard').classList.remove('hidden');
      document.getElementById('addEmprestimoBtn').classList.remove('hidden');
      document.getElementById('meusEmprestimos').classList.add('hidden');
      document.getElementById('livrosActions').classList.remove('hidden');
      
      // Configurar para admin
      document.getElementById('clearLibraryBtn').classList.toggle('hidden', !isAdmin);
      document.getElementById('trocarSenhaBtn').classList.toggle('hidden', !isAdmin);
      document.getElementById('backupBtn').classList.toggle('hidden', !isAdmin);
      
      // Configurar para aluno
      if (isStudent) {
        document.getElementById('usuariosTabBtn').classList.add('hidden');
        document.getElementById('usuariosCard').classList.add('hidden');
        document.getElementById('addEmprestimoBtn').classList.add('hidden');
        document.getElementById('meusEmprestimos').classList.remove('hidden');
        document.getElementById('livrosActions').classList.add('hidden');
      }
      
      updateDashboard();
    }

    function logout() {
      currentUser = null;
      document.getElementById('mainSystem').classList.add('hidden');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('loginForm').reset();
    }

    // ===== SISTEMA DE ABAS =====
    function showTab(tabName) {
      // Esconder todas as abas
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // Mostrar aba selecionada
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
      
      // Atualizar navegação
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
          btn.classList.add('active');
        }
      });
      
      // Carregar dados específicos da aba
      switch (tabName) {
        case 'inicio':
          updateDashboard();
          break;
        case 'livros':
          loadLivros();
          loadFilterOptions();
          break;
        case 'emprestimos':
          loadEmprestimos();
          loadTurmasFilter();
          break;
        case 'devolucoes':
          loadDevolucoesPendentes();
          break;
        case 'usuarios':
          loadUsuarios();
          break;
      }
    }

    // ===== DASHBOARD =====
    function updateDashboard() {
      document.getElementById('totalLivros').textContent = database.livros.length;
      document.getElementById('totalEmprestimos').textContent = 
        database.emprestimos.filter(e => e.status === 'ativo').length;
      document.getElementById('totalUsuarios').textContent = 
        database.usuarios.filter(u => u.status === 'ativo').length;
      
      const hoje = new Date();
      const pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      ).length;
      document.getElementById('totalPendentes').textContent = pendentes;
      
      loadLivrosDestaque();
      
      if (currentUser?.tipo === 'aluno') {
        loadEmprestimosAluno();
      }
    }

    function loadLivrosDestaque() {
      const container = document.getElementById('livrosDestaque');
      
      if (database.livros.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500">Nenhum livro cadastrado ainda.</div>';
        return;
      }
      
      let livros = [...database.livros];
      
      // Ordenar por avaliação, disponibilidade e ID
      livros.sort((a, b) => {
        const mediaA = a.avaliacoes.length ? 
          a.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / a.avaliacoes.length : 0;
        const mediaB = b.avaliacoes.length ? 
          b.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / b.avaliacoes.length : 0;
        
        if (mediaB !== mediaA) return mediaB - mediaA;
        if (b.disponivel !== a.disponivel) return b.disponivel - a.disponivel;
        return b.id - a.id;
      });
      
      livros = livros.slice(0, 5);
      
      container.innerHTML = livros.map(livro => {
        const media = livro.avaliacoes.length ? 
          (livro.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / livro.avaliacoes.length).toFixed(1) : 0;
        
        return `
          <div class="book-card rounded-lg p-4 text-center card-hover">
            <div class="w-16 h-20 mx-auto rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
              ${livro.foto ? 
                `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                '<span class="text-2xl text-white">📖</span>'
              }
            </div>
            <div class="mt-2 font-semibold text-sm truncate" title="${livro.titulo}">${livro.titulo}</div>
            <div class="text-xs text-gray-600 truncate" title="${livro.autor}">${livro.autor}</div>
            <div class="mt-1 text-xs ${livro.disponivel > 0 ? 'text-green-600' : 'text-red-600'}">
              ${livro.disponivel > 0 ? `${livro.disponivel} disponível` : 'Indisponível'}
            </div>
            <div class="text-xs text-gray-500">
              ${livro.avaliacoes.length ? `⭐ ${media} (${livro.avaliacoes.length})` : 'Sem avaliações'}
            </div>
          </div>
        `;
      }).join('');
    }

    function loadEmprestimosAluno() {
      const container = document.getElementById('emprestimosAluno');
      const emprestimos = database.emprestimos.filter(e => e.alunoId === currentUser.id);
      
      if (!emprestimos.length) {
        container.innerHTML = '<div class="text-gray-500 text-center">Você não possui livros emprestados.</div>';
        return;
      }
      
      container.innerHTML = emprestimos.map(emprestimo => {
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <div class="flex items-center justify-between p-3 border rounded-lg ${atrasado ? 'bg-red-50 border-red-200' : 'bg-white'}">
            <div>
              <div class="font-medium">${livro?.titulo || 'Livro'}</div>
              <div class="text-sm text-gray-600">${livro?.autor || ''}</div>
              <div class="text-xs ${atrasado ? 'text-red-600' : 'text-gray-500'}">
                Devolução: ${formatDate(emprestimo.dataDevolucao)} ${atrasado ? '(ATRASADO)' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== GERENCIAMENTO DE LIVROS =====
    function loadLivros() {
      const container = document.getElementById('livrosList');
      const search = document.getElementById('searchLivros').value.toLowerCase().trim();
      const categoria = document.getElementById('filterCategoria').value.trim();
      const autor = document.getElementById('filterAutor').value.trim();
      const disponibilidade = document.getElementById('filterDisponibilidade').value.trim();
      
      let livros = [...database.livros];
      
      // Aplicar filtros
      if (search) {
        livros = livros.filter(livro =>
          (livro.titulo || '').toLowerCase().includes(search) ||
          (livro.autor || '').toLowerCase().includes(search) ||
          (livro.descricao || '').toLowerCase().includes(search) ||
          (livro.categoria || '').toLowerCase().includes(search) ||
          (livro.subcategoria || '').toLowerCase().includes(search) ||
          (livro.editora || '').toLowerCase().includes(search)
        );
      }
      
      if (categoria) {
        livros = livros.filter(livro => (livro.categoria || '').trim() === categoria);
      }
      
      if (autor) {
        livros = livros.filter(livro => (livro.autor || '').trim() === autor);
      }
      
      if (disponibilidade === 'disponivel') {
        livros = livros.filter(livro => livro.disponivel > 0);
      } else if (disponibilidade === 'indisponivel') {
        livros = livros.filter(livro => livro.disponivel === 0);
      }
      
      const canEdit = currentUser && ['admin', 'professor', 'diretor', 'coordenador', 'ajudante'].includes(currentUser.tipo);
      
      container.innerHTML = livros.map(livro => {
        const media = livro.avaliacoes.length ? 
          (livro.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / livro.avaliacoes.length).toFixed(1) : 0;
        
        return `
          <div class="book-card rounded-xl p-5 card-hover">
            <div class="flex gap-4">
              <div class="w-20 h-28 flex-shrink-0 rounded bg-gradient-to-b from-amber-600 to-amber-800 flex items-center justify-center overflow-hidden">
                ${livro.foto ? 
                  `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                  '<span class="text-3xl text-white">📖</span>'
                }
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-bold text-lg truncate">${livro.titulo}</div>
                <div class="text-gray-600">${livro.autor}</div>
                <div class="text-sm text-gray-500">${livro.editora || 'Editora não informada'}</div>
                <div class="mt-2 text-sm flex gap-4">
                  <span>📚 ${livro.disponivel}/${livro.quantidade}</span>
                  <span>⭐ ${media} (${livro.avaliacoes.length})</span>
                  ${livro.localizacao ? `<span>📍 ${livro.localizacao}</span>` : ''}
                </div>
                <div class="mt-3 flex gap-2">
                  ${canEdit ? `
                    <button onclick="editLivro(${livro.id})" class="px-3 py-1 bg-amber-700 hover:bg-amber-800 text-white rounded text-sm">✏️ Editar</button>
                    <button onclick="deleteLivro(${livro.id})" class="px-3 py-1 bg-red-700 hover:bg-red-800 text-white rounded text-sm">🗑️ Excluir</button>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function loadFilterOptions() {
      const categorias = [...new Set(database.livros.map(l => l.categoria).filter(Boolean).map(c => c.trim()))].sort();
      const autores = [...new Set(database.livros.map(l => l.autor).filter(Boolean).map(a => a.trim()))].sort();
      
      const categoriaSelect = document.getElementById('filterCategoria');
      const autorSelect = document.getElementById('filterAutor');
      
      const currentCategoria = categoriaSelect.value;
      const currentAutor = autorSelect.value;
      
      categoriaSelect.innerHTML = '<option value="">Todas as categorias</option>' + 
        categorias.map(c => `<option ${c === currentCategoria ? 'selected' : ''}>${c}</option>`).join('');
      
      autorSelect.innerHTML = '<option value="">Todos os autores</option>' + 
        autores.map(a => `<option ${a === currentAutor ? 'selected' : ''}>${a}</option>`).join('');
    }

    function clearLivrosFilters() {
      document.getElementById('searchLivros').value = '';
      document.getElementById('filterCategoria').value = '';
      document.getElementById('filterAutor').value = '';
      document.getElementById('filterDisponibilidade').value = '';
      loadLivros();
    }

    // ===== CRUD LIVROS =====
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }

    function verificarLivroDuplicado(titulo, autor, codigo, ignoreId = null) {
      const tituloNorm = (titulo || '').toLowerCase().trim();
      const autorNorm = (autor || '').toLowerCase().trim();
      
      return database.livros.some(livro => {
        if (ignoreId && livro.id === ignoreId) return false;
        
        const sameTitleAuthor = (livro.titulo || '').toLowerCase().trim() === tituloNorm && 
                               (livro.autor || '').toLowerCase().trim() === autorNorm;
        
        const sameCode = codigo && livro.codigoBarra && 
                        (livro.codigoBarra + '').trim() === (codigo + '').trim();
        
        return sameTitleAuthor || sameCode;
      });
    }

    async function handleAddBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const titulo = formData.get('titulo');
      const autor = formData.get('autor');
      const codigo = formData.get('codigoBarra');
      
      if (verificarLivroDuplicado(titulo, autor, codigo)) {
        alert('Livro duplicado. Verifique título/autor/código.');
        return;
      }
      
      let foto = formData.get('foto') || '';
      const fotoFile = formData.get('fotoFile');
      
      if (fotoFile && fotoFile.size > 0) {
        try {
          foto = await fileToBase64(fotoFile);
        } catch (error) {
          console.error('Erro ao processar imagem:', error);
        }
      }
      
      const quantidade = parseInt(formData.get('quantidade'));
      
      const novoLivro = {
        id: database.nextId.livros++,
        titulo,
        autor,
        editora: formData.get('editora') || '',
        categoria: formData.get('categoria') || '',
        subcategoria: formData.get('subcategoria') || '',
        quantidade,
        disponivel: quantidade,
        descricao: formData.get('descricao') || '',
        foto,
        codigoBarra: codigo || '',
        localizacao: formData.get('localizacao') || '',
        avaliacoes: []
      };
      
      database.livros.push(novoLivro);
      saveDatabase();
      
      closeModal('addBookModal');
      event.target.reset();
      loadLivros();
      updateDashboard();
      
      alert('Livro adicionado com sucesso!');
    }

    async function handleEditBook(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const id = parseInt(formData.get('id'));
      const livro = database.livros.find(l => l.id === id);
      
      if (!livro) return;
      
      const titulo = formData.get('titulo');
      const autor = formData.get('autor');
      const codigo = formData.get('codigoBarra');
      
      if (verificarLivroDuplicado(titulo, autor, codigo, id)) {
        alert('Conflito com outro livro existente.');
        return;
      }
      
      const novaQuantidade = parseInt(formData.get('quantidade'));
      const diferenca = novaQuantidade - livro.quantidade;
      
      let foto = formData.get('foto') || livro.foto;
      const fotoFile = formData.get('fotoFile');
      
      if (fotoFile && fotoFile.size > 0) {
        try {
          foto = await fileToBase64(fotoFile);
        } catch (error) {
          console.error('Erro ao processar imagem:', error);
        }
      }
      
      // Atualizar livro
      livro.titulo = titulo;
      livro.autor = autor;
      livro.editora = formData.get('editora') || '';
      livro.categoria = formData.get('categoria') || '';
      livro.subcategoria = formData.get('subcategoria') || '';
      livro.quantidade = novaQuantidade;
      livro.disponivel = Math.max(0, livro.disponivel + diferenca);
      livro.descricao = formData.get('descricao') || '';
      livro.foto = foto;
      livro.codigoBarra = codigo || '';
      livro.localizacao = formData.get('localizacao') || '';
      
      saveDatabase();
      closeModal('editBookModal');
      loadLivros();
      updateDashboard();
      
      alert('Livro atualizado!');
    }

    function deleteLivro(id) {
      if (!confirm('Excluir este livro?')) return;
      
      const index = database.livros.findIndex(l => l.id === id);
      if (index >= 0) {
        database.livros.splice(index, 1);
        saveDatabase();
        loadLivros();
        updateDashboard();
      }
    }

    function editLivro(id) {
      const livro = database.livros.find(l => l.id === id);
      if (!livro) return;
      
      document.getElementById('editBookId').value = livro.id;
      document.getElementById('editBookTitulo').value = livro.titulo;
      document.getElementById('editBookCodigo').value = livro.codigoBarra || '';
      document.getElementById('editBookAutor').value = livro.autor;
      document.getElementById('editBookEditora').value = livro.editora || '';
      document.getElementById('editBookCategoria').value = livro.categoria || '';
      document.getElementById('editBookSubcategoria').value = livro.subcategoria || '';
      document.getElementById('editBookQuantidade').value = livro.quantidade;
      document.getElementById('editBookLocalizacao').value = livro.localizacao || '';
      document.getElementById('editBookDescricao').value = livro.descricao || '';
      document.getElementById('editBookFoto').value = livro.foto || '';
      
      showModal('editBookModal');
    }

    function importBooks() {
      const text = document.getElementById('importBooksText').value.trim();
      if (!text) {
        alert('Digite os dados dos livros para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      let errors = [];
      
      lines.forEach((line, index) => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length < 2) {
          errors.push(`Linha ${index + 1}: Formato inválido`);
          return;
        }
        
        const [titulo, autor, codigo = '', categoria = '', estoque = '1', local = '', quantidade = ''] = parts;
        
        if (!titulo || !autor) {
          errors.push(`Linha ${index + 1}: Título e autor são obrigatórios`);
          return;
        }
        
        if (verificarLivroDuplicado(titulo, autor, codigo)) {
          errors.push(`Linha ${index + 1}: Livro duplicado`);
          return;
        }
        
        const qtd = parseInt(quantidade || estoque || '1') || 1;
        
        database.livros.push({
          id: database.nextId.livros++,
          titulo,
          autor,
          editora: '',
          categoria,
          subcategoria: '',
          quantidade: qtd,
          disponivel: qtd,
          descricao: '',
          foto: '',
          codigoBarra: codigo,
          localizacao: local,
          avaliacoes: []
        });
        
        imported++;
      });
      
      if (imported > 0) {
        saveDatabase();
        loadLivros();
        updateDashboard();
      }
      
      closeModal('importBooksModal');
      document.getElementById('importBooksText').value = '';
      
      let message = `${imported} livro(s) importado(s) com sucesso!`;
      if (errors.length > 0) {
        message += `\n\nErros:\n${errors.join('\n')}`;
      }
      
      alert(message);
    }

    // ===== EMPRÉSTIMOS =====
    function showAddEmprestimoModal() {
      const alunoSelect = document.querySelector('#addEmprestimoModal select[name="aluno"]');
      const alunos = database.usuarios.filter(u => u.tipo === 'aluno' && u.status === 'ativo');
      
      alunoSelect.innerHTML = '<option value="">Selecione o aluno...</option>' + 
        alunos.map(aluno => `<option value="${aluno.id}">${aluno.nome} (${aluno.turma || 'Sem turma'})</option>`).join('');
      
      if (currentUser?.tipo === 'aluno') {
        alunoSelect.value = currentUser.id;
        alunoSelect.disabled = true;
        document.getElementById('alunoSelectDiv').style.display = 'none';
      } else {
        alunoSelect.disabled = false;
        document.getElementById('alunoSelectDiv').style.display = 'block';
      }
      
      const hoje = new Date();
      const dateInput = document.querySelector('#addEmprestimoModal input[name="dataDevolucao"]');
      dateInput.min = hoje.toISOString().split('T')[0];
      
      showModal('addEmprestimoModal');
    }

    function searchLivrosEmprestimo() {
      const query = document.getElementById('searchLivroEmprestimo').value.toLowerCase();
      const container = document.getElementById('livroSuggestions');
      
      if (query.length < 2) {
        container.classList.add('hidden');
        return;
      }
      
      const livros = database.livros.filter(l => 
        l.disponivel > 0 && (l.titulo || '').toLowerCase().includes(query)
      );
      
      if (!livros.length) {
        container.innerHTML = '<div class="p-3 text-gray-500">Nenhum livro encontrado</div>';
        container.classList.remove('hidden');
        return;
      }
      
      container.innerHTML = livros.map(livro => `
        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b" onclick="selectLivroEmprestimo(${livro.id})">
          <div class="font-medium">${livro.titulo}</div>
          <div class="text-sm text-gray-600">${livro.autor}</div>
          <div class="text-xs text-green-600">${livro.disponivel} disponível(is)</div>
        </div>
      `).join('');
      
      container.classList.remove('hidden');
    }

    function selectLivroEmprestimo(id) {
      const livro = database.livros.find(l => l.id === id);
      
      document.getElementById('livroId').value = id;
      document.getElementById('livroInfo').innerHTML = `
        <div class="font-medium">${livro.titulo}</div>
        <div class="text-sm text-gray-600">${livro.autor}</div>
        <div class="text-xs text-green-600">${livro.disponivel} disponível(is)</div>
      `;
      
      document.getElementById('livroSelecionado').classList.remove('hidden');
      document.getElementById('livroSuggestions').classList.add('hidden');
      document.getElementById('searchLivroEmprestimo').value = livro.titulo;
    }

    function handleAddEmprestimo(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const alunoId = parseInt(formData.get('aluno')) || currentUser.id;
      const livroId = parseInt(formData.get('livro'));
      const dataDevolucao = formData.get('dataDevolucao');
      
      if (!alunoId || !livroId || !dataDevolucao) {
        alert('Preencha todos os campos obrigatórios.');
        return;
      }
      
      const livro = database.livros.find(l => l.id === livroId);
      if (!livro || livro.disponivel <= 0) {
        alert('Livro indisponível.');
        return;
      }
      
      database.emprestimos.push({
        id: database.nextId.emprestimos++,
        alunoId,
        livroId,
        dataEmprestimo: new Date().toISOString().split('T')[0],
        dataDevolucao,
        status: 'ativo'
      });
      
      livro.disponivel--;
      
      saveDatabase();
      closeModal('addEmprestimoModal');
      event.target.reset();
      document.getElementById('livroSelecionado').classList.add('hidden');
      
      loadEmprestimos();
      updateDashboard();
      
      alert('Empréstimo criado com sucesso!');
    }

    function loadEmprestimos() {
      const container = document.getElementById('emprestimosList');
      let emprestimos = [...database.emprestimos];
      
      if (currentUser?.tipo === 'aluno') {
        emprestimos = emprestimos.filter(e => e.alunoId === currentUser.id);
      }
      
      const search = document.getElementById('searchEmprestimos').value.toLowerCase().trim();
      const dataInicio = document.getElementById('filterDataInicio').value.trim();
      const dataFim = document.getElementById('filterDataFim').value.trim();
      const turma = document.getElementById('filterTurma').value.trim();
      
      if (search) {
        emprestimos = emprestimos.filter(emprestimo => {
          const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
          const livro = database.livros.find(l => l.id === emprestimo.livroId);
          
          return (aluno?.nome || '').toLowerCase().includes(search) ||
                 (aluno?.turma || '').toLowerCase().includes(search) ||
                 (livro?.titulo || '').toLowerCase().includes(search) ||
                 (livro?.autor || '').toLowerCase().includes(search);
        });
      }
      
      if (dataInicio) {
        emprestimos = emprestimos.filter(e => e.dataEmprestimo >= dataInicio);
      }
      
      if (dataFim) {
        emprestimos = emprestimos.filter(e => e.dataEmprestimo <= dataFim);
      }
      
      if (turma) {
        emprestimos = emprestimos.filter(e => {
          const aluno = database.usuarios.find(u => u.id === e.alunoId);
          return (aluno?.turma || '').trim() === turma;
        });
      }
      
      container.innerHTML = emprestimos.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const atrasado = emprestimo.status === 'ativo' && new Date(emprestimo.dataDevolucao) < new Date();
        
        return `
          <tr class="${atrasado ? 'bg-red-50' : ''}">
            <td class="px-6 py-3 text-sm">
              ${aluno ? aluno.nome : '-'}
              ${aluno?.turma ? `<br><span class="text-xs text-gray-500">${aluno.turma}</span>` : ''}
            </td>
            <td class="px-6 py-3 text-sm">
              ${livro ? livro.titulo : '-'}
              ${livro ? `<br><span class="text-xs text-gray-500">${livro.autor}</span>` : ''}
            </td>
            <td class="px-6 py-3 text-sm">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-3 text-sm">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                emprestimo.status === 'ativo' ? 
                  (atrasado ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700') : 
                  'bg-green-100 text-green-700'
              }">
                ${emprestimo.status === 'ativo' ? (atrasado ? 'Atrasado' : 'Ativo') : 'Devolvido'}
              </span>
            </td>
            <td class="px-6 py-3 text-sm">
              ${emprestimo.status === 'ativo' ? 
                `<button onclick="devolverLivro(${emprestimo.id})" class="text-green-700 hover:underline">✅ Devolver</button>` : 
                ''
              }
              ${['admin', 'professor', 'diretor', 'coordenador', 'ajudante'].includes(currentUser?.tipo || '') ? 
                `<button onclick="deleteEmprestimo(${emprestimo.id})" class="text-red-700 hover:underline ml-2">🗑️</button>` : 
                ''
              }
            </td>
          </tr>
        `;
      }).join('');
    }

    function devolverLivro(id) {
      const emprestimo = database.emprestimos.find(e => e.id === id);
      if (!emprestimo) return;
      
      const livro = database.livros.find(l => l.id === emprestimo.livroId);
      const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
      
      emprestimo.status = 'devolvido';
      emprestimo.dataRealDevolucao = new Date().toISOString().split('T')[0];
      
      if (livro) livro.disponivel++;
      if (aluno) aluno.livrosLidos = (aluno.livrosLidos || 0) + 1;
      
      saveDatabase();
      loadEmprestimos();
      loadDevolucoesPendentes();
      updateDashboard();
      
      alert('Livro devolvido com sucesso!');
    }

    function deleteEmprestimo(id) {
      if (!confirm('Excluir este empréstimo?')) return;
      
      const index = database.emprestimos.findIndex(e => e.id === id);
      if (index < 0) return;
      
      const emprestimo = database.emprestimos[index];
      
      if (emprestimo.status === 'ativo') {
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        if (livro) livro.disponivel++;
      } else if (emprestimo.status === 'devolvido') {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        if (aluno && aluno.livrosLidos > 0) aluno.livrosLidos--;
      }
      
      database.emprestimos.splice(index, 1);
      saveDatabase();
      loadEmprestimos();
      updateDashboard();
    }

    function loadDevolucoesPendentes() {
      const hoje = new Date();
      let pendentes = database.emprestimos.filter(e => 
        e.status === 'ativo' && new Date(e.dataDevolucao) < hoje
      );
      
      if (currentUser?.tipo === 'aluno') {
        pendentes = pendentes.filter(e => e.alunoId === currentUser.id);
      }
      
      const container = document.getElementById('devolucoesList');
      
      container.innerHTML = pendentes.map(emprestimo => {
        const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
        const livro = database.livros.find(l => l.id === emprestimo.livroId);
        const diasAtraso = Math.max(0, Math.floor((hoje - new Date(emprestimo.dataDevolucao)) / 86400000));
        
        return `
          <tr class="bg-red-50">
            <td class="px-6 py-3 text-sm">
              ${aluno ? aluno.nome : '-'}
              ${aluno?.turma ? `<br><span class="text-xs text-gray-500">${aluno.turma}</span>` : ''}
            </td>
            <td class="px-6 py-3 text-sm">
              ${livro ? livro.titulo : '-'}
              ${livro ? `<br><span class="text-xs text-gray-500">${livro.autor}</span>` : ''}
            </td>
            <td class="px-6 py-3 text-sm">${formatDate(emprestimo.dataEmprestimo)}</td>
            <td class="px-6 py-3 text-sm">${formatDate(emprestimo.dataDevolucao)}</td>
            <td class="px-6 py-3 text-sm font-bold text-red-700">${diasAtraso} dia(s)</td>
            <td class="px-6 py-3 text-sm">
              <button onclick="devolverLivro(${emprestimo.id})" class="text-green-700 hover:underline">✅ Devolver</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function loadTurmasFilter() {
      const turmas = [...new Set(database.usuarios
        .filter(u => u.turma && u.turma.trim() !== '')
        .map(u => u.turma.trim())
      )].sort();
      
      const select = document.getElementById('filterTurma');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="">Todas as turmas</option>' + 
        turmas.map(t => `<option ${t === currentValue ? 'selected' : ''}>${t}</option>`).join('');
    }

    function clearEmprestimosFilters() {
      document.getElementById('searchEmprestimos').value = '';
      document.getElementById('filterDataInicio').value = '';
      document.getElementById('filterDataFim').value = '';
      document.getElementById('filterTurma').value = '';
      loadEmprestimos();
    }

    // ===== USUÁRIOS =====
    function loadUsuarios() {
      const search = document.getElementById('searchUsuarios').value.toLowerCase();
      const tipo = document.getElementById('filterTipoUsuario').value;
      const status = document.getElementById('filterStatusUsuario').value;
      
      let usuarios = [...database.usuarios];
      
      if (search) {
        usuarios = usuarios.filter(u => 
          (u.nome || '').toLowerCase().includes(search) || 
          (u.login || '').toLowerCase().includes(search)
        );
      }
      
      if (tipo) {
        usuarios = usuarios.filter(u => u.tipo === tipo);
      }
      
      if (status) {
        usuarios = usuarios.filter(u => u.status === status);
      }
      
      const canDelete = currentUser?.tipo === 'admin';
      const container = document.getElementById('usuariosList');
      
      container.innerHTML = usuarios.map(usuario => {
        const canEdit = currentUser?.tipo === 'admin' || 
          (currentUser?.login !== usuario.login && usuario.login !== 'ADMIN');
        
        return `
          <tr>
            <td class="px-6 py-3">${usuario.nome}</td>
            <td class="px-6 py-3">${usuario.login}</td>
            <td class="px-6 py-3">${usuario.tipo}</td>
            <td class="px-6 py-3">${usuario.turma || '-'}</td>
            <td class="px-6 py-3">${usuario.livrosLidos || 0}</td>
            <td class="px-6 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                usuario.status === 'ativo' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
              }">
                ${usuario.status}
              </span>
            </td>
            <td class="px-6 py-3 text-sm">
              ${canEdit ? `<button onclick="editUsuario(${usuario.id})" class="text-orange-700 hover:underline">✏️</button>` : ''}
              ${usuario.login !== 'ADMIN' ? `
                <button onclick="toggleUsuarioStatus(${usuario.id})" class="ml-2 ${
                  usuario.status === 'ativo' ? 'text-red-700' : 'text-green-700'
                } hover:underline">
                  ${usuario.status === 'ativo' ? '🚫' : '✅'}
                </button>
              ` : ''}
              ${canDelete && usuario.login !== 'ADMIN' ? `
                <button onclick="deleteUsuario(${usuario.id})" class="ml-2 text-red-700 hover:underline">🗑️</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    function handleAddUser(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const login = (formData.get('login') || '').trim();
      
      if (database.usuarios.some(u => (u.login || '').toLowerCase() === login.toLowerCase())) {
        alert('Este login já está em uso.');
        return;
      }
      
      const novoUsuario = {
        id: database.nextId.usuarios++,
        nome: formData.get('nome'),
        login,
        senha: formData.get('senha'),
        tipo: formData.get('tipo'),
        turma: formData.get('turma') || '',
        status: 'ativo',
        livrosLidos: 0
      };
      
      database.usuarios.push(novoUsuario);
      saveDatabase();
      
      closeModal('addUserModal');
      event.target.reset();
      loadUsuarios();
      updateDashboard();
      
      alert('Usuário adicionado com sucesso!');
    }

    function editUsuario(id) {
      // Implementar edição de usuário
      alert('Funcionalidade de edição em desenvolvimento');
    }

    function toggleTurmaField(select) {
      const turmaField = document.getElementById('turmaField');
      if (select.value === 'aluno') {
        turmaField.classList.remove('hidden');
        turmaField.querySelector('select').required = true;
      } else {
        turmaField.classList.add('hidden');
        turmaField.querySelector('select').required = false;
      }
    }

    function toggleUsuarioStatus(id) {
      const usuario = database.usuarios.find(u => u.id === id);
      if (!usuario) return;
      
      usuario.status = usuario.status === 'ativo' ? 'bloqueado' : 'ativo';
      saveDatabase();
      loadUsuarios();
      updateDashboard();
    }

    function deleteUsuario(id) {
      if (!confirm('Excluir este usuário?')) return;
      
      const index = database.usuarios.findIndex(u => u.id === id);
      if (index >= 0) {
        database.usuarios.splice(index, 1);
        saveDatabase();
        loadUsuarios();
        updateDashboard();
      }
    }

    function importUsers() {
      const text = document.getElementById('importUsersText').value.trim();
      if (!text) {
        alert('Digite os dados dos usuários para importar.');
        return;
      }
      
      const lines = text.split('\n').filter(line => line.trim());
      let imported = 0;
      let errors = [];
      
      lines.forEach((line, index) => {
        const parts = line.split('|').map(p => p.trim());
        
        if (parts.length < 4) {
          errors.push(`Linha ${index + 1}: Formato inválido`);
          return;
        }
        
        const [nome, login, senha, tipo, turma = ''] = parts;
        
        if (!nome || !login || !senha || !tipo) {
          errors.push(`Linha ${index + 1}: Campos obrigatórios em falta`);
          return;
        }
        
        if (database.usuarios.some(u => (u.login || '').toLowerCase() === login.toLowerCase())) {
          errors.push(`Linha ${index + 1}: Login já existe`);
          return;
        }
        
        database.usuarios.push({
          id: database.nextId.usuarios++,
          nome,
          login,
          senha,
          tipo,
          turma,
          status: 'ativo',
          livrosLidos: 0
        });
        
        imported++;
      });
      
      if (imported > 0) {
        saveDatabase();
        loadUsuarios();
        updateDashboard();
      }
      
      closeModal('importUsersModal');
      document.getElementById('importUsersText').value = '';
      
      let message = `${imported} usuário(s) importado(s) com sucesso!`;
      if (errors.length > 0) {
        message += `\n\nErros:\n${errors.join('\n')}`;
      }
      
      alert(message);
    }

    // ===== FUNCIONALIDADES ADMIN =====
    function exportarBackup() {
      const data = JSON.stringify(database, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `biblion-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
    }

    function copiarBackup() {
      const data = JSON.stringify(database, null, 2);
      navigator.clipboard.writeText(data).then(() => {
        alert('Dados copiados para a área de transferência!');
      }).catch(() => {
        alert('Erro ao copiar dados.');
      });
    }

    function restaurarBackup() {
      const file = document.getElementById('backupFile').files[0];
      const text = document.getElementById('backupText').value.trim();
      
      if (!file && !text) {
        alert('Selecione um arquivo ou cole os dados do backup.');
        return;
      }
      
      if (!confirm('ATENÇÃO: Isso substituirá TODOS os dados atuais. Continuar?')) {
        return;
      }
      
      const processBackup = (data) => {
        try {
          const parsed = JSON.parse(data);
          
          if (!parsed.usuarios || !parsed.livros || !parsed.emprestimos) {
            throw new Error('Formato de backup inválido');
          }
          
          database = parsed;
          saveDatabase();
          
          alert('Backup restaurado com sucesso!');
          closeModal('backupModal');
          updateDashboard();
          
        } catch (error) {
          alert('Erro ao restaurar backup: ' + error.message);
        }
      };
      
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => processBackup(e.target.result);
        reader.readAsText(file);
      } else {
        processBackup(text);
      }
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
      initializeDatabase();
      
      // Login
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      
      // Toggle senha
      document.getElementById('togglePwd').addEventListener('click', function() {
        const input = document.getElementById('loginPassword');
        const btn = this;
        
        if (input.type === 'password') {
          input.type = 'text';
          btn.textContent = 'Ocultar';
        } else {
          input.type = 'password';
          btn.textContent = 'Mostrar';
        }
      });
      
      // Forms
      document.getElementById('addBookForm').addEventListener('submit', handleAddBook);
      document.getElementById('editBookForm').addEventListener('submit', handleEditBook);
      document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
      document.getElementById('addEmprestimoForm').addEventListener('submit', handleAddEmprestimo);
      
      // Busca de livros para empréstimo
      document.getElementById('searchLivroEmprestimo').addEventListener('input', searchLivrosEmprestimo);
      
      // Filtros
      document.getElementById('searchLivros').addEventListener('input', loadLivros);
      document.getElementById('filterCategoria').addEventListener('change', loadLivros);
      document.getElementById('filterAutor').addEventListener('change', loadLivros);
      document.getElementById('filterDisponibilidade').addEventListener('change', loadLivros);
      
      document.getElementById('searchEmprestimos').addEventListener('input', loadEmprestimos);
      document.getElementById('filterDataInicio').addEventListener('change', loadEmprestimos);
      document.getElementById('filterDataFim').addEventListener('change', loadEmprestimos);
      document.getElementById('filterTurma').addEventListener('change', loadEmprestimos);
      
      document.getElementById('searchUsuarios').addEventListener('input', loadUsuarios);
      document.getElementById('filterTipoUsuario').addEventListener('change', loadUsuarios);
      document.getElementById('filterStatusUsuario').addEventListener('change', loadUsuarios);
      
      // Botões do header
      document.getElementById('trocarSenhaBtn').addEventListener('click', () => showModal('trocarSenhaModal'));
      document.getElementById('backupBtn').addEventListener('click', () => {
        // Atualizar estatísticas do backup
        document.getElementById('backupStatsLivros').textContent = database.livros.length;
        document.getElementById('backupStatsUsuarios').textContent = database.usuarios.length;
        document.getElementById('backupStatsEmprestimos').textContent = database.emprestimos.length;
        document.getElementById('backupStatsAvaliacoes').textContent = 
          database.livros.reduce((total, livro) => total + (livro.avaliacoes?.length || 0), 0);
        
        showModal('backupModal');
      });
      
      // Limpar biblioteca
      document.getElementById('clearLibraryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const senha = document.getElementById('adminPasswordConfirm').value;
        const confirmado = document.getElementById('confirmClear').checked;
        
        if (!confirmado) {
          alert('Você deve confirmar que entende o risco.');
          return;
        }
        
        if (senha !== currentUser.senha) {
          alert('Senha incorreta.');
          return;
        }
        
        database.livros = [];
        database.emprestimos = [];
        database.nextId.livros = 1;
        database.nextId.emprestimos = 1;
        
        saveDatabase();
        closeModal('clearLibraryModal');
        
        alert('Biblioteca limpa com sucesso!');
        updateDashboard();
        loadLivros();
      });
      
      // Atualizar estatísticas ao abrir modal de limpar
      document.getElementById('clearLibraryBtn').addEventListener('click', function() {
        document.getElementById('statLivros').textContent = database.livros.length;
        document.getElementById('statEmpAtivos').textContent = 
          database.emprestimos.filter(e => e.status === 'ativo').length;
      });

      // Trocar senha
      document.getElementById('trocarSenhaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const senhaAtual = document.getElementById('senhaAtual').value;
        const novaSenha = document.getElementById('novaSenha').value;
        const confirmarSenha = document.getElementById('confirmarNovaSenha').value;
        
        if (senhaAtual !== currentUser.senha) {
          alert('Senha atual incorreta.');
          return;
        }
        
        if (novaSenha !== confirmarSenha) {
          alert('As senhas não coincidem.');
          return;
        }
        
        if (novaSenha.length < 4) {
          alert('A nova senha deve ter pelo menos 4 caracteres.');
          return;
        }
        
        // Atualizar senha no banco
        const userIndex = database.usuarios.findIndex(u => u.id === currentUser.id);
        if (userIndex >= 0) {
          database.usuarios[userIndex].senha = novaSenha;
          currentUser.senha = novaSenha;
          saveDatabase();
          
          closeModal('trocarSenhaModal');
          e.target.reset();
          alert('Senha alterada com sucesso!');
        }
      });
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9886fddbf1ceca1c',t:'MTc1OTQzNzM4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
