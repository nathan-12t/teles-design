<index.html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BibliOn - Sistema de Biblioteca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #d2691e 0%, #a0522d 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .emoji-3d {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2));
        }
        
        .book-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 1px solid #e0e0e0;
        }
        
        .transition-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #d2691e 0%, #a0522d 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }
        
        .transition-screen.active {
            opacity: 1;
            visibility: visible;
        }
        
        .logo-animation {
            animation: logoFloat 2s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .nav-btn.active {
            border-color: #d2691e !important;
            color: #d2691e !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Tela de Transi√ß√£o -->
    <div id="transitionScreen" class="transition-screen">
        <div class="text-center">
            <div class="logo-animation mb-6">
                <h1 class="text-6xl font-bold text-white mb-2">üìö BibliOn</h1>
                <div class="w-24 h-1 bg-white mx-auto rounded-full"></div>
            </div>
            <div class="bounce-in">
                <p class="text-xl text-white mb-2">Sistema de Biblioteca</p>
                <p class="text-sm text-orange-200">Criado por Nathannael Teles ¬∑ Teles Design</p>
            </div>
            <div class="mt-8">
                <div class="loading-spinner w-8 h-8 border-4 border-white border-t-transparent rounded-full mx-auto"></div>
            </div>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">üìö BibliOn</h1>
                <p class="text-gray-600">Sistema de Gerenciamento de Biblioteca</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio</label>
                    <input type="text" id="loginUser" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Digite seu usu√°rio" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Digite sua senha" required>
                </div>
                
                <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 transition-colors font-medium">
                    Entrar
                </button>
            </form>
            
            <div class="mt-8 text-center text-sm text-gray-500">
                Criado por Nathannael Teles ¬∑ Teles Design
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-3xl emoji-3d">üìö</span>
                        <h1 class="text-2xl font-bold">BibliOn</h1>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span id="userWelcome" class="text-sm"></span>
                        <button id="trocarSenhaBtn" onclick="showTrocarSenhaModal()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-colors" style="display: none;">
                            <span class="emoji-3d">üîë</span> Trocar Senha
                        </button>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-md">
            <div class="container mx-auto px-4">
                <div class="flex space-x-8">
                    <button onclick="showTab('inicio')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-orange-600 transition-colors active">
                        <span class="emoji-3d">üè†</span> In√≠cio
                    </button>
                    <button onclick="showTab('livros')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-orange-600 transition-colors">
                        <span class="emoji-3d">üìñ</span> Livros
                    </button>
                    <button onclick="showTab('emprestimos')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-orange-600 transition-colors">
                        <span class="emoji-3d">üìã</span> Empr√©stimos
                    </button>
                    <button onclick="showTab('devolucoes')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-orange-600 transition-colors">
                        <span class="emoji-3d">‚è∞</span> Devolu√ß√µes Pendentes
                    </button>
                    <button id="usuariosTabBtn" onclick="showTab('usuarios')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-orange-600 transition-colors">
                        <span class="emoji-3d">üë•</span> Usu√°rios
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="container mx-auto px-4 py-8">
            <!-- In√≠cio Tab -->
            <div id="inicioTab" class="tab-content">
                <div class="fade-in">
                    <h2 class="text-3xl font-bold text-gray-800 mb-8">Painel de Controle</h2>
                    
                    <!-- Dashboard Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div onclick="showTab('livros')" class="card-hover bg-white rounded-xl shadow-lg p-6 cursor-pointer">
                            <div class="flex items-center">
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <span class="text-2xl emoji-3d">üìö</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Total de Livros</p>
                                    <p id="totalLivros" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div onclick="showTab('emprestimos')" class="card-hover bg-white rounded-xl shadow-lg p-6 cursor-pointer">
                            <div class="flex items-center">
                                <div class="bg-green-100 p-3 rounded-full">
                                    <span class="text-2xl emoji-3d">üìã</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Empr√©stimos Ativos</p>
                                    <p id="totalEmprestimos" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div onclick="showTab('devolucoes')" class="card-hover bg-white rounded-xl shadow-lg p-6 cursor-pointer">
                            <div class="flex items-center">
                                <div class="bg-red-100 p-3 rounded-full">
                                    <span class="text-2xl emoji-3d">‚è∞</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Devolu√ß√µes Pendentes</p>
                                    <p id="totalPendentes" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="usuariosCard" onclick="showTab('usuarios')" class="card-hover bg-white rounded-xl shadow-lg p-6 cursor-pointer">
                            <div class="flex items-center">
                                <div class="bg-purple-100 p-3 rounded-full">
                                    <span class="text-2xl emoji-3d">üë•</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Usu√°rios Ativos</p>
                                    <p id="totalUsuarios" class="text-2xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exposi√ß√£o de Livros -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <span class="emoji-3d">‚≠ê</span> Livros em Destaque
                        </h3>
                        <div id="livrosDestaque" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <!-- Livros ser√£o carregados aqui -->
                        </div>
                    </div>

                    <!-- Meus Empr√©stimos (para alunos) -->
                    <div id="meusEmprestimos" class="bg-white rounded-xl shadow-lg p-6" style="display: none;">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <span class="emoji-3d">üìñ</span> Meus Livros Emprestados
                        </h3>
                        <div id="emprestimosAluno" class="space-y-4">
                            <!-- Empr√©stimos do aluno ser√£o carregados aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Livros Tab -->
            <div id="livrosTab" class="tab-content hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Gerenciar Livros</h2>
                        <div class="space-x-2" id="livrosActions">
                            <button onclick="showAddBookModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                                <span class="emoji-3d">‚ûï</span> Adicionar Livro
                            </button>
                            <button onclick="showImportBooksModal()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <span class="emoji-3d">üìÑ</span> Importar Livros
                            </button>
                            <button id="clearLibraryBtn" onclick="showClearLibraryModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors" style="display: none;">
                                <span class="emoji-3d">üóëÔ∏è</span> Limpar Biblioteca
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">üîç Filtros de Busca</h3>
                            <button onclick="clearLivrosFilters()" class="text-sm text-orange-600 hover:text-orange-800 underline">
                                Limpar Filtros
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="searchLivros" placeholder="Buscar por t√≠tulo, autor, categoria..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <select id="filterCategoria" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Todas as categorias</option>
                            </select>
                            <select id="filterAutor" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Todos os autores</option>
                            </select>
                            <select id="filterDisponibilidade" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Todos</option>
                                <option value="disponivel">Dispon√≠vel</option>
                                <option value="indisponivel">Indispon√≠vel</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lista de Livros -->
                    <div id="livrosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Livros ser√£o carregados aqui -->
                    </div>
                </div>
            </div>

            <!-- Empr√©stimos Tab -->
            <div id="emprestimosTab" class="tab-content hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Gerenciar Empr√©stimos</h2>
                        <button id="addEmprestimoBtn" onclick="showAddEmprestimoModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <span class="emoji-3d">‚ûï</span> Novo Empr√©stimo
                        </button>
                    </div>
                    
                    <!-- Filtros de Empr√©stimos -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">üîç Filtros de Empr√©stimos</h3>
                            <button onclick="clearEmprestimosFilters()" class="text-sm text-orange-600 hover:text-orange-800 underline">
                                Limpar Filtros
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="searchEmprestimos" placeholder="Buscar por aluno, livro, turma..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <input type="date" id="filterDataInicio" placeholder="Data in√≠cio" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <input type="date" id="filterDataFim" placeholder="Data fim" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <select id="filterTurma" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Todas as turmas</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lista de Empr√©stimos -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Livro</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Empr√©stimo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Devolu√ß√£o</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="emprestimosList" class="bg-white divide-y divide-gray-200">
                                    <!-- Empr√©stimos ser√£o carregados aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Devolu√ß√µes Pendentes Tab -->
            <div id="devolucoesTab" class="tab-content hidden">
                <div class="fade-in">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Devolu√ß√µes Pendentes</h2>
                    
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-red-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Aluno</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Livro</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Data Empr√©stimo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Data Prevista</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Dias Atraso</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="devolucoesList" class="bg-white divide-y divide-gray-200">
                                    <!-- Devolu√ß√µes pendentes ser√£o carregadas aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usu√°rios Tab -->
            <div id="usuariosTab" class="tab-content hidden">
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Gerenciar Usu√°rios</h2>
                        <div class="space-x-2">
                            <button onclick="showAddUserModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                                <span class="emoji-3d">‚ûï</span> Adicionar Usu√°rio
                            </button>
                            <button onclick="showImportUsersModal()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <span class="emoji-3d">üìÑ</span> Importar Usu√°rios
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="searchUsuarios" placeholder="Buscar usu√°rios..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <select id="filterTipoUsuario" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Todos os tipos</option>
                                <option value="aluno">Aluno</option>
                                <option value="professor">Professor</option>
                                <option value="diretor">Diretor</option>
                                <option value="coordenador">Coordenador</option>
                                <option value="ajudante">Ajudante</option>
                                <option value="admin">Admin</option>
                            </select>
                            <select id="filterStatusUsuario" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Todos</option>
                                <option value="ativo">Ativo</option>
                                <option value="bloqueado">Bloqueado</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lista de Usu√°rios -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Login</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Turma</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Livros Lidos</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="usuariosList" class="bg-white divide-y divide-gray-200">
                                    <!-- Usu√°rios ser√£o carregados aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-12">
            <div class="container mx-auto px-4 text-center">
                <p>Criado por Nathannael Teles ¬∑ Teles Design</p>
            </div>
        </footer>
    </div>

    <!-- Modais -->
    
    <!-- Modal Adicionar Livro -->
    <div id="addBookModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-screen overflow-y-auto m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Adicionar Novo Livro</h3>
                <button onclick="closeModal('addBookModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <form id="addBookForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo *</label>
                        <input type="text" name="titulo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo de Barra</label>
                        <input type="text" name="codigoBarra" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Autor *</label>
                        <input type="text" name="autor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Editora</label>
                        <input type="text" name="editora" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <input type="text" name="categoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Subcategoria</label>
                        <input type="text" name="subcategoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade *</label>
                        <input type="number" name="quantidade" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Localiza√ß√£o</label>
                        <input type="text" name="localizacao" placeholder="Ex: Corredor A, Pr√©dio 1, Casa 15" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                    <textarea name="descricao" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Foto do Livro</label>
                    <div class="space-y-2">
                        <input type="file" name="fotoFile" accept="image/png,image/jpg,image/jpeg" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <p class="text-xs text-gray-500">ou</p>
                        <input type="url" name="foto" placeholder="URL da imagem" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="closeModal('addBookModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                        Adicionar Livro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Importar Livros -->
    <div id="importBooksModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Importar Livros</h3>
                <button onclick="closeModal('importBooksModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">Formato de Importa√ß√£o:</h4>
                    <p class="text-sm text-blue-700 mb-2"><strong>Obrigat√≥rio:</strong> T√≠tulo | Autor</p>
                    <p class="text-sm text-blue-700"><strong>Opcional:</strong> T√≠tulo | Autor | C√≥digo | Categoria | Estoque | Local | Quantidade</p>
                </div>
                <textarea id="importBooksText" rows="10" placeholder="Exemplos:&#10;Dom Casmurro | Machado de Assis&#10;O Corti√ßo | Alu√≠sio Azevedo | 123456 | Literatura | 5 | Corredor A | 3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea></div>
                
                <div class="flex justify-end space-x-2">
                    <button onclick="closeModal('importBooksModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button onclick="importBooks()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                        Importar Livros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Usu√°rio -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Adicionar Novo Usu√°rio</h3>
                <button onclick="closeModal('addUserModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                    <input type="text" name="nome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Login *</label>
                    <input type="text" name="login" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha *</label>
                    <input type="password" name="senha" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Usu√°rio *</label>
                    <select name="tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" onchange="toggleTurmaField(this)">
                        <option value="">Selecione...</option>
                        <option value="aluno">Aluno</option>
                        <option value="professor">Professor</option>
                        <option value="diretor">Diretor</option>
                        <option value="coordenador">Coordenador</option>
                        <option value="ajudante">Ajudante</option>
                    </select>
                </div>
                
                <div id="turmaField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Turma</label>
                    <select name="turma" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="">Selecione a turma...</option>
                        <option value="1A">1¬∫ A</option>
                        <option value="1B">1¬∫ B</option>
                        <option value="1C">1¬∫ C</option>
                        <option value="1D">1¬∫ D</option>
                        <option value="1E">1¬∫ E</option>
                        <option value="2A">2¬∫ A</option>
                        <option value="2B">2¬∫ B</option>
                        <option value="2C">2¬∫ C</option>
                        <option value="2D">2¬∫ D</option>
                        <option value="2E">2¬∫ E</option>
                        <option value="3A">3¬∫ A</option>
                        <option value="3B">3¬∫ B</option>
                        <option value="3C">3¬∫ C</option>
                        <option value="3D">3¬∫ D</option>
                        <option value="3E">3¬∫ E</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="closeModal('addUserModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                        Adicionar Usu√°rio
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Importar Usu√°rios -->
    <div id="importUsersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Importar Usu√°rios</h3>
                <button onclick="closeModal('importUsersModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <p class="text-gray-600">Cole o texto com os usu√°rios no formato: Nome | Login | Senha | Tipo | Turma (um por linha)</p>
                <textarea id="importUsersText" rows="10" placeholder="Exemplo:&#10;Jo√£o Silva | joao123 | senha123 | aluno | 3A&#10;Maria Santos | maria456 | senha456 | professor |" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea>
                
                <div class="flex justify-end space-x-2">
                    <button onclick="closeModal('importUsersModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button onclick="importUsers()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                        Importar Usu√°rios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Empr√©stimo -->
    <div id="addEmprestimoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Novo Empr√©stimo</h3>
                <button onclick="closeModal('addEmprestimoModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <form id="addEmprestimoForm" class="space-y-4">
                <div id="alunoSelectDiv">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Aluno *</label>
                    <select name="aluno" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="">Selecione o aluno...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Buscar Livro *</label>
                    <input type="text" id="searchLivroEmprestimo" placeholder="Digite o t√≠tulo do livro..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    <div id="livroSuggestions" class="mt-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg hidden"></div>
                </div>
                
                <div id="livroSelecionado" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Livro Selecionado</label>
                    <div id="livroInfo" class="p-3 bg-gray-50 rounded-lg"></div>
                    <input type="hidden" name="livro" id="livroId">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data de Devolu√ß√£o *</label>
                    <input type="date" name="dataDevolucao" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="closeModal('addEmprestimoModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                        Criar Empr√©stimo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Livro -->
    <div id="editBookModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-screen overflow-y-auto m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Editar Livro</h3>
                <button onclick="closeModal('editBookModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <form id="editBookForm" class="space-y-4">
                <input type="hidden" name="id" id="editBookId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo *</label>
                        <input type="text" name="titulo" id="editBookTitulo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo de Barra</label>
                        <input type="text" name="codigoBarra" id="editBookCodigo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Autor *</label>
                        <input type="text" name="autor" id="editBookAutor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Editora</label>
                        <input type="text" name="editora" id="editBookEditora" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <input type="text" name="categoria" id="editBookCategoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Subcategoria</label>
                        <input type="text" name="subcategoria" id="editBookSubcategoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade *</label>
                        <input type="number" name="quantidade" id="editBookQuantidade" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Localiza√ß√£o</label>
                        <input type="text" name="localizacao" id="editBookLocalizacao" placeholder="Ex: Corredor A, Pr√©dio 1, Casa 15" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                    <textarea name="descricao" id="editBookDescricao" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Foto do Livro</label>
                    <div class="space-y-2">
                        <input type="file" name="fotoFile" accept="image/png,image/jpg,image/jpeg" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <p class="text-xs text-gray-500">ou</p>
                        <input type="url" name="foto" id="editBookFoto" placeholder="URL da imagem" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="closeModal('editBookModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Usu√°rio -->
    <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Editar Usu√°rio</h3>
                <button onclick="closeModal('editUserModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <form id="editUserForm" class="space-y-4">
                <input type="hidden" name="id" id="editUserId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                    <input type="text" name="nome" id="editUserNome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Login *</label>
                    <input type="text" name="login" id="editUserLogin" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nova Senha (deixe em branco para manter a atual)</label>
                    <input type="password" name="senha" id="editUserSenha" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Usu√°rio *</label>
                    <select name="tipo" id="editUserTipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" onchange="toggleEditTurmaField(this)">
                        <option value="">Selecione...</option>
                        <option value="aluno">Aluno</option>
                        <option value="professor">Professor</option>
                        <option value="diretor">Diretor</option>
                        <option value="coordenador">Coordenador</option>
                        <option value="ajudante">Ajudante</option>
                    </select>
                </div>
                
                <div id="editTurmaField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Turma</label>
                    <select name="turma" id="editUserTurma" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="">Selecione a turma...</option>
                        <option value="1A">1¬∫ A</option>
                        <option value="1B">1¬∫ B</option>
                        <option value="1C">1¬∫ C</option>
                        <option value="1D">1¬∫ D</option>
                        <option value="1E">1¬∫ E</option>
                        <option value="2A">2¬∫ A</option>
                        <option value="2B">2¬∫ B</option>
                        <option value="2C">2¬∫ C</option>
                        <option value="2D">2¬∫ D</option>
                        <option value="2E">2¬∫ E</option>
                        <option value="3A">3¬∫ A</option>
                        <option value="3B">3¬∫ B</option>
                        <option value="3C">3¬∫ C</option>
                        <option value="3D">3¬∫ D</option>
                        <option value="3E">3¬∫ E</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="closeModal('editUserModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Limpar Biblioteca -->
    <div id="clearLibraryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-red-600">‚ö†Ô∏è Limpar Biblioteca</h3>
                <button onclick="closeModal('clearLibraryModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl emoji-3d mr-2">üö®</span>
                        <h4 class="font-bold text-red-800">ATEN√á√ÉO: A√á√ÉO IRREVERS√çVEL!</h4>
                    </div>
                    <p class="text-red-700 text-sm">
                        Esta a√ß√£o ir√° <strong>APAGAR TODOS OS LIVROS</strong> da biblioteca permanentemente.
                        Todos os empr√©stimos ativos tamb√©m ser√£o cancelados.
                    </p>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-yellow-800 text-sm">
                        <span class="emoji-3d">üìä</span> 
                        <strong>Dados que ser√£o perdidos:</strong><br>
                        ‚Ä¢ ${database.livros.length} livros cadastrados<br>
                        ‚Ä¢ ${database.emprestimos.filter(e => e.status === 'ativo').length} empr√©stimos ativos<br>
                        ‚Ä¢ Todas as avalia√ß√µes e coment√°rios
                    </p>
                </div>
                
                <form id="clearLibraryForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="emoji-3d">üîê</span> Digite sua senha de administrador para confirmar:
                        </label>
                        <input type="password" id="adminPasswordConfirm" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                               placeholder="Senha do administrador">
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="confirmClear" required class="rounded">
                        <label for="confirmClear" class="text-sm text-gray-700">
                            Confirmo que entendo que esta a√ß√£o √© <strong>irrevers√≠vel</strong>
                        </label>
                    </div>
                    
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" onclick="closeModal('clearLibraryModal')" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                            <span class="emoji-3d">üóëÔ∏è</span> LIMPAR BIBLIOTECA
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes do Livro -->
    <div id="detalhesLivroModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-screen overflow-y-auto m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Detalhes do Livro</h3>
                <button onclick="closeModal('detalhesLivroModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div id="detalhesLivroContent" class="space-y-6">
                <!-- Conte√∫do ser√° carregado dinamicamente -->
            </div>
            
            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="closeModal('detalhesLivroModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Fechar
                </button>
                <button id="avaliarLivroBtn" onclick="avaliarLivroFromDetalhes()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 hidden">
                    <span class="emoji-3d">‚≠ê</span> Avaliar Livro
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Zoom da Foto -->
    <div id="zoomFotoModal" class="fixed inset-0 bg-black bg-opacity-95 hidden items-center justify-center z-50" onclick="closeZoomFoto()">
        <div class="relative max-w-5xl max-h-screen p-4">
            <button onclick="closeZoomFoto()" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 z-10 bg-black bg-opacity-60 rounded-full w-12 h-12 flex items-center justify-center transition-all hover:bg-opacity-80">
                ‚úï
            </button>
            <img id="zoomFotoImg" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl cursor-zoom-out" onclick="event.stopPropagation()">
        </div>
    </div>

    <!-- Modal Trocar Senha -->
    <div id="trocarSenhaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-600">üîë Trocar Senha</h3>
                <button onclick="closeModal('trocarSenhaModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <form id="trocarSenhaForm" class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl emoji-3d mr-2">üîê</span>
                        <h4 class="font-bold text-blue-800">Altera√ß√£o de Senha</h4>
                    </div>
                    <p class="text-blue-700 text-sm">
                        Por seguran√ßa, voc√™ precisa confirmar sua senha atual antes de definir uma nova.
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="emoji-3d">üîí</span> Senha Atual *
                    </label>
                    <input type="password" id="senhaAtual" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Digite sua senha atual">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="emoji-3d">üÜï</span> Nova Senha *
                    </label>
                    <input type="password" id="novaSenha" required minlength="4"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Digite a nova senha (m√≠n. 4 caracteres)">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="emoji-3d">‚úÖ</span> Confirmar Nova Senha *
                    </label>
                    <input type="password" id="confirmarNovaSenha" required minlength="4"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Digite novamente a nova senha">
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-yellow-800 text-sm">
                        <span class="emoji-3d">‚ö†Ô∏è</span> 
                        <strong>Importante:</strong> Anote sua nova senha em local seguro. N√£o ser√° poss√≠vel recuper√°-la caso seja esquecida.
                    </p>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="closeModal('trocarSenhaModal')" 
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        <span class="emoji-3d">üîë</span> Alterar Senha
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Avalia√ß√£o do Livro -->
    <div id="avaliacaoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Avaliar Livro</h3>
                <button onclick="closeModal('avaliacaoModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <form id="avaliacaoForm" class="space-y-4">
                <div id="livroAvaliacaoInfo" class="p-3 bg-gray-50 rounded-lg mb-4"></div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sua Avalia√ß√£o</label>
                    <div class="flex space-x-2">
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="1">‚≠ê</button>
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="2">‚≠ê</button>
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="3">‚≠ê</button>
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="4">‚≠ê</button>
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="5">‚≠ê</button>
                    </div>
                    <input type="hidden" name="avaliacao" id="avaliacaoValue">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Coment√°rio</label>
                    <textarea name="comentario" rows="4" placeholder="Conte o que achou do livro..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="closeModal('avaliacaoModal')" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                        Enviar Avalia√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Base de dados expandida de livros para preenchimento autom√°tico
        const livrosDatabase = {
            // Literatura Brasileira Cl√°ssica
            "Dom Casmurro": {
                autor: "Machado de Assis",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Realista",
                descricao: "Cl√°ssico da literatura brasileira que narra a hist√≥ria de Bentinho e Capitu, explorando temas como ci√∫me, amor e trai√ß√£o atrav√©s da perspectiva de um narrador n√£o confi√°vel.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71jLBXtWJeL.jpg"
            },
            "O Corti√ßo": {
                autor: "Alu√≠sio Azevedo",
                categoria: "Literatura Brasileira",
                subcategoria: "Naturalismo",
                descricao: "Romance naturalista que retrata a vida em um corti√ßo no Rio de Janeiro do s√©culo XIX, mostrando as condi√ß√µes sociais da √©poca e a influ√™ncia do meio sobre o comportamento humano.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "Mem√≥rias P√≥stumas de Br√°s Cubas": {
                autor: "Machado de Assis",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Realista",
                descricao: "Romance inovador narrado por um defunto autor que conta sua vida de forma ir√¥nica e cr√≠tica, inaugurando o realismo no Brasil.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71kQVqzl8eL.jpg"
            },
            "O Guarani": {
                autor: "Jos√© de Alencar",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Indianista",
                descricao: "Romance que narra a hist√≥ria de amor entre o √≠ndio Peri e Ceci, representando o encontro entre culturas e idealizando o ind√≠gena brasileiro.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "Iracema": {
                autor: "Jos√© de Alencar",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Indianista",
                descricao: "Lenda do Cear√° que conta a hist√≥ria de amor entre a √≠ndia Iracema e o portugu√™s Martim, simbolizando o nascimento do povo brasileiro.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71YqVqzl8eL.jpg"
            },
            "Senhora": {
                autor: "Jos√© de Alencar",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Urbano",
                descricao: "Romance que critica a sociedade burguesa atrav√©s da hist√≥ria de Aur√©lia e Seixas, abordando temas como casamento por interesse e reden√ß√£o pelo amor.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71ZqVqzl8eL.jpg"
            },
            "Luc√≠ola": {
                autor: "Jos√© de Alencar",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Urbano",
                descricao: "Romance que aborda a prostitui√ß√£o e a reden√ß√£o atrav√©s do amor, contando a hist√≥ria de L√∫cia e Paulo.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81WKqzl+8eL.jpg"
            },
            "O Ateneu": {
                autor: "Raul Pomp√©ia",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Psicol√≥gico",
                descricao: "Romance autobiogr√°fico que retrata a vida em um col√©gio interno no s√©culo XIX, criticando o sistema educacional da √©poca.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "A Moreninha": {
                autor: "Joaquim Manuel de Macedo",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Rom√¢ntico",
                descricao: "Primeiro romance urbano brasileiro, retratando a sociedade carioca do s√©culo XIX atrav√©s da hist√≥ria de amor entre Augusto e Carolina.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "O Mulato": {
                autor: "Alu√≠sio Azevedo",
                categoria: "Literatura Brasileira",
                subcategoria: "Naturalismo",
                descricao: "Romance que denuncia o preconceito racial na sociedade maranhense, contando a hist√≥ria de Raimundo e Ana Rosa.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "Quincas Borba": {
                autor: "Machado de Assis",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Realista",
                descricao: "Romance que continua a filosofia do Humanitismo iniciada em Mem√≥rias P√≥stumas, narrando a hist√≥ria de Rubi√£o e sua heran√ßa.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71YqVqzl8eL.jpg"
            },
            "Capit√£es da Areia": {
                autor: "Jorge Amado",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Social",
                descricao: "Romance que retrata a vida de meninos de rua em Salvador, Bahia, denunciando as condi√ß√µes sociais e a marginaliza√ß√£o infantil.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "Vidas Secas": {
                autor: "Graciliano Ramos",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Regionalista",
                descricao: "Romance que retrata a vida de uma fam√≠lia de retirantes nordestinos, mostrando a seca, a mis√©ria e a luta pela sobreviv√™ncia.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "O Quinze": {
                autor: "Rachel de Queiroz",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Regionalista",
                descricao: "Romance que aborda a seca de 1915 no Cear√° e seus impactos sociais, sendo a primeira obra de destaque do regionalismo nordestino.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71YqVqzl8eL.jpg"
            },
            "Macuna√≠ma": {
                autor: "M√°rio de Andrade",
                categoria: "Literatura Brasileira",
                subcategoria: "Modernismo",
                descricao: "Raps√≥dia que retrata o her√≥i sem nenhum car√°ter, s√≠mbolo do povo brasileiro, misturando lendas ind√≠genas e cr√≠tica social.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "Casa Grande & Senzala": {
                autor: "Gilberto Freyre",
                categoria: "Sociologia",
                subcategoria: "Hist√≥ria do Brasil",
                descricao: "Obra fundamental sobre a forma√ß√£o da sociedade brasileira e as rela√ß√µes raciais, analisando a influ√™ncia portuguesa, africana e ind√≠gena.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71YqVqzl8eL.jpg"
            },
            
            // Literatura Contempor√¢nea Brasileira
            "Cidade de Deus": {
                autor: "Paulo Lins",
                categoria: "Literatura Brasileira",
                subcategoria: "Romance Contempor√¢neo",
                descricao: "Romance que retrata a viol√™ncia urbana na favela Cidade de Deus, no Rio de Janeiro, mostrando a realidade do tr√°fico de drogas.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "O Coruja": {
                autor: "Alu√≠sio Azevedo",
                categoria: "Literatura Brasileira",
                subcategoria: "Naturalismo",
                descricao: "Romance que retrata a decad√™ncia moral e social atrav√©s da hist√≥ria de Andr√©, mostrando a influ√™ncia do meio sobre o indiv√≠duo.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "Auto da Compadecida": {
                autor: "Ariano Suassuna",
                categoria: "Literatura Brasileira",
                subcategoria: "Teatro Popular",
                descricao: "Pe√ßa teatral que mistura elementos do folclore nordestino com cr√≠tica social, contando as aventuras de Jo√£o Grilo e Chic√≥.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71YqVqzl8eL.jpg"
            },
            
            // Literatura Portuguesa
            "Os Lus√≠adas": {
                autor: "Lu√≠s de Cam√µes",
                categoria: "Literatura Portuguesa",
                subcategoria: "√âpico",
                descricao: "Epopeia que narra as aventuras de Vasco da Gama e a hist√≥ria de Portugal, considerada a maior obra da literatura portuguesa.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "Memorial do Convento": {
                autor: "Jos√© Saramago",
                categoria: "Literatura Portuguesa",
                subcategoria: "Romance Hist√≥rico",
                descricao: "Romance que retrata a constru√ß√£o do Convento de Mafra no s√©culo XVIII, misturando hist√≥ria e fic√ß√£o com elementos fant√°sticos.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "O Crime do Padre Amaro": {
                autor: "E√ßa de Queir√≥s",
                categoria: "Literatura Portuguesa",
                subcategoria: "Realismo",
                descricao: "Romance realista que critica o clero portugu√™s atrav√©s da hist√≥ria do padre Amaro e seu envolvimento com Am√©lia.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71YqVqzl8eL.jpg"
            },
            "O Primo Bas√≠lio": {
                autor: "E√ßa de Queir√≥s",
                categoria: "Literatura Portuguesa",
                subcategoria: "Realismo",
                descricao: "Romance que critica a burguesia lisboeta atrav√©s do adult√©rio de Lu√≠sa com seu primo Bas√≠lio.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            
            // Literatura Mundial Cl√°ssica
            "Dom Quixote": {
                autor: "Miguel de Cervantes",
                categoria: "Literatura Espanhola",
                subcategoria: "Romance Cl√°ssico",
                descricao: "Obra-prima da literatura mundial que narra as aventuras do fidalgo Alonso Quixano e seu escudeiro Sancho Pan√ßa.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "Romeu e Julieta": {
                autor: "William Shakespeare",
                categoria: "Literatura Inglesa",
                subcategoria: "Teatro Cl√°ssico",
                descricao: "Trag√©dia que conta a hist√≥ria de amor imposs√≠vel entre dois jovens de fam√≠lias rivais em Verona.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "Hamlet": {
                autor: "William Shakespeare",
                categoria: "Literatura Inglesa",
                subcategoria: "Teatro Cl√°ssico",
                descricao: "Trag√©dia que narra a hist√≥ria do pr√≠ncipe Hamlet e sua busca por vingan√ßa contra o assassino de seu pai.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71YqVqzl8eL.jpg"
            },
            "Orgulho e Preconceito": {
                autor: "Jane Austen",
                categoria: "Literatura Inglesa",
                subcategoria: "Romance Cl√°ssico",
                descricao: "Romance que retrata a sociedade inglesa do s√©culo XIX atrav√©s da hist√≥ria de Elizabeth Bennet e Mr. Darcy.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "1984": {
                autor: "George Orwell",
                categoria: "Literatura Inglesa",
                subcategoria: "Fic√ß√£o Dist√≥pica",
                descricao: "Romance dist√≥pico que retrata uma sociedade totalit√°ria onde o governo controla todos os aspectos da vida dos cidad√£os.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "O Grande Gatsby": {
                autor: "F. Scott Fitzgerald",
                categoria: "Literatura Americana",
                subcategoria: "Romance Moderno",
                descricao: "Romance que retrata a sociedade americana dos anos 1920 atrav√©s da hist√≥ria de Jay Gatsby e seu amor por Daisy.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "Cem Anos de Solid√£o": {
                autor: "Gabriel Garc√≠a M√°rquez",
                categoria: "Literatura Latino-Americana",
                subcategoria: "Realismo M√°gico",
                descricao: "Romance que narra a hist√≥ria da fam√≠lia Buend√≠a ao longo de v√°rias gera√ß√µes na cidade fict√≠cia de Macondo.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "Crime e Castigo": {
                autor: "Fi√≥dor Dostoi√©vski",
                categoria: "Literatura Russa",
                subcategoria: "Romance Psicol√≥gico",
                descricao: "Romance que explora a psicologia de Rask√≥lnikov ap√≥s cometer um assassinato, abordando temas de culpa e reden√ß√£o.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "Guerra e Paz": {
                autor: "Liev Tolst√≥i",
                categoria: "Literatura Russa",
                subcategoria: "Romance √âpico",
                descricao: "√âpico que retrata a sociedade russa durante as guerras napole√¥nicas atrav√©s das vidas de v√°rias fam√≠lias aristocr√°ticas.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            
            // Literatura Juvenil e Fantasia
            "Harry Potter e a Pedra Filosofal": {
                autor: "J.K. Rowling",
                categoria: "Literatura Juvenil",
                subcategoria: "Fantasia",
                descricao: "Primeiro livro da s√©rie que narra as aventuras do jovem bruxo Harry Potter em sua descoberta do mundo m√°gico.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "O Senhor dos An√©is": {
                autor: "J.R.R. Tolkien",
                categoria: "Literatura Fant√°stica",
                subcategoria: "Alta Fantasia",
                descricao: "√âpico de fantasia que narra a jornada de Frodo para destruir o Um Anel e salvar a Terra-m√©dia.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "O Hobbit": {
                autor: "J.R.R. Tolkien",
                categoria: "Literatura Fant√°stica",
                subcategoria: "Fantasia Aventura",
                descricao: "Hist√≥ria que narra a jornada de Bilbo Bolseiro com os an√µes para recuperar o tesouro guardado pelo drag√£o Smaug.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "As Cr√¥nicas de N√°rnia": {
                autor: "C.S. Lewis",
                categoria: "Literatura Juvenil",
                subcategoria: "Fantasia",
                descricao: "S√©rie de sete livros que narra as aventuras de crian√ßas no mundo m√°gico de N√°rnia.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            
            // Fic√ß√£o Cient√≠fica
            "Funda√ß√£o": {
                autor: "Isaac Asimov",
                categoria: "Fic√ß√£o Cient√≠fica",
                subcategoria: "Space Opera",
                descricao: "Primeiro livro da s√©rie Funda√ß√£o que narra a queda do Imp√©rio Gal√°ctico e os esfor√ßos para preservar o conhecimento.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            "Duna": {
                autor: "Frank Herbert",
                categoria: "Fic√ß√£o Cient√≠fica",
                subcategoria: "Space Opera",
                descricao: "√âpico de fic√ß√£o cient√≠fica que se passa no planeta des√©rtico Arrakis, fonte da especiaria melange.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "Fahrenheit 451": {
                autor: "Ray Bradbury",
                categoria: "Fic√ß√£o Cient√≠fica",
                subcategoria: "Distopia",
                descricao: "Romance dist√≥pico sobre uma sociedade futura onde os livros s√£o proibidos e queimados pelos bombeiros.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            
            // Literatura de Mist√©rio e Suspense
            "O Nome da Rosa": {
                autor: "Umberto Eco",
                categoria: "Literatura Italiana",
                subcategoria: "Romance Hist√≥rico",
                descricao: "Romance que combina mist√©rio medieval com filosofia, narrando investiga√ß√µes em um mosteiro no s√©culo XIV.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "Sherlock Holmes": {
                autor: "Arthur Conan Doyle",
                categoria: "Literatura Inglesa",
                subcategoria: "Mist√©rio",
                descricao: "Colet√¢nea de hist√≥rias do famoso detetive Sherlock Holmes e seu parceiro Dr. Watson.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            },
            
            // Poesia
            "Sonetos": {
                autor: "Vin√≠cius de Moraes",
                categoria: "Poesia Brasileira",
                subcategoria: "L√≠rica Moderna",
                descricao: "Colet√¢nea de sonetos do poeta brasileiro, abordando temas como amor, natureza e exist√™ncia.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/71XqVqzl8eL.jpg"
            },
            "Antologia Po√©tica": {
                autor: "Carlos Drummond de Andrade",
                categoria: "Poesia Brasileira",
                subcategoria: "Modernismo",
                descricao: "Sele√ß√£o dos principais poemas do grande poeta mineiro, representando diferentes fases de sua obra.",
                capa: "https://images-na.ssl-images-amazon.com/images/I/81VKqzl+8eL.jpg"
            }
        };

        // Banco de dados simulado
        let database = {
            usuarios: [
                {
                    id: 1,
                    nome: 'Administrador',
                    login: 'ADMIN',
                    senha: 'VANIA25',
                    tipo: 'admin',
                    turma: '',
                    status: 'ativo',
                    livrosLidos: 0
                }
            ],
            livros: [
                {
                    id: 1,
                    titulo: 'Dom Casmurro',
                    autor: 'Machado de Assis',
                    editora: '√Åtica',
                    categoria: 'Literatura Brasileira',
                    subcategoria: 'Romance',
                    quantidade: 5,
                    disponivel: 5,
                    descricao: 'Cl√°ssico da literatura brasileira que narra a hist√≥ria de Bentinho e Capitu.',
                    foto: '',
                    codigoBarra: '123456789',
                    localizacao: 'Corredor A, Pr√©dio 1, Casa 15',
                    avaliacoes: []
                },
                {
                    id: 2,
                    titulo: 'O Corti√ßo',
                    autor: 'Alu√≠sio Azevedo',
                    editora: 'Moderna',
                    categoria: 'Literatura Brasileira',
                    subcategoria: 'Naturalismo',
                    quantidade: 3,
                    disponivel: 3,
                    descricao: 'Romance naturalista que retrata a vida em um corti√ßo no Rio de Janeiro.',
                    foto: '',
                    codigoBarra: '987654321',
                    localizacao: 'Corredor B, Pr√©dio 1, Casa 22',
                    avaliacoes: []
                }
            ],
            emprestimos: [],
            nextId: {
                usuarios: 2,
                livros: 3,
                emprestimos: 1
            }
        };

        let currentUser = null;

        // Carregar dados do localStorage
        function loadDatabase() {
            const saved = localStorage.getItem('bibliOnDatabase');
            if (saved) {
                database = JSON.parse(saved);
            }
        }

        // Salvar dados no localStorage
        function saveDatabase() {
            localStorage.setItem('bibliOnDatabase', JSON.stringify(database));
        }

        // Fun√ß√£o para converter arquivo para base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Fun√ß√£o para normalizar texto (remove acentos, espa√ßos extras, etc.)
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^\w\s]/g, '') // Remove pontua√ß√£o
                .replace(/\s+/g, ' ') // Remove espa√ßos extras
                .trim();
        }

        // Fun√ß√£o para calcular similaridade entre strings
        function calculateSimilarity(str1, str2) {
            const s1 = normalizeText(str1);
            const s2 = normalizeText(str2);
            
            if (s1 === s2) return 1.0;
            
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // Fun√ß√£o para calcular dist√¢ncia de Levenshtein
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // Fun√ß√£o avan√ßada para preencher dados automaticamente do livro
        function preencherDadosAutomaticos(titulo, autor) {
            let melhorMatch = null;
            let melhorScore = 0;
            
            // Primeiro: busca exata por t√≠tulo
            const livroExato = livrosDatabase[titulo];
            if (livroExato && calculateSimilarity(livroExato.autor, autor) > 0.8) {
                return {
                    categoria: livroExato.categoria,
                    subcategoria: livroExato.subcategoria,
                    descricao: livroExato.descricao,
                    foto: livroExato.capa
                };
            }
            
            // Segundo: busca por similaridade de t√≠tulo e autor
            for (const [tituloDb, info] of Object.entries(livrosDatabase)) {
                const tituloSimilarity = calculateSimilarity(titulo, tituloDb);
                const autorSimilarity = calculateSimilarity(autor, info.autor);
                
                // Score combinado (t√≠tulo tem peso maior)
                const score = (tituloSimilarity * 0.7) + (autorSimilarity * 0.3);
                
                if (score > 0.7 && score > melhorScore) {
                    melhorScore = score;
                    melhorMatch = {
                        categoria: info.categoria,
                        subcategoria: info.subcategoria,
                        descricao: info.descricao,
                        foto: info.capa,
                        confidence: score
                    };
                }
            }
            
            // Terceiro: busca apenas por autor (para livros do mesmo autor)
            if (!melhorMatch || melhorScore < 0.8) {
                for (const [tituloDb, info] of Object.entries(livrosDatabase)) {
                    const autorSimilarity = calculateSimilarity(autor, info.autor);
                    
                    if (autorSimilarity > 0.9) {
                        // Se encontrou o mesmo autor, usa categoria gen√©rica
                        return {
                            categoria: info.categoria,
                            subcategoria: info.subcategoria,
                            descricao: `Obra de ${info.autor}, autor de ${tituloDb} e outras obras importantes da ${info.categoria}.`,
                            foto: '', // N√£o usa foto de outro livro
                            confidence: autorSimilarity * 0.6
                        };
                    }
                }
            }
            
            return melhorMatch;
        }

        // Fun√ß√£o para buscar informa√ß√µes de livro por m√∫ltiplos crit√©rios
        function buscarInformacoesLivro(titulo, autor, codigoBarra = '') {
            // Busca por c√≥digo de barras primeiro (mais confi√°vel)
            if (codigoBarra) {
                for (const [tituloDb, info] of Object.entries(livrosDatabase)) {
                    if (info.codigoBarra && info.codigoBarra === codigoBarra) {
                        return {
                            categoria: info.categoria,
                            subcategoria: info.subcategoria,
                            descricao: info.descricao,
                            foto: info.capa,
                            confidence: 1.0,
                            method: 'codigo_barras'
                        };
                    }
                }
            }
            
            // Busca por t√≠tulo e autor
            const dadosAuto = preencherDadosAutomaticos(titulo, autor);
            if (dadosAuto) {
                dadosAuto.method = 'titulo_autor';
                return dadosAuto;
            }
            
            return null;
        }

        // Inicializar sistema
        function init() {
            loadDatabase();
            
            // Event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('addBookForm').addEventListener('submit', handleAddBook);
            document.getElementById('editBookForm').addEventListener('submit', handleEditBook);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('editUserForm').addEventListener('submit', handleEditUser);
            document.getElementById('addEmprestimoForm').addEventListener('submit', handleAddEmprestimo);
            document.getElementById('avaliacaoForm').addEventListener('submit', handleAvaliacao);
            document.getElementById('clearLibraryForm').addEventListener('submit', handleClearLibrary);
            document.getElementById('trocarSenhaForm').addEventListener('submit', handleTrocarSenha);
            
            // Filtros
            document.getElementById('searchLivros').addEventListener('input', filterLivros);
            document.getElementById('filterCategoria').addEventListener('change', filterLivros);
            document.getElementById('filterAutor').addEventListener('change', filterLivros);
            document.getElementById('filterDisponibilidade').addEventListener('change', filterLivros);
            
            document.getElementById('searchUsuarios').addEventListener('input', filterUsuarios);
            document.getElementById('filterTipoUsuario').addEventListener('change', filterUsuarios);
            document.getElementById('filterStatusUsuario').addEventListener('change', filterUsuarios);
            
            document.getElementById('searchEmprestimos').addEventListener('input', filterEmprestimos);
            document.getElementById('filterDataInicio').addEventListener('change', filterEmprestimos);
            document.getElementById('filterDataFim').addEventListener('change', filterEmprestimos);
            document.getElementById('filterTurma').addEventListener('change', filterEmprestimos);
            
            // Busca de livros no empr√©stimo
            document.getElementById('searchLivroEmprestimo').addEventListener('input', searchLivrosEmprestimo);
            
            // Sistema de avalia√ß√£o por estrelas
            document.querySelectorAll('.star-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    document.getElementById('avaliacaoValue').value = rating;
                    
                    document.querySelectorAll('.star-btn').forEach((star, index) => {
                        if (index < rating) {
                            star.classList.remove('text-gray-300');
                            star.classList.add('text-yellow-400');
                        } else {
                            star.classList.remove('text-yellow-400');
                            star.classList.add('text-gray-300');
                        }
                    });
                });
            });
        }

        // Login
        function handleLogin(e) {
            e.preventDefault();
            
            const login = document.getElementById('loginUser').value;
            const senha = document.getElementById('loginPassword').value;
            
            const user = database.usuarios.find(u => u.login === login && u.senha === senha && u.status === 'ativo');
            
            if (user) {
                currentUser = user;
                showTransition();
            } else {
                alert('Usu√°rio ou senha incorretos!');
            }
        }

        // Mostrar tela de transi√ß√£o
        function showTransition() {
            const transitionScreen = document.getElementById('transitionScreen');
            transitionScreen.classList.add('active');
            
            setTimeout(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').classList.remove('hidden');
                transitionScreen.classList.remove('active');
                
                setupUserInterface();
                showTab('inicio');
            }, 2000);
        }

        // Configurar interface baseada no usu√°rio
        function setupUserInterface() {
            document.getElementById('userWelcome').textContent = `Ol√°, ${currentUser.nome}`;
            
            // Controlar acesso baseado no tipo de usu√°rio
            const isAdmin = currentUser.tipo === 'admin';
            const isStaff = ['admin', 'professor', 'diretor', 'coordenador', 'ajudante'].includes(currentUser.tipo);
            const isAluno = currentUser.tipo === 'aluno';
            
            // Reset all visibility first
            document.getElementById('usuariosTabBtn').style.display = 'block';
            document.getElementById('usuariosCard').style.display = 'block';
            document.getElementById('addEmprestimoBtn').style.display = 'block';
            document.getElementById('meusEmprestimos').style.display = 'none';
            document.getElementById('livrosActions').style.display = 'block';
            document.getElementById('clearLibraryBtn').style.display = 'none'; // Ocultar por padr√£o
            
            // Configure based on user type
            if (isAluno) {
                document.getElementById('usuariosTabBtn').style.display = 'none';
                document.getElementById('usuariosCard').style.display = 'none';
                document.getElementById('addEmprestimoBtn').style.display = 'none';
                document.getElementById('meusEmprestimos').style.display = 'block';
                document.getElementById('livrosActions').style.display = 'none';
            }
            
            // Mostrar bot√£o de limpar biblioteca APENAS para admin
            if (isAdmin) {
                document.getElementById('clearLibraryBtn').style.display = 'inline-block';
            } else {
                document.getElementById('clearLibraryBtn').style.display = 'none';
            }
            
            // Mostrar bot√£o de trocar senha APENAS para admin
            if (isAdmin) {
                document.getElementById('trocarSenhaBtn').style.display = 'inline-block';
            } else {
                document.getElementById('trocarSenhaBtn').style.display = 'none';
            }
            
            updateDashboard();
        }

        // Mostrar aba
        function showTab(tabName) {
            // Ocultar todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remover classe ativa dos bot√µes
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Ativar bot√£o correspondente - encontrar o bot√£o correto
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // Carregar dados da aba
            switch(tabName) {
                case 'inicio':
                    updateDashboard();
                    break;
                case 'livros':
                    loadLivros();
                    loadFilterOptions();
                    break;
                case 'emprestimos':
                    loadEmprestimos();
                    loadTurmasFilter();
                    break;
                case 'devolucoes':
                    loadDevolucoesPendentes();
                    break;
                case 'usuarios':
                    loadUsuarios();
                    break;
            }
        }

        // Atualizar dashboard
        function updateDashboard() {
            document.getElementById('totalLivros').textContent = database.livros.length;
            document.getElementById('totalEmprestimos').textContent = database.emprestimos.filter(e => e.status === 'ativo').length;
            document.getElementById('totalUsuarios').textContent = database.usuarios.filter(u => u.status === 'ativo').length;
            
            const hoje = new Date();
            const pendentes = database.emprestimos.filter(e => {
                return e.status === 'ativo' && new Date(e.dataDevolucao) < hoje;
            });
            document.getElementById('totalPendentes').textContent = pendentes.length;
            
            loadLivrosDestaque();
            if (currentUser.tipo === 'aluno') {
                loadEmprestimosAluno();
            }
        }

        // Carregar livros em destaque
        function loadLivrosDestaque() {
            const container = document.getElementById('livrosDestaque');
            
            if (database.livros.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-6xl emoji-3d mb-4">üìö</div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Nenhum livro cadastrado</h3>
                        <p class="text-gray-500 mb-4">Adicione alguns livros para v√™-los em destaque aqui!</p>
                        ${['admin', 'professor', 'diretor', 'coordenador', 'ajudante'].includes(currentUser.tipo) ? `
                            <button onclick="showTab('livros')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                                <span class="emoji-3d">‚ûï</span> Adicionar Primeiro Livro
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            // Selecionar livros em destaque (com melhor avalia√ß√£o, mais dispon√≠veis, ou mais recentes)
            let livrosDestaque = [...database.livros];
            
            // Ordenar por crit√©rios de destaque:
            // 1. Livros com avalia√ß√µes (m√©dia alta)
            // 2. Livros dispon√≠veis
            // 3. Livros mais recentes (ID maior)
            livrosDestaque.sort((a, b) => {
                // Calcular m√©dia de avalia√ß√µes
                const mediaA = a.avaliacoes.length > 0 ? 
                    a.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / a.avaliacoes.length : 0;
                const mediaB = b.avaliacoes.length > 0 ? 
                    b.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / b.avaliacoes.length : 0;
                
                // Priorizar livros com avalia√ß√µes altas
                if (mediaA !== mediaB) return mediaB - mediaA;
                
                // Depois priorizar livros dispon√≠veis
                if (a.disponivel !== b.disponivel) return b.disponivel - a.disponivel;
                
                // Por √∫ltimo, livros mais recentes
                return b.id - a.id;
            });
            
            // Pegar os 5 primeiros
            livrosDestaque = livrosDestaque.slice(0, 5);
            
            container.innerHTML = livrosDestaque.map(livro => {
                const mediaAvaliacao = livro.avaliacoes.length > 0 ? 
                    (livro.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / livro.avaliacoes.length).toFixed(1) : 0;
                
                const isClickable = currentUser.tipo === 'aluno';
                
                return `
                    <div class="book-card rounded-lg p-4 text-center card-hover ${isClickable ? 'cursor-pointer' : ''}" 
                         ${isClickable ? `onclick="showDetalhesLivro(${livro.id})"` : ''}>
                        <div class="w-16 h-20 bg-gradient-to-b from-orange-400 to-orange-600 rounded mx-auto mb-2 flex items-center justify-center overflow-hidden">
                            ${livro.foto ? 
                                `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover rounded cursor-pointer hover:opacity-80 transition-opacity" onclick="event.stopPropagation(); showZoomFoto(${livro.id}, '${livro.foto}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <span class="text-white text-2xl emoji-3d hidden">üìñ</span>` : 
                                '<span class="text-white text-2xl emoji-3d">üìñ</span>'
                            }
                        </div>
                        <h4 class="font-semibold text-sm mb-1 truncate" title="${livro.titulo}">${livro.titulo}</h4>
                        <p class="text-xs text-gray-600 truncate" title="${livro.autor}">${livro.autor}</p>
                        
                        <div class="mt-2 space-y-1">
                            <p class="text-xs ${livro.disponivel > 0 ? 'text-green-600' : 'text-red-500'}">
                                ${livro.disponivel > 0 ? `${livro.disponivel} dispon√≠vel` : 'Indispon√≠vel'}
                            </p>
                            
                            ${livro.avaliacoes.length > 0 ? `
                                <div class="flex items-center justify-center space-x-1">
                                    <span class="text-yellow-400 text-xs">‚≠ê</span>
                                    <span class="text-xs text-gray-600">${mediaAvaliacao}</span>
                                    <span class="text-xs text-gray-400">(${livro.avaliacoes.length})</span>
                                </div>
                            ` : `
                                <p class="text-xs text-gray-400">Sem avalia√ß√µes</p>
                            `}
                        </div>
                        
                        ${livro.avaliacoes.length > 0 && mediaAvaliacao >= 4.5 ? `
                            <div class="mt-2">
                                <span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">
                                    üèÜ Top Rated
                                </span>
                            </div>
                        ` : ''}
                        
                        ${livro.disponivel === 0 ? `
                            <div class="mt-2">
                                <span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">
                                    üìµ Esgotado
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Carregar empr√©stimos do aluno
        function loadEmprestimosAluno() {
            const container = document.getElementById('emprestimosAluno');
            const emprestimosAluno = database.emprestimos.filter(e => e.alunoId === currentUser.id);
            
            if (emprestimosAluno.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Voc√™ n√£o possui livros emprestados no momento.</p>';
                return;
            }
            
            container.innerHTML = emprestimosAluno.map(emprestimo => {
                const livro = database.livros.find(l => l.id === emprestimo.livroId);
                const hoje = new Date();
                const dataDevolucao = new Date(emprestimo.dataDevolucao);
                const isAtrasado = emprestimo.status === 'ativo' && dataDevolucao < hoje;
                
                return `
                    <div class="flex items-center justify-between p-4 border rounded-lg ${isAtrasado ? 'border-red-300 bg-red-50' : 'border-gray-200'}">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-16 bg-gradient-to-b from-orange-400 to-orange-600 rounded flex items-center justify-center">
                                <span class="text-white emoji-3d">üìñ</span>
                            </div>
                            <div>
                                <h4 class="font-semibold">${livro.titulo}</h4>
                                <p class="text-sm text-gray-600">${livro.autor}</p>
                                <p class="text-xs ${isAtrasado ? 'text-red-600' : 'text-gray-500'}">
                                    Devolu√ß√£o: ${formatDate(emprestimo.dataDevolucao)}
                                    ${isAtrasado ? '(ATRASADO)' : ''}
                                </p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${emprestimo.status === 'devolvido' ? `
                                <button onclick="showAvaliacaoModal(${emprestimo.id})" class="px-3 py-1 bg-orange-500 text-white text-sm rounded hover:bg-orange-600">
                                    <span class="emoji-3d">‚≠ê</span> Avaliar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Carregar livros
        function loadLivros() {
            const container = document.getElementById('livrosList');
            let livros = [...database.livros]; // Criar c√≥pia para n√£o modificar o original
            
            // Aplicar filtros
            const search = document.getElementById('searchLivros').value.toLowerCase().trim();
            const categoria = document.getElementById('filterCategoria').value.trim();
            const autor = document.getElementById('filterAutor').value.trim();
            const disponibilidade = document.getElementById('filterDisponibilidade').value.trim();
            
            // Filtro de busca por texto (t√≠tulo, autor, descri√ß√£o)
            if (search) {
                livros = livros.filter(l => 
                    (l.titulo && l.titulo.toLowerCase().includes(search)) || 
                    (l.autor && l.autor.toLowerCase().includes(search)) ||
                    (l.descricao && l.descricao.toLowerCase().includes(search)) ||
                    (l.categoria && l.categoria.toLowerCase().includes(search)) ||
                    (l.subcategoria && l.subcategoria.toLowerCase().includes(search)) ||
                    (l.editora && l.editora.toLowerCase().includes(search))
                );
            }
            
            // Filtro por categoria
            if (categoria) {
                livros = livros.filter(l => l.categoria && l.categoria.trim() === categoria);
            }
            
            // Filtro por autor
            if (autor) {
                livros = livros.filter(l => l.autor && l.autor.trim() === autor);
            }
            
            // Filtro por disponibilidade
            if (disponibilidade === 'disponivel') {
                livros = livros.filter(l => l.disponivel > 0);
            } else if (disponibilidade === 'indisponivel') {
                livros = livros.filter(l => l.disponivel === 0);
            }
            
            container.innerHTML = livros.map(livro => {
                const canEdit = ['admin', 'professor', 'diretor', 'coordenador', 'ajudante'].includes(currentUser.tipo);
                const mediaAvaliacao = livro.avaliacoes.length > 0 ? 
                    (livro.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / livro.avaliacoes.length).toFixed(1) : 0;
                
                return `
                    <div class="book-card rounded-xl p-6 card-hover ${currentUser.tipo === 'aluno' ? 'cursor-pointer' : ''}" ${currentUser.tipo === 'aluno' ? `onclick="showDetalhesLivro(${livro.id})"` : ''}>
                        <div class="flex items-start space-x-4">
                            <div class="w-20 h-28 bg-gradient-to-b from-orange-400 to-orange-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                ${livro.foto ? `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity" onclick="showZoomFoto(${livro.id}, '${livro.foto}')">` : '<span class="text-white text-3xl emoji-3d">üìñ</span>'}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-lg mb-1 truncate">${livro.titulo}</h3>
                                <p class="text-gray-600 mb-1">${livro.autor}</p>
                                <p class="text-sm text-gray-500 mb-2">${livro.editora || 'Editora n√£o informada'}</p>
                                <p class="text-sm text-gray-700 mb-2">${livro.descricao || 'Sem descri√ß√£o'}</p>
                                
                                <div class="flex items-center space-x-4 text-sm">
                                    <span class="flex items-center">
                                        <span class="emoji-3d">üìö</span>
                                        <span class="ml-1">${livro.disponivel}/${livro.quantidade}</span>
                                    </span>
                                    <span class="flex items-center">
                                        <span class="emoji-3d">‚≠ê</span>
                                        <span class="ml-1">${mediaAvaliacao} (${livro.avaliacoes.length})</span>
                                    </span>
                                    ${livro.localizacao ? `
                                        <span class="flex items-center">
                                            <span class="emoji-3d">üìç</span>
                                            <span class="ml-1">${livro.localizacao}</span>
                                        </span>
                                    ` : ''}
                                </div>
                                
                                ${livro.avaliacoes.length > 0 ? `
                                    <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                        <h4 class="text-sm font-semibold mb-2">Avalia√ß√µes dos Alunos:</h4>
                                        <div class="space-y-2 max-h-32 overflow-y-auto">
                                            ${livro.avaliacoes.slice(-3).map(av => `
                                                <div class="text-xs">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="font-medium">${av.alunoNome}</span>
                                                        <span class="text-yellow-500">${'‚≠ê'.repeat(av.nota)}</span>
                                                    </div>
                                                    ${av.comentario ? `<p class="text-gray-600 mt-1">"${av.comentario}"</p>` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                        ${livro.avaliacoes.length > 3 ? `<p class="text-xs text-gray-500 mt-2">E mais ${livro.avaliacoes.length - 3} avalia√ß√µes...</p>` : ''}
                                    </div>
                                ` : ''}
                                
                                <div class="mt-3 flex space-x-2">
                                    ${canEdit ? `
                                        <button onclick="editLivro(${livro.id})" class="px-3 py-1 bg-orange-500 text-white text-sm rounded hover:bg-orange-600">
                                            <span class="emoji-3d">‚úèÔ∏è</span> Editar
                                        </button>
                                        <button onclick="deleteLivro(${livro.id})" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600">
                                            <span class="emoji-3d">üóëÔ∏è</span> Excluir
                                        </button>
                                    ` : ''}
                                    ${currentUser.tipo === 'aluno' ? `
                                        <button onclick="showAvaliacaoLivroModal(${livro.id})" class="px-3 py-1 bg-yellow-500 text-white text-sm rounded hover:bg-yellow-600">
                                            <span class="emoji-3d">‚≠ê</span> Avaliar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Carregar op√ß√µes de filtro
        function loadFilterOptions() {
            // Obter categorias √∫nicas (removendo valores vazios e duplicados)
            const categorias = [...new Set(database.livros
                .map(l => l.categoria)
                .filter(c => c && c.trim() !== '')
                .map(c => c.trim())
            )].sort();
            
            // Obter autores √∫nicos (removendo valores vazios e duplicados)
            const autores = [...new Set(database.livros
                .map(l => l.autor)
                .filter(a => a && a.trim() !== '')
                .map(a => a.trim())
            )].sort();
            
            // Atualizar select de categorias
            const categoriaSelect = document.getElementById('filterCategoria');
            const categoriaAtual = categoriaSelect.value;
            categoriaSelect.innerHTML = '<option value="">Todas as categorias</option>' +
                categorias.map(c => `<option value="${c}" ${c === categoriaAtual ? 'selected' : ''}>${c}</option>`).join('');
                
            // Atualizar select de autores
            const autorSelect = document.getElementById('filterAutor');
            const autorAtual = autorSelect.value;
            autorSelect.innerHTML = '<option value="">Todos os autores</option>' +
                autores.map(a => `<option value="${a}" ${a === autorAtual ? 'selected' : ''}>${a}</option>`).join('');
        }

        // Filtrar livros
        function filterLivros() {
            loadLivros();
        }

        // Verificar se livro j√° existe
        function verificarLivroDuplicado(titulo, autor, codigoBarra, idExcluir = null) {
            return database.livros.some(livro => {
                if (idExcluir && livro.id === idExcluir) return false;
                
                // Verificar por t√≠tulo e autor (normalizado)
                const tituloNormalizado = titulo.toLowerCase().trim();
                const autorNormalizado = autor.toLowerCase().trim();
                const livroTituloNorm = livro.titulo.toLowerCase().trim();
                const livroAutorNorm = livro.autor.toLowerCase().trim();
                
                const mesmaTituloAutor = tituloNormalizado === livroTituloNorm && autorNormalizado === livroAutorNorm;
                
                // Verificar por c√≥digo de barras se fornecido
                const mesmoCodigoBarra = codigoBarra && livro.codigoBarra && 
                    codigoBarra.trim() === livro.codigoBarra.trim();
                
                return mesmaTituloAutor || mesmoCodigoBarra;
            });
        }

        // Adicionar livro
        async function handleAddBook(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const titulo = formData.get('titulo');
            const autor = formData.get('autor');
            const codigoBarra = formData.get('codigoBarra');
            
            // Verificar duplicatas
            if (verificarLivroDuplicado(titulo, autor, codigoBarra)) {
                const livroExistente = database.livros.find(l => {
                    const tituloNorm = titulo.toLowerCase().trim();
                    const autorNorm = autor.toLowerCase().trim();
                    const livroTituloNorm = l.titulo.toLowerCase().trim();
                    const livroAutorNorm = l.autor.toLowerCase().trim();
                    
                    return (tituloNorm === livroTituloNorm && autorNorm === livroAutorNorm) ||
                           (codigoBarra && l.codigoBarra && codigoBarra.trim() === l.codigoBarra.trim());
                });
                
                const confirmar = confirm(
                    `‚ö†Ô∏è LIVRO DUPLICADO DETECTADO!\n\n` +
                    `J√° existe um livro cadastrado:\n` +
                    `üìñ T√≠tulo: ${livroExistente.titulo}\n` +
                    `‚úçÔ∏è Autor: ${livroExistente.autor}\n` +
                    `üìä Quantidade atual: ${livroExistente.quantidade}\n` +
                    `${livroExistente.codigoBarra ? `üè∑Ô∏è C√≥digo: ${livroExistente.codigoBarra}\n` : ''}` +
                    `\nDeseja adicionar mais exemplares ao livro existente ao inv√©s de criar um novo registro?`
                );
                
                if (confirmar) {
                    // Adicionar √† quantidade existente
                    const quantidadeAdicional = parseInt(formData.get('quantidade'));
                    livroExistente.quantidade += quantidadeAdicional;
                    livroExistente.disponivel += quantidadeAdicional;
                    
                    saveDatabase();
                    closeModal('addBookModal');
                    loadLivros();
                    updateDashboard();
                    e.target.reset();
                    
                    alert(`‚úÖ ${quantidadeAdicional} exemplares adicionados ao livro "${livroExistente.titulo}"!\nTotal agora: ${livroExistente.quantidade} exemplares.`);
                    return;
                } else {
                    return; // Cancelar opera√ß√£o
                }
            }
            
            let foto = formData.get('foto') || '';
            
            // Processar arquivo de imagem se fornecido
            const fotoFile = formData.get('fotoFile');
            if (fotoFile && fotoFile.size > 0) {
                try {
                    foto = await fileToBase64(fotoFile);
                } catch (error) {
                    console.error('Erro ao processar imagem:', error);
                }
            }
            
            const livro = {
                id: database.nextId.livros++,
                titulo: titulo,
                autor: autor,
                editora: formData.get('editora') || '',
                categoria: formData.get('categoria') || '',
                subcategoria: formData.get('subcategoria') || '',
                quantidade: parseInt(formData.get('quantidade')),
                disponivel: parseInt(formData.get('quantidade')),
                descricao: formData.get('descricao') || '',
                foto: foto,
                codigoBarra: codigoBarra || '',
                localizacao: formData.get('localizacao') || '',
                avaliacoes: []
            };
            
            // ü§ñ PREENCHIMENTO AUTOM√ÅTICO INTELIGENTE
            const dadosAuto = buscarInformacoesLivro(titulo, autor, codigoBarra);
            let mensagemAuto = '';
            
            if (dadosAuto) {
                // Preencher apenas campos vazios
                if (!livro.categoria && dadosAuto.categoria) {
                    livro.categoria = dadosAuto.categoria;
                    mensagemAuto += `üìÇ Categoria: ${dadosAuto.categoria}\n`;
                }
                if (!livro.subcategoria && dadosAuto.subcategoria) {
                    livro.subcategoria = dadosAuto.subcategoria;
                    mensagemAuto += `üìã Subcategoria: ${dadosAuto.subcategoria}\n`;
                }
                if (!livro.descricao && dadosAuto.descricao) {
                    livro.descricao = dadosAuto.descricao;
                    mensagemAuto += `üìù Descri√ß√£o adicionada automaticamente\n`;
                }
                if (!livro.foto && dadosAuto.foto) {
                    livro.foto = dadosAuto.foto;
                    mensagemAuto += `üñºÔ∏è Capa do livro adicionada automaticamente\n`;
                }
                
                if (mensagemAuto) {
                    mensagemAuto = `\nü§ñ INFORMA√á√ïES PREENCHIDAS AUTOMATICAMENTE:\n${mensagemAuto}`;
                    if (dadosAuto.confidence) {
                        mensagemAuto += `\nüìä Confian√ßa: ${Math.round(dadosAuto.confidence * 100)}%`;
                    }
                }
            }
            
            database.livros.push(livro);
            saveDatabase();
            
            closeModal('addBookModal');
            loadLivros();
            updateDashboard();
            
            e.target.reset();
            
            let mensagemFinal = `‚úÖ Livro "${titulo}" cadastrado com sucesso!`;
            if (mensagemAuto) {
                mensagemFinal += mensagemAuto;
            }
            
            alert(mensagemFinal);
        }

        // Importar livros
        function importBooks() {
            const text = document.getElementById('importBooksText').value.trim();
            if (!text) return;
            
            const lines = text.split('\n').filter(line => line.trim());
            let imported = 0;
            let updated = 0;
            let skipped = 0;
            let autoFilled = 0;
            const duplicados = [];
            const livrosComDadosAuto = [];
            
            lines.forEach((line, index) => {
                const parts = line.split('|').map(p => p.trim());
                if (parts.length >= 2) {
                    const titulo = parts[0];
                    const autor = parts[1];
                    const codigoBarra = parts[2] || '';
                    const quantidade = parseInt(parts[6] || parts[4] || '1');
                    
                    // Verificar se j√° existe
                    if (verificarLivroDuplicado(titulo, autor, codigoBarra)) {
                        const livroExistente = database.livros.find(l => {
                            const tituloNorm = titulo.toLowerCase().trim();
                            const autorNorm = autor.toLowerCase().trim();
                            const livroTituloNorm = l.titulo.toLowerCase().trim();
                            const livroAutorNorm = l.autor.toLowerCase().trim();
                            
                            return (tituloNorm === livroTituloNorm && autorNorm === livroAutorNorm) ||
                                   (codigoBarra && l.codigoBarra && codigoBarra.trim() === l.codigoBarra.trim());
                        });
                        
                        duplicados.push({
                            linha: index + 1,
                            titulo: titulo,
                            autor: autor,
                            quantidadeNova: quantidade,
                            livroExistente: livroExistente
                        });
                        
                        skipped++;
                        return;
                    }
                    
                    const livro = {
                        id: database.nextId.livros++,
                        titulo: titulo,
                        autor: autor,
                        editora: '',
                        categoria: '',
                        subcategoria: '',
                        quantidade: quantidade,
                        disponivel: quantidade,
                        descricao: '',
                        foto: '',
                        codigoBarra: codigoBarra,
                        localizacao: parts[5] || '',
                        avaliacoes: []
                    };
                    
                    // Aplicar dados opcionais se fornecidos
                    if (parts[3]) livro.categoria = parts[3];
                    
                    // ü§ñ PREENCHIMENTO AUTOM√ÅTICO INTELIGENTE
                    const dadosAuto = buscarInformacoesLivro(titulo, autor, codigoBarra);
                    let camposPreenchidos = [];
                    
                    if (dadosAuto) {
                        if (!livro.categoria && dadosAuto.categoria) {
                            livro.categoria = dadosAuto.categoria;
                            camposPreenchidos.push('categoria');
                        }
                        if (!livro.subcategoria && dadosAuto.subcategoria) {
                            livro.subcategoria = dadosAuto.subcategoria;
                            camposPreenchidos.push('subcategoria');
                        }
                        if (!livro.descricao && dadosAuto.descricao) {
                            livro.descricao = dadosAuto.descricao;
                            camposPreenchidos.push('descri√ß√£o');
                        }
                        if (!livro.foto && dadosAuto.foto) {
                            livro.foto = dadosAuto.foto;
                            camposPreenchidos.push('capa');
                        }
                        
                        if (camposPreenchidos.length > 0) {
                            livrosComDadosAuto.push({
                                titulo: titulo,
                                autor: autor,
                                campos: camposPreenchidos,
                                confidence: dadosAuto.confidence || 1.0
                            });
                            autoFilled++;
                        }
                    }
                    
                    database.livros.push(livro);
                    imported++;
                }
            });
            
            // Mostrar relat√≥rio de importa√ß√£o
            let mensagem = `üìä RELAT√ìRIO DE IMPORTA√á√ÉO:\n\n`;
            mensagem += `‚úÖ Livros importados: ${imported}\n`;
            
            if (autoFilled > 0) {
                mensagem += `ü§ñ Livros com dados preenchidos automaticamente: ${autoFilled}\n`;
            }
            
            if (duplicados.length > 0) {
                mensagem += `‚ö†Ô∏è Livros duplicados ignorados: ${skipped}\n\n`;
                mensagem += `üìã DUPLICADOS DETECTADOS:\n`;
                duplicados.forEach(dup => {
                    mensagem += `‚Ä¢ Linha ${dup.linha}: "${dup.titulo}" - ${dup.autor}\n`;
                    mensagem += `  (J√° existe com ${dup.livroExistente.quantidade} exemplares)\n`;
                });
                
                if (duplicados.length > 0) {
                    mensagem += `\n‚ùì Deseja adicionar os exemplares aos livros existentes?`;
                    
                    const adicionarDuplicados = confirm(mensagem);
                    
                    if (adicionarDuplicados) {
                        duplicados.forEach(dup => {
                            dup.livroExistente.quantidade += dup.quantidadeNova;
                            dup.livroExistente.disponivel += dup.quantidadeNova;
                            updated++;
                        });
                        
                        mensagem = `üìä IMPORTA√á√ÉO FINALIZADA:\n\n`;
                        mensagem += `‚úÖ Novos livros: ${imported}\n`;
                        mensagem += `üîÑ Livros atualizados: ${updated}\n`;
                        if (autoFilled > 0) {
                            mensagem += `ü§ñ Livros com preenchimento autom√°tico: ${autoFilled}\n`;
                        }
                        mensagem += `üìö Total processado: ${imported + updated}`;
                    }
                }
            }
            
            // Mostrar detalhes do preenchimento autom√°tico se houver
            if (livrosComDadosAuto.length > 0 && livrosComDadosAuto.length <= 10) {
                mensagem += `\n\nü§ñ DETALHES DO PREENCHIMENTO AUTOM√ÅTICO:\n`;
                livrosComDadosAuto.forEach(livro => {
                    mensagem += `\nüìñ "${livro.titulo}" - ${livro.autor}\n`;
                    mensagem += `   Preenchido: ${livro.campos.join(', ')}\n`;
                    if (livro.confidence < 1.0) {
                        mensagem += `   Confian√ßa: ${Math.round(livro.confidence * 100)}%\n`;
                    }
                });
            } else if (livrosComDadosAuto.length > 10) {
                mensagem += `\n\nü§ñ ${livrosComDadosAuto.length} livros tiveram informa√ß√µes preenchidas automaticamente (categoria, descri√ß√£o, capa, etc.)`;
            }
            
            saveDatabase();
            closeModal('importBooksModal');
            loadLivros();
            updateDashboard();
            
            alert(mensagem);
            document.getElementById('importBooksText').value = '';
        }

        // Carregar usu√°rios
        function loadUsuarios() {
            const container = document.getElementById('usuariosList');
            let usuarios = database.usuarios;
            
            // Aplicar filtros
            const search = document.getElementById('searchUsuarios').value.toLowerCase();
            const tipo = document.getElementById('filterTipoUsuario').value;
            const status = document.getElementById('filterStatusUsuario').value;
            
            if (search) {
                usuarios = usuarios.filter(u => 
                    u.nome.toLowerCase().includes(search) || 
                    u.login.toLowerCase().includes(search)
                );
            }
            
            if (tipo) {
                usuarios = usuarios.filter(u => u.tipo === tipo);
            }
            
            if (status) {
                usuarios = usuarios.filter(u => u.status === status);
            }
            
            container.innerHTML = usuarios.map(usuario => {
                const canEdit = currentUser.tipo === 'admin' || (currentUser.login !== usuario.login && usuario.login !== 'ADMIN');
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="emoji-3d mr-2">${getTipoEmoji(usuario.tipo)}</span>
                                ${usuario.nome}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.login}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getTipoLabel(usuario.tipo)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.turma || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.livrosLidos || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${usuario.status === 'ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${usuario.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            ${canEdit ? `
                                <button onclick="editUsuario(${usuario.id})" class="text-orange-600 hover:text-orange-900">
                                    <span class="emoji-3d">‚úèÔ∏è</span>
                                </button>
                                ${usuario.login !== 'ADMIN' ? `
                                    <button onclick="toggleUsuarioStatus(${usuario.id})" class="text-${usuario.status === 'ativo' ? 'red' : 'green'}-600 hover:text-${usuario.status === 'ativo' ? 'red' : 'green'}-900">
                                        <span class="emoji-3d">${usuario.status === 'ativo' ? 'üö´' : '‚úÖ'}</span>
                                    </button>
                                    ${currentUser.tipo === 'admin' ? `
                                        <button onclick="deleteUsuario(${usuario.id})" class="text-red-600 hover:text-red-900">
                                            <span class="emoji-3d">üóëÔ∏è</span>
                                        </button>
                                    ` : ''}
                                ` : ''}
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar usu√°rios
        function filterUsuarios() {
            loadUsuarios();
        }

        // Adicionar usu√°rio
        function handleAddUser(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Verificar se login j√° existe
            const loginExists = database.usuarios.some(u => u.login === formData.get('login'));
            if (loginExists) {
                alert('Este login j√° est√° em uso!');
                return;
            }
            
            const usuario = {
                id: database.nextId.usuarios++,
                nome: formData.get('nome'),
                login: formData.get('login'),
                senha: formData.get('senha'),
                tipo: formData.get('tipo'),
                turma: formData.get('turma') || '',
                status: 'ativo',
                livrosLidos: 0
            };
            
            database.usuarios.push(usuario);
            saveDatabase();
            
            closeModal('addUserModal');
            loadUsuarios();
            updateDashboard();
            
            e.target.reset();
        }

        // Importar usu√°rios
        function importUsers() {
            const text = document.getElementById('importUsersText').value.trim();
            if (!text) return;
            
            const lines = text.split('\n').filter(line => line.trim());
            let imported = 0;
            
            lines.forEach(line => {
                const parts = line.split('|').map(p => p.trim());
                if (parts.length >= 4) {
                    // Verificar se login j√° existe
                    const loginExists = database.usuarios.some(u => u.login === parts[1]);
                    if (!loginExists) {
                        const usuario = {
                            id: database.nextId.usuarios++,
                            nome: parts[0],
                            login: parts[1],
                            senha: parts[2],
                            tipo: parts[3],
                            turma: parts[4] || '',
                            status: 'ativo',
                            livrosLidos: 0
                        };
                        
                        database.usuarios.push(usuario);
                        imported++;
                    }
                }
            });
            
            saveDatabase();
            closeModal('importUsersModal');
            loadUsuarios();
            updateDashboard();
            
            alert(`${imported} usu√°rios importados com sucesso!`);
            document.getElementById('importUsersText').value = '';
        }

        // Carregar empr√©stimos
        function loadEmprestimos() {
            const container = document.getElementById('emprestimosList');
            let emprestimos = [...database.emprestimos]; // Criar c√≥pia para n√£o modificar o original
            
            // Filtrar por usu√°rio se for aluno
            if (currentUser.tipo === 'aluno') {
                emprestimos = emprestimos.filter(e => e.alunoId === currentUser.id);
            }
            
            // Aplicar filtros
            const search = document.getElementById('searchEmprestimos').value.toLowerCase().trim();
            const dataInicio = document.getElementById('filterDataInicio').value.trim();
            const dataFim = document.getElementById('filterDataFim').value.trim();
            const turma = document.getElementById('filterTurma').value.trim();
            
            // Filtro de busca por nome do aluno ou t√≠tulo do livro
            if (search) {
                emprestimos = emprestimos.filter(e => {
                    const aluno = database.usuarios.find(u => u.id === e.alunoId);
                    const livro = database.livros.find(l => l.id === e.livroId);
                    
                    const nomeAluno = aluno ? aluno.nome.toLowerCase() : '';
                    const tituloLivro = livro ? livro.titulo.toLowerCase() : '';
                    const autorLivro = livro ? livro.autor.toLowerCase() : '';
                    const turmaAluno = aluno && aluno.turma ? aluno.turma.toLowerCase() : '';
                    
                    return nomeAluno.includes(search) || 
                           tituloLivro.includes(search) || 
                           autorLivro.includes(search) ||
                           turmaAluno.includes(search);
                });
            }
            
            // Filtro por data de in√≠cio
            if (dataInicio) {
                emprestimos = emprestimos.filter(e => e.dataEmprestimo >= dataInicio);
            }
            
            // Filtro por data de fim
            if (dataFim) {
                emprestimos = emprestimos.filter(e => e.dataEmprestimo <= dataFim);
            }
            
            // Filtro por turma
            if (turma) {
                emprestimos = emprestimos.filter(e => {
                    const aluno = database.usuarios.find(u => u.id === e.alunoId);
                    return aluno && aluno.turma && aluno.turma.trim() === turma;
                });
            }
            
            container.innerHTML = emprestimos.map(emprestimo => {
                const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
                const livro = database.livros.find(l => l.id === emprestimo.livroId);
                const hoje = new Date();
                const dataDevolucao = new Date(emprestimo.dataDevolucao);
                const isAtrasado = emprestimo.status === 'ativo' && dataDevolucao < hoje;
                
                return `
                    <tr class="${isAtrasado ? 'bg-red-50' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${aluno ? aluno.nome : 'Usu√°rio n√£o encontrado'}
                            ${aluno && aluno.turma ? `<br><span class="text-xs text-gray-500">${aluno.turma}</span>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${livro ? livro.titulo : 'Livro n√£o encontrado'}
                            ${livro ? `<br><span class="text-xs text-gray-500">${livro.autor}</span>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(emprestimo.dataEmprestimo)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(emprestimo.dataDevolucao)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(emprestimo.status, isAtrasado)}">
                                ${getStatusLabel(emprestimo.status, isAtrasado)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            ${emprestimo.status === 'ativo' ? `
                                <button onclick="devolverLivro(${emprestimo.id})" class="text-green-600 hover:text-green-900">
                                    <span class="emoji-3d">‚úÖ</span> Devolver
                                </button>
                            ` : ''}
                            ${['admin', 'professor', 'diretor', 'coordenador', 'ajudante'].includes(currentUser.tipo) ? `
                                <button onclick="deleteEmprestimo(${emprestimo.id})" class="text-red-600 hover:text-red-900">
                                    <span class="emoji-3d">üóëÔ∏è</span>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Carregar devolu√ß√µes pendentes
        function loadDevolucoesPendentes() {
            const container = document.getElementById('devolucoesList');
            const hoje = new Date();
            
            let pendentes = database.emprestimos.filter(e => {
                const isAtrasado = e.status === 'ativo' && new Date(e.dataDevolucao) < hoje;
                return isAtrasado;
            });
            
            // Filtrar por usu√°rio se for aluno
            if (currentUser.tipo === 'aluno') {
                pendentes = pendentes.filter(e => e.alunoId === currentUser.id);
            }
            
            container.innerHTML = pendentes.map(emprestimo => {
                const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
                const livro = database.livros.find(l => l.id === emprestimo.livroId);
                const diasAtraso = Math.floor((hoje - new Date(emprestimo.dataDevolucao)) / (1000 * 60 * 60 * 24));
                
                return `
                    <tr class="bg-red-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${aluno ? aluno.nome : 'Usu√°rio n√£o encontrado'}
                            ${aluno && aluno.turma ? `<br><span class="text-xs text-gray-500">${aluno.turma}</span>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${livro ? livro.titulo : 'Livro n√£o encontrado'}
                            ${livro ? `<br><span class="text-xs text-gray-500">${livro.autor}</span>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(emprestimo.dataEmprestimo)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(emprestimo.dataDevolucao)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">${diasAtraso} dias</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="devolverLivro(${emprestimo.id})" class="text-green-600 hover:text-green-900">
                                <span class="emoji-3d">‚úÖ</span> Devolver
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Adicionar empr√©stimo
        function showAddEmprestimoModal() {
            // Carregar alunos
            const alunoSelect = document.querySelector('#addEmprestimoModal select[name="aluno"]');
            const alunos = database.usuarios.filter(u => u.tipo === 'aluno' && u.status === 'ativo');
            
            alunoSelect.innerHTML = '<option value="">Selecione o aluno...</option>' +
                alunos.map(a => `<option value="${a.id}">${a.nome} (${a.turma || 'Sem turma'})</option>`).join('');
            
            // Se for aluno, selecionar automaticamente
            if (currentUser.tipo === 'aluno') {
                alunoSelect.value = currentUser.id;
                alunoSelect.disabled = true;
                document.getElementById('alunoSelectDiv').style.display = 'none';
            }
            
            // Definir data m√≠nima como hoje
            const hoje = new Date();
            const dataInput = document.querySelector('#addEmprestimoModal input[name="dataDevolucao"]');
            dataInput.min = hoje.toISOString().split('T')[0];
            
            showModal('addEmprestimoModal');
        }

        // Buscar livros para empr√©stimo
        function searchLivrosEmprestimo() {
            const search = document.getElementById('searchLivroEmprestimo').value.toLowerCase();
            const container = document.getElementById('livroSuggestions');
            
            if (search.length < 2) {
                container.classList.add('hidden');
                return;
            }
            
            const livrosDisponiveis = database.livros.filter(l => 
                l.disponivel > 0 && 
                l.titulo.toLowerCase().includes(search)
            );
            
            if (livrosDisponiveis.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500">Nenhum livro encontrado</div>';
                container.classList.remove('hidden');
                return;
            }
            
            container.innerHTML = livrosDisponiveis.map(livro => `
                <div onclick="selectLivroEmprestimo(${livro.id})" class="p-3 hover:bg-gray-50 cursor-pointer border-b">
                    <div class="font-medium">${livro.titulo}</div>
                    <div class="text-sm text-gray-600">${livro.autor}</div>
                    <div class="text-xs text-green-600">${livro.disponivel} dispon√≠vel(is)</div>
                </div>
            `).join('');
            
            container.classList.remove('hidden');
        }

        // Selecionar livro para empr√©stimo
        function selectLivroEmprestimo(livroId) {
            const livro = database.livros.find(l => l.id === livroId);
            
            document.getElementById('livroId').value = livroId;
            document.getElementById('livroInfo').innerHTML = `
                <div class="font-medium">${livro.titulo}</div>
                <div class="text-sm text-gray-600">${livro.autor}</div>
                <div class="text-xs text-green-600">${livro.disponivel} dispon√≠vel(is)</div>
            `;
            
            document.getElementById('livroSelecionado').classList.remove('hidden');
            document.getElementById('livroSuggestions').classList.add('hidden');
            document.getElementById('searchLivroEmprestimo').value = livro.titulo;
        }

        // Processar empr√©stimo
        function handleAddEmprestimo(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const alunoId = parseInt(formData.get('aluno')) || currentUser.id;
            const livroId = parseInt(formData.get('livro'));
            
            if (!alunoId || !livroId) {
                alert('Por favor, selecione o aluno e o livro!');
                return;
            }
            
            const livro = database.livros.find(l => l.id === livroId);
            if (livro.disponivel <= 0) {
                alert('Este livro n√£o est√° dispon√≠vel!');
                return;
            }
            
            const emprestimo = {
                id: database.nextId.emprestimos++,
                alunoId: alunoId,
                livroId: livroId,
                dataEmprestimo: new Date().toISOString().split('T')[0],
                dataDevolucao: formData.get('dataDevolucao'),
                status: 'ativo'
            };
            
            database.emprestimos.push(emprestimo);
            
            // Reduzir disponibilidade do livro
            livro.disponivel--;
            
            saveDatabase();
            
            closeModal('addEmprestimoModal');
            loadEmprestimos();
            updateDashboard();
            
            e.target.reset();
            document.getElementById('livroSelecionado').classList.add('hidden');
        }

        // Devolver livro
        function devolverLivro(emprestimoId) {
            const emprestimo = database.emprestimos.find(e => e.id === emprestimoId);
            const livro = database.livros.find(l => l.id === emprestimo.livroId);
            const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
            
            emprestimo.status = 'devolvido';
            emprestimo.dataRealDevolucao = new Date().toISOString().split('T')[0];
            
            // Aumentar disponibilidade do livro
            livro.disponivel++;
            
            // Incrementar livros lidos do aluno
            aluno.livrosLidos = (aluno.livrosLidos || 0) + 1;
            
            saveDatabase();
            
            loadEmprestimos();
            loadDevolucoesPendentes();
            updateDashboard();
            
            alert('Livro devolvido com sucesso!');
        }

        // Excluir empr√©stimo
        function deleteEmprestimo(emprestimoId) {
            if (!confirm('Tem certeza que deseja excluir este empr√©stimo?')) return;
            
            const emprestimoIndex = database.emprestimos.findIndex(e => e.id === emprestimoId);
            const emprestimo = database.emprestimos[emprestimoIndex];
            
            if (emprestimo.status === 'ativo') {
                // Devolver disponibilidade do livro
                const livro = database.livros.find(l => l.id === emprestimo.livroId);
                livro.disponivel++;
            } else if (emprestimo.status === 'devolvido') {
                // Se o empr√©stimo foi devolvido, decrementar livros lidos do aluno
                const aluno = database.usuarios.find(u => u.id === emprestimo.alunoId);
                if (aluno && aluno.livrosLidos > 0) {
                    aluno.livrosLidos--;
                }
            }
            
            database.emprestimos.splice(emprestimoIndex, 1);
            saveDatabase();
            
            loadEmprestimos();
            updateDashboard();
        }

        // Mostrar modal de avalia√ß√£o
        function showAvaliacaoModal(emprestimoId) {
            const emprestimo = database.emprestimos.find(e => e.id === emprestimoId);
            const livro = database.livros.find(l => l.id === emprestimo.livroId);
            
            document.getElementById('livroAvaliacaoInfo').innerHTML = `
                <div class="font-medium">${livro.titulo}</div>
                <div class="text-sm text-gray-600">${livro.autor}</div>
            `;
            
            document.getElementById('avaliacaoForm').dataset.emprestimoId = emprestimoId;
            document.getElementById('avaliacaoForm').dataset.livroId = livro.id;
            
            showModal('avaliacaoModal');
        }

        // Mostrar modal de avalia√ß√£o direta do livro (para alunos)
        function showAvaliacaoLivroModal(livroId) {
            const livro = database.livros.find(l => l.id === livroId);
            if (!livro) return;
            
            // Verificar se o aluno j√° avaliou este livro
            const jaAvaliou = livro.avaliacoes.some(av => av.alunoId === currentUser.id);
            if (jaAvaliou) {
                alert('Voc√™ j√° avaliou este livro!');
                return;
            }
            
            document.getElementById('livroAvaliacaoInfo').innerHTML = `
                <div class="font-medium">${livro.titulo}</div>
                <div class="text-sm text-gray-600">${livro.autor}</div>
            `;
            
            document.getElementById('avaliacaoForm').dataset.emprestimoId = '';
            document.getElementById('avaliacaoForm').dataset.livroId = livro.id;
            
            showModal('avaliacaoModal');
        }

        // Processar avalia√ß√£o
        function handleAvaliacao(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const emprestimoId = parseInt(e.target.dataset.emprestimoId);
            const livroId = parseInt(e.target.dataset.livroId);
            const nota = parseInt(formData.get('avaliacao'));
            const comentario = formData.get('comentario');
            
            if (!nota) {
                alert('Por favor, selecione uma avalia√ß√£o!');
                return;
            }
            
            const livro = database.livros.find(l => l.id === livroId);
            
            const avaliacao = {
                id: Date.now(),
                alunoId: currentUser.id,
                alunoNome: currentUser.nome,
                nota: nota,
                comentario: comentario,
                data: new Date().toISOString().split('T')[0]
            };
            
            livro.avaliacoes.push(avaliacao);
            
            saveDatabase();
            
            closeModal('avaliacaoModal');
            loadLivros();
            
            e.target.reset();
            // Reset stars
            document.querySelectorAll('.star-btn').forEach(star => {
                star.classList.remove('text-yellow-400');
                star.classList.add('text-gray-300');
            });
            
            alert('Avalia√ß√£o enviada com sucesso!');
        }

        // Carregar turmas para filtro
        function loadTurmasFilter() {
            // Obter turmas √∫nicas (removendo valores vazios e duplicados)
            const turmas = [...new Set(database.usuarios
                .filter(u => u.turma && u.turma.trim() !== '')
                .map(u => u.turma.trim())
            )].sort();
            
            // Atualizar select de turmas
            const turmaSelect = document.getElementById('filterTurma');
            const turmaAtual = turmaSelect.value;
            turmaSelect.innerHTML = '<option value="">Todas as turmas</option>' +
                turmas.map(t => `<option value="${t}" ${t === turmaAtual ? 'selected' : ''}>${t}</option>`).join('');
        }

        // Filtrar empr√©stimos
        function filterEmprestimos() {
            loadEmprestimos();
        }

        // Limpar filtros de livros
        function clearLivrosFilters() {
            document.getElementById('searchLivros').value = '';
            document.getElementById('filterCategoria').value = '';
            document.getElementById('filterAutor').value = '';
            document.getElementById('filterDisponibilidade').value = '';
            loadLivros();
        }

        // Limpar filtros de empr√©stimos
        function clearEmprestimosFilters() {
            document.getElementById('searchEmprestimos').value = '';
            document.getElementById('filterDataInicio').value = '';
            document.getElementById('filterDataFim').value = '';
            document.getElementById('filterTurma').value = '';
            loadEmprestimos();
        }

        // Mostrar/ocultar campo turma
        function toggleTurmaField(select) {
            const turmaField = document.getElementById('turmaField');
            if (select.value === 'aluno') {
                turmaField.classList.remove('hidden');
                turmaField.querySelector('select').required = true;
            } else {
                turmaField.classList.add('hidden');
                turmaField.querySelector('select').required = false;
            }
        }

        // Fun√ß√µes auxiliares
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function getTipoEmoji(tipo) {
            const emojis = {
                admin: 'üëë',
                professor: 'üë®‚Äçüè´',
                diretor: 'üëî',
                coordenador: 'üìã',
                ajudante: 'ü§ù',
                aluno: 'üéì'
            };
            return emojis[tipo] || 'üë§';
        }

        function getTipoLabel(tipo) {
            const labels = {
                admin: 'Administrador',
                professor: 'Professor',
                diretor: 'Diretor',
                coordenador: 'Coordenador',
                ajudante: 'Ajudante',
                aluno: 'Aluno'
            };
            return labels[tipo] || tipo;
        }

        function getStatusColor(status, isAtrasado) {
            if (status === 'ativo' && isAtrasado) return 'bg-red-100 text-red-800';
            if (status === 'ativo') return 'bg-yellow-100 text-yellow-800';
            return 'bg-green-100 text-green-800';
        }

        function getStatusLabel(status, isAtrasado) {
            if (status === 'ativo' && isAtrasado) return 'Atrasado';
            if (status === 'ativo') return 'Ativo';
            return 'Devolvido';
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Reset forms
            document.getElementById('loginForm').reset();
        }

        // Editar livro
        function editLivro(id) {
            const livro = database.livros.find(l => l.id === id);
            if (!livro) return;
            
            // Preencher formul√°rio
            document.getElementById('editBookId').value = livro.id;
            document.getElementById('editBookTitulo').value = livro.titulo;
            document.getElementById('editBookCodigo').value = livro.codigoBarra || '';
            document.getElementById('editBookAutor').value = livro.autor;
            document.getElementById('editBookEditora').value = livro.editora || '';
            document.getElementById('editBookCategoria').value = livro.categoria || '';
            document.getElementById('editBookSubcategoria').value = livro.subcategoria || '';
            document.getElementById('editBookQuantidade').value = livro.quantidade;
            document.getElementById('editBookLocalizacao').value = livro.localizacao || '';
            document.getElementById('editBookDescricao').value = livro.descricao || '';
            document.getElementById('editBookFoto').value = livro.foto || '';
            
            showModal('editBookModal');
        }

        // Processar edi√ß√£o de livro
        async function handleEditBook(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const id = parseInt(formData.get('id'));
            const livro = database.livros.find(l => l.id === id);
            
            if (!livro) return;
            
            const titulo = formData.get('titulo');
            const autor = formData.get('autor');
            const codigoBarra = formData.get('codigoBarra');
            
            // Verificar duplicatas (excluindo o pr√≥prio livro)
            if (verificarLivroDuplicado(titulo, autor, codigoBarra, id)) {
                const livroExistente = database.livros.find(l => {
                    if (l.id === id) return false; // Excluir o pr√≥prio livro
                    
                    const tituloNorm = titulo.toLowerCase().trim();
                    const autorNorm = autor.toLowerCase().trim();
                    const livroTituloNorm = l.titulo.toLowerCase().trim();
                    const livroAutorNorm = l.autor.toLowerCase().trim();
                    
                    return (tituloNorm === livroTituloNorm && autorNorm === livroAutorNorm) ||
                           (codigoBarra && l.codigoBarra && codigoBarra.trim() === l.codigoBarra.trim());
                });
                
                alert(
                    `‚ö†Ô∏è CONFLITO DETECTADO!\n\n` +
                    `J√° existe outro livro com essas informa√ß√µes:\n` +
                    `üìñ T√≠tulo: ${livroExistente.titulo}\n` +
                    `‚úçÔ∏è Autor: ${livroExistente.autor}\n` +
                    `üìä Quantidade: ${livroExistente.quantidade}\n` +
                    `${livroExistente.codigoBarra ? `üè∑Ô∏è C√≥digo: ${livroExistente.codigoBarra}\n` : ''}` +
                    `\nPor favor, verifique os dados antes de continuar.`
                );
                return;
            }
            
            const novaQuantidade = parseInt(formData.get('quantidade'));
            const diferencaQuantidade = novaQuantidade - livro.quantidade;
            
            let foto = formData.get('foto') || livro.foto;
            
            // Processar arquivo de imagem se fornecido
            const fotoFile = formData.get('fotoFile');
            if (fotoFile && fotoFile.size > 0) {
                try {
                    foto = await fileToBase64(fotoFile);
                } catch (error) {
                    console.error('Erro ao processar imagem:', error);
                }
            }
            
            // Atualizar dados do livro
            livro.titulo = titulo;
            livro.autor = autor;
            livro.editora = formData.get('editora') || '';
            livro.categoria = formData.get('categoria') || '';
            livro.subcategoria = formData.get('subcategoria') || '';
            livro.quantidade = novaQuantidade;
            livro.disponivel = Math.max(0, livro.disponivel + diferencaQuantidade);
            livro.descricao = formData.get('descricao') || '';
            livro.foto = foto;
            livro.codigoBarra = codigoBarra || '';
            livro.localizacao = formData.get('localizacao') || '';
            
            // ü§ñ PREENCHIMENTO AUTOM√ÅTICO INTELIGENTE (apenas campos vazios)
            const dadosAuto = buscarInformacoesLivro(titulo, autor, codigoBarra);
            let mensagemAuto = '';
            
            if (dadosAuto) {
                if (!livro.categoria && dadosAuto.categoria) {
                    livro.categoria = dadosAuto.categoria;
                    mensagemAuto += `üìÇ Categoria: ${dadosAuto.categoria}\n`;
                }
                if (!livro.subcategoria && dadosAuto.subcategoria) {
                    livro.subcategoria = dadosAuto.subcategoria;
                    mensagemAuto += `üìã Subcategoria: ${dadosAuto.subcategoria}\n`;
                }
                if (!livro.descricao && dadosAuto.descricao) {
                    livro.descricao = dadosAuto.descricao;
                    mensagemAuto += `üìù Descri√ß√£o atualizada automaticamente\n`;
                }
                if ((!livro.foto || livro.foto === '') && dadosAuto.foto) {
                    livro.foto = dadosAuto.foto;
                    mensagemAuto += `üñºÔ∏è Capa do livro adicionada automaticamente\n`;
                }
            }
            
            saveDatabase();
            
            closeModal('editBookModal');
            loadLivros();
            updateDashboard();
            
            let mensagemFinal = '‚úÖ Livro atualizado com sucesso!';
            if (mensagemAuto) {
                mensagemFinal += `\n\nü§ñ INFORMA√á√ïES PREENCHIDAS AUTOMATICAMENTE:\n${mensagemAuto}`;
                if (dadosAuto.confidence) {
                    mensagemFinal += `\nüìä Confian√ßa: ${Math.round(dadosAuto.confidence * 100)}%`;
                }
            }
            
            alert(mensagemFinal);
        }

        function deleteLivro(id) {
            if (!confirm('Tem certeza que deseja excluir este livro?')) return;
            
            const livroIndex = database.livros.findIndex(l => l.id === id);
            database.livros.splice(livroIndex, 1);
            saveDatabase();
            
            loadLivros();
            updateDashboard();
        }

        function editUsuario(id) {
            const usuario = database.usuarios.find(u => u.id === id);
            if (!usuario) return;
            
            // Preencher formul√°rio
            document.getElementById('editUserId').value = usuario.id;
            document.getElementById('editUserNome').value = usuario.nome;
            document.getElementById('editUserLogin').value = usuario.login;
            document.getElementById('editUserSenha').value = ''; // N√£o mostrar senha atual
            document.getElementById('editUserTipo').value = usuario.tipo;
            document.getElementById('editUserTurma').value = usuario.turma || '';
            
            // Mostrar/ocultar campo turma
            const turmaField = document.getElementById('editTurmaField');
            if (usuario.tipo === 'aluno') {
                turmaField.classList.remove('hidden');
                turmaField.querySelector('select').required = true;
            } else {
                turmaField.classList.add('hidden');
                turmaField.querySelector('select').required = false;
            }
            
            showModal('editUserModal');
        }

        // Processar edi√ß√£o de usu√°rio
        function handleEditUser(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const id = parseInt(formData.get('id'));
            const usuario = database.usuarios.find(u => u.id === id);
            
            if (!usuario) return;
            
            const novoLogin = formData.get('login');
            
            // Verificar se login j√° existe (exceto o pr√≥prio usu√°rio)
            const loginExists = database.usuarios.some(u => u.login === novoLogin && u.id !== id);
            if (loginExists) {
                alert('Este login j√° est√° em uso!');
                return;
            }
            
            // Atualizar dados do usu√°rio
            usuario.nome = formData.get('nome');
            usuario.login = novoLogin;
            usuario.tipo = formData.get('tipo');
            usuario.turma = formData.get('turma') || '';
            
            // Atualizar senha apenas se foi fornecida
            const novaSenha = formData.get('senha');
            if (novaSenha.trim()) {
                usuario.senha = novaSenha;
            }
            
            saveDatabase();
            
            closeModal('editUserModal');
            loadUsuarios();
            updateDashboard();
            
            alert('Usu√°rio atualizado com sucesso!');
        }

        // Mostrar/ocultar campo turma na edi√ß√£o
        function toggleEditTurmaField(select) {
            const turmaField = document.getElementById('editTurmaField');
            if (select.value === 'aluno') {
                turmaField.classList.remove('hidden');
                turmaField.querySelector('select').required = true;
            } else {
                turmaField.classList.add('hidden');
                turmaField.querySelector('select').required = false;
            }
        }

        function toggleUsuarioStatus(id) {
            const usuario = database.usuarios.find(u => u.id === id);
            usuario.status = usuario.status === 'ativo' ? 'bloqueado' : 'ativo';
            saveDatabase();
            
            loadUsuarios();
            updateDashboard();
        }

        function deleteUsuario(id) {
            if (currentUser.tipo !== 'admin') {
                alert('Apenas administradores podem excluir usu√°rios!');
                return;
            }
            
            const usuario = database.usuarios.find(u => u.id === id);
            if (usuario.login === 'ADMIN') {
                alert('N√£o √© poss√≠vel excluir o usu√°rio administrador!');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja excluir o usu√°rio "${usuario.nome}"?`)) return;
            
            const usuarioIndex = database.usuarios.findIndex(u => u.id === id);
            database.usuarios.splice(usuarioIndex, 1);
            saveDatabase();
            
            loadUsuarios();
            updateDashboard();
        }

        function showAddBookModal() {
            showModal('addBookModal');
        }

        function showImportBooksModal() {
            showModal('importBooksModal');
        }

        function showAddUserModal() {
            showModal('addUserModal');
        }

        function showImportUsersModal() {
            showModal('importUsersModal');
        }

        // Mostrar modal de limpar biblioteca
        function showClearLibraryModal() {
            // Atualizar estat√≠sticas no modal
            const modalContent = document.querySelector('#clearLibraryModal .bg-yellow-50 p');
            modalContent.innerHTML = `
                <span class="emoji-3d">üìä</span> 
                <strong>Dados que ser√£o perdidos:</strong><br>
                ‚Ä¢ ${database.livros.length} livros cadastrados<br>
                ‚Ä¢ ${database.emprestimos.filter(e => e.status === 'ativo').length} empr√©stimos ativos<br>
                ‚Ä¢ Todas as avalia√ß√µes e coment√°rios
            `;
            
            showModal('clearLibraryModal');
        }

        // Processar limpeza da biblioteca
        function handleClearLibrary(e) {
            e.preventDefault();
            
            const senhaDigitada = document.getElementById('adminPasswordConfirm').value;
            const confirmado = document.getElementById('confirmClear').checked;
            
            // Verificar senha do administrador
            if (senhaDigitada !== currentUser.senha) {
                alert('‚ùå Senha incorreta! Acesso negado.');
                return;
            }
            
            if (!confirmado) {
                alert('‚ùå Voc√™ deve confirmar que entende que esta a√ß√£o √© irrevers√≠vel.');
                return;
            }
            
            // Confirma√ß√£o final
            const confirmacaoFinal = confirm(
                `üö® √öLTIMA CONFIRMA√á√ÉO!\n\n` +
                `Voc√™ est√° prestes a APAGAR PERMANENTEMENTE:\n` +
                `üìö ${database.livros.length} livros\n` +
                `üìã ${database.emprestimos.filter(e => e.status === 'ativo').length} empr√©stimos ativos\n` +
                `‚≠ê Todas as avalia√ß√µes\n\n` +
                `Esta a√ß√£o N√ÉO PODE SER DESFEITA!\n\n` +
                `Tem ABSOLUTA CERTEZA que deseja continuar?`
            );
            
            if (!confirmacaoFinal) {
                return;
            }
            
            // Executar limpeza
            const livrosApagados = database.livros.length;
            const emprestimosAtivos = database.emprestimos.filter(e => e.status === 'ativo').length;
            const totalAvaliacoes = database.livros.reduce((total, livro) => total + livro.avaliacoes.length, 0);
            
            // Limpar dados
            database.livros = [];
            database.emprestimos = [];
            database.nextId.livros = 1;
            database.nextId.emprestimos = 1;
            
            // Resetar contador de livros lidos dos usu√°rios
            database.usuarios.forEach(usuario => {
                if (usuario.tipo === 'aluno') {
                    usuario.livrosLidos = 0;
                }
            });
            
            saveDatabase();
            
            closeModal('clearLibraryModal');
            
            // Atualizar interface
            loadLivros();
            loadEmprestimos();
            loadDevolucoesPendentes();
            updateDashboard();
            
            // Limpar formul√°rio
            document.getElementById('clearLibraryForm').reset();
            
            // Mostrar relat√≥rio da limpeza
            alert(
                `‚úÖ BIBLIOTECA LIMPA COM SUCESSO!\n\n` +
                `üìä RELAT√ìRIO DA LIMPEZA:\n` +
                `üóëÔ∏è ${livrosApagados} livros removidos\n` +
                `üìã ${emprestimosAtivos} empr√©stimos cancelados\n` +
                `‚≠ê ${totalAvaliacoes} avalia√ß√µes removidas\n` +
                `üë• Contadores de livros lidos zerados\n\n` +
                `A biblioteca est√° agora completamente vazia e pronta para novos cadastros.`
            );
        }

        // Mostrar detalhes do livro
        function showDetalhesLivro(livroId) {
            const livro = database.livros.find(l => l.id === livroId);
            if (!livro) return;
            
            const mediaAvaliacao = livro.avaliacoes.length > 0 ? 
                (livro.avaliacoes.reduce((sum, av) => sum + av.nota, 0) / livro.avaliacoes.length).toFixed(1) : 0;
            
            const jaAvaliou = livro.avaliacoes.some(av => av.alunoId === currentUser.id);
            
            const content = `
                <div class="flex items-start space-x-6">
                    <div class="w-32 h-44 bg-gradient-to-b from-orange-400 to-orange-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        ${livro.foto ? `<img src="${livro.foto}" alt="${livro.titulo}" class="w-full h-full object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity" onclick="showZoomFoto(${livro.id}, '${livro.foto}')">` : '<span class="text-white text-4xl emoji-3d">üìñ</span>'}
                    </div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold mb-2">${livro.titulo}</h2>
                        <p class="text-lg text-gray-700 mb-2">Por: ${livro.autor}</p>
                        ${livro.editora ? `<p class="text-gray-600 mb-2">Editora: ${livro.editora}</p>` : ''}
                        ${livro.categoria ? `<p class="text-gray-600 mb-2">Categoria: ${livro.categoria}</p>` : ''}
                        ${livro.subcategoria ? `<p class="text-gray-600 mb-2">Subcategoria: ${livro.subcategoria}</p>` : ''}
                        ${livro.localizacao ? `<p class="text-gray-600 mb-2">üìç Localiza√ß√£o: ${livro.localizacao}</p>` : ''}
                        
                        <div class="flex items-center space-x-4 mb-4">
                            <span class="flex items-center text-lg">
                                <span class="emoji-3d">üìö</span>
                                <span class="ml-2">${livro.disponivel}/${livro.quantidade} dispon√≠vel</span>
                            </span>
                            <span class="flex items-center text-lg">
                                <span class="emoji-3d">‚≠ê</span>
                                <span class="ml-2">${mediaAvaliacao} (${livro.avaliacoes.length} avalia√ß√µes)</span>
                            </span>
                        </div>
                    </div>
                </div>
                
                ${livro.descricao ? `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">üìù Descri√ß√£o</h3>
                        <p class="text-gray-700">${livro.descricao}</p>
                    </div>
                ` : ''}
                
                ${livro.avaliacoes.length > 0 ? `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">‚≠ê Avalia√ß√µes dos Alunos</h3>
                        <div class="space-y-4 max-h-64 overflow-y-auto">
                            ${livro.avaliacoes.map(av => `
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium">${av.alunoNome}</span>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-yellow-500">${'‚≠ê'.repeat(av.nota)}</span>
                                            <span class="text-gray-400">${'‚≠ê'.repeat(5 - av.nota)}</span>
                                            <span class="text-sm text-gray-500">${formatDate(av.data)}</span>
                                        </div>
                                    </div>
                                    ${av.comentario ? `<p class="text-gray-700">"${av.comentario}"</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <p class="text-gray-500">Este livro ainda n√£o possui avalia√ß√µes.</p>
                        <p class="text-sm text-gray-400 mt-1">Seja o primeiro a avaliar!</p>
                    </div>
                `}
            `;
            
            document.getElementById('detalhesLivroContent').innerHTML = content;
            
            // Mostrar/ocultar bot√£o de avaliar
            const avaliarBtn = document.getElementById('avaliarLivroBtn');
            if (currentUser.tipo === 'aluno' && !jaAvaliou) {
                avaliarBtn.classList.remove('hidden');
                avaliarBtn.dataset.livroId = livroId;
            } else {
                avaliarBtn.classList.add('hidden');
            }
            
            showModal('detalhesLivroModal');
        }

        // Avaliar livro a partir dos detalhes
        function avaliarLivroFromDetalhes() {
            const livroId = parseInt(document.getElementById('avaliarLivroBtn').dataset.livroId);
            closeModal('detalhesLivroModal');
            showAvaliacaoLivroModal(livroId);
        }

        // Mostrar zoom da foto do livro
        function showZoomFoto(livroId, fotoSrc) {
            const livro = database.livros.find(l => l.id === livroId);
            if (!livro || !fotoSrc) return;
            
            const img = document.getElementById('zoomFotoImg');
            
            img.src = fotoSrc;
            img.alt = livro.titulo;
            
            document.getElementById('zoomFotoModal').classList.remove('hidden');
            document.getElementById('zoomFotoModal').classList.add('flex');
        }

        // Fechar zoom da foto
        function closeZoomFoto() {
            document.getElementById('zoomFotoModal').classList.add('hidden');
            document.getElementById('zoomFotoModal').classList.remove('flex');
        }

        // Mostrar modal de trocar senha
        function showTrocarSenhaModal() {
            // Limpar campos
            document.getElementById('trocarSenhaForm').reset();
            showModal('trocarSenhaModal');
        }

        // Processar troca de senha
        function handleTrocarSenha(e) {
            e.preventDefault();
            
            const senhaAtual = document.getElementById('senhaAtual').value;
            const novaSenha = document.getElementById('novaSenha').value;
            const confirmarNovaSenha = document.getElementById('confirmarNovaSenha').value;
            
            // Verificar senha atual
            if (senhaAtual !== currentUser.senha) {
                alert('‚ùå Senha atual incorreta! Verifique e tente novamente.');
                document.getElementById('senhaAtual').focus();
                return;
            }
            
            // Verificar se a nova senha √© diferente da atual
            if (novaSenha === senhaAtual) {
                alert('‚ö†Ô∏è A nova senha deve ser diferente da senha atual!');
                document.getElementById('novaSenha').focus();
                return;
            }
            
            // Verificar se as senhas coincidem
            if (novaSenha !== confirmarNovaSenha) {
                alert('‚ùå As senhas n√£o coincidem! Verifique e tente novamente.');
                document.getElementById('confirmarNovaSenha').focus();
                return;
            }
            
            // Verificar tamanho m√≠nimo
            if (novaSenha.length < 4) {
                alert('‚ùå A nova senha deve ter pelo menos 4 caracteres!');
                document.getElementById('novaSenha').focus();
                return;
            }
            
            // Confirma√ß√£o final
            const confirmar = confirm(
                `üîë CONFIRMA√á√ÉO DE ALTERA√á√ÉO DE SENHA\n\n` +
                `Voc√™ est√° prestes a alterar sua senha de acesso.\n\n` +
                `‚ö†Ô∏è IMPORTANTE:\n` +
                `‚Ä¢ Anote a nova senha em local seguro\n` +
                `‚Ä¢ N√£o ser√° poss√≠vel recuper√°-la se esquecida\n` +
                `‚Ä¢ Voc√™ precisar√° usar a nova senha no pr√≥ximo login\n\n` +
                `Confirma a altera√ß√£o da senha?`
            );
            
            if (!confirmar) {
                return;
            }
            
            // Atualizar senha no banco de dados
            const usuario = database.usuarios.find(u => u.id === currentUser.id);
            if (usuario) {
                const senhaAnterior = usuario.senha;
                usuario.senha = novaSenha;
                currentUser.senha = novaSenha; // Atualizar tamb√©m na sess√£o atual
                
                saveDatabase();
                
                closeModal('trocarSenhaModal');
                
                // Mostrar confirma√ß√£o de sucesso
                alert(
                    `‚úÖ SENHA ALTERADA COM SUCESSO!\n\n` +
                    `üîê Sua senha foi alterada com seguran√ßa.\n\n` +
                    `üìù DETALHES:\n` +
                    `‚Ä¢ Usu√°rio: ${currentUser.nome} (${currentUser.login})\n` +
                    `‚Ä¢ Data/Hora: ${new Date().toLocaleString('pt-BR')}\n` +
                    `‚Ä¢ Nova senha: ${novaSenha}\n\n` +
                    `‚ö†Ô∏è IMPORTANTE: Anote esta informa√ß√£o em local seguro!\n\n` +
                    `No pr√≥ximo login, use a nova senha.`
                );
                
                console.log(`[ADMIN] Senha alterada - Usu√°rio: ${currentUser.login} - ${new Date().toISOString()}`);
            } else {
                alert('‚ùå Erro interno: Usu√°rio n√£o encontrado no banco de dados!');
            }
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'980b66f68009f211',t:'MTc1ODE0MTQ1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
